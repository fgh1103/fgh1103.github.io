<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="0. 优化思路12345678硬件       : DELL R730 40C 128G 10台 SAS(8块:4块raid10 2块热备)+SSD 512G日志  网卡 4块网卡 bonding 1操作系统   : C7.6,numa  THP 关闭 , XFS  ,Swap ,sysctl.conf ,limits.conf nofile , 防火墙 selinux 关闭,deadline,N">
<meta property="og:type" content="article">
<meta property="og:title" content="全面优化">
<meta property="og:url" content="http://example.com/2024/07/15/%E5%85%A8%E9%9D%A2%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="进学阁">
<meta property="og:description" content="0. 优化思路12345678硬件       : DELL R730 40C 128G 10台 SAS(8块:4块raid10 2块热备)+SSD 512G日志  网卡 4块网卡 bonding 1操作系统   : C7.6,numa  THP 关闭 , XFS  ,Swap ,sysctl.conf ,limits.conf nofile , 防火墙 selinux 关闭,deadline,N">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1609894264877-dd346846-597a-4930-82b4-bd3df8bc2515.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1609981686723-1be82e57-b85f-4699-bb26-532048d8c476.png">
<meta property="article:published_time" content="2024-07-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-06T09:55:08.767Z">
<meta property="article:author" content="139">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="优化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1609894264877-dd346846-597a-4930-82b4-bd3df8bc2515.png">

<link rel="canonical" href="http://example.com/2024/07/15/%E5%85%A8%E9%9D%A2%E4%BC%98%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>全面优化 | 进学阁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">进学阁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">业精于勤荒于嬉，行成于思毁于随</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">38</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">8</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">54</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/%E5%85%A8%E9%9D%A2%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/custom/avatar.jpg">
      <meta itemprop="name" content="139">
      <meta itemprop="description" content="一个普通的JAVA开发的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="进学阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          全面优化
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-07-15T00:00:00+08:00">2024-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-06 17:55:08" itemprop="dateModified" datetime="2025-03-06T17:55:08+08:00">2025-03-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="0-优化思路"><a href="#0-优化思路" class="headerlink" title="0. 优化思路"></a>0. 优化思路</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">硬件       : DELL R730 40C 128G 10台 SAS(8块:4块raid10 2块热备)+SSD 512G日志  网卡 4块网卡 bonding 1</span><br><span class="line">操作系统   : C7.6,numa  THP 关闭 , XFS  ,Swap ,sysctl.conf ,limits.conf nofile , 防火墙 selinux 关闭,deadline,No LVM</span><br><span class="line">数据库实例 ：</span><br><span class="line">SQL规范    ：</span><br><span class="line">索引       ：</span><br><span class="line">事务和锁   ：</span><br><span class="line">架构      ：</span><br><span class="line">安全      ： </span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1609894264877-dd346846-597a-4930-82b4-bd3df8bc2515.png"></p>
<span id="more"></span>

<hr>
<h2 id="1-硬件层面优化"><a href="#1-硬件层面优化" class="headerlink" title="1.硬件层面优化"></a>1.硬件层面优化</h2><p>1.0 硬件选配 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.0</span> 硬件选配</span><br><span class="line">DELL、HP、IBM、华为、浪潮。</span><br><span class="line">CPU：I、E</span><br><span class="line"></span><br><span class="line">内存：ECC </span><br><span class="line">IO : SAS 、 pci<span class="operator">-</span>e SSD 、 Nvme flash</span><br><span class="line">raid卡：Raid10</span><br><span class="line"></span><br><span class="line">网卡： 单卡单口  bonding  <span class="operator">+</span> 交换机堆叠</span><br><span class="line">云服务器： ECS 、RDS 、TDSQL、PolarxDB</span><br></pre></td></tr></table></figure>



<p>1.1 关闭NUMA </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.1</span> 关闭NUMA</span><br><span class="line">SMP   NUMA</span><br><span class="line"></span><br><span class="line">a. bios级别:</span><br><span class="line">在bios层面numa关闭时，无论os层面的numa是否打开，都不会影响性能。 </span><br><span class="line"></span><br><span class="line"># numactl <span class="comment">--hardware</span></span><br><span class="line">available: <span class="number">1</span> nodes (<span class="number">0</span>)       #如果是<span class="number">2</span>或多个nodes就说明numa没关掉</span><br><span class="line"></span><br><span class="line">b. OS grub级别:</span><br><span class="line">vi <span class="operator">/</span>boot<span class="operator">/</span>grub2<span class="operator">/</span>grub.cfg</span><br><span class="line">#<span class="comment">/* Copyright 2010, Oracle. All rights reserved. */</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">default</span><span class="operator">=</span><span class="number">0</span></span><br><span class="line">timeout<span class="operator">=</span><span class="number">5</span></span><br><span class="line">hiddenmenu</span><br><span class="line">foreground<span class="operator">=</span><span class="number">000000</span></span><br><span class="line">background<span class="operator">=</span>ffffff</span><br><span class="line">splashimage<span class="operator">=</span>(hd0,<span class="number">0</span>)<span class="operator">/</span>boot<span class="operator">/</span>grub<span class="operator">/</span>oracle.xpm.gz</span><br><span class="line"> </span><br><span class="line">title Trying_C0D0_as_HD0</span><br><span class="line">root (hd0,<span class="number">0</span>)</span><br><span class="line">kernel <span class="operator">/</span>boot<span class="operator">/</span>vmlinuz<span class="number">-2.6</span><span class="number">.18</span><span class="number">-128.1</span><span class="number">.16</span><span class="number">.0</span><span class="number">.1</span>.el5 root<span class="operator">=</span>LABEL<span class="operator">=</span>DBSYS ro bootarea<span class="operator">=</span>dbsys rhgb quiet console<span class="operator">=</span>ttyS0,<span class="number">115200</span>n8 console<span class="operator">=</span>tty1 crashkernel<span class="operator">=</span><span class="number">128</span>M<span class="variable">@16M</span> numa<span class="operator">=</span>off</span><br><span class="line">initrd <span class="operator">/</span>boot<span class="operator">/</span>initrd<span class="number">-2.6</span><span class="number">.18</span><span class="number">-128.1</span><span class="number">.16</span><span class="number">.0</span><span class="number">.1</span>.el5.img</span><br><span class="line"></span><br><span class="line">在os层numa关闭时,打开bios层的numa会影响性能，QPS会下降<span class="number">15</span><span class="number">-30</span><span class="operator">%</span>;</span><br><span class="line"></span><br><span class="line">c. 数据库级别:</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%numa%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name          <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_numa_interleave <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+-------+</span></span><br><span class="line"></span><br><span class="line">或者： </span><br><span class="line">vi <span class="operator">/</span>etc<span class="operator">/</span>init.d<span class="operator">/</span>mysqld</span><br><span class="line">找到如下行</span><br><span class="line"># Give extra arguments <span class="keyword">to</span> mysqld <span class="keyword">with</span> the my.cnf file. This script</span><br><span class="line"># may be overwritten <span class="keyword">at</span> next upgrade.</span><br><span class="line">$bindir<span class="operator">/</span>mysqld_safe <span class="comment">--datadir=&quot;$datadir&quot; --pid-file=&quot;$mysqld_pid_file_path&quot; $other_args &gt;/dev/null &amp;</span></span><br><span class="line"></span><br><span class="line">wait_for_pid created &quot;$!&quot; &quot;$mysqld_pid_file_path&quot;; return_value<span class="operator">=</span>$?</span><br><span class="line">将$bindir<span class="operator">/</span>mysqld_safe <span class="comment">--datadir=&quot;$datadir&quot;这一行修改为：</span></span><br><span class="line"></span><br><span class="line"><span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>numactl <span class="comment">--interleave all $bindir/mysqld_safe --datadir=&quot;$datadir&quot; --pid-file=&quot;$mysqld_pid_file_path&quot; $other_args &gt;/dev/null &amp;</span></span><br><span class="line">wait_for_pid created &quot;$!&quot; &quot;$mysqld_pid_file_path&quot;; return_value<span class="operator">=</span>$?</span><br></pre></td></tr></table></figure>



<p>1.2 阵列卡配置建议 </p>
<p>1.3 关闭THP </p>
<p>1.4 网卡绑定 </p>
<p>1.5 多路径储存 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.2</span> 阵列卡配置建议</span><br><span class="line">raid10(推荐)</span><br><span class="line">SSD或者PCI<span class="operator">-</span>E或者Flash</span><br><span class="line">强制回写（Force WriteBack）</span><br><span class="line">BBU 电池 ： 如果没电会有较大性能影响、定期充放电，如果UPS、多路电源、发电机。可以关闭。</span><br><span class="line">关闭预读</span><br><span class="line">有可能的话开启Cache(如果UPS、多路电源、发电机。)</span><br><span class="line"></span><br><span class="line"> <span class="number">1.3</span> 关闭THP</span><br><span class="line">vi <span class="operator">/</span>etc<span class="operator">/</span>rc.local</span><br><span class="line">在文件末尾添加如下指令：</span><br><span class="line">if test <span class="operator">-</span>f <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>enabled; <span class="keyword">then</span></span><br><span class="line">echo never <span class="operator">&gt;</span> <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>enabled</span><br><span class="line">fi</span><br><span class="line">if test <span class="operator">-</span>f <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>defrag; <span class="keyword">then</span></span><br><span class="line">echo never <span class="operator">&gt;</span> <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>defrag</span><br><span class="line">fi</span><br><span class="line">[root<span class="variable">@master</span>  <span class="operator">~</span>]# cat <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>enabled </span><br><span class="line">always madvise [never]</span><br><span class="line">[root<span class="variable">@master</span>  <span class="operator">~</span>]# cat  <span class="operator">/</span>sys<span class="operator">/</span>kernel<span class="operator">/</span>mm<span class="operator">/</span>transparent_hugepage<span class="operator">/</span>defrag </span><br><span class="line">always madvise [never]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.4</span> 网卡绑定</span><br><span class="line">bonding技术，业务数据库服务器都要配置bonding继续。建议是主备模式。</span><br><span class="line">交换机一定要堆叠。</span><br><span class="line"></span><br><span class="line"><span class="number">1.5</span> 存储多路径</span><br><span class="line">使用独立存储设备的话，需要配置多路径。</span><br><span class="line">linux 自带 : multipath</span><br><span class="line">厂商提供    :</span><br></pre></td></tr></table></figure>



<h2 id="2-系统层面优化"><a href="#2-系统层面优化" class="headerlink" title="2.系统层面优化"></a>2.系统层面优化</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">a. 更改文件句柄和进程数</span><br><span class="line">内核优化 <span class="operator">/</span>etc<span class="operator">/</span>sysctl.conf</span><br><span class="line">vm.swappiness <span class="operator">=</span> <span class="number">5</span></span><br><span class="line">vm.dirty_ratio <span class="operator">=</span> <span class="number">20</span></span><br><span class="line">vm.dirty_background_ratio <span class="operator">=</span> <span class="number">10</span></span><br><span class="line">net.ipv4.tcp_max_syn_backlog <span class="operator">=</span> <span class="number">819200</span></span><br><span class="line">net.core.netdev_max_backlog <span class="operator">=</span> <span class="number">400000</span></span><br><span class="line">net.core.somaxconn <span class="operator">=</span> <span class="number">4096</span></span><br><span class="line">net.ipv4.tcp_tw_reuse<span class="operator">=</span><span class="number">1</span></span><br><span class="line">net.ipv4.tcp_tw_recycle<span class="operator">=</span><span class="number">0</span></span><br><span class="line"></span><br><span class="line">limits.conf </span><br><span class="line">nofile <span class="number">63000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b. 防火墙</span><br><span class="line">禁用selinux ： <span class="operator">/</span>etc<span class="operator">/</span>sysconfig<span class="operator">/</span>selinux 更改SELINUX<span class="operator">=</span>disabled.</span><br><span class="line">iptables如果不使用可以关闭。可是需要打开MySQL需要的端口号</span><br><span class="line"></span><br><span class="line">c. 文件系统优化</span><br><span class="line">推荐使用XFS文件系统</span><br><span class="line">MySQL数据分区独立 ，例如挂载点为: <span class="operator">/</span>data</span><br><span class="line">mount参数 defaults, noatime, nodiratime, nobarrier 如<span class="operator">/</span>etc<span class="operator">/</span>fstab：</span><br><span class="line"><span class="operator">/</span>dev<span class="operator">/</span>sdb <span class="operator">/</span>data                   xfs     defaults,noatime,nodiratime,nobarrier        <span class="number">1</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line">d. 不使用LVM </span><br><span class="line"></span><br><span class="line">e. io调度</span><br><span class="line">SAS ：      deadline</span><br><span class="line">SSD<span class="operator">&amp;</span>PCI<span class="operator">-</span>E： noop</span><br><span class="line"></span><br><span class="line">centos <span class="number">7</span> 默认是deadline</span><br><span class="line">cat   <span class="operator">/</span>sys<span class="operator">/</span>block<span class="operator">/</span>sda<span class="operator">/</span>queue<span class="operator">/</span>scheduler</span><br><span class="line"></span><br><span class="line">#临时修改为deadline(centos6)</span><br><span class="line">echo deadline <span class="operator">&gt;</span><span class="operator">/</span>sys<span class="operator">/</span>block<span class="operator">/</span>sda<span class="operator">/</span>queue<span class="operator">/</span>scheduler </span><br><span class="line">vi <span class="operator">/</span>boot<span class="operator">/</span>grub<span class="operator">/</span>grub.conf</span><br><span class="line">更改到如下内容:</span><br><span class="line">kernel <span class="operator">/</span>boot<span class="operator">/</span>vmlinuz<span class="number">-2.6</span><span class="number">.18</span><span class="number">-8.</span>el5 ro root<span class="operator">=</span>LABEL<span class="operator">=</span><span class="operator">/</span> elevator<span class="operator">=</span>deadline rhgb quiet</span><br></pre></td></tr></table></figure>



<h2 id="3-数据库版本选择"><a href="#3-数据库版本选择" class="headerlink" title="3. 数据库版本选择"></a>3. 数据库版本选择</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、稳定版：选择开源的社区版的稳定版<span class="variable constant_">GA</span>版本。</span><br><span class="line"><span class="number">2</span>、选择mysql数据库<span class="variable constant_">GA</span>版本发布后<span class="number">6</span>个月-<span class="number">12</span>个月的<span class="variable constant_">GA</span>双数版本，大约在<span class="number">15</span>-<span class="number">20</span>个小版本左右。</span><br><span class="line"><span class="number">3</span>、要选择前后几个月没有大的<span class="variable constant_">BUG</span>修复的版本，而不是大量修复<span class="variable constant_">BUG</span>的集中版本。</span><br><span class="line"><span class="number">4</span>、要考虑开发人员开发程序使用的版本是否兼容你选的版本。</span><br><span class="line"><span class="number">5</span>、作为内部开发测试数据库环境，跑大概<span class="number">3</span>-<span class="number">6</span>个月的时间。</span><br><span class="line"><span class="number">6</span>、优先企业非核心业务采用新版本的数据库<span class="variable constant_">GA</span>版本软件。</span><br><span class="line"><span class="number">7</span>、向<span class="variable constant_">DBA</span>高手请教，或者在技术氛围好的群里和大家一起交流，使用真正的高手们用过的好用的<span class="variable constant_">GA</span>版本产品。</span><br><span class="line"></span><br><span class="line">最终建议： <span class="number">8.0</span><span class="number">.20</span>是一个不错的版本选择。向后可以选择双数版。  </span><br></pre></td></tr></table></figure>



<h2 id="4-💖数据库三层结构及核心参数优化"><a href="#4-💖数据库三层结构及核心参数优化" class="headerlink" title="4.💖数据库三层结构及核心参数优化"></a>4.💖数据库三层结构及核心参数优化</h2><h3 id="4-1-连接层"><a href="#4-1-连接层" class="headerlink" title="4.1 连接层"></a>4.1 连接层</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">max_connections=<span class="number">1000</span>         #*****       最大连接数</span><br><span class="line">max_connect_errors=<span class="number">999999</span>                 数据库开启以来失败连接次数</span><br><span class="line">wait_timeout=<span class="number">600</span>             #*****       连接超时时间</span><br><span class="line">interactive_wait_timeout=<span class="number">3600</span>             交互式连接超时时间</span><br><span class="line">net_read_timeout  = <span class="number">120</span>                   网络读超时时间</span><br><span class="line">net_write_timeout = <span class="number">120</span>                   网络写超时时间</span><br><span class="line">max_allowed_packet= 32M      #*****       允许的数据包大小</span><br></pre></td></tr></table></figure>

<h3 id="4-2-Server层"><a href="#4-2-Server层" class="headerlink" title="4.2 Server层"></a>4.2 Server层</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sql_safe_updates                =<span class="number">1</span>                 # *****             update <span class="keyword">delete</span>语句必须有where条件 有索引</span><br><span class="line">slow_query_log                  =<span class="variable constant_">ON</span>                                    是否开启慢日志</span><br><span class="line">slow_query_log_file             =<span class="regexp">/data/</span><span class="number">3307</span>/slow.<span class="property">log</span>   # *****         慢日志存放位置</span><br><span class="line">long_query_time                 =<span class="number">1</span>                  # *****            多久才算慢日志</span><br><span class="line">log_queries_not_using_indexes   =<span class="variable constant_">ON</span>                 # *****            没走索引的</span><br><span class="line">log_throttle_queries_not_using_indexes = <span class="number">10</span>         # *****            没走索引的  相同语句最多记录次数</span><br><span class="line">sort_buffer 					= 1M</span><br><span class="line">join_buffer 					= 1M</span><br><span class="line">read_buffer						= 1M</span><br><span class="line">read_rnd_buffer                 = 1M</span><br><span class="line">tmp_table  						= 16M</span><br><span class="line">heap_table 						= 16M</span><br><span class="line">max_execution_time              = <span class="number">28800</span>                                <span class="variable constant_">SQL</span>最大执行时间</span><br><span class="line">lock_wait_timeout               = <span class="number">60</span>                 # *****           <span class="variable constant_">MDL</span>锁等待时间</span><br><span class="line">lower_case_table_names          =<span class="number">1</span>                   # *****           建库建表时强制转换小写</span><br><span class="line">thread_cache_size               =<span class="number">64</span>                  </span><br><span class="line">log_timestamps                  =<span class="variable constant_">SYSTEM</span>              # *****           日志时间与系统时间一致</span><br><span class="line">init_connect                    =<span class="string">&quot;set names utf8&quot;</span>    # *****           客户端字符集设置成<span class="string">&#x27;utf8&#x27;</span></span><br><span class="line">event_scheduler                 =<span class="variable constant_">OFF</span>                                   计划任务</span><br><span class="line">secure-file-priv                =/tmp                # *****           导数据传到指定目录</span><br><span class="line">binlog_expire_logs_seconds      =<span class="number">2592000</span>             # *****           二进制日志过期时间</span><br><span class="line">sync_binlog                     =<span class="number">1</span>                   # *****           二进制日志文件每次写的时候同步到磁盘</span><br><span class="line">log-bin                         =<span class="regexp">/data/</span><span class="number">3307</span>/mysql-bin</span><br><span class="line">log-bin-index                   =<span class="regexp">/data/</span><span class="number">3307</span>/mysql-bin.<span class="property">index</span></span><br><span class="line">max_binlog_size                 =500M</span><br><span class="line">binlog_format                   =<span class="variable constant_">ROW</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-存储引擎层"><a href="#4-3-存储引擎层" class="headerlink" title="4.3 存储引擎层"></a>4.3 存储引擎层</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">transaction-isolation               =<span class="string">&quot;READ-COMMITTED&quot;</span>    # *****       隔离级别</span><br><span class="line">innodb_data_home_dir                =/xxx                              ibdata位置点</span><br><span class="line">innodb_log_group_home_dir           =/xxx                              redolog位置点</span><br><span class="line">innodb_log_file_size                =2048M                             redolog大小 （512M-4G)</span><br><span class="line">innodb_log_files_in_group           =<span class="number">3</span>                                 redolog组</span><br><span class="line">innodb_flush_log_at_trx_commit      =<span class="number">2</span>                   # *****       事务提交redolog立即刷新到磁盘</span><br><span class="line">innodb_flush_method                 =<span class="variable constant_">O_DIRECT</span>            # *****       刷新策略</span><br><span class="line">innodb_io_capacity                  =<span class="number">1000</span>                # *****       iops刷新多少数据页</span><br><span class="line">innodb_io_capacity_max              =<span class="number">4000</span>         </span><br><span class="line">innodb_buffer_pool_size             =64G                 # *****       <span class="number">50</span>%-<span class="number">75</span>%物理内存</span><br><span class="line">innodb_buffer_pool_instances        =<span class="number">4</span>                   # *****</span><br><span class="line">innodb_log_buffer_size              =64M                 # *****       redo buffer大小 (512M-4G)</span><br><span class="line">innodb_max_dirty_pages_pct          =<span class="number">85</span>                  # *****       脏页占比  超过出发ckpt刷新到磁盘</span><br><span class="line">innodb_lock_wait_timeout            =<span class="number">10</span>                  # *****       行锁超时时间</span><br><span class="line">innodb_open_files                   =<span class="number">63000</span>               # *****       文件句柄</span><br><span class="line">innodb_page_cleaners                =<span class="number">4</span>                                 刷写数据页线程数量</span><br><span class="line">innodb_sort_buffer_size             =64M                               排序缓冲区</span><br><span class="line">innodb_print_all_deadlocks          =<span class="number">1</span>                   #             监控死锁信息 自动打印到日志</span><br><span class="line">innodb_rollback_on_timeout          =<span class="variable constant_">ON</span>                                事务超时是否自动回滚</span><br><span class="line">innodb_deadlock_detect              =<span class="variable constant_">ON</span></span><br></pre></td></tr></table></figure>

<h3 id="4-4-复制"><a href="#4-4-复制" class="headerlink" title="4.4 复制"></a>4.4 复制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">relay_log                       =<span class="regexp">/opt/</span>log/mysql/blog/relay</span><br><span class="line">relay_log_index                 =<span class="regexp">/opt/</span>log/mysql/blog/relay.<span class="property">index</span></span><br><span class="line">max_relay_log_size              =500M</span><br><span class="line">relay_log_recovery              =<span class="variable constant_">ON</span></span><br><span class="line"></span><br><span class="line">rpl_semi_sync_master_enabled                =<span class="variable constant_">ON</span></span><br><span class="line">rpl_semi_sync_master_timeout                =<span class="number">1000</span></span><br><span class="line">rpl_semi_sync_master_trace_level            =<span class="number">32</span></span><br><span class="line">rpl_semi_sync_master_wait_for_slave_count   =<span class="number">1</span></span><br><span class="line">rpl_semi_sync_master_wait_no_slave          =<span class="variable constant_">ON</span></span><br><span class="line">rpl_semi_sync_master_wait_point             =<span class="variable constant_">AFTER_SYNC</span></span><br><span class="line">rpl_semi_sync_slave_enabled                 =<span class="variable constant_">ON</span></span><br><span class="line">rpl_semi_sync_slave_trace_level             =<span class="number">32</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binlog_group_commit_sync_delay              =<span class="number">1</span></span><br><span class="line">binlog_group_commit_sync_no_delay_count     =<span class="number">1000</span></span><br><span class="line"></span><br><span class="line">gtid_mode                       =<span class="variable constant_">ON</span></span><br><span class="line">enforce_gtid_consistency        =<span class="variable constant_">ON</span></span><br><span class="line"></span><br><span class="line">skip-slave-start                =<span class="number">1</span></span><br><span class="line">#read_only                      =<span class="variable constant_">ON</span></span><br><span class="line">#super_read_only                =<span class="variable constant_">ON</span></span><br><span class="line">log_slave_updates               =<span class="variable constant_">ON</span></span><br><span class="line">server_id                       =<span class="number">2330602</span></span><br><span class="line">report_host                     =xxxx</span><br><span class="line">report_port                     =<span class="number">3306</span></span><br><span class="line">slave_parallel_type                         =<span class="variable constant_">LOGICAL_CLOCK</span></span><br><span class="line">slave_parallel_workers                      =<span class="number">4</span></span><br><span class="line">master_info_repository                      =<span class="variable constant_">TABLE</span></span><br><span class="line">relay_log_info_repository                   =<span class="variable constant_">TABLE</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-其它"><a href="#4-5-其它" class="headerlink" title="4.5 其它"></a>4.5 其它</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">客户端配置： </span><br><span class="line">[mysql]</span><br><span class="line">no-auto-rehash</span><br></pre></td></tr></table></figure>



<h2 id="5-开发规范"><a href="#5-开发规范" class="headerlink" title="5.开发规范"></a>5.开发规范</h2><h3 id="5-1-字段规范"><a href="#5-1-字段规范" class="headerlink" title="5.1 字段规范"></a>5.1 字段规范</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. 每个表建议在30个字段以内(了解三大范式)。</span><br><span class="line">2. 需要存储emoji字符的，则选择utf8mb4字符集。</span><br><span class="line">3. 机密数据，加密后存储。</span><br><span class="line">4. 整型数据，默认加上UNSIGNED。</span><br><span class="line">5. 存储IPV4地址建议用bigINT UNSIGNE，查询时再利用INET_ATON()、INET_NTOA()函数转换。</span><br><span class="line">6. 如果遇到BLOB、TEXT大字段单独存储表或者附件形式存储。</span><br><span class="line">7. 选择尽可能小的数据类型，用于节省磁盘和内存空间。</span><br><span class="line">8. 存储浮点数，可以放大倍数存储。</span><br><span class="line">9. 每个表必须有主键，INT/BIGINT并且自增做为主键，分布式架构使用sequence序列生成器保存。</span><br><span class="line">10. 每个列使用not null，或增加默认值。</span><br></pre></td></tr></table></figure>



<h3 id="5-2-SQL语句规范"><a href="#5-2-SQL语句规范" class="headerlink" title="5.2 SQL语句规范"></a>5.2 SQL语句规范</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">### <span class="number">1.</span> 去掉不必要的括号</span><br><span class="line">如：      ((a <span class="variable constant_">AND</span> b) <span class="variable constant_">AND</span> c <span class="variable constant_">OR</span> (((a <span class="variable constant_">AND</span> b) <span class="variable constant_">AND</span> (c <span class="variable constant_">AND</span> d)))) </span><br><span class="line">修改成    (a <span class="variable constant_">AND</span> b <span class="variable constant_">AND</span> c) <span class="variable constant_">OR</span> (a <span class="variable constant_">AND</span> b <span class="variable constant_">AND</span> c <span class="variable constant_">AND</span> d)</span><br><span class="line">### <span class="number">2.</span>  去掉重叠条件</span><br><span class="line">如：      (a&lt;b <span class="variable constant_">AND</span> b=c) <span class="variable constant_">AND</span> a=<span class="number">5</span></span><br><span class="line">修改成    b&gt;<span class="number">5</span> <span class="variable constant_">AND</span> b=c <span class="variable constant_">AND</span> a=<span class="number">5</span></span><br><span class="line">如：      (B&gt;=<span class="number">5</span> <span class="variable constant_">AND</span> B=<span class="number">5</span>) <span class="variable constant_">OR</span> (B=<span class="number">6</span> <span class="variable constant_">AND</span> <span class="number">5</span>=<span class="number">5</span>) <span class="variable constant_">OR</span> (B=<span class="number">7</span> <span class="variable constant_">AND</span> <span class="number">5</span>=<span class="number">6</span>)</span><br><span class="line">修改成    B=<span class="number">5</span> <span class="variable constant_">OR</span> B=<span class="number">6</span></span><br><span class="line"></span><br><span class="line">### <span class="number">3.</span> 避免使用not <span class="keyword">in</span>、not exists 、&lt;&gt;、like %%</span><br><span class="line">### <span class="number">4.</span> 多表连接，小表驱动大表</span><br><span class="line">### <span class="number">5.</span> 减少临时表应用，优化order by 、group by、union、distinct、join等</span><br><span class="line">### <span class="number">6.</span> 减少语句查询范围，精确查询条件</span><br><span class="line">### <span class="number">7.</span> 多条件，符合联合索引最左原则</span><br><span class="line">### <span class="number">8.</span> 查询条件减少使用函数、拼接字符等条件、条件隐式转换</span><br><span class="line">### <span class="number">9.</span> union all 替代 union</span><br><span class="line">### <span class="number">10.</span>减少having子句使用</span><br><span class="line">### <span class="number">11.</span>如非必须不使用 <span class="keyword">for</span> update语句 </span><br><span class="line">### <span class="number">12.</span>update和<span class="keyword">delete</span>，开启安全更新参数</span><br><span class="line">### <span class="number">13.</span>减少inset  ... select语句应用</span><br><span class="line">### <span class="number">14.</span>使用load 替代insert录入大数据</span><br><span class="line">### <span class="number">15.</span>导入大量数据时，可以禁用索引、增大缓冲区、增大redo文件和buffer、关闭autocommit、<span class="variable constant_">RC</span>级别可以提高效率 </span><br><span class="line">### <span class="number">16.</span>优化limit，最好业务逻辑中先获取主键<span class="variable constant_">ID</span>，再基于<span class="variable constant_">ID</span>进行查询 </span><br><span class="line">	limit <span class="number">5000000</span>,<span class="number">10</span>     limit <span class="number">10</span> , <span class="number">200</span></span><br><span class="line">### <span class="number">17.</span> <span class="variable constant_">DDL</span>执行前要审核</span><br><span class="line">### <span class="number">18.</span> 多表连接语句执行前要看执行计划</span><br></pre></td></tr></table></figure>



<h2 id="6-索引优化"><a href="#6-索引优化" class="headerlink" title="6. 索引优化"></a>6. 索引优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">1. 非唯一索引按照“i_字段名称_字段名称[_字段名]”进行命名。</span><br><span class="line">2. 唯一索引按照“u_字段名称_字段名称[_字段名]”进行命名。</span><br><span class="line">3. 索引名称使用小写。</span><br><span class="line">4. 索引中的字段数不超过5个。</span><br><span class="line">5. 唯一键由3个以下字段组成，并且字段都是整形时，使用唯一键作为主键。</span><br><span class="line">6. 没有唯一键或者唯一键不符合5中的条件时，使用自增<span class="built_in">id</span>作为主键。</span><br><span class="line">7. 唯一键不和主键重复。</span><br><span class="line">8. 索引选择度高的列作为联合索引最左条件</span><br><span class="line">9. ORDER BY，GROUP BY，DISTINCT的字段需要添加在索引的后面。</span><br><span class="line">10. 单张表的索引数量控制在5个以内，若单张表多个字段在查询需求上都要单独用到索引，需要经过DBA评估。</span><br><span class="line">    查询性能问题无法解决的，应从产品设计上进行重构。</span><br><span class="line">	</span><br><span class="line">11. 使用EXPLAIN判断SQL语句是否合理使用索引，尽量避免extra列出现：Using File Sort，Using Temporary。</span><br><span class="line"></span><br><span class="line">12. UPDATE、DELETE语句需要根据WHERE条件添加索引。</span><br><span class="line"></span><br><span class="line">13. 对长度大于50的VARCHAR字段建立索引时，按需求恰当的使用前缀索引，或使用其他方法。</span><br><span class="line"></span><br><span class="line">14. 下面的表增加一列url_crc32，然后对url_crc32建立索引，减少索引字段的长度，提高效率。</span><br><span class="line"></span><br><span class="line">CREATE TABLE all_url(ID INT UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">url VARCHAR(255) NOT NULL DEFAULT 0,      </span><br><span class="line">url_crc32 INT UNSIGNED NOT NULL DEFAULT 0,</span><br><span class="line">index idx_url(url_crc32));</span><br><span class="line"></span><br><span class="line">15. 合理创建联合索引（避免冗余），(a,b,c) 相当于 (a) 、(a,b) 、(a,b,c)。</span><br><span class="line"></span><br><span class="line">16. 合理利用覆盖索引，减少回表。</span><br><span class="line"></span><br><span class="line">17. 减少冗余索引和使用率较低的索引</span><br><span class="line">mysql&gt; select * from sys.schema_unused_indexes;</span><br><span class="line">mysql&gt; select * from sys.schema_redundant_indexes\G</span><br></pre></td></tr></table></figure>



<h2 id="7-锁优化✨✨✨"><a href="#7-锁优化✨✨✨" class="headerlink" title="7.锁优化✨✨✨"></a>7.锁优化✨✨✨</h2><h3 id="7-1-全局锁-Global-Read-lock"><a href="#7-1-全局锁-Global-Read-lock" class="headerlink" title="7.1 全局锁 Global Read lock"></a>7.1 全局锁 Global Read lock</h3><h4 id="a-介绍"><a href="#a-介绍" class="headerlink" title="a. 介绍"></a>a. 介绍</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">全局读锁。</span><br><span class="line">加锁方法： <span class="variable constant_">FTWRL</span>，flush tables <span class="keyword">with</span> read lock.</span><br><span class="line">解锁方法： unlock tables;</span><br><span class="line"></span><br><span class="line">出现场景： </span><br><span class="line">	mysqldump  --master-data  </span><br><span class="line">	xtrabackup（<span class="number">8.0</span>之前早期版本）等备份时。</span><br><span class="line">属于类型： <span class="variable constant_">MDL</span>（matedatalock）层面锁</span><br><span class="line">影响情况： 加锁期间，阻塞所有事务写入，阻塞所有已有事务commit。</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">MDL</span>，等待时间受 lock_wait_timeout=<span class="number">31536000</span></span><br></pre></td></tr></table></figure>



<h4 id="b-检测方法🕵️‍♂️"><a href="#b-检测方法🕵️‍♂️" class="headerlink" title="b. 检测方法🕵️‍♂️"></a>b. 检测方法🕵️‍♂️</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">## <span class="number">8.0</span>之前需要手工配置开启.</span><br><span class="line"><span class="keyword">UPDATE</span> performance_schema.setup_instruments</span><br><span class="line"><span class="keyword">SET</span> ENABLED <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span>, TIMED <span class="operator">=</span> <span class="string">&#x27;YES&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;wait/lock/metadata/sql/mdl&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.metadata_locks\G</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> OBJECT_SCHEMA ,OBJECT_NAME ,LOCK_TYPE,LOCK_DURATION,LOCK_STATUS ,OWNER_THREAD_ID,OWNER_EVENT_ID <span class="keyword">from</span> performance_schema.metadata_locks;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.schema_table_lock_waits;</span><br><span class="line"></span><br><span class="line">场景:  业务反馈所有写入做不了.</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.metadata_locks\G</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.schema_table_lock_waits;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">沟通后决定怎么处理?</span><br><span class="line">kill ?</span><br></pre></td></tr></table></figure>



<h4 id="经典故障案例1：5-7-xtrabackup-x2F-mysqldump备份时数据库出现hang状态，所有修改查询都不能进行"><a href="#经典故障案例1：5-7-xtrabackup-x2F-mysqldump备份时数据库出现hang状态，所有修改查询都不能进行" class="headerlink" title="经典故障案例1：5.7 xtrabackup&#x2F;mysqldump备份时数据库出现hang状态，所有修改查询都不能进行"></a>经典故障案例1：5.7 xtrabackup&#x2F;mysqldump备份时数据库出现hang状态，所有修改查询都不能进行</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">session1: 模拟一个大的查询或事务</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,sleep(<span class="number">100</span>)  <span class="keyword">from</span> city <span class="keyword">where</span> id<span class="operator">&lt;</span><span class="number">100</span>  <span class="keyword">for</span> <span class="keyword">update</span> ;</span><br><span class="line"></span><br><span class="line">session2: 模拟备份时的FTWRL </span><br><span class="line">mysql<span class="operator">&gt;</span> flush tables <span class="keyword">with</span> read lock;</span><br><span class="line"><span class="comment">-- 此时发现命令被阻塞</span></span><br><span class="line"></span><br><span class="line">session3: 发起查询，发现被阻塞</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> world.city <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line"></span><br><span class="line">结论： 备份时，一定要选择业务不繁忙期间，否则有可能会阻塞正常业务。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p> </p>
<h4 id="故障案例2：-5-7版本-innobackupex备份全库，进程死了，mysql里就是全库读锁，后边insert-全阻塞了"><a href="#故障案例2：-5-7版本-innobackupex备份全库，进程死了，mysql里就是全库读锁，后边insert-全阻塞了" class="headerlink" title="故障案例2： 5.7版本  innobackupex备份全库，进程死了，mysql里就是全库读锁，后边insert 全阻塞了"></a>故障案例2： 5.7版本  innobackupex备份全库，进程死了，mysql里就是全库读锁，后边insert 全阻塞了</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#分析思路： </span><br><span class="line">show processlist  ----&gt;  select * <span class="keyword">from</span> performance_schema.<span class="property">metadata_locks</span>;  ---&gt; pending ----&gt;granted ----&gt; <span class="attr">OWNER_THREAD_ID</span>: <span class="number">66</span></span><br><span class="line">----&gt;  select * <span class="keyword">from</span> threads  \G -----&gt;processlist_Id----&gt;  show processlist -----&gt;  kill processlist_Id</span><br><span class="line">分析过程:</span><br><span class="line">pending 	 <span class="number">56</span>   <span class="number">54</span>  <span class="number">57</span></span><br><span class="line">events_statements_history</span><br><span class="line"><span class="number">56</span>: 	</span><br><span class="line"><span class="attr">SQL_TEXT</span>: select * <span class="keyword">from</span> city where id=<span class="number">500</span> <span class="keyword">for</span> update</span><br><span class="line"><span class="number">54</span>:</span><br><span class="line"><span class="attr">SQL_TEXT</span>: flush tables <span class="keyword">with</span> read lock</span><br><span class="line"><span class="number">57</span>:</span><br><span class="line"><span class="attr">SQL_TEXT</span>: select * <span class="keyword">from</span> user where id=<span class="number">1</span> <span class="keyword">for</span> update</span><br><span class="line">granted      <span class="number">55</span> 	</span><br><span class="line"><span class="attr">SQL_TEXT</span>: select id,<span class="title function_">sleep</span>(<span class="number">100</span>)  <span class="keyword">from</span> city where id&lt;<span class="number">100</span>  <span class="keyword">for</span> update</span><br><span class="line"><span class="number">55</span>  ---&gt; <span class="number">54</span> ----&gt; <span class="number">56</span> ,<span class="number">57</span></span><br><span class="line"><span class="number">55</span>?  ----&gt;</span><br><span class="line"></span><br><span class="line">#故障模拟： </span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="7-2-row-lock-wait-锁等待"><a href="#7-2-row-lock-wait-锁等待" class="headerlink" title="7.2 row lock wait 锁等待"></a>7.2 row lock wait 锁等待</h3><h4 id="a-介绍-1"><a href="#a-介绍-1" class="headerlink" title="a.介绍"></a>a.介绍</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">record lock 、gap、next lock</span><br><span class="line">都是基于索引加锁,与事务隔离级别有关。</span><br></pre></td></tr></table></figure>



<h4 id="b-行锁监控及分析🕵️‍♂️"><a href="#b-行锁监控及分析🕵️‍♂️" class="headerlink" title="b. 行锁监控及分析🕵️‍♂️"></a>b. 行锁监控及分析🕵️‍♂️</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 查询锁等待详细信息</span><br><span class="line">select * <span class="keyword">from</span> sys.<span class="property">innodb_lock_waits</span>;   ----&gt; <span class="title function_">blocking_pid</span>(锁源的连接线程)</span><br><span class="line"></span><br><span class="line"># 通过连接线程找<span class="variable constant_">SQL</span>线程</span><br><span class="line">select * <span class="keyword">from</span> performance_schema.<span class="property">threads</span>;</span><br><span class="line"></span><br><span class="line"># 通过<span class="variable constant_">SQL</span>线程找到 <span class="variable constant_">SQL</span>语句</span><br><span class="line">select * <span class="keyword">from</span> performance_schema.<span class="property">events_statements_history</span>;</span><br></pre></td></tr></table></figure>



<h4 id="c-优化方向"><a href="#c-优化方向" class="headerlink" title="c. 优化方向"></a>c. 优化方向</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 优化索引</span><br><span class="line"><span class="number">2.</span> 减少事务的更新范围</span><br><span class="line"><span class="number">3.</span> <span class="variable constant_">RC</span></span><br><span class="line"><span class="number">4.</span> 拆分语句： </span><br><span class="line">例如：  update t1 set num=num+<span class="number">10</span> where k1 &lt;<span class="number">100</span>;  k1 是辅助索引,record lock gap next</span><br><span class="line">	   改为:</span><br><span class="line">	   select id <span class="keyword">from</span> t1 where  k1 &lt;<span class="number">100</span>; ---&gt; <span class="attr">id</span>: <span class="number">20</span>,<span class="number">30</span>,<span class="number">50</span></span><br><span class="line">	   update t1 set num=num+<span class="number">10</span>   where id <span class="keyword">in</span> (<span class="number">20</span>,<span class="number">30</span>,<span class="number">50</span>);</span><br></pre></td></tr></table></figure>



<h4 id="故障案例3-16C-top-CPU使用总量-1200-1300-平均-80-MySQL数据库服务器"><a href="#故障案例3-16C-top-CPU使用总量-1200-1300-平均-80-MySQL数据库服务器" class="headerlink" title="故障案例3 :  16C    top  CPU使用总量 1200%-1300, 平均 80%+   MySQL数据库服务器"></a>故障案例3 :  16C    top  CPU使用总量 1200%-1300, 平均 80%+   MySQL数据库服务器</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#分析思路： </span><br><span class="line">top -<span class="title class_">Hp</span>  <span class="variable constant_">MYSQLID</span>   ---&gt; os_id   ----&gt; <span class="variable constant_">P_S</span>.<span class="property">threads</span> ---&gt; processlist_id ,  thread_id</span><br><span class="line"><span class="variable constant_">IO</span>  ---&gt; top  wait</span><br><span class="line">可能是什么原因?</span><br><span class="line"><span class="variable constant_">IOPS</span>? 回表太多?---&gt; 索引</span><br><span class="line">吞吐? 索引?</span><br><span class="line">硬件? raid <span class="variable constant_">IO</span>调度  .....</span><br><span class="line">大事务.</span><br><span class="line">参数.</span><br><span class="line"><span class="variable constant_">SQL</span> :</span><br><span class="line">events_statements_history/current</span><br><span class="line">类型:</span><br><span class="line">select  ----&gt; explain  ---&gt;索引     <span class="variable constant_">SQL</span>本身 --&gt; kill</span><br><span class="line"><span class="variable constant_">DML</span>     ----&gt; 锁  大事务 ---&gt; 索引  <span class="variable constant_">SQL</span>本身 ---&gt; 评估</span><br><span class="line"><span class="variable constant_">DDL</span>     ----&gt;  <span class="variable constant_">MDL</span>     ----&gt; kill</span><br><span class="line"></span><br><span class="line">#故障模拟：</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="8-架构优化"><a href="#8-架构优化" class="headerlink" title="8.架构优化"></a>8.架构优化</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#高可用架构：</span><br><span class="line">	<span class="variable constant_">MHA</span>+<span class="title class_">ProxySQL</span>+<span class="variable constant_">GTID</span>+增强半同步   <span class="number">99.99</span>%   高可用+ 读写分离--&gt; 中小型企业</span><br><span class="line">	<span class="variable constant_">MGR</span>\<span class="title class_">InnoDB</span> <span class="title class_">Cluster</span>            </span><br><span class="line">	<span class="variable constant_">PXC</span> </span><br><span class="line">#读写分离： </span><br><span class="line">	<span class="title class_">ProxySQL</span>、<span class="title class_">MySQL</span>-router</span><br><span class="line">#分布式架构： </span><br><span class="line">	<span class="title class_">MYcat</span>  <span class="title class_">Polardb</span> <span class="variable constant_">TDSQL</span>   </span><br><span class="line"></span><br><span class="line">#<span class="title class_">NoSQL</span>: </span><br><span class="line">	<span class="title class_">Redis</span>+<span class="title function_">sentinel</span>(哨兵),<span class="title class_">Redis</span> <span class="title class_">Cluster</span></span><br><span class="line">	<span class="title class_">MongoDB</span> <span class="variable constant_">RS</span>/<span class="title class_">MongoDB</span> <span class="variable constant_">SHARDING</span> <span class="title class_">Cluster</span> </span><br><span class="line">	<span class="variable constant_">ES</span>  solr</span><br></pre></td></tr></table></figure>



<h2 id="9-安全优化"><a href="#9-安全优化" class="headerlink" title="9.安全优化"></a>9.安全优化</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、 使用普通nologin用户管理<span class="title class_">MySQL</span></span><br><span class="line"><span class="number">2</span>、 合理授权用户、密码复杂度及最小权限、系统表保证只有管理员用户可访问。</span><br><span class="line"><span class="number">3</span>、 删除数据库匿名用户</span><br><span class="line"><span class="number">4</span>、 锁定非活动用户</span><br><span class="line"><span class="number">5</span>、 <span class="title class_">MySQL</span>尽量不暴露互联网,需要暴露互联网用户需要设置明确白名单、替换<span class="title class_">MySQL</span>默认端口号、使用ssl连接</span><br><span class="line"><span class="number">6</span>、 优化业务代码，防止<span class="variable constant_">SQL</span>注入。</span><br></pre></td></tr></table></figure>



<h2 id="10-常用工具介绍"><a href="#10-常用工具介绍" class="headerlink" title="10.常用工具介绍"></a>10.常用工具介绍</h2><h3 id="一、-PT（percona-toolkits）工具的应用"><a href="#一、-PT（percona-toolkits）工具的应用" class="headerlink" title="一、 PT（percona-toolkits）工具的应用"></a>一、 PT（percona-toolkits）工具的应用</h3><p><em>1. pt工具安装</em></p>
<p>[root@master ~]# <code>&lt;font style=&quot;color:#F5222D;&quot;&gt;yum install -y  percona-toolkit-3.1.0-2.el7.x86_64.rpm&lt;/font&gt;</code><font style="color:#F5222D;"> </font></p>
<p><em>2. 常用工具使用介绍</em></p>
<p><img src="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1609981686723-1be82e57-b85f-4699-bb26-532048d8c476.png"></p>
<h4 id="2-1-pt-archiver-归档表"><a href="#2-1-pt-archiver-归档表" class="headerlink" title="2.1 pt-archiver 归档表"></a><font style="color:#F5222D;">2.1 pt-archiver 归档表</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">场景： </span><br><span class="line">	面试题： 亿级的大表，<span class="keyword">delete</span>批量删除100w左右数据。 #批量删除功能</span><br><span class="line">	面试题： 定期按照时间范围，进行归档表。           #归档功能---并发归档</span><br><span class="line"></span><br><span class="line">#重要参数</span><br><span class="line">--limit <span class="number">100</span>         每次取<span class="number">100</span>行数据用pt-archive处理    </span><br><span class="line">--txn-size  <span class="number">100</span>     设置<span class="number">100</span>行为一个事务提交一次，    </span><br><span class="line">--where <span class="string">&#x27;id&lt;3000&#x27;</span>   设置操作条件    </span><br><span class="line">--progress <span class="number">5000</span>     每处理<span class="number">5000</span>行输出一次处理信息    </span><br><span class="line">--statistics        输出执行过程及最后的操作统计。（只要不加上--quiet，默认情况下pt- archive都会输出执行过程的）    </span><br><span class="line">--charset=<span class="title class_">UTF8</span>      指定字符集为<span class="title class_">UTF8</span>—这个最后加上不然可能出现乱码。    </span><br><span class="line">--bulk-<span class="keyword">delete</span>       批量删除source上的旧数据(例如每次<span class="number">1000</span>行的批量删除操作)</span><br><span class="line"></span><br><span class="line">注意:  需要归档表中至少有一个索引,做好是where条件列有索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用案例：</span><br><span class="line"><span class="number">1.</span>归档到数据库      ---远程归档居多</span><br><span class="line">#<span class="number">1.1</span> 获得建表语句</span><br><span class="line"></span><br><span class="line">#<span class="number">1.2</span> 备份</span><br><span class="line">db01 [test]&gt; create table test1 like t100w;</span><br><span class="line">pt-archiver --source h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,D=test,t=t100w,u=oldguo,p=<span class="number">123</span> --dest h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,D=test,t=test1,u=oldguo,p=<span class="number">123</span> --where <span class="string">&#x27;id&lt;10000&#x27;</span> --no-check-charset --no-<span class="keyword">delete</span> --limit=<span class="number">1000</span> --commit-each --progress <span class="number">1000</span> --statistics</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>只清理数据</span><br><span class="line">pt-archiver --source h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,D=test,t=t100w,u=oldguo,p=<span class="number">123</span> --where <span class="string">&#x27;id&lt;10000&#x27;</span> --purge --limit=<span class="number">1</span> --no-check-charset</span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>只把数据导出到外部文件，但是不删除源表里的数据</span><br><span class="line">pt-archiver --source h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,D=world,t=city,u=root,p=<span class="number">123</span> --where <span class="string">&#x27;1=1&#x27;</span> --no-check-charset --no-<span class="keyword">delete</span> --file=<span class="string">&quot;/tmp/archiver.dat&quot;</span> </span><br></pre></td></tr></table></figure>

<p><strong><font style="color:#F5222D;"></font></strong></p>
<h4 id="2-2-pt-osc-修改表结构"><a href="#2-2-pt-osc-修改表结构" class="headerlink" title="2.2 pt-osc 修改表结构"></a><font style="color:#F5222D;">2.2 pt-osc 修改表结构</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#场景：  </span><br><span class="line">	  修改表结构、索引创建删除</span><br><span class="line">	  不能加快速度，但能减少业务影响（锁）。</span><br><span class="line">	  </span><br><span class="line">#面试题 ： 	  	  </span><br><span class="line">pt-osc工作流程：</span><br><span class="line"><span class="number">1</span>、检查更改表是否有主键或唯一索引，是否有触发器</span><br><span class="line"><span class="number">2</span>、检查修改表的表结构，创建一个临时表，在新表上执行<span class="variable constant_">ALTER</span> <span class="variable constant_">TABLE</span>语句</span><br><span class="line">create table  bak like t1; </span><br><span class="line">alter table bak add telnum <span class="title function_">char</span>(<span class="number">11</span>) not <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、在源表上创建三个触发器分别对于<span class="variable constant_">INSERT</span> <span class="variable constant_">UPDATE</span> <span class="variable constant_">DELETE</span>操作</span><br><span class="line">create trigger </span><br><span class="line">a </span><br><span class="line">b </span><br><span class="line">c</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、从源表拷贝数据到临时表，在拷贝过程中，对源表的更新操作会写入到新建表中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、将临时表和源表rename（需要元数据修改锁，需要短时间锁表）</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、删除源表和触发器，完成表结构的修改。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pt-osc工具限制</span><br><span class="line"><span class="number">1</span>、源表必须有主键或唯一索引，如果没有工具将停止工作</span><br><span class="line"><span class="number">2</span>、如果线上的复制环境过滤器操作过于复杂，工具将无法工作</span><br><span class="line"><span class="number">3</span>、如果开启复制延迟检查，但主从延迟时，工具将暂停数据拷贝工作</span><br><span class="line"><span class="number">4</span>、如果开启主服务器负载检查，但主服务器负载较高时，工具将暂停操作</span><br><span class="line"><span class="number">5</span>、当表使用外键时，如果未使用--alter-foreign-keys-method参数，工具将无法执行</span><br><span class="line"><span class="number">6</span>、只支持<span class="title class_">Innodb</span>存储引擎表，且要求服务器上有该表<span class="number">1</span>倍以上的空闲空间。</span><br><span class="line"></span><br><span class="line">#pt-osc之alter语句限制</span><br><span class="line"><span class="number">1</span>、不需要包含alter table关键字，可以包含多个修改操作，使用逗号分开，如<span class="string">&quot;drop clolumn c1, add column c2 int&quot;</span></span><br><span class="line"><span class="number">2</span>、不支持rename语句来对表进行重命名操作</span><br><span class="line"><span class="number">3</span>、不支持对索引进行重命名操作</span><br><span class="line"><span class="number">4</span>、如果删除外键，需要对外键名加下划线，如删除外键fk_uid, 修改语句为<span class="string">&quot;DROP FOREIGN KEY _fk_uid&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pt-osc之命令模板</span><br><span class="line">## --execute表示执行</span><br><span class="line">## --dry-run表示只进行模拟测试</span><br><span class="line">## 表名只能使用参数t来设置，没有长参数</span><br><span class="line"></span><br><span class="line">pt-online-schema-change \</span><br><span class="line">--host=<span class="string">&quot;127.0.0.1&quot;</span> \</span><br><span class="line">--port=<span class="number">3358</span> \</span><br><span class="line">--user=<span class="string">&quot;root&quot;</span> \</span><br><span class="line">--password=<span class="string">&quot;root@root&quot;</span> \</span><br><span class="line">--charset=<span class="string">&quot;utf8&quot;</span> \</span><br><span class="line">--max-lag=<span class="number">10</span> \</span><br><span class="line">--check-salve-lag=<span class="string">&#x27;xxx.xxx.xxx.xxx&#x27;</span> \</span><br><span class="line">--recursion-method=<span class="string">&quot;hosts&quot;</span> \</span><br><span class="line">--check-interval=<span class="number">2</span> \</span><br><span class="line">--database=<span class="string">&quot;testdb1&quot;</span> \</span><br><span class="line">  t=<span class="string">&quot;tb001&quot;</span> \</span><br><span class="line">--alter=<span class="string">&quot;add column c4 int&quot;</span> \</span><br><span class="line">--execute</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">pt-online-schema-change --user=oldguo --password=<span class="number">123</span> --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --alter <span class="string">&quot;add column state int not null default 1&quot;</span> D=test,t=t100w --print --execute</span><br><span class="line"></span><br><span class="line">pt-online-schema-change --user=oldguo --password=<span class="number">123</span> --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --alter <span class="string">&quot;add index idx(num)&quot;</span> D=test,t=t100w --print --execute</span><br></pre></td></tr></table></figure>

<p><strong><font style="color:#F5222D;"></font></strong></p>
<h4 id="2-3-pt-table-checksum-校验主从数据"><a href="#2-3-pt-table-checksum-校验主从数据" class="headerlink" title="2.3 pt-table-checksum 校验主从数据"></a><font style="color:#F5222D;">2.3 pt-table-checksum 校验主从数据</font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#场景：   校验主从数据一致性，生产中可用于定时任务。</span><br><span class="line"> 环境准备:</span><br><span class="line">	- 主从环境</span><br><span class="line">  - 从库开启配置</span><br><span class="line">    [mysqld]</span><br><span class="line">    report_host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.52</span></span><br><span class="line">		report_port=<span class="number">3307</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.3</span><span class="number">.1</span> 创建数据库</span><br><span class="line"><span class="title class_">Create</span> database pt <span class="variable constant_">CHARACTER</span> <span class="variable constant_">SET</span> utf8;</span><br><span class="line"></span><br><span class="line">创建用户checksum并授权</span><br><span class="line">create user  <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> identified <span class="keyword">with</span> mysql_native_password by <span class="string">&#x27;checksum&#x27;</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">ALL</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> ;</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="number">2.3</span><span class="number">.2</span> 参数: </span><br><span class="line">--[no]check-replication-filters：是否检查复制的过滤器，默认是yes，建议启用不检查模式。</span><br><span class="line">--databases | -d：指定需要被检查的数据库，多个库之间可以用逗号分隔。</span><br><span class="line">--[no]check-binlog-format：是否检查binlog文件的格式，默认值yes。建议开启不检查。因为在默认的row格式下会出错。</span><br><span class="line">--replicate：把checksum的信息写入到指定表中。</span><br><span class="line">--replicate-check-only：只显示不同步信息</span><br><span class="line"></span><br><span class="line">pt-table-checksum --nocheck-replication-filters --no-check-binlog-format --replicate=pt.<span class="property">checksums</span> --create-replicate-table --databases=test --tables=t1 h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,u=checksum,p=checksum,P=<span class="number">3307</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----&gt;  可将命令加入到定时任务脚本。检查异步复制，是否出现问题。</span><br><span class="line">cat checksum.<span class="property">sh</span></span><br><span class="line">#!<span class="regexp">/bin/</span>bash </span><br><span class="line">date &gt;&gt; <span class="regexp">/root/</span>db/checksum.<span class="property">log</span></span><br><span class="line">pt-table-checksum --nocheck-binlog-format --nocheck-plan --nocheck-replication-filters --replicate=pt.<span class="property">checksums</span> --set-vars innodb_lock_wait_timeout=<span class="number">120</span> --databases test --tables t1 -u<span class="string">&#x27;checksum&#x27;</span> -p<span class="string">&#x27;checksum&#x27;</span> -h<span class="string">&#x27;10.0.0.51&#x27;</span> &gt;&gt; <span class="regexp">/tmp/</span>checksum.<span class="property">log</span></span><br><span class="line">date &gt;&gt; <span class="regexp">/root/</span>db/checksum.<span class="property">log</span></span><br></pre></td></tr></table></figure>



<h4 id="2-4-pt-table-sync-修复主从数据"><a href="#2-4-pt-table-sync-修复主从数据" class="headerlink" title="2.4 pt-table-sync 修复主从数据"></a>2.4 pt-table-sync 修复主从数据</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.4</span> pt-table-sync</span><br><span class="line">主要参数介绍</span><br><span class="line">--replicate ：指定通过pt-table-checksum得到的表.</span><br><span class="line">--databases : 指定执行同步的数据库。</span><br><span class="line">--tables ：指定执行同步的表，多个用逗号隔开。</span><br><span class="line">--sync-to-master ：指定一个<span class="variable constant_">DSN</span>，即从的<span class="variable constant_">IP</span>，他会通过show processlist或show slave status 去自动的找主。</span><br><span class="line">h= ：服务器地址，命令里有<span class="number">2</span>个ip，第一次出现的是<span class="title class_">Master</span>的地址，第<span class="number">2</span>次是<span class="title class_">Slave</span>的地址。</span><br><span class="line">u= ：帐号。</span><br><span class="line">p= ：密码。</span><br><span class="line">--print ：打印，但不执行命令。</span><br><span class="line">--execute ：执行命令。</span><br><span class="line"></span><br><span class="line">pt-table-sync --replicate=pt.<span class="property">checksums</span> --databases test  --tables t1 h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,u=checksum,p=checksum,P=<span class="number">3307</span> h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,u=checksum,p=checksum,P=<span class="number">3306</span> --print</span><br><span class="line"></span><br><span class="line">pt-table-sync --replicate=pt.<span class="property">checksums</span> --databases test  --tables t1 h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,u=checksum,p=checksum,P=<span class="number">3307</span> h=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span>,u=checksum,p=checksum,P=<span class="number">3307</span> --execute</span><br></pre></td></tr></table></figure>

<p><strong><font style="color:#F5222D;"></font></strong></p>
<h4 id="2-5-pt-show-grants-备份数据库用户的方法-✨"><a href="#2-5-pt-show-grants-备份数据库用户的方法-✨" class="headerlink" title="2.5. # pt-show-grants (备份数据库用户的方法)✨ "></a><font style="color:#F5222D;">2.5. # pt-show-grants (备份数据库用户的方法)</font><font style="color:#F5222D;">✨</font><font style="color:#F5222D;"> </font></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#作用:  用户和权限信息迁移。</span><br><span class="line">pt-show-grants -h10<span class="number">.0</span><span class="number">.0</span><span class="number">.51</span>  -<span class="variable constant_">P3307</span>  -uchecksum -pchecksum </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-----------------&gt;  导出结果： </span><br><span class="line">-- <span class="title class_">Grants</span> dumped by pt-show-grants</span><br><span class="line">-- <span class="title class_">Dumped</span> <span class="keyword">from</span> server <span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> via <span class="variable constant_">TCP</span>/<span class="variable constant_">IP</span>, <span class="title class_">MySQL</span> <span class="number">5.7</span><span class="number">.28</span>-log at <span class="number">2020</span>-<span class="number">05</span>-<span class="number">15</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">06</span></span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*E5E390AF1BDF241B51D9C0DBBEA262CC9407A2DF&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">UNLOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">ALL</span> <span class="variable constant_">PRIVILEGES</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;checksum&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">LOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">SELECT</span> <span class="variable constant_">ON</span> <span class="string">`mysql`</span>.<span class="string">`user`</span> <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">SELECT</span> <span class="variable constant_">ON</span> <span class="string">`performance_schema`</span>.* <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">SUPER</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.session&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">LOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">SELECT</span> <span class="variable constant_">ON</span> <span class="string">`sys`</span>.<span class="string">`sys_config`</span> <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">TRIGGER</span> <span class="variable constant_">ON</span> <span class="string">`sys`</span>.* <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">USAGE</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;mysql.sys&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*23AE809DDACAF96AF0FD78ED04B6A265E05AA257&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">UNLOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">REPLICATION</span> <span class="variable constant_">SLAVE</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;repl&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*23AE809DDACAF96AF0FD78ED04B6A265E05AA257&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">UNLOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">ALL</span> <span class="variable constant_">PRIVILEGES</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="line">-- <span class="title class_">Grants</span> <span class="keyword">for</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span></span><br><span class="line"><span class="variable constant_">CREATE</span> <span class="variable constant_">USER</span> <span class="variable constant_">IF</span> <span class="variable constant_">NOT</span> <span class="variable constant_">EXISTS</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="variable constant_">ALTER</span> <span class="variable constant_">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="variable constant_">IDENTIFIED</span> <span class="variable constant_">WITH</span> <span class="string">&#x27;mysql_native_password&#x27;</span> <span class="variable constant_">AS</span> <span class="string">&#x27;*23AE809DDACAF96AF0FD78ED04B6A265E05AA257&#x27;</span> <span class="variable constant_">REQUIRE</span> <span class="variable constant_">NONE</span> <span class="variable constant_">PASSWORD</span> <span class="variable constant_">EXPIRE</span> <span class="variable constant_">DEFAULT</span> <span class="variable constant_">ACCOUNT</span> <span class="variable constant_">UNLOCK</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">ALL</span> <span class="variable constant_">PRIVILEGES</span> <span class="variable constant_">ON</span> *.* <span class="variable constant_">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="variable constant_">WITH</span> <span class="variable constant_">GRANT</span> <span class="variable constant_">OPTION</span>;</span><br><span class="line"><span class="variable constant_">GRANT</span> <span class="variable constant_">PROXY</span> <span class="variable constant_">ON</span> <span class="string">&#x27;&#x27;</span>@<span class="string">&#x27;&#x27;</span> <span class="variable constant_">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> <span class="variable constant_">WITH</span> <span class="variable constant_">GRANT</span> <span class="variable constant_">OPTION</span>;</span><br></pre></td></tr></table></figure>



<h4 id="2-5-pt-slave-find-显示主从结构-可了解下ORCH"><a href="#2-5-pt-slave-find-显示主从结构-可了解下ORCH" class="headerlink" title="2.5  pt-slave-find  显示主从结构 (可了解下ORCH)"></a>2.5  pt-slave-find  显示主从结构 (可了解下ORCH)</h4><p>[root@db01 tmp]#   <code>pt-slave-find -h10.0.0.51  -P3307 -uchecksum -pchecksum</code> </p>
<h4 id="2-6-监控主从延时"><a href="#2-6-监控主从延时" class="headerlink" title="2.6  监控主从延时"></a>2.6  监控主从延时</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">2.6</span>监控主从延时自带判定方法:</span><br><span class="line">show slave status \G</span><br><span class="line">second _behind_master===&gt; 从库sQr回放的<span class="title class_">Ts</span>-主从执行是的<span class="title class_">Ts</span>-主从的时间差异(主从系统时间延时会自动补偿)</span><br><span class="line">exec_master_log_pos ---&gt; 异步复制较准确/ 但<span class="variable constant_">SQL</span>多线程回放 如: loigcal_colck</span><br></pre></td></tr></table></figure>




    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
              <a href="/tags/%E4%BC%98%E5%8C%96/" rel="tag"><i class="fa fa-tag"></i> 优化</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/07/15/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/" rel="prev" title="存储引擎">
      <i class="fa fa-chevron-left"></i> 存储引擎
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/15/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%20%E4%B8%8B/" rel="next" title="分布式架构下">
      分布式架构下 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF"><span class="nav-number">1.</span> <span class="nav-text">0. 优化思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%A1%AC%E4%BB%B6%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">1.硬件层面优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%B3%BB%E7%BB%9F%E5%B1%82%E9%9D%A2%E4%BC%98%E5%8C%96"><span class="nav-number">3.</span> <span class="nav-text">2.系统层面优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="nav-number">4.</span> <span class="nav-text">3. 数据库版本选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%F0%9F%92%96%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%89%E5%B1%82%E7%BB%93%E6%9E%84%E5%8F%8A%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">4.💖数据库三层结构及核心参数优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E8%BF%9E%E6%8E%A5%E5%B1%82"><span class="nav-number">5.1.</span> <span class="nav-text">4.1 连接层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Server%E5%B1%82"><span class="nav-number">5.2.</span> <span class="nav-text">4.2 Server层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%B1%82"><span class="nav-number">5.3.</span> <span class="nav-text">4.3 存储引擎层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E5%A4%8D%E5%88%B6"><span class="nav-number">5.4.</span> <span class="nav-text">4.4 复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-%E5%85%B6%E5%AE%83"><span class="nav-number">5.5.</span> <span class="nav-text">4.5 其它</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%BC%80%E5%8F%91%E8%A7%84%E8%8C%83"><span class="nav-number">6.</span> <span class="nav-text">5.开发规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%AD%97%E6%AE%B5%E8%A7%84%E8%8C%83"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 字段规范</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-SQL%E8%AF%AD%E5%8F%A5%E8%A7%84%E8%8C%83"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 SQL语句规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">6. 索引优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E9%94%81%E4%BC%98%E5%8C%96%E2%9C%A8%E2%9C%A8%E2%9C%A8"><span class="nav-number">8.</span> <span class="nav-text">7.锁优化✨✨✨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%85%A8%E5%B1%80%E9%94%81-Global-Read-lock"><span class="nav-number">8.1.</span> <span class="nav-text">7.1 全局锁 Global Read lock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E4%BB%8B%E7%BB%8D"><span class="nav-number">8.1.1.</span> <span class="nav-text">a. 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95%F0%9F%95%B5%EF%B8%8F%E2%80%8D%E2%99%82%EF%B8%8F"><span class="nav-number">8.1.2.</span> <span class="nav-text">b. 检测方法🕵️‍♂️</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%8F%E5%85%B8%E6%95%85%E9%9A%9C%E6%A1%88%E4%BE%8B1%EF%BC%9A5-7-xtrabackup-x2F-mysqldump%E5%A4%87%E4%BB%BD%E6%97%B6%E6%95%B0%E6%8D%AE%E5%BA%93%E5%87%BA%E7%8E%B0hang%E7%8A%B6%E6%80%81%EF%BC%8C%E6%89%80%E6%9C%89%E4%BF%AE%E6%94%B9%E6%9F%A5%E8%AF%A2%E9%83%BD%E4%B8%8D%E8%83%BD%E8%BF%9B%E8%A1%8C"><span class="nav-number">8.1.3.</span> <span class="nav-text">经典故障案例1：5.7 xtrabackup&#x2F;mysqldump备份时数据库出现hang状态，所有修改查询都不能进行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%A1%88%E4%BE%8B2%EF%BC%9A-5-7%E7%89%88%E6%9C%AC-innobackupex%E5%A4%87%E4%BB%BD%E5%85%A8%E5%BA%93%EF%BC%8C%E8%BF%9B%E7%A8%8B%E6%AD%BB%E4%BA%86%EF%BC%8Cmysql%E9%87%8C%E5%B0%B1%E6%98%AF%E5%85%A8%E5%BA%93%E8%AF%BB%E9%94%81%EF%BC%8C%E5%90%8E%E8%BE%B9insert-%E5%85%A8%E9%98%BB%E5%A1%9E%E4%BA%86"><span class="nav-number">8.1.4.</span> <span class="nav-text">故障案例2： 5.7版本  innobackupex备份全库，进程死了，mysql里就是全库读锁，后边insert 全阻塞了</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-row-lock-wait-%E9%94%81%E7%AD%89%E5%BE%85"><span class="nav-number">8.2.</span> <span class="nav-text">7.2 row lock wait 锁等待</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">8.2.1.</span> <span class="nav-text">a.介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E8%A1%8C%E9%94%81%E7%9B%91%E6%8E%A7%E5%8F%8A%E5%88%86%E6%9E%90%F0%9F%95%B5%EF%B8%8F%E2%80%8D%E2%99%82%EF%B8%8F"><span class="nav-number">8.2.2.</span> <span class="nav-text">b. 行锁监控及分析🕵️‍♂️</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E4%BC%98%E5%8C%96%E6%96%B9%E5%90%91"><span class="nav-number">8.2.3.</span> <span class="nav-text">c. 优化方向</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%A1%88%E4%BE%8B3-16C-top-CPU%E4%BD%BF%E7%94%A8%E6%80%BB%E9%87%8F-1200-1300-%E5%B9%B3%E5%9D%87-80-MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">8.2.4.</span> <span class="nav-text">故障案例3 :  16C    top  CPU使用总量 1200%-1300, 平均 80%+   MySQL数据库服务器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E6%9E%B6%E6%9E%84%E4%BC%98%E5%8C%96"><span class="nav-number">9.</span> <span class="nav-text">8.架构优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E5%AE%89%E5%85%A8%E4%BC%98%E5%8C%96"><span class="nav-number">10.</span> <span class="nav-text">9.安全优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="nav-number">11.</span> <span class="nav-text">10.常用工具介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81-PT%EF%BC%88percona-toolkits%EF%BC%89%E5%B7%A5%E5%85%B7%E7%9A%84%E5%BA%94%E7%94%A8"><span class="nav-number">11.1.</span> <span class="nav-text">一、 PT（percona-toolkits）工具的应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-pt-archiver-%E5%BD%92%E6%A1%A3%E8%A1%A8"><span class="nav-number">11.1.1.</span> <span class="nav-text">2.1 pt-archiver 归档表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-pt-osc-%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">11.1.2.</span> <span class="nav-text">2.2 pt-osc 修改表结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-pt-table-checksum-%E6%A0%A1%E9%AA%8C%E4%B8%BB%E4%BB%8E%E6%95%B0%E6%8D%AE"><span class="nav-number">11.1.3.</span> <span class="nav-text">2.3 pt-table-checksum 校验主从数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-pt-table-sync-%E4%BF%AE%E5%A4%8D%E4%B8%BB%E4%BB%8E%E6%95%B0%E6%8D%AE"><span class="nav-number">11.1.4.</span> <span class="nav-text">2.4 pt-table-sync 修复主从数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-pt-show-grants-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E7%9A%84%E6%96%B9%E6%B3%95-%E2%9C%A8"><span class="nav-number">11.1.5.</span> <span class="nav-text">2.5. # pt-show-grants (备份数据库用户的方法)✨ </span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-pt-slave-find-%E6%98%BE%E7%A4%BA%E4%B8%BB%E4%BB%8E%E7%BB%93%E6%9E%84-%E5%8F%AF%E4%BA%86%E8%A7%A3%E4%B8%8BORCH"><span class="nav-number">11.1.6.</span> <span class="nav-text">2.5  pt-slave-find  显示主从结构 (可了解下ORCH)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-%E7%9B%91%E6%8E%A7%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6"><span class="nav-number">11.1.7.</span> <span class="nav-text">2.6  监控主从延时</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="139"
      src="/images/custom/avatar.jpg">
  <p class="site-author-name" itemprop="name">139</p>
  <div class="site-description" itemprop="description">一个普通的JAVA开发的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2023004484号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">139</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
