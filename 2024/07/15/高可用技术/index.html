<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="什么是高可用1234567企业高可用标准：全年无故障率无故障时间     故障时间99.9%          0.1% &#x3D; 525.6 min               KA+双主 ：人为干预99.99%         0.01% &#x3D; 52.56 min              MHA 、ORCH ：半自动化99.999%        0.001% &#x3D; 5.256 min">
<meta property="og:type" content="article">
<meta property="og:title" content="高可用技术">
<meta property="og:url" content="http://example.com/2024/07/15/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF/index.html">
<meta property="og:site_name" content="进学阁">
<meta property="og:description" content="什么是高可用1234567企业高可用标准：全年无故障率无故障时间     故障时间99.9%          0.1% &#x3D; 525.6 min               KA+双主 ：人为干预99.99%         0.01% &#x3D; 52.56 min              MHA 、ORCH ：半自动化99.999%        0.001% &#x3D; 5.256 min">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661963247847-1a7d17cf-244b-49d0-aae2-0017e0dcc538.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661963335260-c7d5699d-2e8a-4171-b1a2-235dfb6a2c90.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661964362995-f6663795-e86a-45c7-a2ad-9573157d7e28.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662198239220-724a2039-161d-449e-8df7-b44a08b1bd27.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662198791773-585599b1-ca0c-4fac-9131-114d60e375d6.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662430632001-ffbe7606-f029-4a5d-9386-05bca89c7cd3.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218330238-24640bac-ff31-41eb-8fb4-f9d3c8a2fa5a.png">
<meta property="article:published_time" content="2024-07-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-06T09:54:52.628Z">
<meta property="article:author" content="139">
<meta property="article:tag" content="mysql">
<meta property="article:tag" content="高可用">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661963247847-1a7d17cf-244b-49d0-aae2-0017e0dcc538.png">

<link rel="canonical" href="http://example.com/2024/07/15/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>高可用技术 | 进学阁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">进学阁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">业精于勤荒于嬉，行成于思毁于随</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">38</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">69</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/custom/avatar.jpg">
      <meta itemprop="name" content="139">
      <meta itemprop="description" content="一个普通的JAVA开发的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="进学阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          高可用技术
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-07-15T00:00:00+08:00">2024-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-06 17:54:52" itemprop="dateModified" datetime="2025-03-06T17:54:52+08:00">2025-03-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="什么是高可用"><a href="#什么是高可用" class="headerlink" title="什么是高可用"></a>什么是高可用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">企业高可用标准：全年无故障率</span><br><span class="line"></span><br><span class="line">无故障时间     故障时间</span><br><span class="line">99.9%          0.1% = 525.6 min               KA+双主 ：人为干预</span><br><span class="line">99.99%         0.01% = 52.56 min              MHA 、ORCH ：半自动化</span><br><span class="line">99.999%        0.001% = 5.256 min             PXC 、 MGR 、MGC</span><br><span class="line">99.9999%       0.0001% = 0.5256 min           自动化、云化、平台化</span><br></pre></td></tr></table></figure>

<h1 id="数据库容灾级别"><a href="#数据库容灾级别" class="headerlink" title="数据库容灾级别"></a>数据库容灾级别</h1><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661963247847-1a7d17cf-244b-49d0-aae2-0017e0dcc538.png"></p>
<span id="more"></span>
<h1 id="1-MHA高可用技术"><a href="#1-MHA高可用技术" class="headerlink" title="1. MHA高可用技术"></a>1. MHA高可用技术</h1><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661963335260-c7d5699d-2e8a-4171-b1a2-235dfb6a2c90.png"></p>
<p>MHA脚本逻辑： </p>
<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661964362995-f6663795-e86a-45c7-a2ad-9573157d7e28.png"></p>
<p>1.0 MHA高可用架构介绍及搭建过程</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 规划:</span></span><br><span class="line">主库:               从库:                 </span><br><span class="line">51 node             52 node         53 node manager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section"># 准备环境</span></span><br><span class="line">略。1主2从GTID</span><br><span class="line"></span><br><span class="line"><span class="section"># 配置关键程序软连接</span></span><br><span class="line">ln -s /data/app/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span><br><span class="line">ln -s /data/app/mysql/bin/mysql /usr/bin/mysql</span><br><span class="line"></span><br><span class="line"><span class="section"># 配置各节点互信(各节点之间无密码SSH)</span></span><br><span class="line"><span class="section">## db01：</span></span><br><span class="line">rm -rf /root/.ssh</span><br><span class="line">ssh-keygen</span><br><span class="line">cd /root/.ssh</span><br><span class="line">mv id<span class="emphasis">_rsa.pub authorized_</span>keys</span><br><span class="line">scp -r /root/.ssh 10.0.0.52:/root</span><br><span class="line">scp -r /root/.ssh 10.0.0.53:/root</span><br><span class="line"><span class="section">## 各节点验证</span></span><br><span class="line"><span class="section">## db01:</span></span><br><span class="line">ssh 10.0.0.51 date</span><br><span class="line">ssh 10.0.0.52 date</span><br><span class="line">ssh 10.0.0.53 date</span><br><span class="line"><span class="section">## db02:</span></span><br><span class="line">ssh 10.0.0.51 date</span><br><span class="line">ssh 10.0.0.52 date</span><br><span class="line">ssh 10.0.0.53 date</span><br><span class="line"><span class="section">## db03:</span></span><br><span class="line">ssh 10.0.0.51 date</span><br><span class="line">ssh 10.0.0.52 date</span><br><span class="line">ssh 10.0.0.53 date</span><br><span class="line"></span><br><span class="line"><span class="section">#安装软件</span></span><br><span class="line"><span class="section">## 下载mha软件</span></span><br><span class="line">mha官网：https://code.google.com/archive/p/mysql-master-ha/</span><br><span class="line">github下载地址：https://github.com/yoshinorim/mha4mysqlmanager/wiki/Downloads</span><br><span class="line"><span class="section">## 所有节点安装Node软件依赖包</span></span><br><span class="line">yum install perl-DBD-MySQL -y</span><br><span class="line">rpm -ivh mha4mysql-node<span class="emphasis">*.rpm</span></span><br><span class="line"><span class="emphasis">## 在db01主库中创建mha需要的用户</span></span><br><span class="line"><span class="emphasis">create user mha@&#x27;10.0.0.%&#x27; identified with mysql_native_password by &#x27;mha&#x27;;</span></span><br><span class="line"><span class="emphasis">grant all privileges on *</span>.* to mha@&#x27;10.0.0.%&#x27;;</span><br><span class="line"><span class="section">## Manager软件安装（db03）</span></span><br><span class="line">yum install -y perl-Config-Tiny epel-release perl-Log-Dispatch perlParallel-ForkManager perl-Time-HiRes</span><br><span class="line">rpm -ivh mha4mysql-manager<span class="emphasis">*.rpm</span></span><br><span class="line"><span class="emphasis">## 配置文件准备(db03)</span></span><br><span class="line"><span class="emphasis">### 创建配置文件目录</span></span><br><span class="line"><span class="emphasis">mkdir -p /etc/mha</span></span><br><span class="line"><span class="emphasis">### 创建日志目录</span></span><br><span class="line"><span class="emphasis">mkdir -p /var/log/mha/app1</span></span><br><span class="line"><span class="emphasis">### 编辑mha配置文件</span></span><br><span class="line"><span class="emphasis">vim /etc/mha/app1.cnf</span></span><br><span class="line"><span class="emphasis">[server default]</span></span><br><span class="line"><span class="emphasis">manager_log=/var/log/mha/app1/manager</span></span><br><span class="line"><span class="emphasis">manager_workdir=/var/log/mha/app1</span></span><br><span class="line"><span class="emphasis">master_binlog_dir=/data/binlog/</span></span><br><span class="line"><span class="emphasis">user=mha</span></span><br><span class="line"><span class="emphasis">password=mha</span></span><br><span class="line"><span class="emphasis">ping_interval=2</span></span><br><span class="line"><span class="emphasis">repl_password=123</span></span><br><span class="line"><span class="emphasis">repl_user=repl</span></span><br><span class="line"><span class="emphasis">ssh_user=root</span></span><br><span class="line"><span class="emphasis">[server1]</span></span><br><span class="line"><span class="emphasis">hostname=10.0.0.51</span></span><br><span class="line"><span class="emphasis">port=3306</span></span><br><span class="line"><span class="emphasis">[server2]</span></span><br><span class="line"><span class="emphasis">hostname=10.0.0.52</span></span><br><span class="line"><span class="emphasis">candidate_master=1</span></span><br><span class="line"><span class="emphasis">port=3306</span></span><br><span class="line"><span class="emphasis">[server3]</span></span><br><span class="line"><span class="emphasis">hostname=10.0.0.53</span></span><br><span class="line"><span class="emphasis">port=3306</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 状态检查</span></span><br><span class="line"><span class="emphasis">## 互信检查</span></span><br><span class="line"><span class="emphasis">masterha_check_ssh --conf=/etc/mha/app1.cnf</span></span><br><span class="line"><span class="emphasis">## 主从状态检查</span></span><br><span class="line"><span class="emphasis">masterha_check_repl --conf=/etc/mha/app1.cnf</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 开启MHA(db03)：</span></span><br><span class="line"><span class="emphasis">nohup masterha_manager --conf=/etc/mha/app1.cnf --remove_dead_master_conf -</span></span><br><span class="line"><span class="emphasis">-ignore_last_failover &lt; /dev/null&gt; /var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 查看MHA状态</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# masterha_check_status --conf=/etc/mha/app1.cnf</span></span><br></pre></td></tr></table></figure>

<h2 id="1-1-MHA软件结构介绍"><a href="#1-1-MHA软件结构介绍" class="headerlink" title="1.1 MHA软件结构介绍"></a>1.1 MHA软件结构介绍</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">manager 组件</span><br><span class="line">masterha<span class="emphasis">_manger 启动MHA</span></span><br><span class="line"><span class="emphasis">masterha_</span>check<span class="emphasis">_ssh 检查MHA的SSH配置状况</span></span><br><span class="line"><span class="emphasis">masterha_</span>check<span class="emphasis">_repl 检查MySQL复制状况</span></span><br><span class="line"><span class="emphasis">masterha_</span>master<span class="emphasis">_monitor 检测master是否宕机</span></span><br><span class="line"><span class="emphasis">masterha_</span>check<span class="emphasis">_status 检测当前MHA运行状态</span></span><br><span class="line"><span class="emphasis">masterha_</span>master<span class="emphasis">_switch 控制故障转移（自动或者手动）</span></span><br><span class="line"><span class="emphasis">masterha_</span>conf<span class="emphasis">_host 添加或删除配置的server信息</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">node 组件</span></span><br><span class="line"><span class="emphasis">save_</span>binary<span class="emphasis">_logs 保存和复制master的二进制日志</span></span><br><span class="line"><span class="emphasis">apply_</span>diff<span class="emphasis">_relay_</span>logs 识别差异的中继日志事件并将其差异的事件应用于其他的</span><br><span class="line">purge<span class="emphasis">_relay_</span>logs 清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure>

<h2 id="1-2-应用透明—VIP"><a href="#1-2-应用透明—VIP" class="headerlink" title="1.2 应用透明—VIP"></a>1.2 应用透明—VIP</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vip : 10.0.0.55/24</span><br><span class="line">vip 故障转移脚本</span><br><span class="line">上传脚本文件到/usr/local/bin 解压</span><br><span class="line">[root@db03 mha<span class="emphasis">_script]# cp -a /data/mha_</span>script/* /usr/local/bin</span><br><span class="line"></span><br><span class="line">修改权限</span><br><span class="line">[root@db03 bin]# chmod +x /usr/local/bin/*</span><br><span class="line"></span><br><span class="line">修改内容</span><br><span class="line">[root@db03 bin]# cp master<span class="emphasis">_ip_</span>failover master<span class="emphasis">_ip_</span>failover.bak</span><br><span class="line">my $vip = &#x27;10.0.0.55/24&#x27;;</span><br><span class="line">my $key = &#x27;1&#x27;;</span><br><span class="line">my $if = &#x27;ens33&#x27;;</span><br><span class="line">my $ssh<span class="emphasis">_start_</span>vip = &quot;/sbin/ifconfig $if:$key $vip&quot;;</span><br><span class="line">my $ssh<span class="emphasis">_stop_</span>vip = &quot;/sbin/ifconfig $if:$key down&quot;;</span><br><span class="line">my $ssh<span class="emphasis">_Bcast_</span>arp= &quot;/sbin/arping -I $if -c 3 -A 10.0.0.55&quot;;</span><br><span class="line">修改Manager 配置文件</span><br><span class="line">vim /etc/mha/app1.cnf</span><br><span class="line">master<span class="emphasis">_ip_</span>failover<span class="emphasis">_script=/usr/local/bin/master_</span>ip<span class="emphasis">_failover</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">重启MHA</span></span><br><span class="line"><span class="emphasis">[root@db03 bin]# masterha_</span>stop --conf=/etc/mha/app1.cnf</span><br><span class="line">[root@db03 bin]# nohup masterha<span class="emphasis">_manager --conf=/etc/mha/app1.cnf --</span></span><br><span class="line"><span class="emphasis">remove_</span>dead<span class="emphasis">_master_</span>conf --ignore<span class="emphasis">_last_</span>failover &lt; /dev/null&gt;</span><br><span class="line">/var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br><span class="line">手工在主库添加VIP</span><br><span class="line">[root@db03 bin]# masterha<span class="emphasis">_check_</span>status --conf=/etc/mha/app1.cnf</span><br><span class="line">[root@db02 ~]# ifconfig ens33:1 10.0.0.55/24</span><br><span class="line"></span><br><span class="line">效果测试</span><br><span class="line">使用navicat 连接测试MHA vip功能。</span><br></pre></td></tr></table></figure>

<h2 id="1-3-故障提醒功能"><a href="#1-3-故障提醒功能" class="headerlink" title="1.3 故障提醒功能"></a>1.3 故障提醒功能</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">准备脚本</span><br><span class="line">[root@db03 bin]# cp send<span class="emphasis">_report send_</span>report.bak1</span><br><span class="line">my $smtp=&#x27;smtp.qq.com&#x27;; # smtp服务器</span><br><span class="line">my $mail<span class="emphasis">_from=&#x27;22654481@qq.com&#x27;; # 发件箱</span></span><br><span class="line"><span class="emphasis">my $mail_</span>user=&#x27;22654481&#x27;; # 用户名 QQ号</span><br><span class="line">my $mail<span class="emphasis">_pass=&#x27;gemghsvgkeyzcagh&#x27;; # 授权码</span></span><br><span class="line"><span class="emphasis">my $mail_</span>to=[&#x27;22654481@qq.com&#x27;]; # 收件箱</span><br><span class="line"><span class="section">#my $mail<span class="emphasis">_to=[&#x27;to1@qq.com&#x27;,&#x27;to2@qq.com&#x27;];</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">修改配置文件</span></span></span><br><span class="line"><span class="emphasis"><span class="section">vim /etc/mha/app1.cnf  # 添加一行：</span></span></span><br><span class="line"><span class="emphasis"><span class="section">report_</span>script=/usr/local/bin/send<span class="emphasis">_report</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section">重启MHA</span></span></span><br><span class="line"><span class="emphasis"><span class="section">[root@db03 bin]# masterha_</span>stop --conf=/etc/mha/app1.cnf</span></span><br><span class="line">[root@db03 bin]# nohup masterha<span class="emphasis">_manager --conf=/etc/mha/app1.cnf --</span></span><br><span class="line"><span class="emphasis">remove_</span>dead<span class="emphasis">_master_</span>conf --ignore<span class="emphasis">_last_</span>failover &lt; /dev/null&gt;</span><br><span class="line">/var/log/mha/app1/manager.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-1-故障如何半自愈？"><a href="#1-3-1-故障如何半自愈？" class="headerlink" title="1.3.1 故障如何半自愈？"></a>1.3.1 故障如何半自愈？</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 检查数据库是否启动</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db01</span> <span class="type">app</span>]<span class="comment"># mysqladmin -umha -pmha -h 10.0.0.51 ping</span></span><br><span class="line"><span class="comment"># 2. 恢复主从</span></span><br><span class="line"><span class="comment">## 2.1 缺失少部分日志</span></span><br><span class="line">如果没有缺失GTID事务。直接change master</span><br><span class="line"><span class="comment">## 2.2 缺失大部分日志</span></span><br><span class="line">备份主库数据，恢复至从库。change master</span><br><span class="line">clone plugin + change master to</span><br><span class="line"><span class="comment"># 3. 配置文件添加修复节点</span></span><br><span class="line">masterha_conf_host <span class="literal">--command</span>=add <span class="literal">--conf</span>=/etc/mha/app1.cnf <span class="literal">--</span></span><br><span class="line">hostname=<span class="number">10.0</span>.<span class="number">0.51</span> <span class="literal">--block</span>=server10 <span class="literal">--params</span>=<span class="string">&quot;port=3306&quot;</span></span><br><span class="line"><span class="comment"># 4. 检查</span></span><br><span class="line"><span class="comment">## 互信检查</span></span><br><span class="line">masterha_check_ssh <span class="literal">--conf</span>=/etc/mha/app1.cnf</span><br><span class="line"><span class="comment">## 主从状态检查</span></span><br><span class="line">masterha_check_repl <span class="literal">--conf</span>=/etc/mha/app1.cnf</span><br><span class="line"><span class="comment"># 启动MHA</span></span><br><span class="line">nohup masterha_manager <span class="literal">--conf</span>=/etc/mha/app1.cnf <span class="literal">--remove_dead_master_conf</span> -</span><br><span class="line"><span class="literal">-ignore_last_failover</span> &lt; /dev/null&gt; /var/log/mha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line"></span><br><span class="line">手工恢复具体步骤：</span><br><span class="line"><span class="number">1</span>. 修改Linux服务器</span><br><span class="line"><span class="number">2</span>. 安装MySQL软件</span><br><span class="line"><span class="number">3</span>. 初始化数据，并启动</span><br><span class="line"><span class="number">4</span>. clone 数据到新节点，并构建主从</span><br><span class="line">主库：</span><br><span class="line">mysql <span class="literal">-e</span> <span class="string">&quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test@&#x27;%&#x27;</span></span><br><span class="line"><span class="string">identified by &#x27;123&#x27;;grant backup_admin on *.* to test@&#x27;%&#x27;;&quot;</span></span><br><span class="line">从库：</span><br><span class="line">mysql <span class="literal">-e</span> <span class="string">&quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test@&#x27;%&#x27;</span></span><br><span class="line"><span class="string">identified by &#x27;123&#x27;;grant clone_admin on *.* to test@&#x27;%&#x27;;SET GLOBAL</span></span><br><span class="line"><span class="string">clone_valid_donor_list=&#x27;10.0.0.52:3306&#x27;;&quot;</span></span><br><span class="line">mysql <span class="literal">-utest</span> <span class="literal">-p123</span> <span class="literal">-h10</span>.<span class="number">0.0</span>.<span class="number">51</span> <span class="literal">-P3306</span> <span class="literal">-e</span> <span class="string">&quot;CLONE INSTANCE FROM</span></span><br><span class="line"><span class="string">test@&#x27;10.0.0.52&#x27;:3306 IDENTIFIED BY &#x27;123&#x27;;&quot;</span></span><br><span class="line">mysql <span class="literal">-e</span> <span class="string">&quot; SELECT STAGE, STATE, END_TIME FROM</span></span><br><span class="line"><span class="string">performance_schema.clone_progress;&quot;</span></span><br><span class="line">mysql <span class="literal">-e</span> \</span><br><span class="line"><span class="string">&quot;CHANGE MASTER TO \</span></span><br><span class="line"><span class="string">MASTER_HOST=&#x27;10.0.0.52&#x27;,\</span></span><br><span class="line"><span class="string">MASTER_USER=&#x27;repl&#x27;, \</span></span><br><span class="line"><span class="string">MASTER_PASSWORD=&#x27;123&#x27;, \</span></span><br><span class="line"><span class="string">MASTER_PORT=3306, \</span></span><br><span class="line"><span class="string">MASTER_AUTO_POSITION=1;&quot;</span></span><br><span class="line">mysql <span class="literal">-e</span> <span class="string">&quot;start slave;&quot;</span></span><br><span class="line">mysql <span class="literal">-e</span> <span class="string">&quot;show slave status \G&quot;</span>|grep <span class="string">&quot;Running:&quot;</span></span><br><span class="line"><span class="number">5</span>. 添加节点至配置文件</span><br><span class="line">masterha_conf_host <span class="literal">--command</span>=add <span class="literal">--conf</span>=/etc/mha/app1.cnf <span class="literal">--</span></span><br><span class="line">hostname=<span class="number">10.0</span>.<span class="number">0.51</span> <span class="literal">--block</span>=server10 <span class="literal">--params</span>=<span class="string">&quot;port=3306&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span>. 修复binlogserver</span><br><span class="line">mysqlbinlog <span class="literal">-R</span> <span class="literal">--host</span>=<span class="number">10.0</span>.<span class="number">0.52</span> <span class="literal">--user</span>=mha <span class="literal">--password</span>=mha <span class="literal">--raw</span> <span class="literal">--stop-never</span> mysql<span class="literal">-bin</span>.<span class="number">000003</span> &amp;</span><br><span class="line"></span><br><span class="line"><span class="number">7</span>. 状态检查</span><br><span class="line"><span class="comment">## 互信检查</span></span><br><span class="line">masterha_check_ssh <span class="literal">--conf</span>=/etc/mha/app1.cnf</span><br><span class="line"><span class="comment">## 主从状态检查</span></span><br><span class="line">masterha_check_repl <span class="literal">--conf</span>=/etc/mha/app1.cnf</span><br><span class="line"><span class="number">8</span>. 启动MHA</span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">app1</span>]<span class="comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --</span></span><br><span class="line">remove_dead_master_conf <span class="literal">--ignore_last_failover</span> &lt; /dev/null&gt;</span><br><span class="line">/var/log/mha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">app1</span>]<span class="comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">可以写脚本实现半自愈功能。</span><br></pre></td></tr></table></figure>

<h2 id="1-4-日志补偿的冗余方案–binlog-server"><a href="#1-4-日志补偿的冗余方案–binlog-server" class="headerlink" title="1.4 日志补偿的冗余方案–binlog_server"></a>1.4 日志补偿的冗余方案–binlog_server</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建必要目录(db03)</span></span><br><span class="line">mkdir <span class="literal">-p</span> /<span class="keyword">data</span>/binlog_server/</span><br><span class="line">chown <span class="literal">-R</span> mysql.mysql /<span class="keyword">data</span>/*</span><br><span class="line"><span class="built_in">cd</span> /<span class="keyword">data</span>/binlog_server/</span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> ~]<span class="comment"># mysql -e &quot;show slave status \G&quot;|grep &quot;Master_Log&quot;</span></span><br><span class="line">Master_Log_File: mysql<span class="literal">-bin</span>.<span class="number">000008</span></span><br><span class="line">Read_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">Relay_Master_Log_File: mysql<span class="literal">-bin</span>.<span class="number">000008</span></span><br><span class="line">Exec_Master_Log_Pos: <span class="number">194</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> ~]<span class="comment">#</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">binlog_server</span>]<span class="comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">7057</span>) is running(<span class="number">0</span>:PING_OK), master:<span class="number">10.0</span>.<span class="number">0.52</span></span><br><span class="line">mysqlbinlog <span class="literal">-R</span> <span class="literal">--host</span>=<span class="number">10.0</span>.<span class="number">0.52</span> <span class="literal">--user</span>=mha <span class="literal">--password</span>=mha <span class="literal">--raw</span> <span class="literal">--stop</span>never mysql<span class="literal">-bin</span>.<span class="number">000003</span> &amp;</span><br><span class="line">注意：</span><br><span class="line">拉取日志的起点,需要按照目前从库的已经获取到的二进制日志点为起点</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件设置</span></span><br><span class="line">vim /etc/mha/app1.cnf</span><br><span class="line">[<span class="type">binlog1</span>]</span><br><span class="line">no_master=<span class="number">1</span></span><br><span class="line">hostname=<span class="number">10.0</span>.<span class="number">0.53</span></span><br><span class="line">master_binlog_dir=/<span class="keyword">data</span>/binlog_server/</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启MHA</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># masterha_stop --conf=/etc/mha/app1.cnf</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --</span></span><br><span class="line">remove_dead_master_conf <span class="literal">--ignore_last_failover</span> &lt; /dev/null&gt;</span><br><span class="line">/var/log/mha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-MHA的维护操作-在线切换功能"><a href="#1-5-MHA的维护操作-在线切换功能" class="headerlink" title="1.5 MHA的维护操作 - 在线切换功能"></a>1.5 MHA的维护操作 - 在线切换功能</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">db03</span> ~]<span class="comment"># masterha_stop --conf=/etc/mha/app1.cnf</span></span><br><span class="line">只切换角色</span><br><span class="line">masterha_master_switch <span class="literal">--conf</span>=/etc/mha/app1.cnf <span class="literal">--master_state</span>=alive <span class="literal">--</span></span><br><span class="line">new_master_host=<span class="number">10.0</span>.<span class="number">0.51</span> <span class="literal">--orig_master_is_new_slave</span> <span class="literal">--</span></span><br><span class="line">running_updates_limit=<span class="number">10000</span></span><br><span class="line">注意：</span><br><span class="line">master_ip_online_change_script is not defined. <span class="keyword">If</span> you <span class="keyword">do</span> not disable writes</span><br><span class="line">on the current master manually, applications keep writing on the current</span><br><span class="line">master. Is it ok to proceed? (yes/NO): yes</span><br><span class="line"><span class="number">1</span>. 此种方法 切换，要注意将原主库，FTWRL，否则会造成主从不一致。</span><br><span class="line"><span class="number">2</span>. 手工切换vip</span><br><span class="line"><span class="number">3</span>. 重新拉去新主库的binlog</span><br><span class="line"><span class="number">4</span>. 发邮件功能</span><br><span class="line"></span><br><span class="line">master_ip_online_change_script功能实现</span><br><span class="line">功能: 在线切换时，自动锁原主库，VIP自动切换</span><br><span class="line"></span><br><span class="line"><span class="comment">#准备切换脚本</span></span><br><span class="line">vim /usr/local/bin/master_ip_online_change</span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">&quot;10.0.0.55/24&quot;</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">&quot;/sbin/ifconfig ens33:<span class="variable">$key</span> <span class="variable">$vip</span>&quot;</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">&quot;/sbin/ifconfig ens33:<span class="variable">$key</span> <span class="variable">$vip</span> down&quot;</span>;</span><br><span class="line">my <span class="variable">$ssh_Bcast_arp</span>= <span class="string">&quot;/sbin/arping -I ens33 -c 3 -A 10.0.0.55&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#修改MHA配置文件</span></span><br><span class="line">vim /etc/mha/app1.cnf</span><br><span class="line">master_ip_online_change_script=/usr/local/bin/master_ip_online_change</span><br><span class="line"></span><br><span class="line"><span class="comment">#停 MHA</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># masterha_stop --conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查repl</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># masterha_check_repl --conf=/etc/mha/app1.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在线切换</span></span><br><span class="line">masterha_master_switch <span class="literal">--conf</span>=/etc/mha/app1.cnf <span class="literal">--master_state</span>=alive <span class="literal">--</span></span><br><span class="line">new_master_host=<span class="number">10.0</span>.<span class="number">0.51</span> <span class="literal">--orig_master_is_new_slave</span> <span class="literal">--</span></span><br><span class="line">running_updates_limit=<span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重构binlogserver</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># ps -ef |grep mysqlbinlog</span></span><br><span class="line">root <span class="number">28144</span> <span class="number">16272</span> <span class="number">0</span> <span class="number">17</span>:<span class="number">50</span> pts/<span class="number">1</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> mysqlbinlog <span class="literal">-R</span> <span class="literal">--</span></span><br><span class="line">host=<span class="number">10.0</span>.<span class="number">0.52</span> <span class="literal">--user</span>=mha <span class="literal">--password</span>=x x <span class="literal">--raw</span> <span class="literal">--stop-never</span> mysqlbin.<span class="number">000005</span></span><br><span class="line">root <span class="number">28529</span> <span class="number">16272</span> <span class="number">0</span> <span class="number">18</span>:<span class="number">03</span> pts/<span class="number">1</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep <span class="literal">--color</span>=auto</span><br><span class="line">mysqlbinlog</span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># kill -9 28144</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># cd /data/binlog_server/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">binlog_server</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">4</span></span><br><span class="line"><span class="literal">-rw-r-----</span> <span class="number">1</span> root root <span class="number">194</span> Apr <span class="number">1</span> <span class="number">17</span>:<span class="number">50</span> mysql<span class="literal">-bin</span>.<span class="number">000005</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">binlog_server</span>]<span class="comment"># rm -rf *</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">binlog_server</span>]<span class="comment"># mysqlbinlog -R --host=10.0.0.51 --user=mha --</span></span><br><span class="line">password=mha <span class="literal">--raw</span> <span class="literal">--stop-never</span> mysql<span class="literal">-bin</span>.<span class="number">000009</span> &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">28534</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动MHA</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">bin</span>]<span class="comment"># nohup masterha_manager --conf=/etc/mha/app1.cnf --</span></span><br><span class="line">remove_dead_master_conf <span class="literal">--ignore_last_failover</span> &lt; /dev/null&gt;</span><br><span class="line">/var/log/mha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;</span><br><span class="line">[<span class="type">root</span>@<span class="type">db03</span> <span class="type">binlog_server</span>]<span class="comment"># masterha_check_status --conf=/etc/mha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">28535</span>) is running(<span class="number">0</span>:PING_OK), master:<span class="number">10.0</span>.<span class="number">0.51</span></span><br></pre></td></tr></table></figure>



<h2 id="1-6-MHA如何防止脑裂"><a href="#1-6-MHA如何防止脑裂" class="headerlink" title="1.6 MHA如何防止脑裂"></a>1.6 MHA如何防止脑裂</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 什么是脑裂？</span></span><br><span class="line">1.7 MHA的数据一致性保证</span><br><span class="line">2、ProxySQL中间件</span><br><span class="line">2.1 介绍</span><br><span class="line">多个节点争抢主库角色。会导致多库写入的问题。</span><br><span class="line">manager程序与现有主库之间出现网络故障。默认manager是单一心跳检查的。</span><br><span class="line"></span><br><span class="line"><span class="section"># 解决方案：</span></span><br><span class="line"><span class="bullet">1.</span> 采用多心跳投票机制。例如：多条网络线路（以太网、磁盘网络）。</span><br><span class="line"><span class="bullet">2.</span> stonith是“shoot the other node in the head”的首字母简写</span><br><span class="line"><span class="section"># shutdown<span class="emphasis">_script 脚本</span></span></span><br><span class="line"><span class="emphasis"><span class="section">利用服务器的远程控制IDRAC等，使用ipmitool强制去关机，以避免fence设备重启主服务器，造成</span></span></span><br><span class="line"><span class="emphasis"><span class="section">脑列现象.</span></span></span><br><span class="line"><span class="emphasis"><span class="section">shutdown_</span>script= /usr/local/bin/power<span class="emphasis">_manager</span></span></span><br><span class="line"><span class="emphasis"><span class="section">fence: 网络fence(ilo、idrac)、电源fence</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># secondary_</span>check<span class="emphasis">_script脚本</span></span></span><br><span class="line"><span class="emphasis"><span class="section">secondary_</span>check<span class="emphasis">_script = &quot;masterha_</span>secondary<span class="emphasis">_check -s 10.0.0.52 -s</span></span></span><br><span class="line"><span class="emphasis"><span class="section">10.0.0.53&quot;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="1-7-MHA的数据一致性保证"><a href="#1-7-MHA的数据一致性保证" class="headerlink" title="1.7 MHA的数据一致性保证"></a>1.7 MHA的数据一致性保证</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">#<span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">*** rpl<span class="emphasis">_semi_</span>sync **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line">rpl<span class="emphasis">_semi_</span>sync<span class="emphasis">_master_</span>enabled =ON</span><br><span class="line">rpl<span class="emphasis">_semi_</span>sync<span class="emphasis">_master_</span>timeout =5000</span><br><span class="line">rpl<span class="emphasis">_semi_</span>sync<span class="emphasis">_master_</span>wait<span class="emphasis">_for_</span>slave<span class="emphasis">_count =1</span></span><br><span class="line"><span class="emphasis">rpl_</span>semi<span class="emphasis">_sync_</span>master<span class="emphasis">_wait_</span>no<span class="emphasis">_slave =ON</span></span><br><span class="line"><span class="emphasis">rpl_</span>semi<span class="emphasis">_sync_</span>master<span class="emphasis">_wait_</span>point =AFTER<span class="emphasis">_SYNC</span></span><br><span class="line"><span class="emphasis">rpl_</span>semi<span class="emphasis">_sync_</span>slave<span class="emphasis">_enabled =ON</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#<span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">*** group commit **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">binlog_</span>group<span class="emphasis">_commit_</span>sync<span class="emphasis">_delay =1</span></span><br><span class="line"><span class="emphasis">binlog_</span>group<span class="emphasis">_commit_</span>sync<span class="emphasis">_no_</span>delay<span class="emphasis">_count =1000</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#<span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">*** gtid **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode =ON</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency =ON</span><br><span class="line">log<span class="emphasis">_slave_</span>update =1</span><br><span class="line"></span><br><span class="line"><span class="section">#<span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">*** gtid **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span></span><br><span class="line">slave<span class="emphasis">_parallel_</span>type =LOGICAL<span class="emphasis">_CLOCK</span></span><br><span class="line"><span class="emphasis">slave_</span>parallel<span class="emphasis">_workers =4</span></span><br><span class="line"><span class="emphasis">master_</span>info<span class="emphasis">_repository =TABLE</span></span><br><span class="line"><span class="emphasis">relay_</span>log<span class="emphasis">_info_</span>repository =TABL</span><br></pre></td></tr></table></figure>

<h1 id="2-ProxySQL中间件"><a href="#2-ProxySQL中间件" class="headerlink" title="2. ProxySQL中间件"></a>2. ProxySQL中间件</h1><h2 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ProxySQL是基于MySQL的一款开源的中间件的产品，是一个灵活的MySQL代理层，可以实现读写分离，</span><br><span class="line">支持 Query路由功能，支持动态指定某个SQL进行缓存，支持动态加载配置信息（无需重启 ProxySQL</span><br><span class="line">服务），支持故障切换和SQL的过滤功能。</span><br><span class="line"></span><br><span class="line">相关 ProxySQL 的网站：</span><br><span class="line">https://www.proxysql.com/</span><br><span class="line">https://github.com/sysown/proxysql/wiki</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662198239220-724a2039-161d-449e-8df7-b44a08b1bd27.png"></p>
<h2 id="2-2-安装ProxySQL"><a href="#2-2-安装ProxySQL" class="headerlink" title="2. 2 安装ProxySQL"></a>2. 2 安装ProxySQL</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 下载proxySQL</span></span><br><span class="line">https://proxysql.com/</span><br><span class="line">https://github.com/sysown/proxysql/releases</span><br><span class="line"></span><br><span class="line"><span class="section"># 安装proxySQL</span></span><br><span class="line">[root@db03 ~]# rpm -ivh proxysql-2.0.10-1-centos7.x86<span class="emphasis">_64.rpm</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# systemctl start proxysql</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# netstat -tulnp</span></span><br><span class="line"><span class="emphasis">tcp 0 0 0.0.0.0:6032 0.0.0.0:* LISTEN</span></span><br><span class="line"><span class="emphasis">	2115/proxysql</span></span><br><span class="line"><span class="emphasis">tcp 0 0 0.0.0.0:6033 0.0.0.0:* LISTEN</span></span><br><span class="line"><span class="emphasis">	2115/proxysql</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# mysql -uadmin -padmin -h127.0.0.1 -P6032</span></span><br></pre></td></tr></table></figure>

<h2 id="2-3-ProxySQL中管理结构"><a href="#2-3-ProxySQL中管理结构" class="headerlink" title="2.3 ProxySQL中管理结构"></a>2.3 ProxySQL中管理结构</h2><h4 id="ProxySQL-自带系统库信息"><a href="#ProxySQL-自带系统库信息" class="headerlink" title="ProxySQL  自带系统库信息"></a>ProxySQL  自带系统库信息</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在ProxySQL，6032端口共五个库： main、disk、stats 、monitor、stats<span class="emphasis">_history</span></span><br><span class="line"><span class="emphasis">   main:</span></span><br><span class="line"><span class="emphasis">     main 库中有如下信息：</span></span><br><span class="line"><span class="emphasis">     mysql_</span>servers: 后端可以连接 MySQL 服务器的列表</span><br><span class="line"><span class="code">     mysql_users: 配置后端数据库的账号和监控的账号。</span></span><br><span class="line"><span class="code">     mysql_query_rules: 指定 Query 路由到后端不同服务器的规则列表。</span></span><br><span class="line"><span class="code">     mysql_replication_hostgroups : 节点分组配置信息</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">注： 表名以 runtime<span class="emphasis">_开头的表示ProxySQL 当前运行的配置内容，不能直接修改。不带runtime_</span></span><br><span class="line">是下文图中Mem相关的配置。</span><br><span class="line"><span class="section">#disk ：</span></span><br><span class="line"><span class="code">	持久化的磁盘的配置</span></span><br><span class="line"><span class="code">#stats：</span></span><br><span class="line"><span class="code">	统计信息的汇总</span></span><br><span class="line"><span class="code">#monitor：</span></span><br><span class="line"><span class="code">	监控的收集信息，比如数据库的健康状态等</span></span><br><span class="line"><span class="code">#stats_history:  ProxySQL 收集的有关其内部功能的历史指标</span></span><br></pre></td></tr></table></figure>

<h4 id="ProxySQL-管理接口的多层配置关系"><a href="#ProxySQL-管理接口的多层配置关系" class="headerlink" title="ProxySQL  管理接口的多层配置关系"></a>ProxySQL  管理接口的多层配置关系</h4><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662198791773-585599b1-ca0c-4fac-9131-114d60e375d6.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">整套配置系统分为三层：</span><br><span class="line"><span class="section"># 顶层 RUNTIME</span></span><br><span class="line"><span class="section"># 中间层 MEMORY （主要修改的配置表）</span></span><br><span class="line"><span class="section"># 持久层 DISK 和 CFG FILE</span></span><br><span class="line"></span><br><span class="line">RUNTIME ：</span><br><span class="line"><span class="code">	代表 ProxySQL 当前正在使用的配置，无法直接修改此配置，必须要从下一层 （MEM层）</span></span><br><span class="line"><span class="code">“load” 进来。</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">MEMORY：</span><br><span class="line">MEMORY 层上面连接 RUNTIME 层，下面disk持久层。这层可以在线操作 ProxySQL 配置，随</span><br><span class="line">便修改，不会影响生产环境。确认正常之后在加载达到RUNTIME和持久化的磁盘上。修改方法：</span><br><span class="line">insert、update、delete、select。</span><br><span class="line"></span><br><span class="line">DISK和CONFIG FILE：</span><br><span class="line">持久化配置信息。重启时，可以从磁盘快速加载回来。</span><br></pre></td></tr></table></figure>

<h4 id="ProxySQL-在不同层次间移动配置"><a href="#ProxySQL-在不同层次间移动配置" class="headerlink" title="ProxySQL  在不同层次间移动配置"></a>ProxySQL  在不同层次间移动配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">为了将配置持久化到磁盘或者应用到 runtime，在管理接口下有一系列管理命令来实现它们。</span><br><span class="line">1. user相关配置</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 加载到runtime</span></span></span><br><span class="line">LOAD MYSQL USERS TO RUNTIME;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># runtime 保存至 MEM</span></span></span><br><span class="line">SAVE MYSQL USERS TO MEMORY;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># disk 加载到 MEM</span></span></span><br><span class="line">LOAD MYSQL USERS FROM DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 到 disk</span></span></span><br><span class="line">SAVE MYSQL USERS TO DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># CFG 到 MEM</span></span></span><br><span class="line">LOAD MYSQL USERS FROM CONFIG</span><br><span class="line">=============================</span><br><span class="line">2. server 相关配置</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 加载到runtime</span></span></span><br><span class="line">LOAD MYSQL SERVERS TO RUNTIME;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># runtime 保存至 MEM</span></span></span><br><span class="line">SAVE MYSQL SERVERS TO MEMORY;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># disk 加载到 MEM</span></span></span><br><span class="line">LOAD MYSQL SERVERS FROM DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 到 disk</span></span></span><br><span class="line">SAVE MYSQL SERVERS TO DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># CFG 到 MEM</span></span></span><br><span class="line">LOAD MYSQL SERVERS FROM CONFIG</span><br><span class="line">===============================</span><br><span class="line">3. mysql query rules配置</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 加载到runtime</span></span></span><br><span class="line">LOAD MYSQL QUERY RULES TO RUNTIME;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># runtime 保存至 MEM</span></span></span><br><span class="line">SAVE MYSQL QUERY RULES TO MEMORY;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># disk 加载到 MEM</span></span></span><br><span class="line">LOAD MYSQL QUERY RULES FROM DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 到 disk</span></span></span><br><span class="line">SAVE MYSQL QUERY RULES TO DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># CFG 到 MEM</span></span></span><br><span class="line">LOAD MYSQL QUERY RULES FROM CONFIG</span><br><span class="line">=================================</span><br><span class="line">4. MySQL variables配置</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 加载到runtime</span></span></span><br><span class="line">LOAD MYSQL VARIABLES TO RUNTIME;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># runtime 保存至 MEM</span></span></span><br><span class="line">SAVE MYSQL VARIABLES TO MEMORY;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># disk 加载到 MEM</span></span></span><br><span class="line">LOAD MYSQL VARIABLES FROM DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># MEM 到 disk</span></span></span><br><span class="line">SAVE MYSQL VARIABLES TO DISK;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># CFG 到 MEM</span></span></span><br><span class="line">LOAD MYSQL VARIABLES FROM CONFIG</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">日常配置其实大部分时间在MEM配置，然后load到RUNTIME，然后SAVE到DIsk。cfg很少使用。</span><br><span class="line">例如 ：</span><br><span class="line">load xxx to runtime;</span><br><span class="line">save xxx to disk;</span><br><span class="line">注意：</span><br><span class="line">只有load到 runtime 状态时才会验证配置。在保MEM或disk时，都不会发生任何警告或错误。</span><br><span class="line">当load到 runtime 时，如果出现错误，将恢复为之前保存得状态，这时可以去检查错误日志。</span><br></pre></td></tr></table></figure>

<h2 id="2-4-ProxySQL应用——基于SQL的读写分离"><a href="#2-4-ProxySQL应用——基于SQL的读写分离" class="headerlink" title="2.4  ProxySQL应用——基于SQL的读写分离"></a>2.4  ProxySQL应用——基于SQL的读写分离</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 在mysql<span class="emphasis">_replication_</span>hostgroup表中，配置读写组编号</span><br><span class="line">db03 [main]&gt;insert into</span><br><span class="line">mysql<span class="emphasis">_replication_</span>hostgroups</span><br><span class="line">(writer<span class="emphasis">_hostgroup, reader_</span>hostgroup, comment)</span><br><span class="line">values (10,20,&#x27;proxy&#x27;);</span><br><span class="line">load mysql servers to runtime;</span><br><span class="line">save mysql servers to disk;</span><br><span class="line"></span><br><span class="line">db03 [main]&gt;select * from mysql<span class="emphasis">_replication_</span>hostgroups\G</span><br><span class="line"><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">*** 1. row **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span>*</span><br><span class="line">writer<span class="emphasis">_hostgroup: 10</span></span><br><span class="line"><span class="emphasis">reader_</span>hostgroup: 20</span><br><span class="line">check<span class="emphasis">_type: read_</span>only</span><br><span class="line">comment: proxy</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">说明：</span><br><span class="line">ProxySQL 会根据server 的read<span class="emphasis">_only 的取值将服务器进行分组。 read_</span>only=0 的</span><br><span class="line">server，master被分到编号为10的写组，read<span class="emphasis">_only=1 的server，slave则被分到编号20的读</span></span><br><span class="line"><span class="emphasis">组。所以需要将从库设置：</span></span><br><span class="line"><span class="emphasis">set global read_</span>only=1;</span><br><span class="line"></span><br><span class="line"><span class="bullet">3.</span> 添加主机到ProxySQL</span><br><span class="line">insert into mysql<span class="emphasis">_servers(hostgroup_</span>id,hostname,port) values</span><br><span class="line">(10,&#x27;10.0.0.51&#x27;,3306);</span><br><span class="line">insert into mysql<span class="emphasis">_servers(hostgroup_</span>id,hostname,port) values</span><br><span class="line">(20,&#x27;10.0.0.52&#x27;,3306);</span><br><span class="line">insert into mysql<span class="emphasis">_servers(hostgroup_</span>id,hostname,port) values</span><br><span class="line">(20,&#x27;10.0.0.53&#x27;,3306);</span><br><span class="line">load mysql servers to runtime;</span><br><span class="line">save mysql servers to disk;</span><br><span class="line"></span><br><span class="line"><span class="bullet">4.</span> 创建监控用户，并开启监控</span><br><span class="line"><span class="section"># 主库创建监控用户</span></span><br><span class="line">create user monitor@&#x27;%&#x27; identified with mysql<span class="emphasis">_native_</span>password by &#x27;123&#x27;;</span><br><span class="line">grant replication client on <span class="emphasis">*.*</span> to monitor@&#x27;%&#x27;;</span><br><span class="line"><span class="section"># proxySQL修改variables表</span></span><br><span class="line">set mysql-monitor<span class="emphasis">_username=&#x27;monitor&#x27;;</span></span><br><span class="line"><span class="emphasis">set mysql-monitor_</span>password=&#x27;123&#x27;;</span><br><span class="line">或者 ：</span><br><span class="line">UPDATE global<span class="emphasis">_variables SET variable_</span>value=&#x27;monitor&#x27;</span><br><span class="line">WHERE variable<span class="emphasis">_name=&#x27;mysql-monitor_</span>username&#x27;;</span><br><span class="line">UPDATE global<span class="emphasis">_variables SET variable_</span>value=&#x27;123&#x27;</span><br><span class="line">WHERE variable<span class="emphasis">_name=&#x27;mysql-monitor_</span>password&#x27;;</span><br><span class="line">load mysql variables to runtime;</span><br><span class="line">save mysql variables to disk;</span><br><span class="line"><span class="section"># 查询监控日志</span></span><br><span class="line">db03 [(none)]&gt;select * from mysql<span class="emphasis">_server_</span>connect<span class="emphasis">_log;</span></span><br><span class="line"><span class="emphasis">db03 [(none)]&gt;select * from mysql_</span>server<span class="emphasis">_ping_</span>log;</span><br><span class="line">db03 [(none)]&gt;select * from mysql<span class="emphasis">_server_</span>read<span class="emphasis">_only_</span>log;</span><br><span class="line">db03 [(none)]&gt;select * from mysql<span class="emphasis">_server_</span>replication<span class="emphasis">_lag_</span>log;</span><br><span class="line"></span><br><span class="line">4.配置应用用户</span><br><span class="line">create user root@&#x27;%&#x27; identified with mysql<span class="emphasis">_native_</span>password by &#x27;123&#x27;;</span><br><span class="line">grant all on <span class="emphasis">*.*</span> to root@&#x27;%&#x27;;</span><br><span class="line">insert into mysql<span class="emphasis">_users(username,password,default_</span>hostgroup)</span><br><span class="line">values(&#x27;root&#x27;,&#x27;123&#x27;,10);</span><br><span class="line">load mysql users to runtime;</span><br><span class="line">save mysql users to disk;</span><br><span class="line">早期版本，需要开启事务持续化。</span><br><span class="line">update mysql<span class="emphasis">_users set transaction_</span>persistent=1 where username=&#x27;root&#x27;;</span><br><span class="line">load mysql users to runtime;</span><br><span class="line">save mysql users to disk;</span><br><span class="line"></span><br><span class="line"><span class="bullet">5.</span> 实用的读写规则</span><br><span class="line">insert into</span><br><span class="line">mysql<span class="emphasis">_query_</span>rules(rule<span class="emphasis">_id,active,match_</span>pattern,destination<span class="emphasis">_hostgroup,apply)</span></span><br><span class="line"><span class="emphasis">values (1,1,&#x27;^select.*for update$&#x27;,10,1);</span></span><br><span class="line"><span class="emphasis">insert into</span></span><br><span class="line"><span class="emphasis">mysql_</span>query<span class="emphasis">_rules(rule_</span>id,active,match<span class="emphasis">_pattern,destination_</span>hostgroup,apply)</span><br><span class="line">values (2,1,&#x27;^select&#x27;,20,1);</span><br><span class="line">load mysql query rules to runtime;</span><br><span class="line">save mysql query rules to disk;</span><br><span class="line">注： select … for update规则的rule<span class="emphasis">_id必须要小于普通的select规则的rule_</span>id，</span><br><span class="line">ProxySQL是根据rule<span class="emphasis">_id的顺序进行规则匹配。</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">6. 测试读写分离</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# mysql -uroot -p123 -P 6033 -h 127.0.0.1 -e &quot;begin;select</span></span><br><span class="line"><span class="emphasis">@@server_</span>id;commit&quot;</span><br><span class="line">[root@db03 ~]# mysql -uroot -p123 -P 6033 -h 127.0.0.1 -e &quot;select</span><br><span class="line">@@server<span class="emphasis">_id;&quot;</span></span><br><span class="line"><span class="emphasis">db03 [(none)]&gt;select * from stats_</span>mysql<span class="emphasis">_query_</span>digest\G</span><br></pre></td></tr></table></figure>

<h3 id="2-5-ProxySQL应用扩展——花式路由规则"><a href="#2-5-ProxySQL应用扩展——花式路由规则" class="headerlink" title="2.5 ProxySQL应用扩展——花式路由规则"></a>2.5 ProxySQL应用扩展——花式路由规则</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> 基于端口的路由</span><br><span class="line"><span class="section">## 修改ProxySQL监听SQL流量的端口号，监听多端口上。</span></span><br><span class="line">set mysql-interfaces=&#x27;0.0.0.0:6033;0.0.0.0:6034&#x27;;</span><br><span class="line">save mysql variables to disk;</span><br><span class="line"></span><br><span class="line"><span class="section">## 重启生效</span></span><br><span class="line">systemctl restart proxysql</span><br><span class="line"></span><br><span class="line"><span class="section">## 设定路由规则</span></span><br><span class="line">delete from mysql<span class="emphasis">_query_</span>rules; # 为了测试，先清空已有规则</span><br><span class="line">insert into</span><br><span class="line">mysql<span class="emphasis">_query_</span>rules(rule<span class="emphasis">_id,active,proxy_</span>port,destination<span class="emphasis">_hostgroup,apply)</span></span><br><span class="line"><span class="emphasis">values(1,1,6033,10,1), (2,1,6034,20,1);</span></span><br><span class="line"><span class="emphasis">load mysql query rules to runtime;</span></span><br><span class="line"><span class="emphasis">save mysql query rules to disk;</span></span><br><span class="line"><span class="emphasis">说明：</span></span><br><span class="line"><span class="emphasis">	除了基于端口进行分离，还可以基于监听地址(修改字段proxy_</span>addr即可)，也可以基于客户端地</span><br><span class="line">址(修改字段client<span class="emphasis">_addr字段即可)。</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">2. 基于用户的路由</span></span><br><span class="line"><span class="emphasis">nsert into mysql_</span>users(username,password,default<span class="emphasis">_hostgroup)</span></span><br><span class="line"><span class="emphasis">values(&#x27;writer&#x27;,&#x27;123&#x27;,10),(&#x27;reader&#x27;,&#x27;123&#x27;,20);</span></span><br><span class="line"><span class="emphasis">load mysql users to runtime;</span></span><br><span class="line"><span class="emphasis">save mysql users to disk;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">delete from mysql_</span>query<span class="emphasis">_rules; # 为了测试，先清空已有规则</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">insert into</span></span><br><span class="line"><span class="emphasis">mysql_</span>query<span class="emphasis">_rules(rule_</span>id,active,username,destination<span class="emphasis">_hostgroup,apply)</span></span><br><span class="line"><span class="emphasis">values(1,1,&#x27;writer&#x27;,10,1),(2,1,&#x27;reader&#x27;,20,1);</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">load mysql query rules to runtime;</span></span><br><span class="line"><span class="emphasis">save mysql query rules to disk;</span></span><br></pre></td></tr></table></figure>

<h1 id="3-ORCH可视化高可用集群应用"><a href="#3-ORCH可视化高可用集群应用" class="headerlink" title="3. ORCH可视化高可用集群应用"></a>3. ORCH可视化高可用集群应用</h1><h2 id="3-1-ORCH介绍"><a href="#3-1-ORCH介绍" class="headerlink" title="3.1 ORCH介绍"></a>3.1 ORCH介绍</h2><p>Orchestrator（orch）：go编写的MySQL高可用性和复制拓扑管理工具，支持复制拓扑结构的调整，</p>
<p>自动故障转移和手动主从切换等。后端数据库用MySQL或SQLite存储元数据，并提供Web界面展示</p>
<p>MySQL复制的拓扑关系及状态，通过Web可更改MySQL实例的复制关系和部分配置信息，同时也提供</p>
<p>命令行和api接口，方便运维管理。 <em><strong>相对比MHA来看最重要的是解决了管理节点的单点问题，其通过</strong></em></p>
<p><em><strong>raft协议保证本身的高可用。GitHub的一部分管理也在用该工具进行管理。</strong></em></p>
<p>① 自动发现MySQL的复制拓扑，并且在web上展示。</p>
<p>② 重构复制关系，可以在web进行拖图来进行复制关系变更。</p>
<p>③ 检测主异常，并可以自动或手动恢复，通过Hooks进行自定义脚本。</p>
<p>④ 支持命令行和web界面管理复制。</p>
<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662430632001-ffbe7606-f029-4a5d-9386-05bca89c7cd3.png"></p>
<blockquote>
<p>参考文档： <a target="_blank" rel="noopener" href="https://blog.csdn.net/u010648194/article/details/126039337?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2~default~ESLANDING~default-4-126039337-blog-122556988.relrec_prioritylanding&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~ESLANDING~default-4-126039337-blog-122556988.relrec_prioritylanding&utm_relevant_index=5">Mysql orchestrator高可用_天道酬勤-明天会更好的博客-CSDN博客_mysql orchestrator</a></p>
</blockquote>
<h2 id="3-2-部署"><a href="#3-2-部署" class="headerlink" title="3.2 部署"></a>3.2 部署</h2><h4 id="a-集群规划"><a href="#a-集群规划" class="headerlink" title="a. 集群规划"></a>a. 集群规划</h4><table>
<thead>
<tr>
<th>IP地址</th>
<th>主机名</th>
<th>安装软件</th>
<th>数据库端口</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.51</td>
<td>db01</td>
<td>mysql、orchestrator</td>
<td>3306、3307</td>
</tr>
<tr>
<td>10.0.0.52</td>
<td>db02</td>
<td>mysql、orchestrator</td>
<td>3306、3307</td>
</tr>
<tr>
<td>10.0.0.53</td>
<td>db03</td>
<td>mysql、orchestrator</td>
<td>3306、3307</td>
</tr>
</tbody></table>
<pre><code> 根据以上表格安装软件、配置地址和主机名、初始化6个MySQL实例。 orch默认是用主机名来进行管理的，需要在mysql的配置文件里添加：report_host和report_port参 数。  
</code></pre>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 ~]# mysql -V</span><br><span class="line">mysql Ver 8.0.20 for Linux on x86<span class="emphasis">_64 (MySQL Community Server - GPL)</span></span><br><span class="line"><span class="emphasis">[root@db02 ~]# mysql -V</span></span><br><span class="line"><span class="emphasis">mysql Ver 8.0.20 for Linux on x86_</span>64 (MySQL Community Server - GPL)</span><br><span class="line">[root@db03 ~]# mysql -V</span><br><span class="line">mysql Ver 8.0.20 for Linux on x86<span class="emphasis">_64 (MySQL Community Server - GPL)</span></span><br><span class="line"><span class="emphasis">[root@db01 ~]# hostname</span></span><br><span class="line"><span class="emphasis">db01</span></span><br><span class="line"><span class="emphasis">[root@db01 ~]# cat /etc/hosts</span></span><br><span class="line"><span class="emphasis">127.0.0.1 localhost localhost.localdomain localhost4</span></span><br><span class="line"><span class="emphasis">localhost4.localdomain4</span></span><br><span class="line"><span class="emphasis">::1 localhost localhost.localdomain localhost6</span></span><br><span class="line"><span class="emphasis">localhost6.localdomain6</span></span><br><span class="line"><span class="emphasis">10.0.0.53 db03</span></span><br><span class="line"><span class="emphasis">10.0.0.52 db02</span></span><br><span class="line"><span class="emphasis">10.0.0.51 db01</span></span><br><span class="line"><span class="emphasis">[root@db02 ~]# cat /etc/hosts</span></span><br><span class="line"><span class="emphasis">127.0.0.1 localhost localhost.localdomain localhost4</span></span><br><span class="line"><span class="emphasis">localhost4.localdomain4</span></span><br><span class="line"><span class="emphasis">::1 localhost localhost.localdomain localhost6</span></span><br><span class="line"><span class="emphasis">localhost6.localdomain6</span></span><br><span class="line"><span class="emphasis">10.0.0.53 db03</span></span><br><span class="line"><span class="emphasis">10.0.0.52 db02</span></span><br><span class="line"><span class="emphasis">10.0.0.51 db01</span></span><br><span class="line"><span class="emphasis">[root@db03 ~]# cat /etc/hosts</span></span><br><span class="line"><span class="emphasis">127.0.0.1 localhost localhost.localdomain localhost4</span></span><br><span class="line"><span class="emphasis">localhost4.localdomain4</span></span><br><span class="line"><span class="emphasis">::1 localhost localhost.localdomain localhost6</span></span><br><span class="line"><span class="emphasis">localhost6.localdomain6</span></span><br><span class="line"><span class="emphasis">10.0.0.53 db03</span></span><br><span class="line"><span class="emphasis">10.0.0.52 db02</span></span><br><span class="line"><span class="emphasis">10.0.0.51 db01</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis"># 部署6个 MySQL实例</span></span><br><span class="line"><span class="emphasis">pkill mysqld</span></span><br><span class="line"><span class="emphasis">rm -rf /etc/my3306.cnf</span></span><br><span class="line"><span class="emphasis">rm -rf /data/3306/data /data/3306/binlog*</span></span><br><span class="line"><span class="emphasis">mkdir -p /data/3306/data /data/3306/binlog</span></span><br><span class="line"><span class="emphasis">mysqld --initialize-insecure --user=mysql --basedir=/data/app/mysql --</span></span><br><span class="line"><span class="emphasis">datadir=/data/3306/data</span></span><br><span class="line"><span class="emphasis">pkill mysqld</span></span><br><span class="line"><span class="emphasis">rm -rf /etc/my3307.cnf</span></span><br><span class="line"><span class="emphasis">rm -rf /data/3307/data /data/3307/binlog*</span></span><br><span class="line"><span class="emphasis">mkdir -p /data/3307/data /data/3307/binlog</span></span><br><span class="line"><span class="emphasis">mysqld --initialize-insecure --user=mysql --basedir=/data/app/mysql --</span></span><br><span class="line"><span class="emphasis">datadir=/data/3307/data</span></span><br><span class="line"><span class="emphasis">cat &gt; /etc/my3306.cnf &lt;<span class="language-xml"><span class="tag">&lt;<span class="name">EOF</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis">[<span class="attr">client</span>]</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">socket</span>=<span class="string">/tmp/mysql3306.sock</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis">[<span class="attr">mysqld</span>]</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">user</span>=<span class="string">mysql</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">basedir</span>=<span class="string">/data/app/mysql</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">datadir</span>=<span class="string">/data/3306/data</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">log_bin</span>=<span class="string">/data/3306/binlog/mysql-bin</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">server_id</span>=<span class="string">6</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">socket</span>=<span class="string">/tmp/mysql.sock</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">gtid_mode</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">enforce_gtid_consistency</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">master_info_repository</span>=<span class="string">TABLE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">relay_log_info_repository</span>=<span class="string">TABLE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">log_slave_updates</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">tmpdir</span> = <span class="string">/tmp</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">default-storage-engine</span>=<span class="string">INNODB</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">disabled_storage_engines</span> = <span class="string">MyISAM,BLACKHOLE,FEDERATED,CSV,ARCHIVE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">max_connections</span>=<span class="string">500</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">max_allowed_packet</span>=<span class="string">32M</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">default_authentication_plugin</span>=<span class="string">mysql_native_password</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">report_host</span>=<span class="string">10.0.0.51</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">report_port</span>=<span class="string">3306</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">mysqlx</span>=<span class="string">0</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">EOF</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">cat</span> &gt;</span></span> /etc/my3307.cnf &lt;<span class="language-xml"><span class="tag">&lt;<span class="name">EOF</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis">[<span class="attr">client</span>]</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">socket</span>=<span class="string">/tmp/mysql3307.sock</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis">[<span class="attr">mysqld</span>]</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">user</span>=<span class="string">mysql</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">basedir</span>=<span class="string">/data/app/mysql</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">datadir</span>=<span class="string">/data/3307/data</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">log_bin</span>=<span class="string">/data/3307/binlog/mysql-bin</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">server_id</span>=<span class="string">16</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">socket</span>=<span class="string">/tmp/mysql3307.sock</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">gtid_mode</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">enforce_gtid_consistency</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">master_info_repository</span>=<span class="string">TABLE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">relay_log_info_repository</span>=<span class="string">TABLE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">log_slave_updates</span>=<span class="string">ON</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">tmpdir</span> = <span class="string">/tmp</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">default-storage-engine</span>=<span class="string">INNODB</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">disabled_storage_engines</span> = <span class="string">MyISAM,BLACKHOLE,FEDERATED,CSV,ARCHIVE</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">max_connections</span>=<span class="string">500</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">max_allowed_packet</span>=<span class="string">32M</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">default_authentication_plugin</span>=<span class="string">mysql_native_password</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">report_host</span>=<span class="string">10.0.0.51</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">report_port</span>=<span class="string">3307</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">port</span>=<span class="string">3307</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">mysqlx</span>=<span class="string">0</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="emphasis"><span class="attr">EOF</span></span></span></span></span><br></pre></td></tr></table></figure>

<h4 id="b-获取软件和相关脚本"><a href="#b-获取软件和相关脚本" class="headerlink" title="b. 获取软件和相关脚本"></a>b. 获取软件和相关脚本</h4><p><code>https://github.com/openark/orchestrator/releases </code></p>
<p><code>https://github.com/theTibi/orchestrator_vip  </code></p>
<h4 id="c-安装软件"><a href="#c-安装软件" class="headerlink" title="c. 安装软件"></a>c. 安装软件</h4><p><code>yum install -y orchestrator-* </code></p>
<h4 id="d-配置orch-后端数据库及用户-所有3306节点"><a href="#d-配置orch-后端数据库及用户-所有3306节点" class="headerlink" title="d. 配置orch 后端数据库及用户(所有3306节点)"></a>d. 配置orch 后端数据库及用户(所有3306节点)</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE IF NOT EXISTS oldguo;</span><br><span class="line">CREATE USER &#x27;oldguo&#x27;@&#x27;127.0.0.1&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line">GRANT ALL ON oldguo.* TO &#x27;oldguo&#x27;@&#x27;127.0.0.1&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="e-配置被管理节点主从关系-3307"><a href="#e-配置被管理节点主从关系-3307" class="headerlink" title="e.配置被管理节点主从关系(3307)"></a>e.配置被管理节点主从关系(3307)</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 主库</span></span><br><span class="line">CREATE USER &#x27;repl&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line">GRANT replication slave on <span class="emphasis">*.*</span> TO &#x27;repl&#x27;@&#x27;%&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="section"># 从库</span></span><br><span class="line">change master to</span><br><span class="line">master<span class="emphasis">_host=&#x27;10.0.0.51&#x27;,master_</span>port=3307,master<span class="emphasis">_user=&#x27;repl&#x27;,master_</span>password</span><br><span class="line">=&#x27;123456&#x27;,master<span class="emphasis">_auto_</span>position=1,MASTER<span class="emphasis">_HEARTBEAT_</span>PERIOD=2,MASTER<span class="emphasis">_CONNECT_</span>R</span><br><span class="line">ETRY=1, MASTER<span class="emphasis">_RETRY_</span>COUNT=86400;</span><br><span class="line">start slave;</span><br><span class="line">set global slave<span class="emphasis">_net_</span>timeout=8;</span><br><span class="line">set global read<span class="emphasis">_only=1;</span></span><br><span class="line"><span class="emphasis">set global super_</span>read<span class="emphasis">_only=1;</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">#说明：</span></span><br><span class="line"><span class="emphasis">1、orch检测主库宕机依赖从库的IO线程。默认change master to时，</span></span><br><span class="line"><span class="emphasis">MASTER_</span>HEARTBEAT<span class="emphasis">_PERIOD过长，会导致切换判断过久。所以，需要修改</span></span><br><span class="line"><span class="emphasis">MASTER_</span>HEARTBEAT<span class="emphasis">_PERIOD 优化故障感知速度。</span></span><br><span class="line"><span class="emphasis">2、另外slave_</span>net<span class="emphasis">_timeout,参数定义了从库从主库获取数据等待的秒数，超过这个时间从库会主动</span></span><br><span class="line"><span class="emphasis">退出读取，中断连接，并尝试重连。</span></span><br></pre></td></tr></table></figure>

<h4 id="f-配置被管理节点用户"><a href="#f-配置被管理节点用户" class="headerlink" title="f. 配置被管理节点用户"></a>f. 配置被管理节点用户</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#x27;oldboy&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;Aa123456&#x27;;</span><br><span class="line">GRANT SUPER, PROCESS, REPLICATION SLAVE, RELOAD ON <span class="emphasis">*.*</span> TO &#x27;oldboy&#x27;@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON mysql.slave<span class="emphasis">_master_</span>info TO &#x27;oldboy&#x27;@&#x27;%&#x27;;</span><br><span class="line">GRANT SELECT ON meta.* TO &#x27;oldboy&#x27;@&#x27;%&#x27;;</span><br></pre></td></tr></table></figure>

<h4 id="g-orch配置文件定制"><a href="#g-orch配置文件定制" class="headerlink" title="g.orch配置文件定制"></a>g.orch配置文件定制</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> orchestrator<span class="literal">-sample</span>.conf.json /etc/orchestrator.conf.json</span><br><span class="line">vim /etc/orchestrator.conf.json</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;Debug&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;EnableSyslog&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;ListenAddress&quot;</span>: <span class="string">&quot;:3000&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologyUser&quot;</span>: <span class="string">&quot;orchestrator&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologyPassword&quot;</span>: <span class="string">&quot;Aa123456&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologyCredentialsConfigFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologySSLPrivateKeyFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologySSLCertFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologySSLCAFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologySSLSkipVerify&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;MySQLTopologyUseMutualTLS&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorHost&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorPort&quot;</span>: <span class="number">3306</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorDatabase&quot;</span>: <span class="string">&quot;orchestrator&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorUser&quot;</span>: <span class="string">&quot;orchestrator&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorPassword&quot;</span>: <span class="string">&quot;123456&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorCredentialsConfigFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorSSLPrivateKeyFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorSSLCertFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorSSLCAFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorSSLSkipVerify&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;MySQLOrchestratorUseMutualTLS&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;MySQLConnectTimeoutSeconds&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;MySQLTopologyReadTimeoutSeconds&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;MySQLDiscoveryReadTimeoutSeconds&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;DefaultInstancePort&quot;</span>: <span class="number">3306</span>,</span><br><span class="line"><span class="string">&quot;DiscoverByShowSlaveHosts&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;InstancePollSeconds&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;UnseenInstanceForgetHours&quot;</span>: <span class="number">240</span>,</span><br><span class="line"><span class="string">&quot;SnapshotTopologiesIntervalHours&quot;</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">&quot;InstanceBulkOperationsWaitTimeoutSeconds&quot;</span>: <span class="number">10</span>,</span><br><span class="line"><span class="string">&quot;HostnameResolveMethod&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line"><span class="string">&quot;MySQLHostnameResolveMethod&quot;</span>: <span class="string">&quot;@@hostname&quot;</span>,</span><br><span class="line"><span class="string">&quot;SkipBinlogServerUnresolveCheck&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;SkipMaxScaleCheck&quot;</span>:true,</span><br><span class="line"><span class="string">&quot;ExpiryHostnameResolvesMinutes&quot;</span>: <span class="number">60</span>,</span><br><span class="line"><span class="string">&quot;RejectHostnameResolvePattern&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;ReasonableReplicationLagSeconds&quot;</span>: <span class="number">10</span>,</span><br><span class="line"><span class="string">&quot;ProblemIgnoreHostnameFilters&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;VerifyReplicationFilters&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;ReasonableMaintenanceReplicationLagSeconds&quot;</span>: <span class="number">20</span>,</span><br><span class="line"><span class="string">&quot;CandidateInstanceExpireMinutes&quot;</span>: <span class="number">1440</span>,</span><br><span class="line"><span class="string">&quot;AuditLogFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AuditToSyslog&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;RemoveTextFromHostnameDisplay&quot;</span>: <span class="string">&quot;:3306&quot;</span>,</span><br><span class="line"><span class="string">&quot;ReadOnly&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AuthenticationMethod&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;HTTPAuthUser&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;HTTPAuthPassword&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AuthUserHeader&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;PowerAuthUsers&quot;</span>: [<span class="string">&quot;*&quot;</span>],</span><br><span class="line"><span class="string">&quot;ClusterNameToAlias&quot;</span>: &#123;<span class="string">&quot;127.0.0.1&quot;</span>: <span class="string">&quot;test suite&quot;</span>&#125;,</span><br><span class="line"><span class="string">&quot;SlaveLagQuery&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectClusterAliasQuery&quot;</span>: <span class="string">&quot;SELECT cluster_name FROM meta.cluster WHERE</span></span><br><span class="line"><span class="string">cluster_name = left(@@hostname,4) &quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectClusterDomainQuery&quot;</span>: <span class="string">&quot;SELECT cluster_domain FROM meta.cluster WHERE</span></span><br><span class="line"><span class="string">cluster_name = left(@@hostname,4) &quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectInstanceAliasQuery&quot;</span>: <span class="string">&quot;SELECT @@hostname as instance_alias&quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectPromotionRuleQuery&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectDataCenterQuery&quot;</span>: <span class="string">&quot;SELECT data_center FROM meta.cluster WHERE</span></span><br><span class="line"><span class="string">cluster_name = left(@@hostname,4) &quot;</span>,</span><br><span class="line"><span class="string">&quot;PhysicalEnvironmentPattern&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;PromotionIgnoreHostnameFilters&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;DetachLostReplicasAfterMasterFailover&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;DetectSemiSyncEnforcedQuery&quot;</span>: <span class="string">&quot;SELECT 0 AS semisync FROM DUAL WHERE NOT</span></span><br><span class="line"><span class="string">EXISTS (SELECT 1 FROM performance_schema.global_variables WHERE</span></span><br><span class="line"><span class="string">VARIABLE_NAME = &#x27;rpl_semi_sync_master_wait_no_slave&#x27; AND VARIABLE_VALUE =</span></span><br><span class="line"><span class="string">&#x27;ON&#x27;) UNION SELECT 1 FROM DUAL WHERE EXISTS (SELECT 1 FROM</span></span><br><span class="line"><span class="string">performance_schema.global_variables WHERE VARIABLE_NAME =</span></span><br><span class="line"><span class="string">&#x27;rpl_semi_sync_master_wait_no_slave&#x27; AND VARIABLE_VALUE = &#x27;ON&#x27;)&quot;</span>,</span><br><span class="line"><span class="string">&quot;ServeAgentsHttp&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AgentsServerPort&quot;</span>: <span class="string">&quot;:3001&quot;</span>,</span><br><span class="line"><span class="string">&quot;AgentsUseSSL&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AgentsUseMutualTLS&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AgentSSLSkipVerify&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AgentSSLPrivateKeyFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AgentSSLCertFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AgentSSLCAFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;AgentSSLValidOUs&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;UseSSL&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;UseMutualTLS&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;SSLSkipVerify&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;SSLPrivateKeyFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;SSLCertFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;SSLCAFile&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;SSLValidOUs&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;URLPrefix&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;StatusEndpoint&quot;</span>: <span class="string">&quot;/api/status&quot;</span>,</span><br><span class="line"><span class="string">&quot;StatusSimpleHealth&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;StatusOUVerify&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;AgentPollMinutes&quot;</span>: <span class="number">60</span>,</span><br><span class="line"><span class="string">&quot;UnseenAgentForgetHours&quot;</span>: <span class="number">6</span>,</span><br><span class="line"><span class="string">&quot;StaleSeedFailMinutes&quot;</span>: <span class="number">60</span>,</span><br><span class="line"><span class="string">&quot;SeedAcceptableBytesDiff&quot;</span>: <span class="number">8192</span>,</span><br><span class="line"><span class="string">&quot;AutoPseudoGTID&quot;</span>:true,</span><br><span class="line"><span class="string">&quot;PseudoGTIDPattern&quot;</span>: <span class="string">&quot;drop view if exists</span></span><br><span class="line"><span class="string">`meta`.`_pseudo_gtid_hint__asc:&quot;</span>,</span><br><span class="line"><span class="string">&quot;PseudoGTIDPatternIsFixedSubstring&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;PseudoGTIDMonotonicHint&quot;</span>: <span class="string">&quot;asc:&quot;</span>,</span><br><span class="line"><span class="string">&quot;DetectPseudoGTIDQuery&quot;</span>: <span class="string">&quot;select count(*) as pseudo_gtid_exists from</span></span><br><span class="line"><span class="string">meta.pseudo_gtid_status where anchor = 1 and time_generated &gt; now() -</span></span><br><span class="line"><span class="string">interval 2 hour&quot;</span>,</span><br><span class="line"><span class="string">&quot;BinlogEventsChunkSize&quot;</span>: <span class="number">10000</span>,</span><br><span class="line"><span class="string">&quot;SkipBinlogEventsContaining&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;ReduceReplicationAnalysisCount&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;FailureDetectionPeriodBlockMinutes&quot;</span>: <span class="number">60</span>,</span><br><span class="line"><span class="string">&quot;RecoveryPeriodBlockSeconds&quot;</span>: <span class="number">31</span>,</span><br><span class="line"><span class="string">&quot;RecoveryIgnoreHostnameFilters&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;RecoverMasterClusterFilters&quot;</span>: [<span class="string">&quot;*&quot;</span>],</span><br><span class="line"><span class="string">&quot;RecoverIntermediateMasterClusterFilters&quot;</span>: [<span class="string">&quot;*&quot;</span>],</span><br><span class="line"><span class="string">&quot;OnFailureDetectionProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Detected &#123;failureType&#125; on</span></span><br><span class="line"><span class="string">&#123;failureCluster&#125;. Affected replicas: &#123;countSlaves&#125;&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PreGracefulTakeoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Planned takeover about to take</span></span><br><span class="line"><span class="string">place on &#123;failureCluster&#125;. Master will switch to read_only&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PreFailoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Will recover from &#123;failureType&#125; on</span></span><br><span class="line"><span class="string">&#123;failureCluster&#125;&#x27; &gt;&gt; /tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostFailoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; (for all types) Recovered from</span></span><br><span class="line"><span class="string">&#123;failureType&#125; on &#123;failureCluster&#125;. Failed: &#123;failedHost&#125;:&#123;failedPort&#125;;</span></span><br><span class="line"><span class="string">Successor: &#123;successorHost&#125;:&#123;successorPort&#125;; failureClusterAlias:</span></span><br><span class="line"><span class="string">&#123;failureClusterAlias&#125;&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>,<span class="string">&quot;/usr/local/orchestrator/orch_hook.sh &#123;failureType&#125;</span></span><br><span class="line"><span class="string">&#123;failureClusterAlias&#125; &#123;failedHost&#125; &#123;successorHost&#125; &gt;&gt; /tmp/orch.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostUnsuccessfulFailoverProcesses&quot;</span>: [ <span class="string">&quot;echo &#x27; Unsuccessful Failover &#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostMasterFailoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Recovered from &#123;failureType&#125; on</span></span><br><span class="line"><span class="string">&#123;failureCluster&#125;. Failed: &#123;failedHost&#125;:&#123;failedPort&#125;; Promoted:</span></span><br><span class="line"><span class="string">&#123;successorHost&#125;:&#123;successorPort&#125;&#x27; &gt;&gt;/tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostIntermediateMasterFailoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Recovered from</span></span><br><span class="line"><span class="string">&#123;failureType&#125; on &#123;failureCluster&#125;. Failed: &#123;failedHost&#125;:&#123;failedPort&#125;;</span></span><br><span class="line"><span class="string">Successor: &#123;successorHost&#125;:&#123;successorPort&#125;&#x27; &gt;&gt; /tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostGracefulTakeoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; Planned takeover complete&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;CoMasterRecoveryMustPromoteOtherCoMaster&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;DetachLostSlavesAfterMasterFailover&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;ApplyMySQLPromotionAfterMasterFailover&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;PreventCrossDataCenterMasterFailover&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;MasterFailoverDetachSlaveMasterHost&quot;</span>: false,</span><br><span class="line"><span class="string">&quot;MasterFailoverLostInstancesDowntimeMinutes&quot;</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">&quot;PostponeSlaveRecoveryOnLagMinutes&quot;</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">&quot;OSCIgnoreHostnameFilters&quot;</span>: [],</span><br><span class="line"><span class="string">&quot;GraphiteAddr&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;GraphitePath&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;GraphiteConvertHostnameDotsToUnderscores&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;RaftEnabled&quot;</span>: true,</span><br><span class="line"><span class="string">&quot;BackendDB&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line"><span class="string">&quot;RaftBind&quot;</span>: <span class="string">&quot;10.0.0.51&quot;</span>,</span><br><span class="line"><span class="string">&quot;RaftDataDir&quot;</span>: <span class="string">&quot;/usr/local/orchestrator&quot;</span>,</span><br><span class="line"><span class="string">&quot;DefaultRaftPort&quot;</span>: <span class="number">10008</span>,</span><br><span class="line"><span class="string">&quot;RaftNodes&quot;</span>: [<span class="string">&quot;10.0.0.51&quot;</span>,<span class="string">&quot;10.0.0.52&quot;</span>,<span class="string">&quot;10.0.0.53&quot;</span>],</span><br><span class="line"><span class="string">&quot;ConsulAddress&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;ConsulAclToken&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="h-启动orch"><a href="#h-启动orch" class="headerlink" title="h.启动orch"></a>h.启动orch</h4><p><code> cd /usr/local/orchestrator &amp;&amp; nohup ./orchestrator -- config=/etc/orchestrator.conf.json http &amp;</code>  </p>
<h4 id="i-配置自动切换脚本"><a href="#i-配置自动切换脚本" class="headerlink" title="i.配置自动切换脚本"></a>i.配置自动切换脚本</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;PostFailoverProcesses&quot;</span>: [<span class="string">&quot;echo &#x27; (for all types) Recovered from</span></span><br><span class="line"><span class="string">&#123;failureType&#125; on &#123;failureCluster&#125;. Failed: &#123;failedHost&#125;:&#123;failedPort&#125;;</span></span><br><span class="line"><span class="string">Successor: &#123;successorHost&#125;:&#123;successorPort&#125;; failureClusterAlias:</span></span><br><span class="line"><span class="string">&#123;failureClusterAlias&#125;&#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>,<span class="string">&quot;/usr/local/orchestrator/orch_hook.sh &#123;failureType&#125;</span></span><br><span class="line"><span class="string">&#123;failureClusterAlias&#125; &#123;failedHost&#125; &#123;successorHost&#125; &gt;&gt; /tmp/orch.log&quot;</span>],</span><br><span class="line"><span class="string">&quot;PostUnsuccessfulFailoverProcesses&quot;</span>: [ <span class="string">&quot;echo &#x27; Unsuccessful Failover &#x27; &gt;&gt;</span></span><br><span class="line"><span class="string">/tmp/recovery.log&quot;</span>],</span><br></pre></td></tr></table></figure>

<h4 id="j-免交互管理orch"><a href="#j-免交互管理orch" class="headerlink" title="j. 免交互管理orch"></a>j. 免交互管理orch</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> clusters</span><br><span class="line"><span class="comment"># 手工发现节点</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> discover <span class="literal">-i</span> db01:<span class="number">3307</span></span><br><span class="line"><span class="comment"># 忘记节点</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> forget <span class="literal">-i</span> db01:<span class="number">3307</span></span><br><span class="line"><span class="comment"># 查看集群拓扑</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> topology<span class="literal">-tabulated</span> <span class="literal">-i</span> db03:<span class="number">3307</span></span><br><span class="line"><span class="comment"># 手工切换主从关系</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> graceful<span class="literal">-master-takeover</span> <span class="literal">-a</span> db03:<span class="number">3307</span> <span class="literal">-d</span> db01:<span class="number">3307</span></span><br><span class="line"><span class="comment"># 调整主从拓扑</span></span><br><span class="line">orchestrator<span class="literal">-client</span> <span class="literal">-c</span> relocate <span class="literal">-i</span> db03:<span class="number">3307</span> <span class="literal">-d</span> db01:<span class="number">3307</span></span><br></pre></td></tr></table></figure>

<h1 id="4-InnoDB-Cluster-应用"><a href="#4-InnoDB-Cluster-应用" class="headerlink" title="4. InnoDB Cluster 应用"></a>4. InnoDB Cluster 应用</h1><h2 id="4-1-介绍"><a href="#4-1-介绍" class="headerlink" title="4.1 介绍"></a>4.1 介绍</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL InnoDB集群提供了一个集成的，本地的，HA解决方案。Mysq Innodb Cluster是利用组复制</span><br><span class="line">的 pxos 协议，保障数据一致性，组复制支持单主模式和多主模式。</span><br><span class="line">MySQL InnoDB集群由以下几部分组成：</span><br><span class="line">- MySQL Servers with <span class="built_in">Group</span> Replication：向集群的所有成员复制数据，同时提供容错、自</span><br><span class="line">动故障转移和弹性。MySQL Server <span class="number">5.7</span>.<span class="number">17</span>或更高的版本。</span><br><span class="line">- MySQL Router：确保客户端请求是负载平衡的，并在任何数据库故障时路由到正确的服务器。</span><br><span class="line">MySQL Router <span class="number">2.1</span>.<span class="number">3</span>或更高的版本。</span><br><span class="line">- MySQL Shell：通过内置的管理API创建及管理Innodb集群。MySQL Shell <span class="number">1.0</span>.<span class="number">9</span>或更高的版</span><br><span class="line">本。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218330238-24640bac-ff31-41eb-8fb4-f9d3c8a2fa5a.png"></p>
<h2 id="4-2-构建过程"><a href="#4-2-构建过程" class="headerlink" title="4.2 构建过程"></a>4.2 构建过程</h2><h3 id="4-2-1主机-规划列表"><a href="#4-2-1主机-规划列表" class="headerlink" title="4.2.1主机 规划列表"></a>4.2.1主机 规划列表</h3><table>
<thead>
<tr>
<th>IP</th>
<th>HOSTNAME</th>
<th>主机角色</th>
<th>安装软件</th>
</tr>
</thead>
<tbody><tr>
<td>10.0.0.151</td>
<td>master</td>
<td>mic-master</td>
<td>mysql、mysqlsh</td>
</tr>
<tr>
<td>10.0.0.152</td>
<td>slave1</td>
<td>mic-slave1</td>
<td>mysql、mysqlsh</td>
</tr>
<tr>
<td>10.0.0.153</td>
<td>slave2</td>
<td>mic-slave2</td>
<td>mysql、mysqlsh</td>
</tr>
<tr>
<td>10.0.0.154</td>
<td>manager</td>
<td>mic-manager</td>
<td>mysqlsh、mysql-router</td>
</tr>
</tbody></table>
<h3 id="4-2-2-准备MIC基础环境"><a href="#4-2-2-准备MIC基础环境" class="headerlink" title="4.2.2 准备MIC基础环境"></a>4.2.2 准备MIC基础环境</h3><blockquote>
<p><em><strong><font style="color:#E8323C;">准备三台虚拟机并上传软件  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 按照规划列表，将所有软件解压。</span></span><br><span class="line">tar xf mysql<span class="literal">-8</span>.<span class="number">0.20</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86_64</span>.tar.xz</span><br><span class="line">tar xf mysql<span class="literal">-shell-8</span>.<span class="number">0.21</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86-64bit</span>.tar.gz</span><br><span class="line">tar xf mysql<span class="literal">-router-8</span>.<span class="number">0.21</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86_64</span>.tar.xz</span><br><span class="line">ln <span class="literal">-s</span> mysql<span class="literal">-8</span>.<span class="number">0.20</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86_64</span> mysql</span><br><span class="line">ln <span class="literal">-s</span> mysql<span class="literal">-shell-8</span>.<span class="number">0.21</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86-64bit</span>.tar.gz mysqlsh</span><br><span class="line">ln <span class="literal">-s</span> mysql<span class="literal">-shell-8</span>.<span class="number">0.21</span><span class="literal">-linux-glibc2</span>.<span class="number">12</span><span class="literal">-x86-64bit</span>.tar.gz mysql<span class="literal">-router</span></span><br><span class="line"><span class="comment"># 配置环境遍变量</span></span><br><span class="line">export PATH=/<span class="keyword">data</span>/app/mysql/bin:/<span class="keyword">data</span>/app/mysqlsh/bin:/<span class="keyword">data</span>/app/mysqlrouter/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="comment"># 按照规划列表，将所有主机名和hosts文件全部解析。</span></span><br><span class="line"><span class="built_in">cat</span> /etc/hosts</span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span> localhost localhost.localdomain localhost4</span><br><span class="line">localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span> localhost localhost.localdomain localhost6</span><br><span class="line">localhost6.localdomain6</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.151</span> master</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.152</span> slave1</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.153</span> slave2</span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.154</span> manage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将所有节点Firewalld和SELINUX关闭。</span></span><br><span class="line">略。</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong><font style="color:#E8323C;">准备三台数据库节点（151、152、153）</font></strong><font style="color:#E8323C;"> </font> </p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#清理环境，并重新初始化数据</span></span><br><span class="line">pkill mysqld</span><br><span class="line">pkill mysqlsh</span><br><span class="line"><span class="built_in">rm</span> <span class="literal">-rf</span> /<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span> /<span class="keyword">data</span>/<span class="number">3306</span>/binlog*</span><br><span class="line">mkdir /<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span> /<span class="keyword">data</span>/<span class="number">3306</span>/binlog</span><br><span class="line">mysqld <span class="literal">--initialize-insecure</span> <span class="literal">--user</span>=mysql <span class="literal">--basedir</span>=/<span class="keyword">data</span>/app/mysql <span class="literal">--</span></span><br><span class="line">datadir=/<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span></span><br><span class="line"><span class="comment">#配置文件准备</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## master节点</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">master</span> <span class="type">app</span>]<span class="comment"># cat &gt; /etc/my.cnf &lt;&lt;EOF</span></span><br><span class="line">[<span class="type">client</span>]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[<span class="type">mysqld</span>]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/<span class="keyword">data</span>/app/mysql</span><br><span class="line">datadir=/<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span></span><br><span class="line">log_bin=/<span class="keyword">data</span>/<span class="number">3306</span>/binlog</span><br><span class="line">server_id=<span class="number">151</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">tmpdir = /tmp</span><br><span class="line">default<span class="literal">-storage-engine</span>=INNODB</span><br><span class="line">disabled_storage_engines = MyISAM,BLACKHOLE,FEDERATED,CSV,ARCHIVE</span><br><span class="line">max_connections=<span class="number">500</span></span><br><span class="line">max_allowed_packet=<span class="number">32</span>M</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose<span class="literal">-group_replication_group_name</span>=<span class="string">&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_start_on_boot</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_local_address</span>= <span class="string">&quot;master:33061&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_group_seeds</span>=</span><br><span class="line"><span class="string">&quot;master:33061,slave1:33062,slave2:33063&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_bootstrap_group</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_ip_whitelist</span>=<span class="string">&quot;master,slave1,slave2,manager&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">## slave1 节点</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">slave1</span> <span class="type">data</span>]<span class="comment"># cat &gt;/etc/my.cnf &lt;&lt;EOF</span></span><br><span class="line">[<span class="type">client</span>]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[<span class="type">mysqld</span>]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/<span class="keyword">data</span>/app/mysql</span><br><span class="line">datadir=/<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span></span><br><span class="line">log_bin=/<span class="keyword">data</span>/<span class="number">3306</span>/binlog</span><br><span class="line">server_id=<span class="number">152</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">tmpdir = /tmp</span><br><span class="line">default<span class="literal">-storage-engine</span>=INNODB</span><br><span class="line">disabled_storage_engines = MyISAM,BLACKHOLE,FEDERATED,CSV,ARCHIVE</span><br><span class="line">max_connections=<span class="number">500</span></span><br><span class="line">max_allowed_packet=<span class="number">16</span>M</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose<span class="literal">-group_replication_group_name</span>=<span class="string">&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_start_on_boot</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_local_address</span>= <span class="string">&quot;slave1:33062&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_group_seeds</span>=</span><br><span class="line"><span class="string">&quot;master:33061,slave1:33062,slave2:33063&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_bootstrap_group</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_ip_whitelist</span>=<span class="string">&quot;master,slave1,slave2,manager&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_allow_local_disjoint_gtids_join</span>=ON</span><br><span class="line">[<span class="type">root</span>@<span class="type">slave1</span> <span class="type">data</span>]<span class="comment">#</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">## slave2 节点</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">slave2</span> <span class="type">data</span>]<span class="comment"># cat &gt; /etc/my.cnf &lt;&lt;EOF</span></span><br><span class="line">[<span class="type">client</span>]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[<span class="type">mysqld</span>]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/<span class="keyword">data</span>/app/mysql</span><br><span class="line">datadir=/<span class="keyword">data</span>/<span class="number">3306</span>/<span class="keyword">data</span></span><br><span class="line">log_bin=/<span class="keyword">data</span>/<span class="number">3306</span>/binlog</span><br><span class="line">server_id=<span class="number">153</span></span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">tmpdir = /tmp</span><br><span class="line">default<span class="literal">-storage-engine</span>=INNODB</span><br><span class="line">disabled_storage_engines = MyISAM,BLACKHOLE,FEDERATED,CSV,ARCHIVE</span><br><span class="line">max_connections=<span class="number">200</span></span><br><span class="line">max_allowed_packet=<span class="number">16</span>M</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose<span class="literal">-group_replication_group_name</span>=<span class="string">&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_start_on_boot</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_local_address</span>= <span class="string">&quot;slave2:33063&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_group_seeds</span>=</span><br><span class="line"><span class="string">&quot;master:33061,slave1:33062,slave2:33063&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_bootstrap_group</span>=OFF</span><br><span class="line">loose<span class="literal">-group_replication_ip_whitelist</span>=<span class="string">&quot;master,slave1,slave2,manager&quot;</span></span><br><span class="line">loose<span class="literal">-group_replication_allow_local_disjoint_gtids_join</span>=ON</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-所有数据库节点初始化集群实例"><a href="#4-2-3-所有数据库节点初始化集群实例" class="headerlink" title="4.2.3 所有数据库节点初始化集群实例"></a>4.2.3 所有数据库节点初始化集群实例</h3><blockquote>
<p><em><strong><font style="color:#E8323C;"> 设置root@’localhost’密码  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter user root<span class="string">@&#x27;localhost&#x27; identified with mysql_native_password by</span></span><br><span class="line"><span class="string">&#x27;123&#x27;;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><em><strong><font style="color:#E8323C;"> 初始化配置集群实例  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysqlsh</span><br><span class="line">mysql<span class="literal">-js</span>&gt; shell.connect(<span class="string">&#x27;root@localhost:3306&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; dba.configureLocalInstance(); <span class="comment">#见下图。</span></span><br><span class="line">mysql<span class="literal">-js</span>&gt; dba.checkInstanceConfiguration(<span class="string">&quot;root@localhost:3306&quot;</span>);<span class="comment"># 见下图。</span></span><br></pre></td></tr></table></figure>

<pre><code>           ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218754065-3fbd608d-870b-47c0-8110-74098c19ca69.png)

          ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218768038-615966d9-ecbc-47f5-84b6-6b8aef49fe19.png)
</code></pre>
<h3 id="4-2-4-创建集群并添加节点（154）"><a href="#4-2-4-创建集群并添加节点（154）" class="headerlink" title="4.2.4 创建集群并添加节点（154）"></a>4.2.4 创建集群并添加节点（154）</h3><blockquote>
<p><em><strong><font style="color:#E8323C;"> 创建集群并添加主节点  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysqlsh</span><br><span class="line">mysql<span class="literal">-js</span>&gt; shell.connect(<span class="string">&#x27;root@master:3306&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; var cluster = dba.createCluster(<span class="string">&#x27;oldguo&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; cluster.status();</span><br></pre></td></tr></table></figure>

<pre><code>       ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218825275-df2b5e2a-957d-4184-bd3b-92b05825d5ad.png)

       ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218843093-31c7ccce-07d7-4016-b7db-6db654769d73.png)
</code></pre>
<blockquote>
<p><em><strong><font style="color:#E8323C;">添加slave1\slave2节点  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysqlsh</span><br><span class="line">mysql<span class="literal">-js</span>&gt; shell.connect(<span class="string">&#x27;root@master:3306&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; var cluster = dba.getCluster(<span class="string">&#x27;oldguo&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; cluster.addInstance(<span class="string">&#x27;root@slave1:3306&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; cluster.addInstance(<span class="string">&#x27;root@slave2:3306&#x27;</span>);</span><br><span class="line">mysql<span class="literal">-js</span>&gt; cluster.status();</span><br></pre></td></tr></table></figure>

<pre><code>     ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218888036-addddda1-df0e-4d16-9b87-686d431609f9.png)

    ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218899554-fc49b44c-1f76-427a-a5d7-11b7655972d9.png)
</code></pre>
<blockquote>
<p><em><strong><font style="color:#E8323C;">配置启动 mysql-router（154）  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册router到集群，生成myrouter目录, 并生成启动程序和配置文件.</span></span><br><span class="line">mysqlrouter <span class="literal">--bootstrap</span> root@master:<span class="number">3306</span> <span class="literal">-d</span> myrouter <span class="literal">--user</span>=root</span><br><span class="line"><span class="comment"># 启动myrouter</span></span><br><span class="line">myrouter/start.sh</span><br></pre></td></tr></table></figure>

<pre><code>        ![](https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1662218928961-7a72ce01-05cb-4037-a85e-c5c547234d2e.png)
</code></pre>
<blockquote>
<p><em><strong><font style="color:#E8323C;"> 验证连接router  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a) 管理节点本机mysql<span class="literal">-shell</span>连接:</span><br><span class="line">mysqlsh <span class="literal">--uri</span> root@localhost:<span class="number">6446</span></span><br><span class="line">b) 管理节点本机mysql连接:</span><br><span class="line">mysql <span class="literal">-u</span> root <span class="literal">-h</span> <span class="number">127.0</span>.<span class="number">0.1</span> <span class="literal">-P</span> <span class="number">6446</span> <span class="literal">-p</span></span><br><span class="line">c) 远程客户机通过route连接mysql</span><br><span class="line">mysql <span class="literal">-u</span> root <span class="literal">-h</span> manager_ip <span class="literal">-P</span> <span class="number">6446</span> <span class="literal">-p</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><em><strong><font style="color:#E8323C;"> 验证cluster集群  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.登陆后，新建一个表，往里面写进数据，查看从节点数据会不会同步；</span><br><span class="line"><span class="number">2</span>.关闭master的mysql服务，route将主节点自动切换到slave1，slave1从只读变为可读写，重新启</span><br><span class="line">动master mysql后，master变为只读模式。</span><br><span class="line"><span class="number">3</span>. 验证读写分离功能</span><br></pre></td></tr></table></figure>

<blockquote>
<p><em><strong><font style="color:#E8323C;"> 可能遇到的问题  </font></strong></em></p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">主节点：</span><br><span class="line">mysqlshell 清空集群</span><br><span class="line">dba.dropMetadataSchema()</span><br><span class="line">mysql&gt; stop group_replication;</span><br><span class="line">mysql&gt; reset master; （清空日志，确保和从库的表没有冲突奥，）</span><br><span class="line">mysql&gt; reset slave</span><br><span class="line">其他节点(主要清理和主库的主从信息， 确保主库和从库的表没有冲突奥)</span><br><span class="line">mysql&gt; stop group_replication;</span><br><span class="line">mysql&gt; reset master;</span><br><span class="line">mysql&gt; reset slave</span><br></pre></td></tr></table></figure>

<h2 id="4-3-MIC集群常用管理命令汇总"><a href="#4-3-MIC集群常用管理命令汇总" class="headerlink" title="4.3 MIC集群常用管理命令汇总"></a>4.3 MIC集群常用管理命令汇总</h2><h3 id="4-3-1-信息查询"><a href="#4-3-1-信息查询" class="headerlink" title="4.3.1 信息查询"></a>4.3.1 信息查询</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查节点是否符合集群标准</span></span><br><span class="line">dba.checkInstanceConfiguration()</span><br><span class="line"><span class="comment"># 集群结构信息描述</span></span><br><span class="line">cluster.describe()</span><br><span class="line"><span class="comment"># 集群状态总览</span></span><br><span class="line">cluster.status()</span><br><span class="line"><span class="comment"># 查看集群名字</span></span><br><span class="line">dba.getCluster();</span><br><span class="line"><span class="comment">#查看router信息</span></span><br><span class="line">cluster.listRouters()</span><br></pre></td></tr></table></figure>

<h3 id="4-3-2-集群创建及节点管理"><a href="#4-3-2-集群创建及节点管理" class="headerlink" title="4.3.2 集群创建及节点管理"></a>4.3.2 集群创建及节点管理</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dba.createCluster()</span></span><br><span class="line">例：</span><br><span class="line">var cluster = dba.createCluster(<span class="string">&#x27;oldguo&#x27;</span>);</span><br><span class="line"><span class="comment"># Cluster.addInstance()</span></span><br><span class="line">例：</span><br><span class="line">cluster.addInstance(<span class="string">&#x27;root@slave1:3306&#x27;</span>);</span><br><span class="line"><span class="comment"># Cluster.removeInstance()</span></span><br><span class="line">例：</span><br><span class="line">cluster.removeInstance(<span class="string">&#x27;root@slave1:3306&#x27;</span>);</span><br><span class="line"><span class="comment"># Cluster.rejoinInstance()</span></span><br><span class="line">如果实例离开集群，比如丢失连接，并且没有自动重新加入集群。可以通过</span><br><span class="line">cluster.rejoinInstance()方法将实例重新加入到集群中。</span><br><span class="line"><span class="comment"># Cluster.setPrimaryInstance(instance)</span></span><br><span class="line">在线切换primary 实例。</span><br><span class="line"></span><br><span class="line">例：</span><br><span class="line">cluster.setPrimaryInstance(<span class="string">&#x27;root@slave1:3306&#x27;</span>)</span><br><span class="line">cluster.status()</span><br><span class="line">cluster.setPrimaryInstance(<span class="string">&#x27;root@master:3306&#x27;</span>)</span><br><span class="line"><span class="comment"># cluster.switchToMultiPrimaryMode()</span></span><br><span class="line">切换为多primary模式。</span><br><span class="line"><span class="comment"># cluster.switchToSinglePrimaryMode(&#x27;root@master:3306&#x27;)</span></span><br><span class="line">切换为单primary模式。</span><br><span class="line">注：在切换为多 primary 模式后，<span class="number">6447</span>端口（默认只读）接收读写，并且可通过该端口访问所有集</span><br><span class="line">群成员。而<span class="number">6446</span>端口（默认读写）只能连接到其中一个成员（之前的primary成员）。</span><br></pre></td></tr></table></figure>

<h3 id="4-3-3-集群故障处理"><a href="#4-3-3-集群故障处理" class="headerlink" title="4.3.3 集群故障处理"></a>4.3.3 集群故障处理</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dba.rebootClusterFromCompleteOutage()</span></span><br><span class="line">用于在集群完全断电后重新配置集群。如果dba.rebootClusterFromCompleteOutage() 方法失</span><br><span class="line">败，可以通过一下方式删除所有集群元数据。</span><br><span class="line"><span class="comment"># dba.dropMetadataSchema()</span></span><br><span class="line">删除集群元数据，然后dba.createCluster() 重建集群。</span><br><span class="line"><span class="comment">#删除已注册的router</span></span><br><span class="line">Cluster.removeRouterMetadata(router)</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
              <a href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/" rel="tag"><i class="fa fa-tag"></i> 高可用</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/07/15/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E3%80%81%E5%A4%87%20%E4%BB%BD%E3%80%81%E6%81%A2%E5%A4%8D%E3%80%81%E8%BF%81%E7%A7%BB/" rel="prev" title="日志管理、备 份、恢复、迁移">
      <i class="fa fa-chevron-left"></i> 日志管理、备 份、恢复、迁移
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/15/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%B8%8A/" rel="next" title="分布式架构上">
      分布式架构上 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">什么是高可用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%B9%E7%81%BE%E7%BA%A7%E5%88%AB"><span class="nav-number">2.</span> <span class="nav-text">数据库容灾级别</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF"><span class="nav-number">3.</span> <span class="nav-text">1. MHA高可用技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-MHA%E8%BD%AF%E4%BB%B6%E7%BB%93%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.</span> <span class="nav-text">1.1 MHA软件结构介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E5%BA%94%E7%94%A8%E9%80%8F%E6%98%8E%E2%80%94VIP"><span class="nav-number">3.2.</span> <span class="nav-text">1.2 应用透明—VIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%95%85%E9%9A%9C%E6%8F%90%E9%86%92%E5%8A%9F%E8%83%BD"><span class="nav-number">3.3.</span> <span class="nav-text">1.3 故障提醒功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-%E6%95%85%E9%9A%9C%E5%A6%82%E4%BD%95%E5%8D%8A%E8%87%AA%E6%84%88%EF%BC%9F"><span class="nav-number">3.3.1.</span> <span class="nav-text">1.3.1 故障如何半自愈？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-%E6%97%A5%E5%BF%97%E8%A1%A5%E5%81%BF%E7%9A%84%E5%86%97%E4%BD%99%E6%96%B9%E6%A1%88%E2%80%93binlog-server"><span class="nav-number">3.4.</span> <span class="nav-text">1.4 日志补偿的冗余方案–binlog_server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-MHA%E7%9A%84%E7%BB%B4%E6%8A%A4%E6%93%8D%E4%BD%9C-%E5%9C%A8%E7%BA%BF%E5%88%87%E6%8D%A2%E5%8A%9F%E8%83%BD"><span class="nav-number">3.5.</span> <span class="nav-text">1.5 MHA的维护操作 - 在线切换功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-MHA%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E8%84%91%E8%A3%82"><span class="nav-number">3.6.</span> <span class="nav-text">1.6 MHA如何防止脑裂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-MHA%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="nav-number">3.7.</span> <span class="nav-text">1.7 MHA的数据一致性保证</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-ProxySQL%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">4.</span> <span class="nav-text">2. ProxySQL中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">2.1 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%AE%89%E8%A3%85ProxySQL"><span class="nav-number">4.2.</span> <span class="nav-text">2. 2 安装ProxySQL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-ProxySQL%E4%B8%AD%E7%AE%A1%E7%90%86%E7%BB%93%E6%9E%84"><span class="nav-number">4.3.</span> <span class="nav-text">2.3 ProxySQL中管理结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL-%E8%87%AA%E5%B8%A6%E7%B3%BB%E7%BB%9F%E5%BA%93%E4%BF%A1%E6%81%AF"><span class="nav-number">4.3.0.1.</span> <span class="nav-text">ProxySQL  自带系统库信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL-%E7%AE%A1%E7%90%86%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%A4%9A%E5%B1%82%E9%85%8D%E7%BD%AE%E5%85%B3%E7%B3%BB"><span class="nav-number">4.3.0.2.</span> <span class="nav-text">ProxySQL  管理接口的多层配置关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL-%E5%9C%A8%E4%B8%8D%E5%90%8C%E5%B1%82%E6%AC%A1%E9%97%B4%E7%A7%BB%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.0.3.</span> <span class="nav-text">ProxySQL  在不同层次间移动配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-ProxySQL%E5%BA%94%E7%94%A8%E2%80%94%E2%80%94%E5%9F%BA%E4%BA%8ESQL%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-number">4.4.</span> <span class="nav-text">2.4  ProxySQL应用——基于SQL的读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-ProxySQL%E5%BA%94%E7%94%A8%E6%89%A9%E5%B1%95%E2%80%94%E2%80%94%E8%8A%B1%E5%BC%8F%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99"><span class="nav-number">4.4.1.</span> <span class="nav-text">2.5 ProxySQL应用扩展——花式路由规则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-ORCH%E5%8F%AF%E8%A7%86%E5%8C%96%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E5%BA%94%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">3. ORCH可视化高可用集群应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-ORCH%E4%BB%8B%E7%BB%8D"><span class="nav-number">5.1.</span> <span class="nav-text">3.1 ORCH介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E9%83%A8%E7%BD%B2"><span class="nav-number">5.2.</span> <span class="nav-text">3.2 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="nav-number">5.2.0.1.</span> <span class="nav-text">a. 集群规划</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E8%8E%B7%E5%8F%96%E8%BD%AF%E4%BB%B6%E5%92%8C%E7%9B%B8%E5%85%B3%E8%84%9A%E6%9C%AC"><span class="nav-number">5.2.0.2.</span> <span class="nav-text">b. 获取软件和相关脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="nav-number">5.2.0.3.</span> <span class="nav-text">c. 安装软件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E9%85%8D%E7%BD%AEorch-%E5%90%8E%E7%AB%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8A%E7%94%A8%E6%88%B7-%E6%89%80%E6%9C%893306%E8%8A%82%E7%82%B9"><span class="nav-number">5.2.0.4.</span> <span class="nav-text">d. 配置orch 后端数据库及用户(所有3306节点)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E9%85%8D%E7%BD%AE%E8%A2%AB%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E4%B8%BB%E4%BB%8E%E5%85%B3%E7%B3%BB-3307"><span class="nav-number">5.2.0.5.</span> <span class="nav-text">e.配置被管理节点主从关系(3307)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-%E9%85%8D%E7%BD%AE%E8%A2%AB%E7%AE%A1%E7%90%86%E8%8A%82%E7%82%B9%E7%94%A8%E6%88%B7"><span class="nav-number">5.2.0.6.</span> <span class="nav-text">f. 配置被管理节点用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#g-orch%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%AE%9A%E5%88%B6"><span class="nav-number">5.2.0.7.</span> <span class="nav-text">g.orch配置文件定制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#h-%E5%90%AF%E5%8A%A8orch"><span class="nav-number">5.2.0.8.</span> <span class="nav-text">h.启动orch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#i-%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%E8%84%9A%E6%9C%AC"><span class="nav-number">5.2.0.9.</span> <span class="nav-text">i.配置自动切换脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#j-%E5%85%8D%E4%BA%A4%E4%BA%92%E7%AE%A1%E7%90%86orch"><span class="nav-number">5.2.0.10.</span> <span class="nav-text">j. 免交互管理orch</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-InnoDB-Cluster-%E5%BA%94%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">4. InnoDB Cluster 应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">4.1 介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">6.2.</span> <span class="nav-text">4.2 构建过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1%E4%B8%BB%E6%9C%BA-%E8%A7%84%E5%88%92%E5%88%97%E8%A1%A8"><span class="nav-number">6.2.1.</span> <span class="nav-text">4.2.1主机 规划列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E5%87%86%E5%A4%87MIC%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="nav-number">6.2.2.</span> <span class="nav-text">4.2.2 准备MIC基础环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%BA%93%E8%8A%82%E7%82%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4%E5%AE%9E%E4%BE%8B"><span class="nav-number">6.2.3.</span> <span class="nav-text">4.2.3 所有数据库节点初始化集群实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-4-%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4%E5%B9%B6%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%EF%BC%88154%EF%BC%89"><span class="nav-number">6.2.4.</span> <span class="nav-text">4.2.4 创建集群并添加节点（154）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-MIC%E9%9B%86%E7%BE%A4%E5%B8%B8%E7%94%A8%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB"><span class="nav-number">6.3.</span> <span class="nav-text">4.3 MIC集群常用管理命令汇总</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2"><span class="nav-number">6.3.1.</span> <span class="nav-text">4.3.1 信息查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E9%9B%86%E7%BE%A4%E5%88%9B%E5%BB%BA%E5%8F%8A%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="nav-number">6.3.2.</span> <span class="nav-text">4.3.2 集群创建及节点管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="nav-number">6.3.3.</span> <span class="nav-text">4.3.3 集群故障处理</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="139"
      src="/images/custom/avatar.jpg">
  <p class="site-author-name" itemprop="name">139</p>
  <div class="site-description" itemprop="description">一个普通的JAVA开发的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2023004484号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">139</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
