<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1. MySQL 8.0 的日志管理1.1 general_log1.1.1 作用12一般不会开启开功能，因为log的量会非常庞大。但个别情况下可能会临时的开一会儿general log以供调试使用。">
<meta property="og:type" content="article">
<meta property="og:title" content="日志管理、备 份、恢复、迁移">
<meta property="og:url" content="http://example.com/2024/07/15/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E3%80%81%E5%A4%87%20%E4%BB%BD%E3%80%81%E6%81%A2%E5%A4%8D%E3%80%81%E8%BF%81%E7%A7%BB/index.html">
<meta property="og:site_name" content="进学阁">
<meta property="og:description" content="1. MySQL 8.0 的日志管理1.1 general_log1.1.1 作用12一般不会开启开功能，因为log的量会非常庞大。但个别情况下可能会临时的开一会儿general log以供调试使用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100275127-51f1c6a7-649b-49b2-834a-b5738ee7ec88.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100319440-4a3592aa-6454-45f1-895f-6ec8ab013dfb.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100371147-775542dc-e477-49cb-9883-0c8a0871cddc.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2024/png/1581532/1713245256106-086ad27d-8f90-4cae-98f3-a22c1e1f170e.png">
<meta property="article:published_time" content="2024-07-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-06T09:54:20.835Z">
<meta property="article:author" content="139">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100275127-51f1c6a7-649b-49b2-834a-b5738ee7ec88.png">

<link rel="canonical" href="http://example.com/2024/07/15/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E3%80%81%E5%A4%87%20%E4%BB%BD%E3%80%81%E6%81%A2%E5%A4%8D%E3%80%81%E8%BF%81%E7%A7%BB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>日志管理、备 份、恢复、迁移 | 进学阁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">进学阁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">业精于勤荒于嬉，行成于思毁于随</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">38</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">69</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E3%80%81%E5%A4%87%20%E4%BB%BD%E3%80%81%E6%81%A2%E5%A4%8D%E3%80%81%E8%BF%81%E7%A7%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/custom/avatar.jpg">
      <meta itemprop="name" content="139">
      <meta itemprop="description" content="一个普通的JAVA开发的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="进学阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          日志管理、备 份、恢复、迁移
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-07-15T00:00:00+08:00">2024-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-06 17:54:20" itemprop="dateModified" datetime="2025-03-06T17:54:20+08:00">2025-03-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-MySQL-8-0-的日志管理"><a href="#1-MySQL-8-0-的日志管理" class="headerlink" title="1. MySQL 8.0 的日志管理"></a>1. MySQL 8.0 的日志管理</h1><h2 id="1-1-general-log"><a href="#1-1-general-log" class="headerlink" title="1.1 general_log"></a>1.1 general_log</h2><h3 id="1-1-1-作用"><a href="#1-1-1-作用" class="headerlink" title="1.1.1 作用"></a>1.1.1 作用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一般不会开启开功能，因为log的量会非常庞大。但个别情况下可能会临时的开</span><br><span class="line">一会儿general log以供调试使用。</span><br></pre></td></tr></table></figure>
<span id="more"></span>


<h3 id="1-1-2查询及配置"><a href="#1-1-2查询及配置" class="headerlink" title="1.1.2查询及配置"></a>1.1.2查询及配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;general_log&#x27;;       -- 查看日志是否开启</span><br><span class="line">show variables like &#x27;general_log_file&#x27;;  -- 看看日志文件保存位置</span><br><span class="line">show variables like &#x27;log_output&#x27;;        -- 看看日志输出类型 table或file</span><br><span class="line">set global general_log=on;               -- 开启日志功能</span><br><span class="line">set global general_log_file=&#x27;/data/logs/general.log&#x27;; --设置日志文件保存位置</span><br><span class="line">set global log_output=&#x27;table&#x27;;      --设置输出类型为 table</span><br><span class="line">set global log_output=&#x27;file&#x27;;       --设置输出类型为 file</span><br><span class="line">set global log_output=&#x27;table,file&#x27;;     --设置多位置保存</span><br></pre></td></tr></table></figure>



<h3 id="1-1-3-使用"><a href="#1-1-3-使用" class="headerlink" title="1.1.3 使用"></a>1.1.3 使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">检测mysqldump备份过程。</span><br></pre></td></tr></table></figure>



<h2 id="1-2-binlog"><a href="#1-2-binlog" class="headerlink" title="1.2 binlog *"></a>1.2 binlog *</h2><h3 id="1-2-1-作用"><a href="#1-2-1-作用" class="headerlink" title="1.2.1 作用"></a>1.2.1 作用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(1)备份恢复必须依赖二进制日志</span><br><span class="line">(2)复制环境必须依赖二进制日志</span><br><span class="line">8.0之后，默认自动开启。</span><br></pre></td></tr></table></figure>



<h3 id="1-2-2-配置"><a href="#1-2-2-配置" class="headerlink" title="1.2.2 配置"></a>1.2.2 配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#注意：MySQL默认是没有开启二进制日志的。</span><br><span class="line">基础参数查看:</span><br><span class="line">开关:</span><br><span class="line">[(none)]&gt;select @@log_bin;                          </span><br><span class="line"></span><br><span class="line">日志路径及名字：</span><br><span class="line">[(none)]&gt;select @@log_bin_basename;         </span><br><span class="line"></span><br><span class="line">服务ID号:</span><br><span class="line">[(none)]&gt;select @@server_id;</span><br><span class="line"></span><br><span class="line">二进制日志格式:</span><br><span class="line">[(none)]&gt;select @@binlog_format;</span><br><span class="line"></span><br><span class="line">二进制日志只记录修改类的操作日志。对于DML（i u d ） 有以下格式</span><br><span class="line">S : statement SQL ，日志量少，但可能不准确.</span><br><span class="line">R ： ROW 记录行变化，日志量比较大，很准确.</span><br><span class="line">M : Mixed 略.</span><br><span class="line"></span><br><span class="line">###双一标准之二:</span><br><span class="line">select @@innodb_flush_log_at_trx_commit=1/2</span><br><span class="line">select @@sync_binlog=1</span><br><span class="line"></span><br><span class="line">SBR 、 RBR 、MBR binlog_format的区别？</span><br><span class="line">略</span><br><span class="line">binlog 记录了些什么内容？       </span><br><span class="line">略</span><br></pre></td></tr></table></figure>



<h3 id="1-2-3-使用"><a href="#1-2-3-使用" class="headerlink" title="1.2.3 使用"></a>1.2.3 使用</h3><h4 id="日志内容查看"><a href="#日志内容查看" class="headerlink" title="日志内容查看"></a>日志内容查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">db01 [(none)]&gt;show binary logs;</span><br><span class="line">+------------------+-----------+-----------+</span><br><span class="line">| Log_name         | File_size | Encrypted |</span><br><span class="line">| mysql-bin.000001 | 179       | No        |</span><br><span class="line">| mysql-bin.000002 | 723901    | No        |</span><br><span class="line">| mysql-bin.000003 | 21097721  | No        |</span><br><span class="line">| mysql-bin.000004 | 34583     | No        |</span><br><span class="line">| mysql-bin.000005 | 1011      | No        |</span><br><span class="line">| mysql-bin.000006 | 243       | No        |</span><br><span class="line">| mysql-bin.000007 | 243       | No        |</span><br><span class="line">| mysql-bin.000008 | 2662      | No        |</span><br><span class="line">+------------------+-----------+-----------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">db01 [(none)]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB |Binlog_Ignore_DB | Executed_Gtid_Set|</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000008 | 2662      |             |                   | 483e9795-ad5b-11ea-86e8-000c298e182d:1-85 |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">Master [binlog]&gt;show binlog events in &#x27;mysql-bin.000003&#x27;;</span><br><span class="line"></span><br><span class="line">Log_name：           binlog文件名</span><br><span class="line">Pos：                开始的position *****</span><br><span class="line">Event_type：         事件类型</span><br><span class="line">Format_desc：        格式描述，每一个日志文件的第一个事件，多用户没有意义，MySQL识别binlog必要信息</span><br><span class="line">Server_id：          mysql服务号标识</span><br><span class="line">End_log_pos：        事件的结束位置号 *****</span><br><span class="line">Info：               事件内容*****</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#补充: 如何快速的定位drop操作的pos号 </span><br><span class="line">SHOW BINLOG EVENTS</span><br><span class="line">[IN &#x27;log_name&#x27;]</span><br><span class="line">[FROM pos]</span><br><span class="line">[LIMIT [offset,] row_count]</span><br><span class="line">[root@db01 binlog]# mysql -e &quot;show binlog events in&#x27;  mysql-bin.000004&#x27;&quot; |  grep drop</span><br></pre></td></tr></table></figure>



<h4 id="binlog文件内容详细查看"><a href="#binlog文件内容详细查看" class="headerlink" title="binlog文件内容详细查看"></a>binlog文件内容详细查看</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog   /data/mysql/mysql-bin.000006</span><br><span class="line">mysqlbinlog --base64-output=decode-rows -vvv  /data/binlog/mysql-bin.000003</span><br><span class="line">mysqlbinlog  -d binlog /data/binlog/mysql-bin.000003</span><br><span class="line"></span><br><span class="line">[root@db01 binlog]# mysqlbinlog --start-datetime=&#x27;2019-05-06 17:00:00&#x27; --stop-datetime=&#x27;2019-05-06 17:01:00&#x27; /data/binlog/mysql-bin.000004</span><br></pre></td></tr></table></figure>



<h4 id="基于Position号进行日志截取"><a href="#基于Position号进行日志截取" class="headerlink" title="基于Position号进行日志截取"></a>基于Position号进行日志截取</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#核心就是找截取的起点和终点</span><br><span class="line">--start-position=321</span><br><span class="line">--stop-position=513</span><br><span class="line"></span><br><span class="line">mysqlbinlog --start-position=219 --stop-position=1347/data/binlog/mysql-bin.000003 &gt;/tmp/bin.sql</span><br><span class="line"></span><br><span class="line">#面试案例:</span><br><span class="line">1. 备份策略每天全备,有全量的二进制日志</span><br><span class="line">2. 业务中一共10个库,其中一个被误drop了</span><br><span class="line">3. 需要在其他9个库正常工作过程中进行数据恢复</span><br></pre></td></tr></table></figure>



<h4 id="彩蛋：-截取日志痛点"><a href="#彩蛋：-截取日志痛点" class="headerlink" title="彩蛋： 截取日志痛点"></a>彩蛋： 截取日志痛点</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">###思考一下：如果生产中会有什么痛点？</span><br><span class="line">1. 需要的日志在多个文件中，怎么截取？</span><br><span class="line">方法1： 分段截取</span><br><span class="line">方法2:  时间戳截取</span><br><span class="line">方法3： gtid</span><br><span class="line"></span><br><span class="line">2. binlog属于全局日志，日志中有其他库的操作，怎么排除掉？</span><br><span class="line">mysqlbinlog -d oldboy mysql-bin.000008 &gt; /tmp/bin.sql1.2.4 gtid特性</span><br><span class="line"></span><br><span class="line">3. binlog中100w个事件，怎么快速找到drop database的位置点？</span><br><span class="line">mysql&gt; pager grep &quot;DROP&quot;</span><br><span class="line">[root@db01 ~]# mysql -e &quot;show binlog events in &#x27;mysqlbin.000014&#x27;&quot; |less</span><br><span class="line">[root@db01 ~]# mysql -e &quot;show binlog events in &#x27;mysqlbin.000014&#x27;&quot; |grep</span><br><span class="line"></span><br><span class="line">4. 比如删除的库，建库是在2年前操作的。这种情况怎么办？</span><br><span class="line">每天全备，binlog完好的。</span><br><span class="line">可以使用全备+binlog方式实现恢复数据故障之前。</span><br><span class="line"></span><br><span class="line">5. 恢复中只想要某张表的binlog，怎么办？</span><br><span class="line">binlog2sql</span><br></pre></td></tr></table></figure>



<h3 id="1-2-4-gtid特性"><a href="#1-2-4-gtid特性" class="headerlink" title="1.2.4 gtid特性"></a>1.2.4 gtid特性</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">5.6 版本新加的特性,5.7中做了加强</span><br><span class="line">5.6 中不开启,没有这个功能.</span><br><span class="line">5.7+ 中的GTID,即使不开也会有自动生成</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;</span><br><span class="line">是对于一个已提交事务的编号，并且是一个全局唯一的编号。</span><br><span class="line">它的官方定义如下：</span><br><span class="line">GTID = server_uuid ：transaction_id</span><br><span class="line">7E11FA47-31CA-19E1-9E56-C43AA21293967:1-29</span><br><span class="line">重要参数介绍：</span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#具备GTID后,截取查看某些事务日志:</span><br><span class="line">--include-gtids</span><br><span class="line">--exclude-gtids</span><br><span class="line">--skip-gtidscase:</span><br><span class="line">mysqlbinlog --include-gtids=&#x27;dff98809-55c3-11e9-a58b-000c2928f5dd:1-6&#x27; --exclude-gtids=&#x27;dff98809-55c3-11e9-</span><br><span class="line">a58b-000c2928f5dd:4&#x27; /data/binlog/mysql-bin.000004</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">开启GTID后,MySQL恢复Binlog时,重复GTID的事务不会再执行了</span><br><span class="line">就想恢复?怎么办?</span><br><span class="line">--skip-gtids</span><br><span class="line">mysqlbinlog --include-gtids=&#x27;3ca79ab5-3e4d-11e9-a709-</span><br><span class="line">000c293b577e:4&#x27; /data/binlog/mysql-bin.000004</span><br><span class="line">/data/binlog/mysql-bin.000004</span><br><span class="line">set sql_log_bin=0;</span><br><span class="line">source /tmp/binlog.sql</span><br><span class="line">set sql_log_bin=1;</span><br></pre></td></tr></table></figure>



<h4 id="case"><a href="#case" class="headerlink" title="case:"></a>case:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">db01 [(none)]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File | Position | Binlog_Do_DB              |Binlog_Ignore_DB | Executed_Gtid_Set</span><br><span class="line">|</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000009 | 196      |             |</span><br><span class="line">| 483e9795-ad5b-11ea-86e8-000c298e182d:1-86 |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">db01 [(none)]&gt;create database gtdb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [(none)]&gt;use gtdb;</span><br><span class="line">Database changed</span><br><span class="line">db01 [gtdb]&gt;create table t1 (id int);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">db01 [gtdb]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File | Position | Binlog_Do_DB |Binlog_Ignore_DB | Executed_Gtid_Set</span><br><span class="line">|+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000009 | 570        |               |                | 483e9795-ad5b-11ea-86e8-000c298e182d:1-88 |</span><br><span class="line">  +------------------+----------+--------------+-----------------+-------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;insert into t1 values(1);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;insert into t1 values(2);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;insert into t1 values(3);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File | Position  | Binlog_Do_DB | Binlog_Ignore_DB            | Executed_Gtid_Set                          |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000009 | 1019      |              |                | 483e9795-ad5b-11ea-86e8-000c298e182d:1-89   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)db01 [gtdb]&gt;begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;insert into t1 values(11);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;insert into t1 values(12);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File | Position | Binlog_Do_DB |Binlog_Ignore_DB | Executed_Gtid_Set|</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000009 | 1380 |   |              | 483e9795-ad5b-11ea-86e8-000c298e182d:1-90 |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">db01 [gtdb]&gt;drop database gtdb;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">db01 [(none)]&gt;</span><br><span class="line">db01 [(none)]&gt;</span><br><span class="line">db01 [(none)]&gt;</span><br><span class="line">db01 [(none)]&gt;show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| File | Position | Binlog_Do_DB |Binlog_Ignore_DB | Executed_Gtid_Set                                                                          |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">| mysql-bin.000009 | 1561 |    |             | 483e9795-ad5b-11ea-86e8-000c298e182d:1-91                                    |</span><br><span class="line">| mysql-bin.000009 | 1380 |    |             | 483e9795-ad5b-11ea-86e8-000c298e182d:1-90                                        |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------------------------------+</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">[root@db01 binlog]# mysqlbinlog --skip-gtids --include-gtids=&#x27;483e9795-ad5b-11ea-86e8-000c298e182d:87-90&#x27; mysql-bin.000009 &gt;/data/bin1.sql</span><br><span class="line"></span><br><span class="line">注意： 只要显示的设定了gtid，不管是传统方式截取日志还是gtid截取，都需</span><br><span class="line">要加--skip-gtids做恢复。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">假设： 我要截取 1-20号gtid,跳过 14 ，18号gtid</span><br><span class="line">mysqlbinlog --skip-gtids --include-gtids=&#x27;483e9795-ad5b-11ea-86e8-000c298e182d:1-20&#x27;--exclude-gtids=&#x27;483e9795-ad5b-11ea-86e8-000c298e182d:14&#x27;,&#x27;483e9795-ad5b-11ea-86e8-000c298e182d:18&#x27; mysql-bin.000009 &gt;/data/bin1.sql</span><br></pre></td></tr></table></figure>



<h3 id="1-2-5-二进制日志其他操作"><a href="#1-2-5-二进制日志其他操作" class="headerlink" title="1.2.5 二进制日志其他操作"></a>1.2.5 二进制日志其他操作</h3><h4 id="自动清理日志"><a href="#自动清理日志" class="headerlink" title="自动清理日志"></a>自动清理日志</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%expire%&#x27;;</span><br><span class="line">expire_logs_days 0</span><br><span class="line">#自动清理时间,是要按照全备周期+1</span><br><span class="line">set global expire_logs_days=8;</span><br><span class="line"></span><br><span class="line">#永久生效:</span><br><span class="line">my.cnf</span><br><span class="line">expire_logs_days=15;</span><br><span class="line"></span><br><span class="line">#企业建议,至少保留两个全备周期+1的binlog</span><br><span class="line">8.0 变化：</span><br><span class="line">binlog_expire_logs_seconds=2592000</span><br></pre></td></tr></table></figure>



<h4 id="手工清理"><a href="#手工清理" class="headerlink" title="手工清理"></a>手工清理</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day;</span><br><span class="line">PURGE BINARY LOGS TO &#x27;mysql-bin.000010&#x27;;</span><br><span class="line">注意:不要手工 rm binlog文件</span><br><span class="line">1. my.cnf binlog关闭掉,启动数据库</span><br><span class="line">2. 把数据库关闭,开启binlog,启动数据库</span><br><span class="line">删除所有binlog,并从000001开始重新记录日志</span><br></pre></td></tr></table></figure>



<h4 id="日志滚动"><a href="#日志滚动" class="headerlink" title="日志滚动"></a>日志滚动</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flush logs;</span><br><span class="line">重启mysql也会自动滚动一个新的</span><br><span class="line">日志文件达到1G大小(max_binlog_size)</span><br><span class="line">| max_binlog_size | 1073741824</span><br><span class="line">备份时,加入参数也可以自动滚动</span><br></pre></td></tr></table></figure>



<h3 id="1-2-6-binlog2sql应用"><a href="#1-2-6-binlog2sql应用" class="headerlink" title="1.2.6 binlog2sql应用"></a>1.2.6 binlog2sql应用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 功能</span><br><span class="line">1. 友好的展示或管理binlog</span><br><span class="line">2. 快速DML闪回（通过日志翻转方式）。</span><br><span class="line"></span><br><span class="line"># 安装配置binlog2sql</span><br><span class="line">[root@db01 ] git clone https://github.com/danfengcao/binlog2sql.git &amp;&amp;</span><br><span class="line">[root@db01 ] cd binlog2sql</span><br><span class="line">[root@db01 ] yum install python3</span><br><span class="line">[root@db01 ] pip3 install -r requirements.txt (Pymysql 0.9.3)</span><br><span class="line">[root@db01 ]</span><br><span class="line">db03 [(none)]&gt;create user root@&#x27;10.0.0.%&#x27; identified with</span><br><span class="line">mysql_native_password by &#x27;123&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">db03 [(none)]&gt;grant all on *.* to root@&#x27;10.0.0.%&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 模拟数据修改</span><br><span class="line">db01 [(none)]&gt;flush logs;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">db01 [(none)]&gt;create database test;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">db01 [(none)]&gt;use test;</span><br><span class="line">Database changed</span><br><span class="line">db01 [test]&gt;create table t1 (id int);</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">db01 [test]&gt;insert into t1 values(1),(2),(3),(4),(5),(6),</span><br><span class="line">(7),(8);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3 Duplicates: 0 Warnings: 0</span><br><span class="line">db01 [test]&gt;commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">db01 [test]&gt;update t1 set id=10 where id=1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1 Changed: 1 Warnings: 0</span><br><span class="line">db01 [test]&gt;delete from t1 where id=3;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">db01 [test]&gt;commit;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">db01 [test]&gt;^DBye</span><br><span class="line"></span><br><span class="line">#解析日志事件SQL</span><br><span class="line">[root@db01 binlog2sql]# python3 binlog2sql.py -h 10.0.0.100 -P3306 -uroot -p123 -d test -t t1 --start-file=&#x27;binlog.000005&#x27;</span><br><span class="line">USE b&#x27;test&#x27;;</span><br><span class="line">create database test;</span><br><span class="line">USE b&#x27;test&#x27;;</span><br><span class="line">create table t1 (id int);</span><br><span class="line">INSERT INTO `test`.`t1`(`id`) VALUES (1); #start 649 end</span><br><span class="line">822 time 2020-06-13 19:58:40</span><br><span class="line">INSERT INTO `test`.`t1`(`id`) VALUES (2); #start 649 end</span><br><span class="line">822 time 2020-06-13 19:58:401.3 slowlog</span><br><span class="line">INSERT INTO `test`.`t1`(`id`) VALUES (3); #start 649 end</span><br><span class="line">822 time 2020-06-13 19:58:40</span><br><span class="line">UPDATE `test`.`t1` SET `id`=10 WHERE `id`=1 LIMIT 1;</span><br><span class="line">#start 932 end 1110 time 2020-06-13 19:58:56</span><br><span class="line">DELETE FROM `test`.`t1` WHERE `id`=3 LIMIT 1; #start 932</span><br><span class="line">end 1198 time 2020-06-13 19:59:05</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 只解析delete类型操作</span><br><span class="line">[root@db01 binlog2sql]# python3 binlog2sql.py -h</span><br><span class="line">10.0.0.51 -P3306 -uroot -p123 -d test -t t1 --startfile=&#x27;mysql-bin.000003&#x27; --sql-type=delete</span><br><span class="line"></span><br><span class="line">#生成指定事件回滚语句</span><br><span class="line">[root@db01 binlog2sql]# python3 binlog2sql.py -h</span><br><span class="line">10.0.0.51 -P3306 -uroot -p123 -d test -t t1 --start-file=&#x27;mysql-bin.000003&#x27; --sql-type=delete --start-position=932 --stop-position=1198 -B</span><br><span class="line">[root@db01 binlog2sql]# python3 binlog2sql.py -h</span><br><span class="line">10.0.0.51 -P3306 -uroot -p123 -d test -t t1 --start-file=&#x27;mysql-bin.000003&#x27; --sql-type=delete --start-position=932 --stop-position=1198 -B&gt;/tmp/flashback.sql</span><br></pre></td></tr></table></figure>



<h2 id="1-3-slowlog"><a href="#1-3-slowlog" class="headerlink" title="1.3 slowlog"></a>1.3 slowlog</h2><h3 id="1-3-1-作用"><a href="#1-3-1-作用" class="headerlink" title="1.3.1 作用"></a>1.3.1 作用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">记录慢SQL语句的日志,定位低效SQL语句的工具日志</span><br></pre></td></tr></table></figure>



<h3 id="1-3-2-配置"><a href="#1-3-2-配置" class="headerlink" title="1.3.2 配置"></a>1.3.2 配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#开关:</span><br><span class="line">slow_query_log=1</span><br><span class="line"></span><br><span class="line">#文件位置及名字</span><br><span class="line">slow_query_log_file=/data/mysql/slow.log</span><br><span class="line"></span><br><span class="line">#设定慢查询时间:</span><br><span class="line">long_query_time=0.1</span><br><span class="line"></span><br><span class="line">#没走索引的语句也记录:</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line"></span><br><span class="line">vim /etc/my.cnf</span><br><span class="line">slow_query_log=1</span><br><span class="line">slow_query_log_file=/data/mysql/slow.log</span><br><span class="line">long_query_time=0.1</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<h3 id="1-3-3-分析及使用"><a href="#1-3-3-分析及使用" class="headerlink" title="1.3.3 分析及使用"></a>1.3.3 分析及使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldumpslow -s c -t 10 /data/mysql/slow.log</span><br></pre></td></tr></table></figure>



<h3 id="1-3-4-pt-query-digest-pqd-应用"><a href="#1-3-4-pt-query-digest-pqd-应用" class="headerlink" title="1.3.4 pt-query-digest(pqd)应用"></a>1.3.4 pt-query-digest(pqd)应用</h3><h4 id="安装及介绍："><a href="#安装及介绍：" class="headerlink" title="安装及介绍："></a>安装及介绍：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 安装工具：</span><br><span class="line">[root@master ~]# yum install -y percona-toolkit-3.1.0-2.el7.x86_64.rpm</span><br><span class="line">#命令语法：</span><br><span class="line">pt-query-digest [OPTIONS] [FILES] [DSN]</span><br><span class="line">--create-review-table 当使用--review参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--create-history-table 当使用--history参数把分析结果输出到表中时，如果没有表就自动创建。</span><br><span class="line">--filter 对输入的慢查询按指定的字符串进行匹配过滤后再进行分析</span><br><span class="line">--limit 限制输出结果百分比或数量，默认值是20,即将最慢的20条语句输出，如果是50%则按总响应时间占比从大到小排序，输出到总和达到50%位置截止。</span><br><span class="line">--host mysql服务器地址</span><br><span class="line">--user mysql用户名</span><br><span class="line">--password mysql用户密码</span><br><span class="line">--history 将分析结果保存到表中，分析结果比较详细，下次再使用--history时，如果存在相同的语句，且查询所在的时间区间和历史表中的不同，则会记录到数据表中，可以通过查询同一CHECKSUM来比较某类型查询的历史变化。</span><br><span class="line"></span><br><span class="line">--review 将分析结果保存到表中，这个分析只是对查询条件进行参数化，一个类型的查询一条记录，比较简单。当下次使用--review时，如果存在相同的语句分析，就不会记录到数据表中。</span><br><span class="line"></span><br><span class="line">--output 分析结果输出类型，值可以是report(标准分析报告)、</span><br><span class="line"></span><br><span class="line">--slowlog(Mysql slow log)、json、json-anon，一般使用report，以便于阅读。</span><br><span class="line">--since 从什么时间开始分析，值为字符串，可以是指定的某个”yyyy-mm-dd[hh:mm:ss]”格式的时间点，也可以是简单的一个时间值：s(秒)、h(小时)、m(分钟)、d(天)，如12h就表示从12小时前开始统计。</span><br><span class="line">--until 截止时间，配合—since可以分析一段时间内的慢查询。</span><br></pre></td></tr></table></figure>



<h4 id="结果说明："><a href="#结果说明：" class="headerlink" title="结果说明："></a>结果说明：</h4><p><img src="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100275127-51f1c6a7-649b-49b2-834a-b5738ee7ec88.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Overall：        总共有多少条查询</span><br><span class="line">Time range： 查询执行的时间范围</span><br><span class="line">unique：         唯一查询数量，即对查询条件进行参数化以后，总共有多少个不同的查询</span><br><span class="line">total：          总计 min：最小 max：最大 avg：平均</span><br><span class="line">95%：                把所有值从小到大排列，位置位于95%的那个数，这个数一般最具有参考价值</span><br><span class="line">median：         中位数，把所有值从小到大排列，位置位于中间那个数</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100319440-4a3592aa-6454-45f1-895f-6ec8ab013dfb.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Response: 总的响应时间。</span><br><span class="line">time: 该查询在本次分析中总的时间占比。</span><br><span class="line">calls: 执行次数，即本次分析总共有多少条这种类型的查询语句。</span><br><span class="line">R/Call: 平均每次执行的响应时间。</span><br><span class="line">Item : 查询对象</span><br><span class="line"></span><br><span class="line">每部分详细统计结果</span><br><span class="line">1号查询的详细统计结果，最上面的表格列出了执行次数、最大、最小、平均、</span><br><span class="line">95%等各项目的统计。</span><br><span class="line">Databases: 库名</span><br><span class="line">Users: 各个用户执行的次数（占比）</span><br><span class="line">Query_time distribution : 查询时间分布, 长短体现区间占比，本例中</span><br><span class="line">查询集中在10ms。</span><br><span class="line">Tables: 查询中涉及到的表</span><br><span class="line">Explain: 示例</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.fbbizyy.com/yuque/0/2021/png/1581532/1615100371147-775542dc-e477-49cb-9883-0c8a0871cddc.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">###每部分详细统计结果</span><br><span class="line">1号查询的详细统计结果，最上面的表格列出了执行次数、最大、最小、平均、</span><br><span class="line">95%等各项目的统计。</span><br><span class="line">Databases: 库名</span><br><span class="line">Users: 各个用户执行的次数（占比）</span><br><span class="line">Query_time distribution : 查询时间分布, 长短体现区间占比，本例中</span><br><span class="line">查询集中在1s+。</span><br><span class="line">Tables: 查询中涉及到的表</span><br><span class="line">Explain: 执行计划</span><br></pre></td></tr></table></figure>



<h4 id="命令行应用实例："><a href="#命令行应用实例：" class="headerlink" title="命令行应用实例："></a>命令行应用实例：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">用法示例</span><br><span class="line">1.直接分析慢查询文件:</span><br><span class="line">pt-query-digest slow.log &gt; slow_report.log</span><br><span class="line"></span><br><span class="line">2.分析最近12小时内的查询：</span><br><span class="line">pt-query-digest --since=12h slow.log &gt; slow_report2.log</span><br><span class="line"></span><br><span class="line">3.分析指定时间范围内的查询：</span><br><span class="line">pt-query-digest slow.log --since &#x27;2019-01-07 09:30:00&#x27; --</span><br><span class="line">until &#x27;2019-01-07 10:00:00&#x27;&gt; &gt; slow_report3.log</span><br><span class="line"></span><br><span class="line">4.分析指含有select语句的慢查询</span><br><span class="line">pt-query-digest --filter &#x27;$event-&gt;&#123;fingerprint&#125; =~m/^select/i&#x27; slow.log&gt; slow_report4.log</span><br><span class="line"></span><br><span class="line">5.针对某个用户的慢查询</span><br><span class="line">pt-query-digest --filter &#x27;($event-&gt;&#123;user&#125; || &quot;&quot;) =~m/^root/i&#x27; slow.log&gt; slow_report5.log</span><br><span class="line">6.查询所有所有的全表扫描或full join的慢查询</span><br><span class="line">pt-query-digest --filter &#x27;(($event-&gt;&#123;Full_scan&#125; || &quot;&quot;) eq &quot;yes&quot;) ||(($event-&gt;&#123;Full_join&#125; || &quot;&quot;) eq &quot;yes&quot;)&#x27; slow.log&gt;slow_report6.log</span><br><span class="line">7.把结果保存到query_review表</span><br><span class="line">pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_review --create-review-table slow.log</span><br><span class="line">8.把结果保存到query_history表</span><br><span class="line">pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_history --create-review-table slow.log_0001</span><br><span class="line">pt-query-digest --user=root –password=abc123 --review h=localhost,D=test,t=query_history --create-review-table slow.log_0002</span><br><span class="line">9.通过tcpdump抓取mysql的tcp协议数据，然后再分析</span><br><span class="line">tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt</span><br><span class="line">pt-query-digest --type tcpdump mysql.tcp.txt &gt;slow_report9.log</span><br><span class="line">10.分析binlog</span><br><span class="line">mysqlbinlog mysql-bin.000093 &gt; mysql-bin000093.sql pt-query-digest --type=binlog mysql-bin000093.sql &gt;slow_report10.log</span><br><span class="line">11.分析general log</span><br><span class="line">pt-query-digest --type=genlog localhost.log &gt;slow_report11.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###慢日志图形化展示项目：</span><br><span class="line">gui</span><br><span class="line">anemometer</span><br><span class="line">lepus</span><br></pre></td></tr></table></figure>



<h1 id="2-MySQL-8-0的备份、恢复、迁移"><a href="#2-MySQL-8-0的备份、恢复、迁移" class="headerlink" title="2.MySQL 8.0的备份、恢复、迁移"></a>2.MySQL 8.0的备份、恢复、迁移</h1><h2 id="2-1备份恢复中的职责"><a href="#2-1备份恢复中的职责" class="headerlink" title="2.1备份恢复中的职责"></a>2.1备份恢复中的职责</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设计备份策略</span><br><span class="line">日常备份巡检</span><br><span class="line">定期恢复演练(测试库)</span><br><span class="line">故障恢复</span><br><span class="line">升级迁移</span><br></pre></td></tr></table></figure>



<h2 id="2-2-MySQL8-0备份工具介绍"><a href="#2-2-MySQL8-0备份工具介绍" class="headerlink" title="2.2 MySQL8.0备份工具介绍"></a>2.2 MySQL8.0备份工具介绍</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">###逻辑：</span><br><span class="line">mysqldump</span><br><span class="line">load data/mysqlimport</span><br><span class="line">mydumper</span><br><span class="line"></span><br><span class="line">###物理：</span><br><span class="line">Percona Xtrabackup 8.0.12+</span><br><span class="line">Enterprise Backup</span><br><span class="line">8017+ Clone Plugin</span><br></pre></td></tr></table></figure>



<h2 id="2-3逻辑备份工具使用-mysqldump-✨"><a href="#2-3逻辑备份工具使用-mysqldump-✨" class="headerlink" title="2.3逻辑备份工具使用-mysqldump ✨"></a>2.3逻辑备份工具使用-mysqldump ✨</h2><p> <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/687236988">mysqldump备份原理</a>  <a target="_blank" rel="noopener" href="https://www.cnblogs.com/VicLiu/p/15492310.html">MySQL mysqldump备份恢复及原理 - VicLW - 博客园</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.调用FWRL（flush tables with read lock）,全局禁止读写</span><br><span class="line"></span><br><span class="line">2.开启快照读，获取此期间的快照（仅仅对innodb起作用）</span><br><span class="line"></span><br><span class="line">3.备份非innodb表数据（*.frm,*.myi,*.myd等）</span><br><span class="line"></span><br><span class="line">4.非innodb表备份完毕之后，释放FTWRL</span><br><span class="line"></span><br><span class="line">5.逐一备份innodb表数据</span><br><span class="line"></span><br><span class="line">6.备份完成</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2024/png/1581532/1713245256106-086ad27d-8f90-4cae-98f3-a22c1e1f170e.png"></p>
<h4 id="客户端通用参数"><a href="#客户端通用参数" class="headerlink" title="客户端通用参数"></a>客户端通用参数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-u -p -S -h -P</span><br><span class="line">本地备份:</span><br><span class="line">mysqldump -uroot -p -S /tmp/mysql.sock</span><br><span class="line">远程备份:</span><br><span class="line">mysqldump -uroot -p -h 10.0.0.51 -P3306</span><br></pre></td></tr></table></figure>



<h4 id="备份专用参数"><a href="#备份专用参数" class="headerlink" title="备份专用参数"></a>备份专用参数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">-A 全备参数</span><br><span class="line">-B db1 db2 db3      备份多个单库备份单个或多个表</span><br><span class="line">-R                            备份存储过程及函数</span><br><span class="line">--triggers              备份触发器</span><br><span class="line">-E                          备份事件</span><br><span class="line">-F                            在备份开始时,刷新一个新binlog日志</span><br><span class="line">--master-data=2         以注释的形式,保存备份开始时间点的binlog的状态信息</span><br><span class="line"></span><br><span class="line">###功能：</span><br><span class="line">（1） 在备份时，会自动记录，二进制日志文件名和位置号</span><br><span class="line">（2） 自动锁表（FTWRL）</span><br><span class="line">（3）如果配合--single-transaction，只对非InnoDB表进行锁表备份，InnoDB表进行“热“”备，实际上是实现 快照备份。</span><br><span class="line">                        --single-transaction  innodb 存储引擎开启热备(快照备份)功能</span><br><span class="line">案例：</span><br><span class="line">1. 5.6 100+G 有MyISAM表，做大批量DML，mysqldump备份数据库 出现hang住。</span><br><span class="line">2. 5.6 3000w表做DDL，改数据类型，备份期间，锁严重。 master-data可以自动加锁</span><br><span class="line">（1）在不加--single-transaction ，启动所有表的温备份，所有表都锁定</span><br><span class="line">（2）加上--single-transaction ,对innodb进行快照备份,对非innodb表可以实现自动锁表功能</span><br><span class="line"></span><br><span class="line">--set-gtid-purged=auto  auto , (on)off</span><br><span class="line"></span><br><span class="line">使用场景:</span><br><span class="line">1. --set-gtid-purged=OFF,可以使用在日常备份参数中.</span><br><span class="line">mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF &gt;/data/backup/full.sql</span><br><span class="line"></span><br><span class="line">2. auto , on:在构建主从复制环境时需要的参数配置</span><br><span class="line">mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=ON &gt;/data/backup/full.sql</span><br><span class="line"></span><br><span class="line">--max-allowed-packet=#</span><br><span class="line">mysqldump -uroot -p -A -R -E --triggers --master-data=2 --single-transaction --set-gtid-purged=OFF --max-allowed-packet=256M &gt;/data/backup/full.sql</span><br><span class="line"></span><br><span class="line">--max-allowed-packet=#</span><br><span class="line">The maximum packet length to send to or receive from server</span><br><span class="line"></span><br><span class="line">例子：</span><br><span class="line">mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date+%F).sql.gz</span><br><span class="line"></span><br><span class="line">mysqldump -uroot -p123 -A -R --triggers --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F-%T).sql.gz</span><br><span class="line"></span><br><span class="line">mysqldump备份的恢复方式    ###在生产中恢复要谨慎，恢复会删除重复的表</span><br><span class="line">set sql_log_bin=0;       #恢复的时候不记录日志</span><br><span class="line">source /backup/full_2018-06-28.sql</span><br><span class="line">set sql_log_bin=1;</span><br><span class="line"></span><br><span class="line">###注意：</span><br><span class="line">1、mysqldump在备份和恢复时都需要mysql实例启动为前提。</span><br><span class="line">2、一般数据量级100G以内，大约15-45分钟可以备份成功，但恢复时间通常需要5-10倍时间，数据量级很大很大的时候（PB、EB）</span><br><span class="line">3、 mysqldump是覆盖形式恢复的方法。</span><br><span class="line"></span><br><span class="line">#ps： 一般我们认为，在同数据量级，物理备份要比逻辑备份速度快.</span><br><span class="line"></span><br><span class="line">###逻辑备份的优势:</span><br><span class="line">1、可读性强</span><br><span class="line">2、压缩比很高</span><br><span class="line"></span><br><span class="line">master-data=2 : 记录备份开始binlog pos gtid</span><br></pre></td></tr></table></figure>



<h2 id="2-4逻辑备份工具使用-mydumper-amp-myloader"><a href="#2-4逻辑备份工具使用-mydumper-amp-myloader" class="headerlink" title="2.4逻辑备份工具使用-mydumper&amp;myloader"></a>2.4逻辑备份工具使用-mydumper&amp;myloader</h2><h3 id="2-4-0-介绍"><a href="#2-4-0-介绍" class="headerlink" title="2.4.0 介绍"></a>2.4.0 介绍</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Hehuyi_In/article/details/105354786">https://blog.csdn.net/Hehuyi_In&#x2F;article&#x2F;details&#x2F;105354786</a></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL自身的mysqldump工具支持单线程工作，依次一个个导出多个表，没有一</span><br><span class="line">个并行的机，这就使得它无法迅速的备份数据。</span><br><span class="line">mydumper作为一个实用工具，能够良好支持多线程工作，可以并行的多线程的</span><br><span class="line">从表中读入数据并同时写到不同的文件里，这使得它在处理速度方面快于传统的</span><br><span class="line">mysqldump。其特征之一是在处理过程中需要对列表加以锁定，因此如果我们需</span><br><span class="line">要在工作时段执行备份工作，那么会引起DML阻塞。但一般现在的MySQL都有主</span><br><span class="line">从，备份也大部分在从上进行，所以锁的问题可以不用考虑。这样，mydumper</span><br><span class="line">能更好的完成备份任务。</span><br><span class="line"></span><br><span class="line">mydumper特性</span><br><span class="line">多线程备份</span><br><span class="line">因为是多线程逻辑备份，备份后会生成多个备份文件</span><br><span class="line">备份时对MyISAM表施加FTWRL(FLUSH TABLES WITH READ LOCK),会阻塞</span><br><span class="line"></span><br><span class="line">DML语句</span><br><span class="line">保证备份数据的一致性</span><br><span class="line">支持文件压缩</span><br><span class="line">支持导出binlog</span><br><span class="line">支持多线程恢复</span><br><span class="line">支持以守护进程模式工作，定时快照和连续二进制日志</span><br><span class="line">支持将备份文件切块</span><br></pre></td></tr></table></figure>



<h3 id="2-4-1-工作原理"><a href="#2-4-1-工作原理" class="headerlink" title="2.4.1 工作原理"></a>2.4.1 工作原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># mydumper主要流程概括</span><br><span class="line">1、主线程 FLUSH TABLES WITH READ LOCK, 施加全局只读锁，以阻止DML语句写入，保证数据的一致性</span><br><span class="line">2、读取当前时间点的二进制日志文件名和日志写入的位置并记录在metadata文件中，以供即使点恢复使用</span><br><span class="line">3、N个（线程数可以指定，默认是4）dump线程 START TRANSACTION WITH CONSISTENT SNAPSHOT; 开启读一致的事务</span><br><span class="line">4、dump non-InnoDB tables, 首先导出非事务引擎的表</span><br><span class="line">5、主线程 UNLOCK TABLES 非 事务引擎备份完后，释放全局只读锁</span><br><span class="line">6、dump InnoDB tables, 基于 事务导出InnoDB表</span><br><span class="line">7、事务结束</span><br><span class="line"></span><br><span class="line"># 备份所生成的文件</span><br><span class="line">目录中包含一个metadata文件</span><br><span class="line">记录了备份数据库在备份时间点的二进制日志文件名，日志的写入位置，</span><br><span class="line">如果是在从库进行备份，还会记录备份时同步至主库的二进制日志文件及写入位置</span><br><span class="line">每个表有两个备份文件：</span><br><span class="line">database.table-schema.sql 表结构文件</span><br><span class="line">database.table.sql 表数据文件</span><br><span class="line"></span><br><span class="line">如果对表文件分片，将生成多个备份数据文件，可以指定行数或指定大小分片</span><br></pre></td></tr></table></figure>



<h3 id="2-4-2-参数介绍"><a href="#2-4-2-参数介绍" class="headerlink" title="2.4.2 参数介绍"></a>2.4.2 参数介绍</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"># mydumper</span><br><span class="line">-B, --database 要备份的数据库，不指定则备份所有库</span><br><span class="line">-T, --tables-list 需要备份的表，名字用逗号隔开</span><br><span class="line">-o, --outputdir 备份文件输出的目录</span><br><span class="line">-s, --statement-size 生成的insert语句的字节数，默认</span><br><span class="line">1000000</span><br><span class="line">-r, --rows 将表按行分块时，指定的块行数，指定这</span><br><span class="line">个选项会关闭 --chunk-filesize</span><br><span class="line">-F, --chunk-filesize 将表按大小分块时，指定的块大小，单位</span><br><span class="line">是 MB</span><br><span class="line">-c, --compress 压缩输出文件-e, --build-empty-files 如果表数据是空，还是产生一个空文件</span><br><span class="line">（默认无数据则只有表结构文件）</span><br><span class="line">-x, --regex 是同正则表达式匹配 &#x27;db.table&#x27;</span><br><span class="line">-i, --ignore-engines 忽略的存储引擎，用都厚分割</span><br><span class="line">-m, --no-schemas 不备份表结构</span><br><span class="line">-k, --no-locks 不使用临时共享只读锁，使用这个选项会</span><br><span class="line">造成数据不一致</span><br><span class="line">--less-locking 减少对InnoDB表的锁施加时间（这种模</span><br><span class="line">式的机制下文详解）</span><br><span class="line">-l, --long-query-guard 设定阻塞备份的长查询超时时间，单位是</span><br><span class="line">秒，默认是60秒（超时后默认mydumper将会退出）</span><br><span class="line">--kill-long-queries 杀掉长查询 (不退出)</span><br><span class="line">-b, --binlogs 导出binlog</span><br><span class="line">-D, --daemon 启用守护进程模式，守护进程模式以某个</span><br><span class="line">间隔不间断对数据库进行备份</span><br><span class="line">-I, --snapshot-interval dump快照间隔时间，默认60s，需要在</span><br><span class="line">daemon模式下</span><br><span class="line">-L, --logfile 使用的日志文件名(mydumper所产生的日</span><br><span class="line">志), 默认使用标准输出</span><br><span class="line">--tz-utc 跨时区是使用的选项，不解释了</span><br><span class="line">--skip-tz-utc 同上</span><br><span class="line">--use-savepoints 使用savepoints来减少采集metadata</span><br><span class="line">所造成的锁时间，需要 SUPER 权限</span><br><span class="line">--success-on-1146 Not increment error count and</span><br><span class="line">Warning instead of Critical in case of table doesn&#x27;t exist</span><br><span class="line">-h, --host 连接的主机名</span><br><span class="line">-u, --user 备份所使用的用户</span><br><span class="line">-p, --pass 密码</span><br><span class="line">-P, --port 端口</span><br><span class="line">-S, --socket 使用socket通信时的socket文件</span><br><span class="line">-t, --threads 开启的备份线程数，默认是4</span><br><span class="line">-C, --compress-protocol 压缩与mysql通信的数据</span><br><span class="line">-V, --version 显示版本号</span><br><span class="line">-v, --verbose 输出信息模式, 0 = silent, 1 =</span><br><span class="line">errors, 2 = warnings, 3= info, 默认为 2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># myloader</span><br><span class="line">-d, --directory 备份文件的文件夹</span><br><span class="line">-q, --queries-per-transaction 每次事物执行的查询数量，默认</span><br><span class="line">是1000</span><br><span class="line">-o, --overwrite-tables 如果要恢复的表存在，则先drop</span><br><span class="line">掉该表，使用该参数，需要备份时候要备份表结构</span><br><span class="line">-B, --database 需要还原的数据库</span><br><span class="line">-e, --enable-binlog 启用还原数据的二进制日志</span><br><span class="line">-h, --host 主机</span><br><span class="line">-u, --user 还原的用户</span><br><span class="line">-p, --pass 密码</span><br><span class="line">-P, --port 端口</span><br><span class="line">-S, --socket socket文件</span><br><span class="line">-t, --threads 还原所使用的线程数，默认是4</span><br><span class="line">-C, --compress-protocol 压缩协议</span><br><span class="line">-V, --version 显示版本</span><br><span class="line">-v, --verbose 输出模式, 0 = silent, 1 =</span><br><span class="line">errors, 2 = warnings,3 = info, 默认为2</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#下载地址：</span><br><span class="line">https://github.com/maxbube/mydumper/releases/</span><br><span class="line"></span><br><span class="line">#安装：</span><br><span class="line">[root@db01 app]# yum install -y mydumper-0.9.5-2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>



<h3 id="2-4-3-使用"><a href="#2-4-3-使用" class="headerlink" title="2.4.3 使用"></a>2.4.3 使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#备份全库：</span><br><span class="line">mydumper -u root -p &#x27;123&#x27; -o /data/backup/</span><br><span class="line"># 备份test数据库：</span><br><span class="line">mydumper -u root -p &#x27;123&#x27; -B test -o /data/backup/</span><br><span class="line">#备份多张表(tableA,tableB)：</span><br><span class="line">mydumper -u root -p &#x27;123&#x27; -B test -T tableA,tableB -o</span><br><span class="line">/data/backup/</span><br><span class="line">#备份tableA表的数据，不备份表结构</span><br><span class="line">mydumper -u root -p &#x27;123&#x27; -B test -m -o /data/backup/</span><br><span class="line">#备份tableA表的数据，并进行压缩</span><br><span class="line">mydumper -u root -p &#x27;123&#x27; -B test -c -o /data/backup/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#还原test库：</span><br><span class="line">myloader -u root -p &#x27;123&#x27; -B test -d /data/backup/</span><br><span class="line">#还原tableA表</span><br><span class="line">myloader -u root -p &#x27;123&#x27; -B test -o tableA -d  /data/backup/</span><br><span class="line">Ps: 适合有很多的小表备份。</span><br></pre></td></tr></table></figure>



<h2 id="2-5逻辑导入导出-load-data"><a href="#2-5逻辑导入导出-load-data" class="headerlink" title="2.5逻辑导入导出-load data"></a>2.5逻辑导入导出-load data</h2><h3 id="2-5-0-功能"><a href="#2-5-0-功能" class="headerlink" title="2.5.0 功能"></a>2.5.0 功能</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 大数据量的录入</span><br><span class="line">2. 异构迁移</span><br><span class="line">    数据源： MySQL 、异构平台导出的、造数工具生成文本类的文件。</span><br></pre></td></tr></table></figure>



<h3 id="2-5-1-造数"><a href="#2-5-1-造数" class="headerlink" title="2.5.1 造数"></a>2.5.1 造数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">use oldguo</span><br><span class="line">show tables;</span><br><span class="line">+---------------------+</span><br><span class="line">| Tables_in_oldguo    |</span><br><span class="line">+---------------------+</span><br><span class="line">| test                |</span><br><span class="line">| test2             |</span><br><span class="line">+---------------------+</span><br><span class="line">create table test3(id int unsigned not null primary key</span><br><span class="line">auto_increment,test varchar(100),test2 varchar(100));</span><br><span class="line">insert into test3(test,test2) values(&#x27;a</span><br><span class="line">string&#x27;,&#x27;100.20&#x27;),(&#x27;a string containing a ,</span><br><span class="line">comma&#x27;,&#x27;102.20&#x27;),(&#x27;a string containing a &quot;</span><br><span class="line">quote&#x27;,&#x27;102.20&#x27;),\</span><br><span class="line">(&#x27;a string containing a &quot;, quote and comma&#x27;,&#x27;102.20&#x27;);</span><br><span class="line">                                 </span><br><span class="line">select * from test3;</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id |                                      test | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                 | 100.20  |</span><br><span class="line">| 4 | a string containing a , comma            | 102.20  |</span><br><span class="line">| 6 | a string containing a &quot; quote            | 102.20  |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma | 102.20  |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>



<h3 id="2-5-2-语法"><a href="#2-5-2-语法" class="headerlink" title="2.5.2 语法"></a>2.5.2 语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">help load data;</span><br><span class="line">Name: &#x27;LOAD DATA&#x27;</span><br><span class="line">Description:</span><br><span class="line">Syntax:</span><br><span class="line">LOAD DATA [LOW_PRIORITY | CONCURRENT] [LOCAL] INFILE</span><br><span class="line">&#x27;file_name&#x27;</span><br><span class="line">[REPLACE | IGNORE]</span><br><span class="line">INTO TABLE tbl_name</span><br><span class="line">[PARTITION (partition_name,...)]</span><br><span class="line">[CHARACTER SET charset_name]</span><br><span class="line">[&#123;FIELDS | COLUMNS&#125;</span><br><span class="line">[TERMINATED BY &#x27;string&#x27;]</span><br><span class="line">[[OPTIONALLY] ENCLOSED BY &#x27;char&#x27;]</span><br><span class="line">[ESCAPED BY &#x27;char&#x27;]</span><br><span class="line">]</span><br><span class="line">[LINES</span><br><span class="line">[STARTING BY &#x27;string&#x27;]</span><br><span class="line">[TERMINATED BY &#x27;string&#x27;]</span><br><span class="line">]</span><br><span class="line">[IGNORE number &#123;LINES | ROWS&#125;]</span><br><span class="line">[(col_name_or_user_var,...)]</span><br><span class="line">[SET col_name = expr,...]</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">load data语句加载的数据源可以是mysqldump导出的纯文本数据文件，也可</span><br><span class="line">以是使用SELECT … INTO OUTFILE &#x27;/path/xx.txt&#x27;;</span><br><span class="line">语句生成的单表纯文本数据文件，或者其他的方式生成的txt（只要生成的纯文本数据列按指定分隔符分割的纯文本数据文件即可）</span><br><span class="line">从上面的帮助信息可以看到整个load data语句的语法结构，其中load datainfile &#x27;file.txt&#x27; into table tb_name; 是最基本的使用语句结构，</span><br><span class="line">其余的都为可选子句</span><br></pre></td></tr></table></figure>



<h3 id="2-5-3必选子句或关键字"><a href="#2-5-3必选子句或关键字" class="headerlink" title="2.5.3必选子句或关键字"></a>2.5.3必选子句或关键字</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># load data语句简单示例</span><br><span class="line">如果文本文件中的数据字段与表结构中的字段定义顺序相同，则直接使用如下语</span><br><span class="line">句载入即可</span><br><span class="line">select * from test3;</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id | test                                     |  test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                  | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma             | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote             | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma  | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot;;</span><br><span class="line">truncate test3;</span><br><span class="line">load data infile &#x27;/tmp/t3.txt&#x27; into table test3;</span><br><span class="line">select * from test3;     #这里可以看到，数据到处导入正常</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id |                                     test | test2  |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                  | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma             | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote             | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma  | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br></pre></td></tr></table></figure>



<h3 id="2-5-4-设置字段顺序"><a href="#2-5-4-设置字段顺序" class="headerlink" title="2.5.4 设置字段顺序"></a>2.5.4 设置字段顺序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">如果文本文件中的数据字段与表结构中的字段定义顺序不同，则使用如下语句指</span><br><span class="line">定载入表中的字段顺序</span><br><span class="line"># 导出文本，导出文本时不使用select *，而是使用具体的字段，把顺序稍微</span><br><span class="line">调整一下</span><br><span class="line">system rm -f /tmp/t3.txt;</span><br><span class="line">desc test3; # 留意表的字段定义顺序，这里是id, test, test2</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type              | Null | Key | Default | Extra|</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">| id    | int(10) unsigned | NO   | PRI | NULL     |auto_increment |</span><br><span class="line">| test  | varchar(100)     | YES  |     | NULL     |               |</span><br><span class="line">| test2 | varchar(100)     | YES  |     | NULL     |               |</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">select * from test3; # 留个表中各个字段的值大概是什么内容</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id |                                      test | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                  | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma             | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote             | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma  | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">select id,test2,test from test3 into outfile</span><br><span class="line">&quot;/tmp/test3.txt&quot;;</span><br><span class="line">system cat /tmp/test3.txt; #这里可以看到文本文件中的test字段值</span><br><span class="line">放到最后去了</span><br><span class="line">2 100.20 a string</span><br><span class="line">4 102.20 a string containing a , comma</span><br><span class="line">6 102.20 a string containing a &quot; quote</span><br><span class="line">8 102.20 a string containing a &quot;, quote and comma</span><br><span class="line"></span><br><span class="line"># 现在，truncate掉表test3，执行load data载入数据</span><br><span class="line">truncate test3;</span><br><span class="line">load data infile &#x27;/tmp/test3.txt&#x27; into table</span><br><span class="line">test3(id,test2,test);</span><br><span class="line">select * from test3; #可以看到，使用(id,test2,test)子句指定</span><br><span class="line">了与文本文件中数据的字段一致的顺序，导入表表中之后数据的顺序是正确的</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id | test                                     | test2  |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                  | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma             | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote             | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma  | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br></pre></td></tr></table></figure>



<h3 id="2-5-5-LOCAL关键字"><a href="#2-5-5-LOCAL关键字" class="headerlink" title="2.5.5 LOCAL关键字"></a>2.5.5 LOCAL关键字</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">说明： 如果要载入的文本文件不在mysql server数据库本身的本地磁盘，客户端也不是从mysql server本机登录的，则需要使用local关键字，指定mysql server从client host本地加载该文件，需要mysql server端使用</span><br><span class="line">     local_infile=true(或者设置为1，不设置时默认为1)启动，以及客户端连接mysql server时也使用local_infile=true(或者设置为1，不指定时默认为1)连接才能使用，server和client必须都开启这个参数才能使用local关键字，任意一个关闭都不能使用.</span><br><span class="line"></span><br><span class="line"># 登录到数据库，重新导出表数据到文本，并发送到10.0.0.52服务器</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot;;</span><br><span class="line">system scp /tmp/test3.txt 10.0.0.52:/tmp/test3.txt</span><br><span class="line"># 登录到10.0.0.52服务器，远程连接10.0.0.51数据库</span><br><span class="line">mysql -uroot -p123 h10.0.0.51</span><br><span class="line">mysql&gt; use oldguo</span><br><span class="line">mysql&gt; system ls -lh /tmp/test3.txt;</span><br><span class="line">-rw-r--r-- 1 root root 146 May 3 11:11 /tmp/test3.txt</span><br><span class="line">mysql&gt; system cat /tmp/test3.txt;</span><br><span class="line">2 a string 100.20</span><br><span class="line">4 a string containing a , comma 102.20</span><br><span class="line">6 a string containing a &quot; quote 102.20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8 a string containing a &quot;, quote and comma 102.20</span><br><span class="line">mysql&gt; show variables like &#x27;%local%&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| local_infile | ON     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">mysql&gt; set global local_infile=OFF; #关闭server端的local_infile参数</span><br><span class="line">mysql&gt; truncate test3;</span><br><span class="line">mysql&gt; load data local infile &#x27;/tmp/test3.txt&#x27; into table test3; #执行导入数据时报错了</span><br><span class="line">ERROR 1148 (42000): The used command is not allowed with</span><br><span class="line">this MySQL version</span><br><span class="line">mysql&gt; set global local_infile=ON; #重新打开server端的local_infile参数</span><br><span class="line">mysql&gt; load data local infile &#x27;/tmp/test3.txt&#x27; into table test3; #导入成功</span><br><span class="line">Records: 4 Deleted: 0 Skipped: 0 Warnings: 0</span><br><span class="line">mysql&gt; select * from test3; #查看数据，可以看到数据已成功导入表</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id | test                                      | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string                                   | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma              | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote              | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma   | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"># 对于客户端连接server时使用local_infile=0参数，在执行导入数据时也</span><br><span class="line">会报相同的错误：</span><br><span class="line">mysql -uroot -p123 -h10.0.0.51 --local-infile=0</span><br></pre></td></tr></table></figure>



<h3 id="2-5-6-REPLACE与IGNORE关键字"><a href="#2-5-6-REPLACE与IGNORE关键字" class="headerlink" title="2.5.6 REPLACE与IGNORE关键字"></a>2.5.6 REPLACE与IGNORE关键字</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REPLACE和IGNORE关键字控制对唯一键值冲突行的处理： 如果指定了REPLACE关键字，则输入行将覆盖现有行。</span><br><span class="line">换句话说，与主键或唯一 索引冲突的数据行将被执行覆盖写入，如果同时使用了local关键字，则与没有 使用local关键字行为相同 如果指定了IGNORE关键字，则与唯一键值冲突的数据行将被丢弃，</span><br><span class="line">如果同时使用 了local关键字，则与没有使用local关键字行为相同</span><br></pre></td></tr></table></figure>



<h3 id="2-5-7-fields关键字应用"><a href="#2-5-7-fields关键字应用" class="headerlink" title="2.5.7 fields关键字应用"></a>2.5.7 fields关键字应用</h3><h4 id="字段-列-分隔符应用"><a href="#字段-列-分隔符应用" class="headerlink" title="字段(列)分隔符应用"></a>字段(列)分隔符应用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">默认是\t，使用子句 fields terminated by &#x27;string&#x27; 指定，其中</span><br><span class="line">string代表指定的字段分隔符</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; FIELDS</span><br><span class="line">TERMINATED BY &#x27;,&#x27;;</span><br><span class="line">system cat /tmp/test3.txt</span><br><span class="line">2,a string,100.20</span><br><span class="line">4,a string containing a \, comma,102.20</span><br><span class="line">6,a string containing a &quot; quote,102.20</span><br><span class="line">8,a string containing a &quot;\, quote and comma,102.20</span><br><span class="line"></span><br><span class="line">应用：</span><br><span class="line">db03 [oldguo]&gt;load data infile &#x27;/tmp/passwd&#x27; into table</span><br><span class="line">passwd FIELDS TERMINATED BY &#x27;:&#x27;;</span><br></pre></td></tr></table></figure>



<h4 id="字段引用符"><a href="#字段引用符" class="headerlink" title="字段引用符"></a>字段引用符</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">如果加optionally选项则只用在char、varchar和text等字符型字段上，数</span><br><span class="line">值类型会忽略使用引用符，如果不指定该子句，则默认不使用引用符，使用子句</span><br><span class="line">fields [optionally] enclosed by &#x27;char&#x27;指定，其中char代表指定的</span><br><span class="line">字段引用符</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; FIELDS</span><br><span class="line">ENCLOSED BY &#x27;&quot;&#x27;;</span><br><span class="line">system cat /tmp/test3.txt</span><br><span class="line">&quot;2&quot; &quot;a string&quot; &quot;100.20&quot;</span><br><span class="line">&quot;4&quot; &quot;a string containing a , comma&quot; &quot;102.20&quot;</span><br><span class="line">&quot;6&quot; &quot;a string containing a \&quot; quote&quot; &quot;102.20&quot;</span><br><span class="line">&quot;8&quot; &quot;a string containing a \&quot;, quote and comma&quot; &quot;102.20&quot;</span><br><span class="line">&quot;10&quot; &quot;\\t&quot; &quot;102.20&quot;</span><br><span class="line"># 指定字段引用符为&quot;，使用optionally关键字，可以看到id列的字段引用符</span><br><span class="line">去掉了</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; FIELDS</span><br><span class="line">optionally ENCLOSED BY &#x27;&quot;&#x27;;</span><br><span class="line">system cat /tmp/test3.txt</span><br><span class="line">2 &quot;a string&quot; &quot;100.20&quot;</span><br><span class="line">4 &quot;a string containing a , comma&quot; &quot;102.20&quot;</span><br><span class="line">6 &quot;a string containing a \&quot; quote&quot; &quot;102.20&quot;</span><br><span class="line">8 &quot;a string containing a \&quot;, quote and comma&quot; &quot;102.20&quot;</span><br><span class="line">10 &quot;\\t&quot; &quot;102.20&quot;</span><br><span class="line">db03 [oldguo]&gt;select * from t5 into outfile &#x27;/tmp/t7.txt&#x27;</span><br><span class="line">FIELDS TERMINATED BY &#x27;,&#x27; ENCLOSED BY &#x27;&quot;&#x27;;</span><br><span class="line">db03 [oldguo]&gt;select * from t5 into outfile &#x27;/tmp/t8.txt&#x27;</span><br><span class="line">FIELDS TERMINATED BY &#x27;,&#x27; optionally ENCLOSED BY &#x27;&quot;&#x27;;</span><br></pre></td></tr></table></figure>



<h4 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">默认为\，使用子句fields escaped by &#x27;char&#x27; 指定，其中char代表指定</span><br><span class="line">的转义字符</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; fields</span><br><span class="line">escaped by &#x27;.&#x27;;</span><br><span class="line">system cat /tmp/test3.txt # 可以看到数据中指定的转义符.号被转义</span><br><span class="line">了，而数据\t没有被转义</span><br><span class="line">2 a string 100..20</span><br><span class="line">4 a string containing a , comma 102..20</span><br><span class="line">6 a string containing a &quot; quote 102..20</span><br><span class="line">8 a string containing a &quot;, quote and comma 102..20</span><br><span class="line">10 \t 102..20</span><br><span class="line">truncate test3; #清空表</span><br><span class="line">load data infile &quot;/tmp/test3.txt&quot; into table test3 fields</span><br><span class="line">escaped by &#x27;.&#x27;; #导入数据时指定转义符为.号</span><br><span class="line">select * from test3; #校验数据，可以看到导入数据正常</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id | 										test | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string 									| 100.20 |</span><br><span class="line">| 4 | a string containing a , comma 			| 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote 			| 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma  | 102.20 |</span><br><span class="line">| 10 | \t 										| 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br></pre></td></tr></table></figure>



<h3 id="2-5-8-LINES-关键字应用"><a href="#2-5-8-LINES-关键字应用" class="headerlink" title="2.5.8 LINES 关键字应用"></a>2.5.8 LINES 关键字应用</h3><h4 id="行前缀字符串"><a href="#行前缀字符串" class="headerlink" title="行前缀字符串"></a>行前缀字符串</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># load data语句如下</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; LINES</span><br><span class="line">STARTING BY &#x27;xxx&#x27;;</span><br><span class="line">system cat /tmp/test3.txt #可以看到每行数据前面多了个行前缀字符</span><br><span class="line">串xxx</span><br><span class="line">xxx2 a string 100.20</span><br><span class="line">xxx4 a string containing a , comma 102.20</span><br><span class="line">xxx6 a string containing a &quot; quote 102.20</span><br><span class="line">xxx8 a string containing a &quot;, quote and comma 102.20</span><br><span class="line">xxx10 \\t 102.20</span><br><span class="line"># 现在，到shell命令行去修改一下，增加两行</span><br><span class="line">system cat /tmp/test3.txt # 最后要加载的纯文本数据内容如下</span><br><span class="line">xxx2 a string 100.20</span><br><span class="line">xxx4 a string containing a , comma 102.20</span><br><span class="line">xxx6 a string containing a &quot; quote 102.20</span><br><span class="line">xxx8 a string containing a &quot;, quote and comma 102.20</span><br><span class="line">xxx10 \\t 102.20</span><br><span class="line">12 \\t 102.20</span><br><span class="line">dfadsfasxxx14 \\t 102.20</span><br><span class="line">truncate test3; #清空表</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line">load data infile &quot;/tmp/test3.txt&quot; into table test3 LINES</span><br><span class="line">STARTING BY &#x27;xxx&#x27;; #导入数据，指定行前缀字符为xxx</span><br><span class="line">select * from test3; #校验表数据，可以看到没有xxx行前缀的行被忽</span><br><span class="line">略了，而包含xxx的最后一行，从xxx开始截断，xxx字符本身及其之前的内容被</span><br><span class="line">忽略，\</span><br><span class="line">xxx之后的内容被解析为行数据导入了</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id |										 test | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string									 | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma				 | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote 			 | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma   | 102.20 |</span><br><span class="line">| 10 | \t										 | 102.20 |</span><br><span class="line">| 14 | \t 										 | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br></pre></td></tr></table></figure>



<h4 id="行结束符"><a href="#行结束符" class="headerlink" title="行结束符"></a>行结束符</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">linux下默认为\n，使用子句lines terminated by &#x27;string&#x27; 指定，其</span><br><span class="line">中string代表指定的换行符</span><br><span class="line"># 指定换行符为\r\n导出数据</span><br><span class="line">system rm -f /tmp/test3.txt;</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; lines</span><br><span class="line">terminated by &#x27;\r\n&#x27;;</span><br><span class="line"># 现在，把数据重新导入表，从下面的结果中可以看到，导入表中的数据正确</span><br><span class="line">truncate test3;</span><br><span class="line">load data infile &quot;/tmp/test3.txt&quot; into table test3 lines</span><br><span class="line">terminated by &#x27;\r\n&#x27;;</span><br><span class="line">select * from test3;</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| id |										 test | test2 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br><span class="line">| 2 | a string									 | 100.20 |</span><br><span class="line">| 4 | a string containing a , comma				 | 102.20 |</span><br><span class="line">| 6 | a string containing a &quot; quote 			 | 102.20 |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma   | 102.20 |</span><br><span class="line">| 10 | \t										 | 102.20 |</span><br><span class="line">| 14 | \t 										 | 102.20 |</span><br><span class="line">+----+------------------------------------------+--------+</span><br></pre></td></tr></table></figure>



<h3 id="2-5-9FIELDS和LINES注意事项"><a href="#2-5-9FIELDS和LINES注意事项" class="headerlink" title="2.5.9FIELDS和LINES注意事项"></a>2.5.9FIELDS和LINES注意事项</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">MySQL中反斜杠是SQL语句中特殊字符的转义字符，因此在sql语句中碰到</span><br><span class="line">特殊字符时，您必须指定一个或者两个反斜杠来为特殊字符转义（如在mysql中</span><br><span class="line">或者一些其他程序中，\n代表换行符，\t代表制表符，\代表转义符，那么需要</span><br><span class="line">使用\t来转义制表符，\n来转义换行符，\来转义转义符本身，这样才能正确写</span><br><span class="line">入数据库或者生成导出的数据文本,使用FIELDS ESCAPED BY子句指定转义符.</span><br><span class="line">特殊字符列表如下</span><br><span class="line">\0 ASCII NUL (X&#x27;00&#x27;) 字符</span><br><span class="line">\b 退格字符</span><br><span class="line">\n 换行符</span><br><span class="line">\r 回车符</span><br><span class="line">\t 制表符</span><br><span class="line">\Z ASCII 26 (Control+Z)</span><br><span class="line">\N NULL值，如果转义符值为空，则会直接导出null字符串作为数据，这在导</span><br><span class="line">入时将把null作为数据导入</span><br><span class="line">例如： 数据中包含了ENCLOSED BY &#x27;&quot;&#x27;子句指定字段引用符号，则与字段引</span><br><span class="line">用符号相同数据字符也会被自动添加一个反斜杠进行转义（如果转义符指定为</span><br><span class="line">空，则可能会导致数据在导入时无法正确解析）。</span><br><span class="line">例如：</span><br><span class="line">select * from test3 into outfile &quot;/tmp/test3.txt&quot; FIELDS</span><br><span class="line">OPTIONALLY enclosed BY &#x27;&quot;&#x27;;</span><br><span class="line">system cat /tmp/test3.txt;</span><br><span class="line">2 &quot;a string&quot; &quot;100.20&quot;</span><br><span class="line">4 &quot;a string containing a , comma&quot; &quot;102.20&quot;</span><br><span class="line">6 &quot;a string containing a \&quot; quote&quot; &quot;102.20&quot;</span><br><span class="line">8 &quot;a string containing a \&quot;, quote and comma&quot; &quot;102.20&quot; #</span><br><span class="line">可以看到与字段引用符相同的符号数据被转义了</span><br></pre></td></tr></table></figure>



<h3 id="2-5-10-IGNORE-number-LINES-ROWS-子句"><a href="#2-5-10-IGNORE-number-LINES-ROWS-子句" class="headerlink" title="2.5.10 IGNORE number {LINES | ROWS}子句"></a>2.5.10 IGNORE number {LINES | ROWS}子句</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">忽略输入文件中的前number行数据，使用子句ignore number lines指定忽</span><br><span class="line">略文本的前number行，在某些情况下生成的文本（如：mysql -e &quot;select</span><br><span class="line">….&quot; &gt; xx.txt中）带有字段名称，在导入时会把这一行字段名称也当作数据，</span><br><span class="line">所以需要忽略掉这行字段名称</span><br><span class="line">system cat /tmp/test3.txt</span><br><span class="line">id test test2 test3</span><br><span class="line">2 a string 100.20 null</span><br><span class="line">4 a string containing a , comma 102.20 NULL</span><br><span class="line">6 a string containing a &quot; quote 102.20 NULL</span><br><span class="line">8 a string containing a &quot;, quote and comma 102.20</span><br><span class="line">NULL</span><br><span class="line">10 \\t 102.20 NULL</span><br><span class="line">14 \\t 102.20 NULL</span><br><span class="line">truncate test4;</span><br><span class="line">load data infile &quot;/tmp/test3.txt&quot; into table test4 ignore</span><br><span class="line">1 lines; #载入文本时指定ignore 1 lines子句忽略文本中的前1行数据</span><br><span class="line">select * from test4; #查询表test4中的数据，从下面的结果中可以看</span><br><span class="line">到数据正确</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| id | 										 test | test2 |test3 |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| 2 | a string | 100.20									   |null |</span><br><span class="line">| 4 | a string containing a , comma 			  | 102.20 |NULL |</span><br><span class="line">| 6 | a string containing a &quot; quote 			  | 102.20 |NULL |</span><br><span class="line">| 8 | a string containing a &quot;, quote and comma    | 102.20 |NULL |</span><br><span class="line">| 10 |\t									      | 102.20 |NULL |</span><br><span class="line">| 14 | \t 										  | 102.20 |NULL |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br></pre></td></tr></table></figure>



<h3 id="2-5-11-SET-col-name-x3D-expr-…子句"><a href="#2-5-11-SET-col-name-x3D-expr-…子句" class="headerlink" title="2.5.11 SET col_name &#x3D; expr,…子句"></a>2.5.11 SET col_name &#x3D; expr,…子句</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">将列做一定的数值转换后再加载，使用子句set col_name = expr,.. 指</span><br><span class="line">定，要注意：col_name必须为表中真实的列名，expr可以是任意的表达式或者</span><br><span class="line">子查询，只要返回的数据结果值能对应上表中的字段数据定义类型即可，注意，</span><br><span class="line">非set语句生成的列名，必须使用括号括起来，否则报语法错误。</span><br><span class="line"># 如果系统将id列的文本数据加上<span class="number">10</span>以后再加载到表的test3列中，可以如下</span><br><span class="line">操作：</span><br><span class="line">system rm -f /tmp/test3.<span class="property">txt</span>;</span><br><span class="line">select * <span class="keyword">from</span> test3 into outfile <span class="string">&quot;/tmp/test3.txt&quot;</span>;</span><br><span class="line">system cat /tmp/test3.<span class="property">txt</span></span><br><span class="line"><span class="number">2</span> a string <span class="number">100.20</span> <span class="literal">null</span></span><br><span class="line"><span class="number">4</span> a string containing a , comma <span class="number">102.20</span> \N</span><br><span class="line"><span class="number">6</span> a string containing a <span class="string">&quot; quote 102.20 \N</span></span><br><span class="line"><span class="string">8 a string containing a &quot;</span>, quote and comma <span class="number">102.20</span> \N</span><br><span class="line"><span class="number">10</span> \\t <span class="number">102.20</span> \N</span><br><span class="line"><span class="number">14</span> \\t <span class="number">102.20</span> \N</span><br><span class="line">create table test4 like test3;</span><br><span class="line">alter table test4 add column test3 <span class="title function_">varchar</span>(<span class="number">10</span>);</span><br><span class="line">truncate test4;</span><br><span class="line">load data infile <span class="string">&quot;/tmp/test3.txt&quot;</span> into table test4</span><br><span class="line">(id,test,test2) set test3=id+<span class="number">10</span> ;</span><br><span class="line"><span class="variable constant_">ERROR</span> <span class="number">1262</span> (<span class="number">01000</span>): <span class="title class_">Row</span> <span class="number">1</span> was truncated; it contained more</span><br><span class="line">data than there were input columns</span><br><span class="line">select * <span class="keyword">from</span> test4; #严格模式下因为文本中多了一个字段被截断了，</span><br><span class="line">所以拒绝导入,修改sql_mode后导入。</span><br><span class="line">load data local infile <span class="string">&quot;/tmp/test3.txt&quot;</span> into table test4</span><br><span class="line">(id,test,test2) set test3=id+<span class="number">10</span> ;</span><br><span class="line">#可以使用local关键字强制进行截断最后一个字段的<span class="literal">null</span>值列进行导入</span><br><span class="line">注意，如果不使用local关键字，那就需要修改sql_mode才能导入</span><br><span class="line">select * <span class="keyword">from</span> test4;</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| id | test | test2 |test3 |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| <span class="number">2</span> | a string | <span class="number">100.20</span> |<span class="number">12</span> |</span><br><span class="line">| <span class="number">4</span> | a string containing a , comma | <span class="number">102.20</span> |<span class="number">14</span> |</span><br><span class="line">| <span class="number">6</span> | a string containing a <span class="string">&quot; quote | 102.20 |16 |</span></span><br><span class="line"><span class="string">| 8 | a string containing a &quot;</span>, quote and comma | <span class="number">102.20</span> |<span class="number">18</span> |</span><br><span class="line">| <span class="number">10</span> | \t | <span class="number">102.20</span> |<span class="number">20</span> |</span><br><span class="line">| <span class="number">14</span> | \t | <span class="number">102.20</span> |<span class="number">24</span> |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line"><span class="number">6</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"># 或者使用txt文件中的某些列进行计算后生成新的列插入，这里演示两个字段</span><br><span class="line">进行相加后导入另外一个字段中：</span><br><span class="line">load data local infile <span class="string">&quot;/tmp/test3.txt&quot;</span> into table test4</span><br><span class="line">(id,test,test2) set test3=id+test2 ; # 注意，如果不使用local</span><br><span class="line">关键字，那就需要修改sql_mode才能导入</span><br><span class="line">select * <span class="keyword">from</span> test4;</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| id | 		test																	 | test2 |test3  |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line">| <span class="number">2</span> | a string																 	| <span class="number">100.20</span> |<span class="number">102.2</span> |</span><br><span class="line">| <span class="number">4</span> | a string containing a , comma 				  	| <span class="number">102.20</span> |<span class="number">106.2</span> |</span><br><span class="line">| <span class="number">6</span> | a string containing a <span class="string">&quot; quote 					  | 102.20 |108.2 |</span></span><br><span class="line"><span class="string">| 8 | a string containing a &quot;</span>, quote and comma  | <span class="number">102.20</span> |<span class="number">110.2</span> |</span><br><span class="line">| <span class="number">10</span> | \t 																			| <span class="number">102.20</span> |<span class="number">112.2</span> |</span><br><span class="line">| <span class="number">14</span> | \t 																			| <span class="number">102.20</span> |<span class="number">116.2</span> |</span><br><span class="line">+----+------------------------------------------+--------+-------+</span><br><span class="line"><span class="number">6</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<h3 id="2-5-12使用mysqldump批量导出"><a href="#2-5-12使用mysqldump批量导出" class="headerlink" title="2.5.12使用mysqldump批量导出"></a>2.5.12使用mysqldump批量导出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -u username -p&#x27;xxx&#x27; -T target_dir db_name</span><br><span class="line"></span><br><span class="line">tb_name [option];</span><br><span class="line">其中option参数是以下几种可选参数：</span><br><span class="line">	--fields-terminated-by &#x27;string&#x27; 字段分隔符</span><br><span class="line">	--fields-enclosed-by &#x27;char&#x27; 字段引用符</span><br><span class="line">	--fields-optionally-enclosed-by &#x27;char&#x27; 字段引用符，只在char,varchar,text等字段类型上生效</span><br><span class="line">	--fields-escaped-by &#x27;char&#x27; 转义字符</span><br><span class="line">	--lines-terminated-by &#x27;string&#x27; 记录结束符，即换行符</span><br><span class="line"></span><br><span class="line">mkdir /data/backup/</span><br><span class="line">chown mysql.mysql /data/backup -R</span><br><span class="line">mysqldump -uroot -p123 -h 10.0.0.53 --single-transaction --master-data=2 --triggers --routines --events--fields-terminated-by &#x27;,&#x27; --fields-enclosed-by &#x27;&quot;&#x27; world -T /data/backup/</span><br></pre></td></tr></table></figure>



<h3 id="2-5-13-使用mysqlimport批量导入"><a href="#2-5-13-使用mysqlimport批量导入" class="headerlink" title="2.5.13 使用mysqlimport批量导入"></a>2.5.13 使用mysqlimport批量导入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport -uroot -p <span class="string">&#x27;xxx&#x27;</span> [--local] db_name</span><br><span class="line">order_tab.<span class="property">txt</span> [iption]</span><br><span class="line"># 参数：</span><br><span class="line">--fields-terminated-by=name 指定字段分隔符</span><br><span class="line">--fields-enclosed-by=name 指定字段引用符</span><br><span class="line">--fields-optionally-enclosed-by=name 指定字段引用符，但只在</span><br><span class="line">char、varchar、text字段上使用引用符</span><br><span class="line">--fields-escaped-by=name 指定转义字符</span><br><span class="line">--lines-terminated-by=name 指定行记录结束符（换行符）</span><br><span class="line">--ignore-liens=number 忽略前几行</span><br><span class="line">--low-priority 碰到有其他线程update操作操作的表与导入操作表相同</span><br><span class="line">时，延迟执行导入操作</span><br><span class="line">-i, --ignore 如果碰到唯一键冲突就忽略冲突行导入</span><br><span class="line">-r, --replace 如果碰到唯一键冲突就覆盖冲突行导入</span><br><span class="line">-L, --local 从客户端主机加载数据文本文件</span><br><span class="line">-C, --compress 在C/S模型之间使用压缩传输数据</span><br><span class="line">-c, --columns=name 指定需要导入哪些列，与load data语句中一样需</span><br><span class="line">要指定表定义中真实的列名，有多个列名时使用逗号分隔</span><br><span class="line">--<span class="keyword">default</span>-character-set=name 设置使用该选项指定的字符集来解析文</span><br><span class="line">本文件中的内容</span><br><span class="line">-h, --host 指定导入server的主机<span class="variable constant_">IP</span></span><br><span class="line">-p, --password[=name] 指定导入server的用户密码</span><br><span class="line">-P, --port=# 指定导入server的监听端口</span><br><span class="line">--use-threads=# 指定多少个线程并发执行load data语句（实测单表时</span><br><span class="line">指定多线程时要比单线程要快，由于数据量小，测试出来的差别并不大，官方并</span><br><span class="line">没有说明是基于什么级别的并发，\</span><br><span class="line">只写了一句：<span class="title class_">Load</span> files <span class="keyword">in</span> parallel using N threads，推测可能是</span><br><span class="line">基于类似mydumper的并发，但是多表导入时指定多线程就明显比单线程要快很</span><br><span class="line">多）</span><br><span class="line">-u, --user=name 指定导入server的用户名</span><br><span class="line">-d, --<span class="keyword">delete</span> 指定导入操作之前先把表清空（实测重复导入时加了这个选项</span><br><span class="line">之后可以正常执行，，通过解析binlog发现，发现binlog中记录的第二次和第</span><br><span class="line">一次导入的语句完全相同是，\</span><br><span class="line">第二次导入时如果发现表中有冲突数据，就先执行的不带where条件的</span><br><span class="line"><span class="keyword">delete</span>，所有表先<span class="keyword">delete</span>掉，然后再执行load data语句导入数据，另外，</span><br><span class="line">当与replace一起使用时，忽略replace选项）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># mysqlimport用法演示示例</span><br><span class="line">## 单表</span><br><span class="line">mysqlimport -uroot -p123 -h10<span class="number">.0</span><span class="number">.0</span><span class="number">.51</span> world</span><br><span class="line">/data/backup/city.<span class="property">txt</span></span><br><span class="line">## 多表</span><br><span class="line">mysqlimport -uroot -p123 -h10<span class="number">.0</span><span class="number">.0</span><span class="number">.51</span> --replace world</span><br><span class="line">/data/backup<span class="comment">/*.txt</span></span><br><span class="line"><span class="comment">## 多表导入时可以使用参数--use-threads指定多个线程</span></span><br><span class="line"><span class="comment">mysqlimport -uroot -p123 -h10.0.0.51 --replace --use-threads=8 world /data/backup/*.txt</span></span><br></pre></td></tr></table></figure>



<h2 id="2-6物理备份工具使用-PerconaXtrabackup-✨"><a href="#2-6物理备份工具使用-PerconaXtrabackup-✨" class="headerlink" title="2.6物理备份工具使用-PerconaXtrabackup ✨"></a>2.6物理备份工具使用-PerconaXtrabackup ✨</h2><h3 id="2-6-1-安装"><a href="#2-6-1-安装" class="headerlink" title="2.6.1 安装"></a>2.6.1 安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install percona-xtrabackup</span><br><span class="line">对于8.0.20版本，需要使用PXB 8.0.12+以上版本。</span><br><span class="line">PXB 8.0 只能备份 MySQL 8.0 ，不能备份低版本</span><br><span class="line">低版本MySQL 使用PXB2.4版本</span><br></pre></td></tr></table></figure>



<h3 id="2-6-2-全量备份"><a href="#2-6-2-全量备份" class="headerlink" title="2.6.2 全量备份"></a>2.6.2 全量备份</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>全量备份</span><br><span class="line">xtrabackup --defaults-file=<span class="regexp">/etc/my</span>.<span class="property">cnf</span> --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --</span><br><span class="line">user=root --password=<span class="number">123</span> --port=<span class="number">3306</span> --backup --target-dir=<span class="regexp">/data/</span>backup/full</span><br><span class="line">或者：使用参数--datadir替换掉参数--defaults-file.</span><br><span class="line"># xtrabackup --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --user=root --password=<span class="number">123</span> -</span><br><span class="line">-port=<span class="number">3306</span> --datadir=<span class="regexp">/data/</span>crm/ --backup --target-dir=<span class="regexp">/data/</span>backup/</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>数据恢复：</span><br><span class="line"><span class="number">2.1</span> 准备：</span><br><span class="line">xtrabackup --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --user=root --password=<span class="number">123</span> --</span><br><span class="line">port=<span class="number">3306</span> --prepare --target-dir=<span class="regexp">/data/</span>backup/</span><br><span class="line"><span class="number">2.2</span> 拷回数据：</span><br><span class="line">xtrabackup --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --user=root --password=<span class="number">123</span> --</span><br><span class="line">port=<span class="number">3306</span> --datadir=<span class="regexp">/data/</span>bak --copy-back --targetdir=<span class="regexp">/data/</span>backup/</span><br><span class="line"><span class="number">2.3</span> 修改目录属性启动数据库：</span><br><span class="line">chown -R mysql.<span class="property">mysql</span> /data/bak</span><br><span class="line">chmod -R <span class="number">755</span> /data/bak</span><br><span class="line"><span class="number">2.4</span> 启动数据库实例:</span><br><span class="line"><span class="number">2.5</span> 若有主从的问题可以查看备份目录下的文件：</span><br><span class="line">cat xtrabackup_binlog_pos_innodb</span><br></pre></td></tr></table></figure>



<h3 id="2-6-3-增量备份"><a href="#2-6-3-增量备份" class="headerlink" title="2.6.3 增量备份"></a>2.6.3 增量备份</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">全量备份的目录为： mkdir -p /data/backup/full</span><br><span class="line">增量备份的目录为： mkdir -p /data/backup/inc</span><br><span class="line"><span class="number">1.</span>备份操作：</span><br><span class="line"><span class="number">1.1</span>.全量备份：</span><br><span class="line">xtrabackup --defaults-file=<span class="regexp">/etc/my</span>.<span class="property">cnf</span> --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --</span><br><span class="line">user=root --password=<span class="number">123</span> --port=<span class="number">3306</span> --backup --parallel=<span class="number">4</span></span><br><span class="line">--target-dir=<span class="regexp">/data/</span>backup/full</span><br><span class="line"><span class="number">1.2</span>.增量备份：</span><br><span class="line">xtrabackup --defaults-file=<span class="regexp">/etc/my</span>.<span class="property">cnf</span> --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --</span><br><span class="line">user=root --password=<span class="number">123</span> --port=<span class="number">3306</span> --backup --parallel=<span class="number">4</span></span><br><span class="line">--target-dir=<span class="regexp">/data/</span>backup/inc --incremental-basedir=<span class="regexp">/data/</span>backup/full</span><br><span class="line"><span class="number">2.</span>恢复操作：</span><br><span class="line"><span class="number">2.1</span> 准备全备份的日志：</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=<span class="regexp">/data/</span>backup/full</span><br><span class="line"><span class="number">2.2</span> 准备增量备份的日志：</span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=<span class="regexp">/data/</span>backup/full --incremental-dir=<span class="regexp">/data/</span>backup/inc</span><br><span class="line"><span class="number">2.3</span> 全备份准备：</span><br><span class="line"># xtrabackup --prepare --target-dir=<span class="regexp">/data/</span>backup</span><br><span class="line"><span class="number">2.4</span> 拷回数据：</span><br><span class="line">xtrabackup --host=<span class="number">10.0</span><span class="number">.0</span><span class="number">.51</span> --user=root --password=<span class="number">123</span> --</span><br><span class="line">port=<span class="number">3306</span> --datadir=<span class="regexp">/data/</span>bak1 --copy-back --target-dir=<span class="regexp">/data/</span>backup/full</span><br><span class="line"><span class="number">2.5</span> 修改数据目录的权限和属性：</span><br><span class="line">chown -R <span class="attr">mysql</span>:mysql /data/bak1</span><br><span class="line">chmod -R <span class="number">755</span> /data/bak1</span><br></pre></td></tr></table></figure>



<h2 id="2-7企业级备份工具MEB介绍及使用"><a href="#2-7企业级备份工具MEB介绍及使用" class="headerlink" title="2.7企业级备份工具MEB介绍及使用"></a>2.7企业级备份工具MEB介绍及使用</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 下载地址</span><br><span class="line">https://edelivery.oracle.com/</span><br><span class="line">#全备及恢复</span><br><span class="line">mysqlbackup --backup_dir=/data/backup backup</span><br><span class="line">mysqlbackup --backup-dir=/data/backup/ apply-log</span><br><span class="line">mysqlbackup --backup-dir=/data/backup/ copy-back</span><br><span class="line"># 单文件</span><br><span class="line">mysqlbackup --backup-image=/data/backup/img/bak.img --</span><br><span class="line">backup-dir=/data/backup/tmp backup-to-image</span><br><span class="line">#增量:</span><br><span class="line">mysqlbackup --incremental=optimistic --incrementalbase=history:last_backup --backup-dir=/data/back/incr1 --</span><br><span class="line">backup-image=incremental_image1.bi backup-to-image</span><br><span class="line">mysqlbackup --incremental=optimistic --incrementalbase=dir:/back/full1 --backup-dir=/back/incr1 --backupimage=incremental_image1.bi backup-to-image</span><br><span class="line">mysqlbackup --incremental=optimistic --incrementalbase=dir:/back/incr1 --backup-dir=/back/incr2 --backupimage=incremental_image2.bi backup-to-image</span><br><span class="line"># 恢复：</span><br><span class="line">方法一：</span><br><span class="line">使用copy-back-and-apply-log恢复全量</span><br><span class="line">使用copy-back-and-apply-log恢复增量</span><br><span class="line">方法二：</span><br><span class="line">前滚全量</span><br><span class="line">mysqlbackup --backup-dir=/full-backup/ apply-log</span><br><span class="line">前滚增量</span><br><span class="line">mysqlbackup --incremental-backup-dir=/incr-backup</span><br><span class="line">–backup-dir=/full-backup apply-incremental-backup</span><br></pre></td></tr></table></figure>



<h2 id="2-8-MySQL-8-0-8-0-17-Clone-plugin"><a href="#2-8-MySQL-8-0-8-0-17-Clone-plugin" class="headerlink" title="2.8 MySQL 8.0 (8.0.17+) Clone-plugin"></a>2.8 MySQL 8.0 (8.0.17+) Clone-plugin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">1 . Clone Plugin介绍</span><br><span class="line">本地克隆：</span><br><span class="line">启动克隆操作的MySQL服务器实例中的数据，克隆到同服务器或同节点上的一个</span><br><span class="line">目录里</span><br><span class="line">远程克隆：</span><br><span class="line">默认情况下，远程克隆操作会删除接受者(recipient)数据目录中的数据，并</span><br><span class="line">将其替换为捐赠者(donor)的克隆数据。您也可以将数据克隆到接受者的其他目</span><br><span class="line">录，以避免删除现有数据。(可选)</span><br><span class="line"></span><br><span class="line">2. 原理</span><br><span class="line"># PAGE COPY</span><br><span class="line">这里有两个动作开启redo archiving功能，从当前点开始存储新增的redo log，这样从当前</span><br><span class="line">点开始所有的增量修改都不会丢失。同时上一步在page track的page被发送到</span><br><span class="line">目标端。确保当前点之前所做的变更一定发送到目标端。</span><br><span class="line">关于redo archiving，实际上这是官方早就存在的功能，主要用于官方的企业</span><br><span class="line">级备份工具，但这里clone利用了该特性来维持增量修改产生的redo。</span><br><span class="line">在开始前会做一次checkpoint， 开启一个后台线程</span><br><span class="line">log_archiver_thread()来做日志归档。当有新的写入时</span><br><span class="line">(notify_about_advanced_write_lsn)也会通知他去archive。当</span><br><span class="line">arch_log_sys处于活跃状态时，他会控制日志写入以避免未归档的日志被覆盖</span><br><span class="line">(log_writer_wait_on_archiver), 注意如果log_writer等待时间过长</span><br><span class="line">的话， archive任务会被中断掉.</span><br><span class="line"># Redo Copy</span><br><span class="line">停止Redo Archiving&quot;, 所有归档的日志被发送到目标端，这些日志包含了从</span><br><span class="line">page copy阶段开始到现在的所有日志，另外可能还需要记下当前的复制点，例</span><br><span class="line">如最后一个事务提交时的binlog位点或者gtid信息，在系统页中可以找到。</span><br><span class="line"># Done</span><br><span class="line">目标端重启实例，通过crash recovery将redo log应用上去。</span><br><span class="line"></span><br><span class="line">3. 限制</span><br><span class="line">官方文档列出的一些限制：</span><br><span class="line">The clone plugin is subject to these limitations:</span><br><span class="line">* DDL, is not permitted during a cloning operation. This</span><br><span class="line">limitation should be considered when selecting data</span><br><span class="line">sources. A workaround is to use dedicated donor instances,</span><br><span class="line">which can accommodate DDL operations being blocked while</span><br><span class="line">data is cloned. Concurrent DML is permitted.</span><br><span class="line">* An instance cannot be cloned from a different MySQL</span><br><span class="line">server version. The donor and recipient must have the same</span><br><span class="line">MySQL server version. For example, you cannot clone</span><br><span class="line">between MySQL 5.7 and MySQL 8.0\. The clone plugin is only</span><br><span class="line">supported in MySQL 8.0.17 and higher.</span><br><span class="line">* Only a single MySQL instance can be cloned at a time.</span><br><span class="line">Cloning multiple MySQL instances in a single cloning</span><br><span class="line">operation is not supported.</span><br><span class="line">* The X Protocol port specified byis not supported for</span><br><span class="line">remote cloning operations</span><br><span class="line">* The clone plugin does not support cloning of MySQL</span><br><span class="line">server configurations.</span><br><span class="line">* The clone plugin does not support cloning of binary</span><br><span class="line">logs.* The clone plugin only clones data stored in `InnoDB`.</span><br><span class="line">Other storage engine data is not cloned.</span><br><span class="line">* Connecting to the donor MySQL server instance through</span><br><span class="line">MySQL Router is not supported.</span><br><span class="line">* Local cloning operations do not support cloning of</span><br><span class="line">general tablespaces that were created with an absolute</span><br><span class="line">path. A cloned tablespace file with the same path as the</span><br><span class="line">source tablespace file would cause a conflict.</span><br><span class="line"></span><br><span class="line">4. 应用</span><br><span class="line">4.1 本地</span><br><span class="line">4.1.1 加载插件</span><br><span class="line">INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;</span><br><span class="line">或</span><br><span class="line">[mysqld]</span><br><span class="line">plugin-load-add=mysql_clone.so</span><br><span class="line">clone=FORCE_PLUS_PERMANENT</span><br><span class="line">SELECT PLUGIN_NAME, PLUGIN_STATUS</span><br><span class="line">FROM INFORMATION_SCHEMA.PLUGINS</span><br><span class="line">WHERE PLUGIN_NAME LIKE &#x27;clone&#x27;;</span><br><span class="line">4.1.2 创建克隆专用用户</span><br><span class="line">CREATE USER clone_user@&#x27;%&#x27; IDENTIFIED by &#x27;password&#x27;;</span><br><span class="line">GRANT BACKUP_ADMIN ON *.* TO &#x27;clone_user&#x27;;</span><br><span class="line"># BACKUP_ADMIN是MySQL8.0 才有的备份锁的权限</span><br><span class="line">4.1.3 本地克隆</span><br><span class="line">[root@db01 3306]# mkdir -p /data/test/</span><br><span class="line">[root@db01 3306]# chown -R mysql.mysql /data/</span><br><span class="line">mysql -uclone_user -ppassword</span><br><span class="line">CLONE LOCAL DATA DIRECTORY = &#x27;/data/test/clonedir&#x27;;</span><br><span class="line"># 观测状态</span><br><span class="line">db01 [(none)]&gt; SELECT STAGE, STATE, END_TIME FROM</span><br><span class="line">performance_schema.clone_progress;</span><br><span class="line">+-----------+-------------+----------------------------+</span><br><span class="line">| STAGE | STATE | END_TIME |</span><br><span class="line">+-----------+-------------+----------------------------+</span><br><span class="line">| DROP DATA | Completed | 2020-04-20 21:13:19.264003 |</span><br><span class="line">| FILE COPY | Completed | 2020-04-20 21:13:20.025444 |</span><br><span class="line">| PAGE COPY | Completed | 2020-04-20 21:13:20.028552 |</span><br><span class="line">| REDO COPY | Completed | 2020-04-20 21:13:20.030042 |</span><br><span class="line">| FILE SYNC | Completed | 2020-04-20 21:13:20.439444 |</span><br><span class="line">| RESTART | Not Started | NULL |</span><br><span class="line">| RECOVERY | Not Started | NULL |</span><br><span class="line">+-----------+-------------+----------------------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line">#日志观测：</span><br><span class="line">set global log_error_verbosity=3;</span><br><span class="line">tail -f db01.err</span><br><span class="line">CLONE LOCAL DATA DIRECTORY = &#x27;/data/test/3308&#x27;;</span><br><span class="line">4.1.4 启动新实例</span><br><span class="line">[root@db01 clonedir]# mysqld_safe --</span><br><span class="line">datadir=/data/test/3307 --port=3333 --</span><br><span class="line">socket=/tmp/mysql3333.sock --user=mysql --mysqlx=OFF &amp;</span><br><span class="line">4.2 远程clone</span><br><span class="line">INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;</span><br><span class="line">或</span><br><span class="line">[mysqld]</span><br><span class="line">plugin-load-add=mysql_clone.so</span><br><span class="line">clone=FORCE_PLUS_PERMANENT</span><br><span class="line">SELECT PLUGIN_NAME, PLUGIN_STATUS</span><br><span class="line">FROM INFORMATION_SCHEMA.PLUGINS</span><br><span class="line">WHERE PLUGIN_NAME LIKE &#x27;clone&#x27;;</span><br><span class="line">4.2.1 创建远程clone用户</span><br><span class="line"># 捐赠者授权</span><br><span class="line">create user test@&#x27;%&#x27; identified by &#x27;123&#x27;;</span><br><span class="line">grant backup_admin on *.* to test@&#x27;%&#x27;;</span><br><span class="line"># 接受者授权</span><br><span class="line">create user test@&#x27;%&#x27; identified by &#x27;123&#x27;;</span><br><span class="line">grant clone_admin on *.* to test@&#x27;%&#x27;;</span><br><span class="line">4.2.2 远程clone</span><br><span class="line"># 开始克隆</span><br><span class="line">SET GLOBAL clone_valid_donor_list=&#x27;10.0.0.51:3306&#x27;;</span><br><span class="line">mysql -utest -p123 -h10.0.0.53 -P3306</span><br><span class="line">CLONE INSTANCE FROM test@&#x27;10.0.0.51&#x27;:3306 IDENTIFIED BY</span><br><span class="line">&#x27;123&#x27;;</span><br></pre></td></tr></table></figure>



<h2 id="2-9-MySQL升级及迁移实战"><a href="#2-9-MySQL升级及迁移实战" class="headerlink" title="2.9 MySQL升级及迁移实战"></a>2.9 MySQL升级及迁移实战</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><span class="line">1. MySQL升级和降级</span><br><span class="line">1.1 方式</span><br><span class="line">1.1.1 INPLACE 就地</span><br><span class="line">在一台服务器上，原版本升级到新版本。</span><br><span class="line">风险较大。</span><br><span class="line">**** 建议 ： 不管哪种方式升级，都应该先做备份。方便失败回退。****</span><br><span class="line">1.1.2 Mergeing 迁移 ----&gt; 建议</span><br><span class="line">备份迁移</span><br><span class="line">主从迁移 （主库（低）---&gt; 从库（高））</span><br><span class="line">1.2 升级注意事项</span><br><span class="line">Upgrade is only supported between General Availability</span><br><span class="line">(GA) releases.</span><br><span class="line">Upgrade from MySQL 5.6 to 5.7 is supported. Upgrading to</span><br><span class="line">the latest release is recommended before upgrading to the</span><br><span class="line">next version. For example, upgrade to the latest MySQL 5.6</span><br><span class="line">release before upgrading to MySQL 5.7.</span><br><span class="line">Upgrade that skips versions is not supported. For example,</span><br><span class="line">upgrading directly from MySQL 5.5 to 5.7 is not supported.</span><br><span class="line">Upgrade within a release series is supported. For example,</span><br><span class="line">upgrading from MySQL 5.7.x to 5.7.y is supported. Skipping</span><br><span class="line">a release is also supported. For example, upgrading from</span><br><span class="line">MySQL 5.7.x to 5.7.z is supported.</span><br><span class="line">a. 支持GA版本之间升级</span><br><span class="line">b. 5.6--&gt; 5.7 ,先将5.6升级至最新版，再升级到5.7</span><br><span class="line">c. 5.5 ---&gt; 5.7 ,先将5.5 升级至最新，再5.5---&gt; 5.6最新，再5.6--</span><br><span class="line">-&gt;5.7 最新</span><br><span class="line">d. 回退方案要提前考虑好，最好升级前要备份(特别是往8.0版本升级)。</span><br><span class="line">e. 降低停机时间（停业务的时间）</span><br><span class="line">1.3 INPLACE 升级过程原理</span><br><span class="line">0. 备份原数据库数据</span><br><span class="line">a. 安装新版本软件</span><br><span class="line">b. 关闭原数据库（挂维护页）</span><br><span class="line">c. 使用新版本软件 “挂” 旧版本数据启动(--skip-grant-tables ,--</span><br><span class="line">skip-networking)</span><br><span class="line">d. 升级 ： 只是升级系统表。升级时间和数据量无关的。(8.0 和 5.7 区</span><br><span class="line">别)</span><br><span class="line">e. 正常重启数据库。</span><br><span class="line">f. 验证各项功能是否正常。</span><br><span class="line">g. 业务恢复。</span><br><span class="line">1.4 5.6.46 ----&gt; 5.7.28 Inplace 升级演练</span><br><span class="line">a. 安装 新版本软件</span><br><span class="line">b. 停原库</span><br><span class="line"># 1. 快速关库功能关闭(优雅关闭)</span><br><span class="line">mysql&gt; set global innodb_fast_shutdown=0 ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">[root@db01 app]# /data/app/mysql56/bin/mysqladmin -S</span><br><span class="line">/tmp/mysql56.scok shutdown</span><br><span class="line">c. 使用高版本软件挂低版本数据启动</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql</span><br><span class="line">datadir=/data/mysql56/data</span><br><span class="line">socket=/tmp/mysql56.scok</span><br><span class="line">port=3356</span><br><span class="line">[root@db01 data]# /data/app/mysql/bin/mysqld_safe --</span><br><span class="line">defaults-file=/etc/my.cnf --skip-grant-tables --skipnetworking &amp;</span><br><span class="line">d. 升级 （升级到8.0可以省略）</span><br><span class="line">[root@db01 data]# /data/app/mysql/bin/mysql_upgrade -S</span><br><span class="line">/tmp/mysql56.scok --force</span><br><span class="line">e. 重启数据库到正常状态</span><br><span class="line">[root@db01 data]# mysqladmin -S /tmp/mysql3316.sock</span><br><span class="line">shutdown</span><br><span class="line">f: 正常启动数据库</span><br><span class="line">[root@db01 app]# /data/app/mysql/bin/mysqld_safe &amp;</span><br><span class="line"># 连接查看[root@db01 app]# /data/app/mysql56/bin/mysql -S</span><br><span class="line">/tmp/mysql56.scok</span><br><span class="line">mysql&gt; show variables like &#x27;%version%&#x27;;</span><br><span class="line">+-------------------------+------------------------------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+-------------------------+------------------------------+</span><br><span class="line">| innodb_version | 5.7.28 |</span><br><span class="line">| protocol_version | 10 |</span><br><span class="line">| slave_type_conversions | |</span><br><span class="line">| tls_version | TLSv1,TLSv1.1,TLSv1.2 |</span><br><span class="line">| version | 5.7.28 |</span><br><span class="line">| version_comment | MySQL Community Server (GPL) |</span><br><span class="line">| version_compile_machine | x86_64 |</span><br><span class="line">| version_compile_os | linux-glibc2.12 |</span><br><span class="line">+-------------------------+------------------------------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 测试应用</span><br><span class="line">1、各项功能验证</span><br><span class="line">2、SQL_MODE: 日期、group by</span><br><span class="line">临时：关闭相应 SQL_mode</span><br><span class="line">建议：让应用满足 SQL_mode</span><br><span class="line">1.5 5.7.28 ----&gt; 8.0.20 Inplace 升级演练</span><br><span class="line">彩蛋： 8.0的新功能</span><br><span class="line">mysql-shell工具，8.0以后，可以调用这个命令，升级之前的预检查。</span><br><span class="line">[root@db01 ~]# mysqlsh root:123@10.0.0.51:3306 -e</span><br><span class="line">&quot;util.checkForServerUpgrade()&quot;</span><br><span class="line">例如： 5.7.28 升级至 8.0.20 版本</span><br><span class="line">1. 下载 8.0.20 版本的 mysql-shell，并安装 。</span><br><span class="line">[root@db01 app]# yum install -y mysql-shell-8.0.18-</span><br><span class="line">1.el7.x86_64.rpm</span><br><span class="line">2. 创建用户</span><br><span class="line">mysql&gt; grant all on *.* to root@&#x27;10.0.0.%&#x27; identified by</span><br><span class="line">&#x27;123&#x27;;</span><br><span class="line">3. 预 检查</span><br><span class="line">mysqlsh root:123@10.0.0.51:3306 -e</span><br><span class="line">&quot;util.checkForServerUpgrade()&quot;</span><br><span class="line"># 开始升级</span><br><span class="line">a. 安装 8.0.20 软件</span><br><span class="line">b. 优雅关闭5728</span><br><span class="line">[root@db01 app]# /data/app/mysql/bin/mysql -S</span><br><span class="line">/tmp/mysql56.scok</span><br><span class="line">mysql&gt; set global innodb_fast_shutdown=0 ;</span><br><span class="line">mysql&gt; shutdown;</span><br><span class="line">c. 使用高版本软件挂低版本数据启动</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql8</span><br><span class="line">datadir=/data/mysql56/data</span><br><span class="line">socket=/tmp/mysql56.scok</span><br><span class="line">port=3356</span><br><span class="line">d.高版本软件挂低版本数据启动</span><br><span class="line">[root@db01 data]# /data/app/mysql8/bin/mysqld_safe --</span><br><span class="line">defaults-file=/etc/my.cnf --skip-grant-tables --skipnetworking &amp;</span><br><span class="line">e. 正常启动数据库</span><br><span class="line">[root@db01 data]# /data/app/mysql8/bin/mysqladmin -S</span><br><span class="line">/tmp/mysql56.sock shutdown</span><br><span class="line">f: 正常启动数据库</span><br><span class="line">[root@db01 app]# /data/app/mysql8/bin/mysqld_safe &amp;</span><br><span class="line">1.6 通过mysqldump迁移升级方式：5.7.28到8.0.20</span><br><span class="line">源端： 10.0.0.51 : 3306 ,MySQL 5.7.28 ,binlog开启。</span><br><span class="line">目标端： 10.0.0.53 : 3306 ,MySQL 8.0.20 , binlog开启</span><br><span class="line">预装mysql5728版本软件。</span><br><span class="line">周日凌晨：2:00-3:00</span><br><span class="line">a. 周六全备（凌晨）</span><br><span class="line">[root@db03 ~]# /data/app/mysql/bin/mysqldump -uroot -p123</span><br><span class="line">-h10.0.0.51 -P3356 -A --master-data=2 &gt;/data/full.sql</span><br><span class="line">b. 初始化一个5728新实例</span><br><span class="line">[root@db03 ~]# mv /etc/my.cnf /etc/my.cnf.bak</span><br><span class="line">[root@db03 ~]# mkdir -p /data/3357/data[root@db03 data]# /data/app/mysql/bin/mysqld --initializeinsecure --user=mysql --basedir=/data/app/mysql --</span><br><span class="line">datadir=/data/3357/data</span><br><span class="line">c. 配置文件</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql</span><br><span class="line">datadir=/data/3357/data</span><br><span class="line">socket=/tmp/mysql57.scok</span><br><span class="line">port=3357</span><br><span class="line">server_id=57</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">d. 启动新环境</span><br><span class="line">[root@db03 bin]# /data/app/mysql/bin/mysqld_safe &amp;</span><br><span class="line">e. 恢复周六数据</span><br><span class="line">f. 拉取源端日志</span><br><span class="line">/data/app/mysql/bin/mysqlbinlog -R --host=10.0.0.51 --</span><br><span class="line">port=3306 --user=root --password=123 --raw --stop-never</span><br><span class="line">mysql-bin.000003 &amp;</span><br><span class="line">g.依次恢复需要的日志</span><br><span class="line">原端： flush logs</span><br><span class="line">目标端：</span><br><span class="line">[root@db03 data]# /data/app/mysql/bin/mysqlbinlog</span><br><span class="line">/data/binlog/mysql-bin.000004 |/data/app/mysql/bin/mysql -</span><br><span class="line">S /tmp/mysql57.sock</span><br><span class="line">断开远端数据库所有连接，将所有剩余binlog，恢复。</span><br><span class="line">h. 目标端inplace升级到8.0</span><br><span class="line">略。</span><br><span class="line">i. 测试应用</span><br><span class="line">j. 应用端割接，重启业务。</span><br><span class="line">1.7 降级</span><br><span class="line">官方解释：</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/downgradepaths.htmlDowngrade from MySQL 5.7 to 5.6 is supported using the</span><br><span class="line">logical downgrade method.</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/downgrade-binarypackage.html#downgrade-procedure-inplace</span><br><span class="line">In-place downgrade is supported for downgrades between GA</span><br><span class="line">releases within the same release series. 5.7.y ---&gt; 5.7.x</span><br><span class="line">## 5.7.28 ---》 5.7.10 inplace downgrade ok</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###原环境：</span><br><span class="line">5.7.28 二进制版本 + /data/3306/data</span><br><span class="line">1. 安装 5.7.10 （低） 二进制版本</span><br><span class="line">/data/app/mysql5710</span><br><span class="line">2. 针对5728版本（高）进行处理工作</span><br><span class="line">https://dev.mysql.com/doc/refman/5.7/en/downgrading-toprevious-series.html</span><br><span class="line">set</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,N</span><br><span class="line">O_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27; ;</span><br><span class="line">set global</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,N</span><br><span class="line">O_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27; ;</span><br><span class="line">ALTER TABLE mysql.proc MODIFY definer char(77) CHARACTER</span><br><span class="line">SET utf8 COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.event MODIFY definer char(77) CHARACTER</span><br><span class="line">SET utf8 COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.tables_priv MODIFY Grantor char(77)</span><br><span class="line">COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.procs_priv MODIFY Grantor char(77)</span><br><span class="line">COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">3. 优雅的关闭5.7.28（高）。</span><br><span class="line">set global innodb_fast_shutdown=0 ;</span><br><span class="line">mysqladmin shutdown</span><br><span class="line">4. 删除ib_logfile*</span><br><span class="line">[root@db01 mysql5710]# rm -rf /data/3306/data/ib_logfile*5. 替换配置文件、环境变量 （替换成低版本）</span><br><span class="line">[root@db01 mysql5710]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql5710</span><br><span class="line">#basedir=/data/app/mysql56</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">~</span><br><span class="line">[root@db01 mysql5710]# vim /etc/profile</span><br><span class="line">export PATH=/data/app/mysql5710/bin:$PATH</span><br><span class="line">[root@db01 mysql5710]# source /etc/profile</span><br><span class="line">[root@db01 mysql5710]# mysql -V</span><br><span class="line">mysql Ver 14.14 Distrib 5.7.10, for linux-glibc2.5</span><br><span class="line">(x86_64) using EditLine wrapper</span><br><span class="line">6. 启动数据库</span><br><span class="line">[root@db01 mysql5710]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.. SUCCESS!</span><br><span class="line">7. 执行upgrade</span><br><span class="line">[root@db01 mysql5710]# mysql_upgrade --force</span><br><span class="line">## 5.7.28 ---》 5.6.46 logical downgrade ok</span><br><span class="line">0. 恢复5.7.28 环境</span><br><span class="line">[root@db01 data]# pkill mysqld</span><br><span class="line">[root@db01 data]# rm -rf /data/3306/data/*</span><br><span class="line"># 恢复配置文件</span><br><span class="line">[root@db01 data]# vim /etc/my.cnf</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql</span><br><span class="line">#basedir=/data/app/mysql56</span><br><span class="line">datadir=/data/3306/datasocket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line"># 恢复环境变量</span><br><span class="line">export PATH=/data/app/mysql/bin:$PATH</span><br><span class="line">[root@db01 data]# source /etc/profile</span><br><span class="line">[root@db01 data]# mysql -V</span><br><span class="line">mysql Ver 14.14 Distrib 5.7.28, for linux-glibc2.12</span><br><span class="line">(x86_64) using EditLine wrapper</span><br><span class="line"># 初始化数据</span><br><span class="line">mysqld --initialize-insecure --user=mysql --</span><br><span class="line">basedir=/data/app/mysql --datadir=/data/3306/data</span><br><span class="line"># 启动数据库</span><br><span class="line">[root@db01 data]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL.Logging to &#x27;/data/3306/data/db01.err&#x27;.</span><br><span class="line">SUCCESS!</span><br><span class="line">mysql&gt; select version();</span><br><span class="line">+-----------+</span><br><span class="line">| version() |</span><br><span class="line">+-----------+</span><br><span class="line">| 5.7.28 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. 安装5.6.46二进制版本软件</span><br><span class="line">/data/app/mysql56</span><br><span class="line">2. 处理5.7.28高版本数据</span><br><span class="line">set</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,N</span><br><span class="line">O_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27; ;</span><br><span class="line">set global</span><br><span class="line">sql_mode=&#x27;STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,N</span><br><span class="line">O_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION&#x27; ;ALTER TABLE mysql.proc MODIFY definer char(77) CHARACTER</span><br><span class="line">SET utf8 COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.event MODIFY definer char(77) CHARACTER</span><br><span class="line">SET utf8 COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.tables_priv MODIFY Grantor char(77)</span><br><span class="line">COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.procs_priv MODIFY Grantor char(77)</span><br><span class="line">COLLATE utf8_bin NOT NULL DEFAULT &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.tables_priv MODIFY User char(16) NOT</span><br><span class="line">NULL default &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.columns_priv MODIFY User char(16) NOT</span><br><span class="line">NULL default &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.user MODIFY User char(16) NOT NULL</span><br><span class="line">default &#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.db MODIFY User char(16) NOT NULL default</span><br><span class="line">&#x27;&#x27;;</span><br><span class="line">ALTER TABLE mysql.procs_priv MODIFY User char(16) binary</span><br><span class="line">DEFAULT &#x27;&#x27; NOT NULL;</span><br><span class="line">ALTER TABLE mysql.user ADD Password char(41) character set</span><br><span class="line">latin1</span><br><span class="line">collate latin1_bin NOT NULL default &#x27;&#x27; AFTER user;</span><br><span class="line">UPDATE mysql.user SET password = authentication_string</span><br><span class="line">WHERE</span><br><span class="line">LENGTH(authentication_string) = 41 AND plugin =</span><br><span class="line">&#x27;mysql_native_password&#x27;;</span><br><span class="line">UPDATE mysql.user SET authentication_string = &#x27;&#x27; WHERE</span><br><span class="line">LENGTH(authentication_string) = 41 AND plugin =</span><br><span class="line">&#x27;mysql_native_password&#x27;;</span><br><span class="line">ALTER TABLE mysql.help_category ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.help_keyword ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.help_relation ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.help_topic ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.time_zone ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;ALTER TABLE mysql.time_zone_leap_second ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.time_zone_name ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.time_zone_transition ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.time_zone_transition_type</span><br><span class="line">ENGINE=&#x27;MyISAM&#x27; STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.plugin ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.servers ENGINE=&#x27;MyISAM&#x27;</span><br><span class="line">STATS_PERSISTENT=DEFAULT;</span><br><span class="line">ALTER TABLE mysql.user MODIFY plugin CHAR(64) COLLATE</span><br><span class="line">utf8_bin</span><br><span class="line">DEFAULT &#x27;mysql_native_password&#x27;;</span><br><span class="line">DROP DATABASE sys;</span><br><span class="line"></span><br><span class="line">3. 逻辑备份5.7.28数据</span><br><span class="line">[root@db01 ~]# mysqldump -A &gt;/tmp/full.sql</span><br><span class="line"></span><br><span class="line">4. 初始化一套5.6.46的空环境</span><br><span class="line">[root@db01 ~]# vim /etc/profile</span><br><span class="line">export PATH=/data/app/mysql56/bin:$PATH</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# source /etc/profile</span><br><span class="line">[root@db01 ~]# mysql -V</span><br><span class="line">mysql Ver 14.14 Distrib 5.6.46, for linux-glibc2.12</span><br><span class="line">(x86_64) using EditLine wrapper</span><br><span class="line"></span><br><span class="line">[root@db01 ~]# mv /etc/my.cnf /etc/my.cnf.bak</span><br><span class="line">mv: overwrite ‘/etc/my.cnf.bak’? y</span><br><span class="line">[root@db01 data]# rm -rf /data/3316/data/*</span><br><span class="line">[root@db01 data]#</span><br><span class="line">/data/app/mysql56/scripts/mysql_install_db --user=mysql -</span><br><span class="line">-basedir=/data/app/mysql56 --datadir=/data/3316/data</span><br><span class="line">[root@db01 data]# systemctl start mysqld3316</span><br><span class="line"></span><br><span class="line">5. 恢复备份数据到5.6.46中</span><br><span class="line">[root@db01 data]# mysql -S /tmp/mysql3316.sock</span><br><span class="line">mysql&gt; source /tmp/full.sql</span><br></pre></td></tr></table></figure>



<h2 id="2-10-MySQL备份策略定制、备份巡检思路"><a href="#2-10-MySQL备份策略定制、备份巡检思路" class="headerlink" title="2.10 MySQL备份策略定制、备份巡检思路"></a>2.10 MySQL备份策略定制、备份巡检思路</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1. 备份策略：</span><br><span class="line">	a. 备份工具</span><br><span class="line">	逻辑：</span><br><span class="line">	mysqldump ： 数据量较小</span><br><span class="line">	mydumper ： 数据量小，表个数比较多，每个表都不大</span><br><span class="line">	replication ： 延时从库</span><br><span class="line">	mysqlbinlog ： -R --raws --stop-never</span><br><span class="line">	navicat</span><br><span class="line">	binlog2sql</span><br><span class="line">物理：</span><br><span class="line">	PXB</span><br><span class="line">	MEB</span><br><span class="line"></span><br><span class="line">存储镜像</span><br><span class="line">	cp冷备</span><br><span class="line"></span><br><span class="line">	b. 时间点</span><br><span class="line">		凌晨</span><br><span class="line">	c. 策略</span><br><span class="line">		每天全备+binlog</span><br><span class="line">		每周全备+inc+binlog</span><br><span class="line">		每月全备+inc</span><br><span class="line">2. 恢复策略</span><br><span class="line">	大量数据损坏： 全备+增量+binlog</span><br><span class="line">	部分： 从全备+增量提取备份+部分binlog ，延时从库</span><br><span class="line">3. 定期备份检查和恢复演练</span><br><span class="line">	a. 逻辑备份 ： 检查备份文件 头部 、 抽查备份文件中核心的业务表存在性、数据量。</span><br><span class="line">	b. 物理备份 ： 备份目录下的日志。备份的大小。</span><br><span class="line">	c. 恢复演练 ： 按季度。</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/05/03/%E5%8D%95%E4%BD%93%E5%BA%94%E7%94%A8%E5%92%8C%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%8C%BA%E5%88%AB/" rel="prev" title="分布式事务">
      <i class="fa fa-chevron-left"></i> 分布式事务
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/15/%E9%AB%98%E5%8F%AF%E7%94%A8%E6%8A%80%E6%9C%AF/" rel="next" title="高可用技术">
      高可用技术 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-MySQL-8-0-%E7%9A%84%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">1. MySQL 8.0 的日志管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-general-log"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 general_log</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E4%BD%9C%E7%94%A8"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1.1 作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2%E6%9F%A5%E8%AF%A2%E5%8F%8A%E9%85%8D%E7%BD%AE"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.1.2查询及配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-3-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.1.3 使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-binlog"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 binlog *</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E4%BD%9C%E7%94%A8"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E4%BD%BF%E7%94%A8"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%86%85%E5%AE%B9%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">日志内容查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#binlog%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E8%AF%A6%E7%BB%86%E6%9F%A5%E7%9C%8B"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">binlog文件内容详细查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EPosition%E5%8F%B7%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E6%88%AA%E5%8F%96"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">基于Position号进行日志截取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BD%A9%E8%9B%8B%EF%BC%9A-%E6%88%AA%E5%8F%96%E6%97%A5%E5%BF%97%E7%97%9B%E7%82%B9"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">彩蛋： 截取日志痛点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-gtid%E7%89%B9%E6%80%A7"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.2.4 gtid特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#case"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">case:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-5-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><span class="nav-number">1.2.5.</span> <span class="nav-text">1.2.5 二进制日志其他操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E6%B8%85%E7%90%86%E6%97%A5%E5%BF%97"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">自动清理日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%8B%E5%B7%A5%E6%B8%85%E7%90%86"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">手工清理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%BB%9A%E5%8A%A8"><span class="nav-number">1.2.5.3.</span> <span class="nav-text">日志滚动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-6-binlog2sql%E5%BA%94%E7%94%A8"><span class="nav-number">1.2.6.</span> <span class="nav-text">1.2.6 binlog2sql应用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-slowlog"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 slowlog</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-%E4%BD%9C%E7%94%A8"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1 作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.3.2.</span> <span class="nav-text">1.3.2 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-3-%E5%88%86%E6%9E%90%E5%8F%8A%E4%BD%BF%E7%94%A8"><span class="nav-number">1.3.3.</span> <span class="nav-text">1.3.3 分析及使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-4-pt-query-digest-pqd-%E5%BA%94%E7%94%A8"><span class="nav-number">1.3.4.</span> <span class="nav-text">1.3.4 pt-query-digest(pqd)应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BB%8B%E7%BB%8D%EF%BC%9A"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">安装及介绍：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%9C%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">结果说明：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B%EF%BC%9A"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">命令行应用实例：</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-MySQL-8-0%E7%9A%84%E5%A4%87%E4%BB%BD%E3%80%81%E6%81%A2%E5%A4%8D%E3%80%81%E8%BF%81%E7%A7%BB"><span class="nav-number">2.</span> <span class="nav-text">2.MySQL 8.0的备份、恢复、迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E4%B8%AD%E7%9A%84%E8%81%8C%E8%B4%A3"><span class="nav-number">2.1.</span> <span class="nav-text">2.1备份恢复中的职责</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-MySQL8-0%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 MySQL8.0备份工具介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8-mysqldump-%E2%9C%A8"><span class="nav-number">2.3.</span> <span class="nav-text">2.3逻辑备份工具使用-mysqldump ✨</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%80%9A%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">2.3.0.1.</span> <span class="nav-text">客户端通用参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E4%B8%93%E7%94%A8%E5%8F%82%E6%95%B0"><span class="nav-number">2.3.0.2.</span> <span class="nav-text">备份专用参数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4%E9%80%BB%E8%BE%91%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8-mydumper-amp-myloader"><span class="nav-number">2.4.</span> <span class="nav-text">2.4逻辑备份工具使用-mydumper&amp;myloader</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-0-%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.0 介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.4.1 工作原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E5%8F%82%E6%95%B0%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.4.3.</span> <span class="nav-text">2.4.2 参数介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E4%BD%BF%E7%94%A8"><span class="nav-number">2.4.4.</span> <span class="nav-text">2.4.3 使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5%E9%80%BB%E8%BE%91%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA-load-data"><span class="nav-number">2.5.</span> <span class="nav-text">2.5逻辑导入导出-load data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-0-%E5%8A%9F%E8%83%BD"><span class="nav-number">2.5.1.</span> <span class="nav-text">2.5.0 功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-%E9%80%A0%E6%95%B0"><span class="nav-number">2.5.2.</span> <span class="nav-text">2.5.1 造数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-%E8%AF%AD%E6%B3%95"><span class="nav-number">2.5.3.</span> <span class="nav-text">2.5.2 语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-3%E5%BF%85%E9%80%89%E5%AD%90%E5%8F%A5%E6%88%96%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">2.5.4.</span> <span class="nav-text">2.5.3必选子句或关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-4-%E8%AE%BE%E7%BD%AE%E5%AD%97%E6%AE%B5%E9%A1%BA%E5%BA%8F"><span class="nav-number">2.5.5.</span> <span class="nav-text">2.5.4 设置字段顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-5-LOCAL%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">2.5.6.</span> <span class="nav-text">2.5.5 LOCAL关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-6-REPLACE%E4%B8%8EIGNORE%E5%85%B3%E9%94%AE%E5%AD%97"><span class="nav-number">2.5.7.</span> <span class="nav-text">2.5.6 REPLACE与IGNORE关键字</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-7-fields%E5%85%B3%E9%94%AE%E5%AD%97%E5%BA%94%E7%94%A8"><span class="nav-number">2.5.8.</span> <span class="nav-text">2.5.7 fields关键字应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5-%E5%88%97-%E5%88%86%E9%9A%94%E7%AC%A6%E5%BA%94%E7%94%A8"><span class="nav-number">2.5.8.1.</span> <span class="nav-text">字段(列)分隔符应用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E5%BC%95%E7%94%A8%E7%AC%A6"><span class="nav-number">2.5.8.2.</span> <span class="nav-text">字段引用符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6"><span class="nav-number">2.5.8.3.</span> <span class="nav-text">转义字符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-8-LINES-%E5%85%B3%E9%94%AE%E5%AD%97%E5%BA%94%E7%94%A8"><span class="nav-number">2.5.9.</span> <span class="nav-text">2.5.8 LINES 关键字应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E5%89%8D%E7%BC%80%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="nav-number">2.5.9.1.</span> <span class="nav-text">行前缀字符串</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E7%BB%93%E6%9D%9F%E7%AC%A6"><span class="nav-number">2.5.9.2.</span> <span class="nav-text">行结束符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-9FIELDS%E5%92%8CLINES%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">2.5.10.</span> <span class="nav-text">2.5.9FIELDS和LINES注意事项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-10-IGNORE-number-LINES-ROWS-%E5%AD%90%E5%8F%A5"><span class="nav-number">2.5.11.</span> <span class="nav-text">2.5.10 IGNORE number {LINES | ROWS}子句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-11-SET-col-name-x3D-expr-%E2%80%A6%E5%AD%90%E5%8F%A5"><span class="nav-number">2.5.12.</span> <span class="nav-text">2.5.11 SET col_name &#x3D; expr,…子句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-12%E4%BD%BF%E7%94%A8mysqldump%E6%89%B9%E9%87%8F%E5%AF%BC%E5%87%BA"><span class="nav-number">2.5.13.</span> <span class="nav-text">2.5.12使用mysqldump批量导出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-13-%E4%BD%BF%E7%94%A8mysqlimport%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5"><span class="nav-number">2.5.14.</span> <span class="nav-text">2.5.13 使用mysqlimport批量导入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6%E7%89%A9%E7%90%86%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8-PerconaXtrabackup-%E2%9C%A8"><span class="nav-number">2.6.</span> <span class="nav-text">2.6物理备份工具使用-PerconaXtrabackup ✨</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-1-%E5%AE%89%E8%A3%85"><span class="nav-number">2.6.1.</span> <span class="nav-text">2.6.1 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-2-%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD"><span class="nav-number">2.6.2.</span> <span class="nav-text">2.6.2 全量备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-3-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD"><span class="nav-number">2.6.3.</span> <span class="nav-text">2.6.3 增量备份</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A4%87%E4%BB%BD%E5%B7%A5%E5%85%B7MEB%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8"><span class="nav-number">2.7.</span> <span class="nav-text">2.7企业级备份工具MEB介绍及使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-MySQL-8-0-8-0-17-Clone-plugin"><span class="nav-number">2.8.</span> <span class="nav-text">2.8 MySQL 8.0 (8.0.17+) Clone-plugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-MySQL%E5%8D%87%E7%BA%A7%E5%8F%8A%E8%BF%81%E7%A7%BB%E5%AE%9E%E6%88%98"><span class="nav-number">2.9.</span> <span class="nav-text">2.9 MySQL升级及迁移实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-10-MySQL%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5%E5%AE%9A%E5%88%B6%E3%80%81%E5%A4%87%E4%BB%BD%E5%B7%A1%E6%A3%80%E6%80%9D%E8%B7%AF"><span class="nav-number">2.10.</span> <span class="nav-text">2.10 MySQL备份策略定制、备份巡检思路</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="139"
      src="/images/custom/avatar.jpg">
  <p class="site-author-name" itemprop="name">139</p>
  <div class="site-description" itemprop="description">一个普通的JAVA开发的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2023004484号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">139</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
