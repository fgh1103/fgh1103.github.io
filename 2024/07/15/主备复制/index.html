<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1 复制简介123456789101112复制是指：将主库的DDL、DML等操作通过binlog日志，传输到复制服务器（副本），副本进行回放这些日志，从而使得从库和主库数据保持&lt;近似&gt;同步的工作模式。复制架构: （1）传统异步：1主1从、1主多从、级联主从、双主（2）演变：(增强)半同步、过滤、延时、GTID、MTS(多SQL线程并发回放relaylog)（3）新型：多源复制（5.7+">
<meta property="og:type" content="article">
<meta property="og:title" content="主备复制">
<meta property="og:url" content="http://example.com/2024/07/15/%E4%B8%BB%E5%A4%87%E5%A4%8D%E5%88%B6/index.html">
<meta property="og:site_name" content="进学阁">
<meta property="og:description" content="1 复制简介123456789101112复制是指：将主库的DDL、DML等操作通过binlog日志，传输到复制服务器（副本），副本进行回放这些日志，从而使得从库和主库数据保持&lt;近似&gt;同步的工作模式。复制架构: （1）传统异步：1主1从、1主多从、级联主从、双主（2）演变：(增强)半同步、过滤、延时、GTID、MTS(多SQL线程并发回放relaylog)（3）新型：多源复制（5.7+">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661873940324-7f7cd184-4c8c-4bc0-aae5-25605a867043.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960590057-924046bf-663f-48cc-a567-7d53dbf51130.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960761551-19811b64-a47a-40d8-8884-a09162eb68a4.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960812807-04c737c8-e978-4f1d-ad4a-6437f6b342c5.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960993317-4d120d62-0024-4dcf-920c-3b692931957b.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961256653-6bbfc44a-dca0-4dfc-a27c-c6c927b8abd2.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961313863-c981821e-b5d8-4f4a-9ff2-988c81ff785d.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961388742-07ddb480-84fb-48bd-92a8-677e790afb9b.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961400032-5d8e18d6-ee39-41be-9288-76fa1b709aac.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961413541-486a9116-f41b-4961-8783-a1cda9d1693f.png">
<meta property="og:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961617336-44c73a57-8ccf-403c-b2e2-e244d580aef6.png">
<meta property="article:published_time" content="2024-07-14T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-06T09:54:37.891Z">
<meta property="article:author" content="139">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661873940324-7f7cd184-4c8c-4bc0-aae5-25605a867043.png">

<link rel="canonical" href="http://example.com/2024/07/15/%E4%B8%BB%E5%A4%87%E5%A4%8D%E5%88%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>主备复制 | 进学阁</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">进学阁</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">业精于勤荒于嬉，行成于思毁于随</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">39</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">83</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/15/%E4%B8%BB%E5%A4%87%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/custom/avatar.jpg">
      <meta itemprop="name" content="139">
      <meta itemprop="description" content="一个普通的JAVA开发的博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="进学阁">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          主备复制
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-15 00:00:00" itemprop="dateCreated datePublished" datetime="2024-07-15T00:00:00+08:00">2024-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-06 17:54:37" itemprop="dateModified" datetime="2025-03-06T17:54:37+08:00">2025-03-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-复制简介"><a href="#1-复制简介" class="headerlink" title="1 复制简介"></a>1 复制简介</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">复制是指：将主库的DDL、DML等操作通过binlog日志，传输到复制服务器（副本），副本进行回放这些日志，从而使得从库和主库数据保持&lt;近似&gt;同步的工作模式。</span><br><span class="line">复制架构: </span><br><span class="line">（1）传统异步：1主1从、1主多从、级联主从、双主</span><br><span class="line">（2）演变：(增强)半同步、过滤、延时、GTID、MTS(多SQL线程并发回放relaylog)</span><br><span class="line">（3）新型：多源复制（5.7+支持）</span><br><span class="line">（4）MGR：5.7.17+支持、8.0增强（WS:WriteSets）</span><br><span class="line">复制主要应用场景：</span><br><span class="line">	1. 备份</span><br><span class="line">	2. 高可用</span><br><span class="line">	3. 读写分离</span><br><span class="line">	4. 分布式架构</span><br><span class="line">	5. 迁移</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h1 id="2-主从复制前提"><a href="#2-主从复制前提" class="headerlink" title="2 主从复制前提"></a>2 主从复制前提</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a. 2台以上的MySQL实例(同版本、同平台),具备不同的server_id,server_uuid</span><br><span class="line">b. 主库&quot;开启binlog, 创建复制用户。</span><br><span class="line">c. “补课”： 备份主库数据，恢复到从库.</span><br><span class="line">	mysqldump</span><br><span class="line">	pxb</span><br><span class="line">	Clone Plugin</span><br><span class="line">d. 告知从库复制的信息：change master to user,password, ip ,port, filename、pos (gtid)</span><br><span class="line">e. 让他干活 ： 启动线程 </span><br><span class="line">f. 查看复制状态</span><br></pre></td></tr></table></figure>

<h1 id="3-主从复制花式构建方法"><a href="#3-主从复制花式构建方法" class="headerlink" title="3 主从复制花式构建方法"></a>3 主从复制花式构建方法</h1><h2 id="3-0-准备初始环境"><a href="#3-0-准备初始环境" class="headerlink" title="3.0 准备初始环境"></a>3.0 准备初始环境</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 三台虚拟机</span><br><span class="line">10.0.0.51  db01</span><br><span class="line">10.0.0.52  db02</span><br><span class="line">10.0.0.53  db03</span><br><span class="line">防火墙关闭</span><br><span class="line"></span><br><span class="line">#清理环境： </span><br><span class="line">pkill mysqld</span><br><span class="line">rm -rf /data/3306/*</span><br><span class="line">mkdir -p /data/3306/data /data/3306/binlog</span><br><span class="line">chown -R mysql.mysql /data/*</span><br><span class="line"></span><br><span class="line"># 准备配置文件</span><br><span class="line">主库db01：</span><br><span class="line">mv /etc/my.cnf /tmp</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/usr/local/mysql</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=51</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">slave1(db02)：</span><br><span class="line">mv /etc/my.cnf /tmp</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/usr/local/mysql</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=52</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db02 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">slave2(db03)：</span><br><span class="line">mv /etc/my.cnf /tmp</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/usr/local/mysql </span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=53</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line"></span><br><span class="line">log-slave-updates=1</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db03 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">初始化数据</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data </span><br><span class="line"></span><br><span class="line">启动数据库</span><br><span class="line">/etc/init.d/mysqld start</span><br></pre></td></tr></table></figure>



<h2 id="3-1-通过mysqldump（XBK）备份构建传统主从"><a href="#3-1-通过mysqldump（XBK）备份构建传统主从" class="headerlink" title="3.1 通过mysqldump（XBK）备份构建传统主从"></a>3.1 通过mysqldump（XBK）备份构建传统主从</h2><h3 id="a-各节点检查server-id、server-uuid、binlog"><a href="#a-各节点检查server-id、server-uuid、binlog" class="headerlink" title="a.各节点检查server_id、server_uuid、binlog"></a>a.各节点检查server_id、server_uuid、binlog</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;select @@server_id; select @@server_uuid;show variables like &#x27;log_bin%&#x27;;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="b-主库（51）创建复制用户和远程管理用户"><a href="#b-主库（51）创建复制用户和远程管理用户" class="headerlink" title="b.主库（51）创建复制用户和远程管理用户"></a>b.主库（51）创建复制用户和远程管理用户</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;create user repl@&#x27;10.0.0.%&#x27; identified with mysql_native_password by &#x27;123&#x27;;grant replication slave on *.* to repl@&#x27;10.0.0.%&#x27;;&quot;</span><br><span class="line">mysql -e &quot;create user root@&#x27;10.0.0.%&#x27; identified with mysql_native_password by &#x27;123&#x27;;grant all on *.* to root@&#x27;10.0.0.%&#x27;;&quot;</span><br><span class="line"></span><br><span class="line">[root@db01 app]# mysql -e &quot;select user,host,plugin from mysql.user;&quot;</span><br><span class="line">+------------------+-----------+-----------------------+</span><br><span class="line">| user             | host      | plugin                |</span><br><span class="line">+------------------+-----------+-----------------------+</span><br><span class="line">| repl             | 10.0.0.%  | mysql_native_password |</span><br><span class="line">| root             | 10.0.0.%  | mysql_native_password |</span><br><span class="line">| mysql.infoschema | localhost | caching_sha2_password |</span><br><span class="line">| mysql.session    | localhost | caching_sha2_password |</span><br><span class="line">| mysql.sys        | localhost | caching_sha2_password |</span><br><span class="line">| root             | localhost | caching_sha2_password |</span><br></pre></td></tr></table></figure>

<h3 id="c-从库备份主库数据，并恢复。"><a href="#c-从库备份主库数据，并恢复。" class="headerlink" title="c.从库备份主库数据，并恢复。"></a>c.从库备份主库数据，并恢复。</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@db02 data]# mysqldump -uroot -p123 -h 10.0.0.51 -P 3306 -A --master-data=2 --single-transaction -R -E --triggers &gt;/tmp/full.sql</span><br><span class="line">db02 [mysql]&gt;source /tmp/full.sql</span><br><span class="line"></span><br><span class="line">课后练习：</span><br><span class="line">通过pxb方式构建主从。</span><br></pre></td></tr></table></figure>

<h3 id="d-启动主从复制"><a href="#d-启动主从复制" class="headerlink" title="d. 启动主从复制"></a>d. 启动主从复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#获取复制起点</span><br><span class="line">[root@db02 data]# grep  &quot;\--\ CHANGE MASTER&quot; /tmp/full.sql </span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, MASTER_LOG_POS=1187;</span><br><span class="line"></span><br><span class="line">[root@db02 data]# mysql -e \</span><br><span class="line">&quot;CHANGE MASTER TO \</span><br><span class="line">  MASTER_HOST=&#x27;10.0.0.51&#x27;,\</span><br><span class="line">  MASTER_USER=&#x27;repl&#x27;, \</span><br><span class="line">  MASTER_PASSWORD=&#x27;123&#x27;, \</span><br><span class="line">  MASTER_PORT=3306, \</span><br><span class="line">  MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, \</span><br><span class="line">  MASTER_LOG_POS=1187, \</span><br><span class="line">  MASTER_CONNECT_RETRY=10;&quot;</span><br><span class="line">[root@db02 data]# mysql -e &quot;start slave;&quot;</span><br><span class="line">[root@db02 data]# mysql -e &quot;show slave status \G&quot;|grep &quot;Running:&quot;</span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h2 id="3-2-新姿势-通过Clone-plugin搭建传统和GTID主从"><a href="#3-2-新姿势-通过Clone-plugin搭建传统和GTID主从" class="headerlink" title="3.2 新姿势-通过Clone-plugin搭建传统和GTID主从"></a>3.2 新姿势-通过Clone-plugin搭建传统和GTID主从</h2><h3 id="a-主库操作"><a href="#a-主库操作" class="headerlink" title="a. 主库操作"></a>a. 主库操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test1@&#x27;%&#x27; identified by &#x27;123&#x27;;grant backup_admin on *.* to test1@&#x27;%&#x27;;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="b-从库操作"><a href="#b-从库操作" class="headerlink" title="b. 从库操作"></a>b. 从库操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@db03 data]# mysql -e &quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test2@&#x27;%&#x27; identified by &#x27;123&#x27;;grant clone_admin on *.* to test2@&#x27;%&#x27;;SET GLOBAL clone_valid_donor_list=&#x27;10.0.0.51:3306&#x27;;&quot;</span><br><span class="line">[root@db03 data]# mysql -utest2 -p123 -h10.0.0.53  -P3306 -e &quot;CLONE INSTANCE FROM test1@&#x27;10.0.0.51&#x27;:3306 IDENTIFIED BY &#x27;123&#x27;;&quot;</span><br><span class="line"></span><br><span class="line">[root@db03 data]# mysql -e &quot;SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;&quot;</span><br><span class="line"></span><br><span class="line">[root@db03 data]# mysql -e &quot;SELECT BINLOG_FILE, BINLOG_POSITION FROM performance_schema.clone_status;&quot;</span><br><span class="line">+------------------+-----------------+</span><br><span class="line">| BINLOG_FILE      | BINLOG_POSITION |</span><br><span class="line">+------------------+-----------------+</span><br><span class="line">| mysql-bin.000002 |            1714 |</span><br><span class="line">+------------------+-----------------+</span><br><span class="line"></span><br><span class="line">注： 如果GTID复制查看: </span><br><span class="line">[root@db03 data]# mysql -e &quot;SELECT @@GLOBAL.GTID_EXECUTED;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="c-启动主从复制"><a href="#c-启动主从复制" class="headerlink" title="c. 启动主从复制"></a>c. 启动主从复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@db03 data]# mysql -e \</span><br><span class="line">&quot;CHANGE MASTER TO \</span><br><span class="line">  MASTER_HOST=&#x27;10.0.0.51&#x27;,\</span><br><span class="line">  MASTER_USER=&#x27;repl&#x27;, \</span><br><span class="line">  MASTER_PASSWORD=&#x27;123&#x27;, \</span><br><span class="line">  MASTER_PORT=3306, \</span><br><span class="line">  MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;, \</span><br><span class="line">  MASTER_LOG_POS=1717, \</span><br><span class="line">  MASTER_CONNECT_RETRY=10;&quot;</span><br><span class="line">[root@db03 data]# mysql -e &quot;start slave;&quot;</span><br><span class="line">[root@db03 data]# mysql -e &quot;show slave status \G&quot;|grep &quot;Running:&quot;</span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes            </span><br><span class="line">注： GTID方式</span><br><span class="line">[root@db03 data]# mysql -e \</span><br><span class="line">&quot;CHANGE MASTER TO \</span><br><span class="line">  MASTER_HOST=&#x27;10.0.0.51&#x27;,\</span><br><span class="line">  MASTER_USER=&#x27;repl&#x27;, \</span><br><span class="line">  MASTER_PASSWORD=&#x27;123&#x27;, \</span><br><span class="line">  MASTER_PORT=3306, \</span><br><span class="line">  MASTER_AUTO_POSITION=1;&quot;</span><br><span class="line">[root@db03 data]# mysql -e &quot;start slave;&quot;</span><br><span class="line">[root@db03 data]# mysql -e &quot;show slave status \G&quot;|grep &quot;Running:&quot;</span><br><span class="line">            Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h3 id="3-3-传统复制和GTID转换"><a href="#3-3-传统复制和GTID转换" class="headerlink" title="3.3 传统复制和GTID转换"></a>3.3 传统复制和GTID转换</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">全局唯一的ID号。 49a40a92-83d7-11eb-b567-000c2956311f:1-7</span><br></pre></td></tr></table></figure>

<h3 id="a-查看当前状态"><a href="#a-查看当前状态" class="headerlink" title="a. 查看当前状态"></a>a. 查看当前状态</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 app]# mysql -e &quot;select @@enforce_gtid_consistency;&quot;</span><br><span class="line">+----------------------------+</span><br><span class="line">| @@enforce_gtid_consistency |</span><br><span class="line">+----------------------------+</span><br><span class="line">| OFF                        |</span><br><span class="line">+----------------------------+</span><br><span class="line">[root@db01 app]# mysql -e &quot;select @@gtid_mode;&quot;</span><br><span class="line">+-------------+</span><br><span class="line">| @@gtid_mode |</span><br><span class="line">+-------------+</span><br><span class="line">| OFF         |</span><br><span class="line">+-------------+</span><br></pre></td></tr></table></figure>

<h3 id="b-修改enforce-gtid-consistency"><a href="#b-修改enforce-gtid-consistency" class="headerlink" title="b. 修改enforce_gtid_consistency"></a>b. 修改enforce_gtid_consistency</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 data]# mysql -e &quot;set global enforce_gtid_consistency =warn;&quot;</span><br><span class="line">[root@db02 data]# mysql -e &quot;set global enforce_gtid_consistency =warn;&quot;</span><br><span class="line">[root@db03 data]# mysql -e &quot;set global enforce_gtid_consistency =warn;&quot;</span><br><span class="line">注意： </span><br><span class="line">	所有节点均先将其修改为 WARN,同时注意查看日志是否出现警告信息，生产环境想调整为GTID模式时，需提前一段时间调整此参数，观察一段时间，确定无警告后再调整。</span><br><span class="line">	开启后观察数据库日志，只有在无警告的情况下才可以进行下一步的操作。</span><br></pre></td></tr></table></figure>

<h3 id="c-修改enforce-gtid-consistency-x3D-on"><a href="#c-修改enforce-gtid-consistency-x3D-on" class="headerlink" title="c. 修改enforce_gtid_consistency &#x3D; on"></a>c. 修改enforce_gtid_consistency &#x3D; on</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;set global enforce_gtid_consistency = on;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="d-修改gtid-mode-x3D-off-permissive"><a href="#d-修改gtid-mode-x3D-off-permissive" class="headerlink" title="d. 修改gtid_mode &#x3D; off_permissive"></a>d. 修改gtid_mode &#x3D; off_permissive</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;set global gtid_mode = off_permissive;&quot;</span><br><span class="line">生成新的事务为匿名事务，同时允许复制的事务为匿名和GTID的。</span><br></pre></td></tr></table></figure>

<h3 id="e-修改gtid-mode-x3D-on-permissive"><a href="#e-修改gtid-mode-x3D-on-permissive" class="headerlink" title="e.修改gtid_mode&#x3D;on_permissive"></a>e.修改gtid_mode&#x3D;on_permissive</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;set global gtid_mode=on_permissive;&quot;</span><br><span class="line">生成新的事务使用GTID，同时允许复制的事务为匿名和GTID的。</span><br></pre></td></tr></table></figure>

<h3 id="f-各从节点检查剩余事务数"><a href="#f-各从节点检查剩余事务数" class="headerlink" title="f. 各从节点检查剩余事务数"></a>f. 各从节点检查剩余事务数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -e  &quot;show status like &#x27;ongoing_anonymous_transaction_count&#x27;;&quot;</span><br><span class="line">表示标记为匿名正在运行的事务数量。置0后执行下一步。</span><br><span class="line">mysql -e  &quot;flush logs;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="g-启用gtid-mode"><a href="#g-启用gtid-mode" class="headerlink" title="g. 启用gtid_mode"></a>g. 启用gtid_mode</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -e  &quot;set global gtid_mode=on;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="h-从库切换复制模式"><a href="#h-从库切换复制模式" class="headerlink" title="h. 从库切换复制模式"></a>h. 从库切换复制模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -e &quot;stop slave; change master to master_auto_position=1;start slave;&quot;</span><br><span class="line">mysql -e &quot;show slave status \G&quot;</span><br></pre></td></tr></table></figure>

<h3 id="i-修改配置文件永久生效"><a href="#i-修改配置文件永久生效" class="headerlink" title="i. 修改配置文件永久生效"></a>i. 修改配置文件永久生效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br></pre></td></tr></table></figure>

<h1 id="4-异步（传统、GTID）复制工作原理"><a href="#4-异步（传统、GTID）复制工作原理" class="headerlink" title="4 异步（传统、GTID）复制工作原理"></a>4 异步（传统、GTID）复制工作原理</h1><h2 id="4-1-传统"><a href="#4-1-传统" class="headerlink" title="4.1 传统"></a>4.1 传统</h2><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661873940324-7f7cd184-4c8c-4bc0-aae5-25605a867043.png"></p>
<h2 id="4-2-GTID在复制中改变"><a href="#4-2-GTID在复制中改变" class="headerlink" title="4.2 GTID在复制中改变"></a>4.2 GTID在复制中改变</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gtid格式 ：</span><br><span class="line">server_uuid:seq</span><br><span class="line">a. MASTER 发生事务,生成GTID,记录binlog。</span><br><span class="line">b. slave 根据gtid_next请求下一个GTID的事件。</span><br><span class="line">c. Master 发送 binlog到SLAVE.</span><br><span class="line">d. slave 接收二进制日志，存储至relaylog，读取gtid信息并设置gtid_next值。</span><br><span class="line">e. slave SQL 回放GTID事务。</span><br><span class="line">	1. 检测本地binlog是否有该GTID</span><br><span class="line">	2. 应用事务，并更新本地binlog(log_slave_updates)</span><br><span class="line">注： </span><br><span class="line">已执行的gtid信息更新至mysql.gtid_executed表中，并定期进行压缩。（reset master 会清空此表）</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960590057-924046bf-663f-48cc-a567-7d53dbf51130.png"></p>
<h1 id="5-半同步、增强半同步复制工作原理"><a href="#5-半同步、增强半同步复制工作原理" class="headerlink" title="5 半同步、增强半同步复制工作原理"></a>5 半同步、增强半同步复制工作原理</h1><h2 id="5-0-预备知识–2PC-及-group-commit"><a href="#5-0-预备知识–2PC-及-group-commit" class="headerlink" title="5.0 预备知识–2PC 及 group commit"></a>5.0 预备知识–2PC 及 group commit</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#a. 2PC机制</span><br><span class="line">	客户端下发commit命令，此时进入真正的两阶段提交，两阶段提交分为prepare和commit两个阶段</span><br><span class="line">## prepare阶段： </span><br><span class="line">	prepare分为binlog prepare和innobase redo prepare,其中binlog prepare几乎不做操作，innobase prepare会更新事务状态。</span><br><span class="line"></span><br><span class="line"># commit阶段：</span><br><span class="line">	commit阶段被分为了三个阶段，分别是flush，sync，commit。其中 flush操作会进行线程binlog cache的文件写入，再将用户binlog cache刷新到文件；sync操作负责binlog的落盘；commit操作负责更新server层的最大事务提交数量(和并行复制相关),然后innobase 再次更新事务状态。提交结束。</span><br><span class="line"></span><br><span class="line">#b. group commit流程： </span><br><span class="line">## FLUSH 阶段：</span><br><span class="line">1)      持有Lock_log mutex [leader持有，follower等待]</span><br><span class="line">2)      获取队列中的一组binlog(队列中的所有事务)</span><br><span class="line">3)      将binlog buffer到OS cache</span><br><span class="line">4)      通知dump线程dump binlog</span><br><span class="line"></span><br><span class="line">## SYNC阶段</span><br><span class="line">1)      释放Lock_log mutex，持有Lock_sync mutex[leader持有，follower等待]</span><br><span class="line">2)      将一组binlog 落盘(sync动作，最耗时，假设sync_binlog为1)</span><br><span class="line"></span><br><span class="line">## COMMIT阶段</span><br><span class="line">1)      释放Lock_sync mutex，持有Lock_commit mutex[leader持有，follower等待]</span><br><span class="line">2)      遍历队列中的事务，逐一进行innodb commit</span><br><span class="line">3)      释放Lock_commit mutex</span><br><span class="line">4)      唤醒队列中等待的线程</span><br><span class="line"></span><br><span class="line">配套参数：</span><br><span class="line">binlog_group_commit_sync_no_delay_count=N</span><br><span class="line">binlog_group_commit_sync_delay=M</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960761551-19811b64-a47a-40d8-8884-a09162eb68a4.png"></p>
<h2 id="5-1-半同步复制-after-commit"><a href="#5-1-半同步复制-after-commit" class="headerlink" title="5.1 半同步复制(after_commit)"></a>5.1 半同步复制(after_commit)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFTER_COMMIT: The master writes each transaction to its binary log and the slave, syncs the binary log, and commits the transaction to the storage engine. The master waits for slave acknowledgment of transaction receipt after the commit. Upon receiving acknowledgment, the master returns a result to the client, which then can proceed.</span><br></pre></td></tr></table></figure>

<h2 id="5-2-增强半同步-after-sync"><a href="#5-2-增强半同步-after-sync" class="headerlink" title="5.2 增强半同步(after_sync)"></a>5.2 增强半同步(after_sync)</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFTER_SYNC (the default): The master writes each transaction to its binary log and the slave, and syncs the binary log to disk. The master waits for slave acknowledgment of transaction receipt after the sync. Upon receiving acknowledgment, the master commits the transaction to the storage engine and returns a result to the client, which then can proceed.</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960812807-04c737c8-e978-4f1d-ad4a-6437f6b342c5.png"></p>
<h1 id="5-主从复制故障监控、原因分析、处理方案"><a href="#5-主从复制故障监控、原因分析、处理方案" class="headerlink" title="5 主从复制故障监控、原因分析、处理方案"></a>5 主从复制故障监控、原因分析、处理方案</h1><h2 id="5-1-主从复制监控方式"><a href="#5-1-主从复制监控方式" class="headerlink" title="5.1 主从复制监控方式"></a>5.1 主从复制监控方式</h2><h3 id="5-1-1-主库监控"><a href="#5-1-1-主库监控" class="headerlink" title="5.1.1 主库监控"></a>5.1.1 主库监控</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 data]# mysql  -e &quot;show processlist&quot; |grep &quot;Dump&quot;</span><br><span class="line">7	repl	db01:34640	NULL	Binlog Dump	5355	Master has sent all binlog to slave; waiting for more updates	NULL</span><br><span class="line">9	repl	db01:34642	NULL	Binlog Dump	687	Master has sent all binlog to slave; waiting for more updates	NULL</span><br><span class="line"></span><br><span class="line">[root@db01 data]# mysql  -e &quot;show slave hosts;&quot;</span><br><span class="line">+-----------+----------------+------+-----------+--------------------------------------+</span><br><span class="line">| Server_id | Host           | Port | Master_id | Slave_UUID                           |</span><br><span class="line">+-----------+----------------+------+-----------+--------------------------------------+</span><br><span class="line">|        53 | 10.0.0.53:3306 | 3306 |        51 | af1c4368-c31a-11ea-9078-000c29a5e781 |</span><br><span class="line">|        52 | 10.0.0.52:3306 | 3306 |        51 | ac703788-c31a-11ea-a322-000c29f2d9fe |</span><br><span class="line">+-----------+----------------+------+-----------+--------------------------------------+</span><br></pre></td></tr></table></figure>

<h3 id="5-1-2-从库监控"><a href="#5-1-2-从库监控" class="headerlink" title="5.1.2 从库监控"></a>5.1.2 从库监控</h3><h4 id="a-主库连接信息、binlog位置信息"><a href="#a-主库连接信息、binlog位置信息" class="headerlink" title="a. 主库连接信息、binlog位置信息"></a>a. 主库连接信息、binlog位置信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@db01 data]# mysql -e &quot;show slave status \G&quot;</span><br><span class="line">Master_Host: 10.0.0.51</span><br><span class="line">Master_User: repl</span><br><span class="line">Master_Port: 3306</span><br><span class="line">Connect_Retry: 10</span><br><span class="line">Master_Log_File: mysql-bin.000006</span><br><span class="line">Read_Master_Log_Pos: 341</span><br></pre></td></tr></table></figure>

<h4 id="b-从库中relay-log的回放信息"><a href="#b-从库中relay-log的回放信息" class="headerlink" title="b. 从库中relay-log的回放信息"></a>b. 从库中relay-log的回放信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Relay_Log_File: db02-relay-bin.000004</span><br><span class="line">Relay_Log_Pos: 458</span><br><span class="line">Relay_Master_Log_File: mysql-bin.000006</span><br><span class="line">Exec_Master_Log_Pos: 341</span><br></pre></td></tr></table></figure>

<h4 id="c-线程监控信息：主要用来排查主从故障"><a href="#c-线程监控信息：主要用来排查主从故障" class="headerlink" title="c. 线程监控信息：主要用来排查主从故障"></a>c. 线程监控信息：主要用来排查主从故障</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br><span class="line">Last_IO_Errno: 0</span><br><span class="line">Last_IO_Error: </span><br><span class="line">Last_SQL_Errno: 0</span><br><span class="line">Last_SQL_Error:</span><br></pre></td></tr></table></figure>

<h4 id="d-过滤复制相关信息"><a href="#d-过滤复制相关信息" class="headerlink" title="d. 过滤复制相关信息"></a>d. 过滤复制相关信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Replicate_Do_DB: </span><br><span class="line">Replicate_Ignore_DB: </span><br><span class="line">Replicate_Do_Table: </span><br><span class="line">Replicate_Ignore_Table: </span><br><span class="line">Replicate_Wild_Do_Table: </span><br><span class="line">Replicate_Wild_Ignore_Table:</span><br></pre></td></tr></table></figure>

<h4 id="e-落后于主库的秒数"><a href="#e-落后于主库的秒数" class="headerlink" title="e. 落后于主库的秒数"></a>e. 落后于主库的秒数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Seconds_Behind_Master: 0</span><br></pre></td></tr></table></figure>

<h4 id="f-延时从库状态信息"><a href="#f-延时从库状态信息" class="headerlink" title="f. 延时从库状态信息"></a>f. 延时从库状态信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SQL_Delay: 0</span><br><span class="line">SQL_Remaining_Delay: NULL</span><br></pre></td></tr></table></figure>

<h4 id="g-GTID复制信息"><a href="#g-GTID复制信息" class="headerlink" title="g. GTID复制信息"></a>g. GTID复制信息</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Retrieved_Gtid_Set: </span><br><span class="line">Executed_Gtid_Set: </span><br><span class="line">Auto_Position: 0</span><br></pre></td></tr></table></figure>

<h4 id="h-一堆pos-功能"><a href="#h-一堆pos-功能" class="headerlink" title="h. 一堆pos 功能"></a>h. 一堆pos 功能</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">（1） IO 已经获取到的主库Binlog的位置点（master.info）</span><br><span class="line">Master_Log_File: mysql-bin.000001</span><br><span class="line">Read_Master_Log_Pos: 444</span><br><span class="line">作用： IO下次请求日志时，起点位置。</span><br><span class="line"></span><br><span class="line">（2） SQL 回放到的relaylog位置点。(relay-log.info)</span><br><span class="line">Relay_Log_File: db01-relay-bin.000006</span><br><span class="line">Relay_Log_Pos: 320</span><br><span class="line"></span><br><span class="line">（3）SQL回放的realylog位置点，对应的主库binlog的位置点(relay-log.info)</span><br><span class="line">Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">Exec_Master_Log_Pos: 600</span><br><span class="line">作用： 计算主从复制延时日志量。</span><br></pre></td></tr></table></figure>

<h2 id="5-2-主从故障分析及处理"><a href="#5-2-主从故障分析及处理" class="headerlink" title="5.2 主从故障分析及处理"></a>5.2 主从故障分析及处理</h2><h3 id="5-2-1-如何监控"><a href="#5-2-1-如何监控" class="headerlink" title="5.2.1 如何监控"></a>5.2.1 如何监控</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如何监控 </span><br><span class="line">[root@db01 data]# mysql -S /tmp/mysql3308.sock -e &quot;show slave status \G&quot;</span><br><span class="line">Slave_IO_Running: Yes                # IO线程工作状态： YES、NO、Connecting  </span><br><span class="line">Slave_SQL_Running: Yes               # SQL线程工作状态：YES、NO</span><br><span class="line">Last_IO_Errno: 0                     # IO故障代码：2003,1045,1040,1593,1236...</span><br><span class="line">Last_IO_Error:                       # IO线程报错详细信息  </span><br><span class="line">Last_SQL_Errno: 0                    # SQL故障代码：1008，1007，1032，1062..</span><br><span class="line">Last_SQL_Error:                      # IO线程报错详细信息</span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-IO线程故障"><a href="#5-2-2-IO线程故障" class="headerlink" title="5.2.2 IO线程故障"></a>5.2.2 IO线程故障</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">a. 连接主库失败 </span><br><span class="line">user,password,IP,Port,plugin</span><br><span class="line">主库无法连接：网络、宕机、防护墙、最大连接数上限</span><br><span class="line">故障模拟： </span><br><span class="line">(1)主库宕机 </span><br><span class="line"> systemctl stop mysqld3307 </span><br><span class="line"> show slave status\G </span><br><span class="line"> 还原: </span><br><span class="line"> systemctl start mysqld3307 </span><br><span class="line"> mysql -S /tmp/mysql3308.sock  -e &quot;start slave;&quot; </span><br><span class="line">(2) 模拟用户密码错误</span><br><span class="line">  mysql  -e &quot;alter user repl@&#x27;10.0.0.%&#x27; identified by &#x27;11212&#x27;&quot;</span><br><span class="line">  mysql   -e &quot;start slave;  show slave status\G &quot; </span><br><span class="line"> 还原： </span><br><span class="line">   mysql  -e &quot;alter user repl@&#x27;10.0.0.%&#x27; identified by &#x27;123&#x27;&quot; </span><br><span class="line">   mysql  -e &quot;start slave;  show slave status\G &quot; </span><br><span class="line"> </span><br><span class="line">(3) 连接数上限</span><br><span class="line"> mysql -e &quot; set global max_connections=2;&quot; </span><br><span class="line"> mysql </span><br><span class="line"> mysql </span><br><span class="line"> mysql  -e &quot;stop slave; start slave;  show slave status\G &quot; </span><br><span class="line"> 还原：  </span><br><span class="line"> mysql   -e &quot; set global max_connections=200;&quot; </span><br><span class="line"> mysql -e &quot;stop slave; start slave;  show slave status\G &quot; </span><br><span class="line"></span><br><span class="line">通用排查方法： </span><br><span class="line">[root@db01 ~]# mysql -urepl -p123 -h 10.0.0.51 -P 3300</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 2003 (HY000): Can&#x27;t connect to MySQL server on &#x27;10.0.0.51&#x27; (111)</span><br><span class="line">[root@db01 ~]# mysql -urepl -p123 -h 10.0.0.52 -P 3307</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 2003 (HY000): Can&#x27;t connect to MySQL server on &#x27;10.0.0.52&#x27; (113)</span><br><span class="line">[root@db01 ~]# mysql -urepla -p123 -h 10.0.0.51 -P 3307</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1045 (28000): Access denied for user &#x27;repla&#x27;@&#x27;db01&#x27; (using password: YES)</span><br><span class="line">[root@db01 ~]# mysql -urepl -p1123 -h 10.0.0.51 -P 3307</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1045 (28000): Access denied for user &#x27;repl&#x27;@&#x27;db01&#x27; (using password: YES)</span><br><span class="line">[root@db01 ~]# </span><br><span class="line"></span><br><span class="line">b. 主从信息交换</span><br><span class="line">主从的server_id、Server_uuid、相同。</span><br><span class="line">版本不兼容（低到高可以、高到低不行、跨太多版本也不行）。</span><br><span class="line"># server_id 故障重现： </span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3307.sock</span><br><span class="line">mysql&gt; set global server_id=8;</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3307.sock</span><br><span class="line">mysql&gt; select @@server_id;</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3308.sock</span><br><span class="line">mysql&gt; stop slave;start slave;show slave status;</span><br><span class="line"></span><br><span class="line">回退： </span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3307.sock</span><br><span class="line">mysql&gt; set global server_id=7;</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3307.sock</span><br><span class="line">mysql&gt; select @@server_id;</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3308.sock</span><br><span class="line">mysql&gt; start slave;show slave status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c. 请求日志失败</span><br><span class="line">主库日志损坏、缺失。</span><br><span class="line"></span><br><span class="line"># 主库日志损坏故障重现：</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3307.sock</span><br><span class="line">mysql&gt; reset master;</span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3308.sock</span><br><span class="line">mysql&gt; start slave;show slave status;</span><br><span class="line"></span><br><span class="line">测试环境处理方法（主从的数据当前是一致的）： </span><br><span class="line">[root@db01 ~]# mysql -S /tmp/mysql3308.sock</span><br><span class="line"># 将所有线程停止。</span><br><span class="line">mysql&gt; stop slave;                </span><br><span class="line"># 将从库复制信息清空（master.info,relay-log.info清空，show slave status看不到信息了）</span><br><span class="line">mysql&gt; reset slave all;  </span><br><span class="line">mysql&gt; CHANGE MASTER TO</span><br><span class="line">  MASTER_HOST=&#x27;10.0.0.51&#x27;,</span><br><span class="line">  MASTER_USER=&#x27;repl&#x27;,</span><br><span class="line">  MASTER_PASSWORD=&#x27;123&#x27;,</span><br><span class="line">  MASTER_PORT=3307,</span><br><span class="line">  MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">  MASTER_LOG_POS=154,</span><br><span class="line">  MASTER_CONNECT_RETRY=10;</span><br><span class="line">mysql&gt; start slave;</span><br><span class="line"></span><br><span class="line">生产中需要额外考虑什么情景？</span><br><span class="line">需要重构主从：</span><br><span class="line">	  1. 备份恢复.</span><br><span class="line">	  2. change master to  ;    start slave</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3-SQL线程故障"><a href="#5-2-3-SQL线程故障" class="headerlink" title="5.2.3 SQL线程故障"></a>5.2.3 SQL线程故障</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">SQL线程主要工作： 回放relaylog中的日志事件，可以理解为后台执行SQL语句。</span><br><span class="line">a. realy-log 损坏。 </span><br><span class="line">处理方法： 重构。</span><br><span class="line">方法1： 备份主库+change master to + start slave;  </span><br><span class="line"></span><br><span class="line">方法2： 找到问题点+ change master + start slave;</span><br><span class="line">	思路： 如何找到问题位置点。</span><br><span class="line">		1. 找到SQL已经回放到什么位置了。</span><br><span class="line">		SQL回放的realylog位置点，对应的主库binlog的位置点(relay-log.info)</span><br><span class="line">		Relay_Log_File: db01-relay-bin.000006</span><br><span class="line">		Relay_Log_Pos: 320</span><br><span class="line">		----》 </span><br><span class="line">		2. 找到主库相应位置点：</span><br><span class="line">		Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">		Exec_Master_Log_Pos: 600</span><br><span class="line">        3.  change master to  mysql-bin.000001 600</span><br><span class="line"></span><br><span class="line">b. 执行SQL出问题？</span><br><span class="line">（1）主从节点配置不一样： 平台、版本、参数、SQL_MODE</span><br><span class="line">  调整成一致。</span><br><span class="line">（2）修改的对象不存在（库、表、用户）</span><br><span class="line"> 从库被写入了。 双主架构。异步方式主从，导致数据不一致。</span><br><span class="line">（3）创建的对象已存在（库、表、用户、约束冲突）</span><br><span class="line"> 从库被写入了。 双主架构。</span><br><span class="line"></span><br><span class="line">方法一：部分场景可以使用，只要保证数据以主库为准即可使用。</span><br><span class="line">stop slave; </span><br><span class="line">set global sql_slave_skip_counter = 1;</span><br><span class="line">#将同步指针向下移动一个，如果多次不同步，可以重复操作。</span><br><span class="line">start slave;</span><br><span class="line"></span><br><span class="line">方法二：不推荐</span><br><span class="line">/etc/my.cnf</span><br><span class="line">slave-skip-errors = 1032,1062,1007</span><br><span class="line"></span><br><span class="line">常见错误代码:</span><br><span class="line">1007:对象已存在</span><br><span class="line">1032:无法执行DML</span><br><span class="line">1062:主键冲突,或约束冲突</span><br><span class="line">pt-table-checksum  pt-table-sync</span><br><span class="line"></span><br><span class="line">c. GTID 处理错误方式： </span><br><span class="line">查看监控信息:</span><br><span class="line">Last_SQL_Error: Error &#x27;Can&#x27;t create database &#x27;oldboy&#x27;; database exists&#x27; on query. Default database: &#x27;oldboy&#x27;. Query: &#x27;create database oldboy&#x27;</span><br><span class="line"></span><br><span class="line">Retrieved_Gtid_Set: 71bfa52e-4aae-11e9-ab8c-000c293b577e:1-3</span><br><span class="line">Executed_Gtid_Set:  71bfa52e-4aae-11e9-ab8c-000c293b577e:1-2,</span><br><span class="line">7ca4a2b7-4aae-11e9-859d-000c298720f6:1</span><br><span class="line">注入空事物的方法：</span><br><span class="line">stop slave;</span><br><span class="line">set gtid_next=&#x27;99279e1e-61b7-11e9-a9fc-000c2928f5dd:3&#x27;;</span><br><span class="line">begin;commit;</span><br><span class="line">set gtid_next=&#x27;AUTOMATIC&#x27;;</span><br><span class="line">    </span><br><span class="line">这里的xxxxx:N 也就是你的slave sql thread报错的GTID，或者说是你想要跳过的GTID。</span><br><span class="line">最好的解决方案：重新构建主从环境</span><br><span class="line"></span><br><span class="line">d. 总结： SQL线程故障规避方法</span><br><span class="line">1. 从库只读 ，读写分离中间件。</span><br><span class="line">2. 不使用双主结构。PXC、MGR替代。</span><br><span class="line">3. 半同步、增强半同步复制等，或者PXC、MGR替代。</span><br><span class="line">4. 使用pt相关工具校验主从数据，并同步。</span><br></pre></td></tr></table></figure>

<h2 id="5-3-主从延时分析及处理"><a href="#5-3-主从延时分析及处理" class="headerlink" title="5.3 主从延时分析及处理"></a>5.3 主从延时分析及处理</h2><h3 id="5-3-1-监控方法"><a href="#5-3-1-监控方法" class="headerlink" title="5.3.1 监控方法"></a>5.3.1 监控方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">方法一： 有没有延时</span><br><span class="line">Seconds_Behind_Master: 0</span><br><span class="line"></span><br><span class="line">方法二： </span><br><span class="line">主库： </span><br><span class="line">mysql&gt; show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000004 |   151847 |              |                  |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">从库： </span><br><span class="line">[root@db01 data]# mysql   -e &quot;show slave status \G&quot;|grep &quot;Master_Log&quot;</span><br><span class="line">已经拿到的主库日志量(master.info)：判断传输有没有延时</span><br><span class="line">Master_Log_File: mysql-bin.000004</span><br><span class="line">Read_Master_Log_Pos: 151847</span><br><span class="line"></span><br><span class="line">已经执行的主库日志(relay-log.info): 判断回放有没有延时</span><br><span class="line">Relay_Master_Log_File: mysql-bin.000004</span><br><span class="line">Exec_Master_Log_Pos: 141847</span><br><span class="line"></span><br><span class="line">计算主从复制延时日志量。</span><br><span class="line"></span><br><span class="line">方法三： </span><br><span class="line">	pt-heartbeat</span><br></pre></td></tr></table></figure>

<h3 id="5-3-2-导致延时的主要原因"><a href="#5-3-2-导致延时的主要原因" class="headerlink" title="5.3.2 导致延时的主要原因"></a>5.3.2 导致延时的主要原因</h3><h4 id="a-主库方面"><a href="#a-主库方面" class="headerlink" title="a. 主库方面"></a>a. 主库方面</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">（1） binlog记录不及时。</span><br><span class="line">mysql&gt; select @@sync_binlog;</span><br><span class="line">+---------------+</span><br><span class="line">| @@sync_binlog |</span><br><span class="line">+---------------+</span><br><span class="line">|             1 |</span><br><span class="line">+---------------+</span><br><span class="line">参数说明： </span><br><span class="line">	   1 ： 每次事务提交都立即刷新binlog到磁盘。 </span><br><span class="line">	   0 ： 由操作系统决定，什么刷新磁盘。</span><br><span class="line"></span><br><span class="line">（2） DUMP线程串行工作。</span><br><span class="line">大事务、并发事务高、DDL</span><br><span class="line">解决办法： </span><br><span class="line">	5.6版本加入GTID复制模式，但手工配置。DUMP在传输日志时可以并发。</span><br><span class="line">    5.7版本GTID做了增强，不手工开启也自动维护匿名的GTID信息。    </span><br><span class="line">（3）怎么判断是主库导致的延时？ </span><br><span class="line">主库： </span><br><span class="line">mysql&gt; show master status ;</span><br><span class="line">从库： </span><br><span class="line">mysql -S /tmp/mysql3308.sock -uroot -p123  -e &quot;show slave status \G&quot;|grep &quot;Master_Log&quot;</span><br></pre></td></tr></table></figure>

<h4 id="b-从库方面"><a href="#b-从库方面" class="headerlink" title="b. 从库方面"></a>b. 从库方面</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># IO线程： </span><br><span class="line">从库IO比较慢。relay 落地慢。可以将realy放到 SSD</span><br><span class="line"></span><br><span class="line"># SQL 线程： 串行回放。</span><br><span class="line">主库可以并行事务，从库SQL线程串行回放。</span><br><span class="line">所以：并发事务高、大事务、DDL</span><br><span class="line"></span><br><span class="line">解决方法： </span><br><span class="line">	   5.6 版本： 开启GTID后，可以多SQL线程，只能针对不同的库的事务进行并行SQL恢复。</span><br><span class="line">	   5.7 版本： 做了增强，基于逻辑时钟的并行回放。MTS。LAST_COMMIT(BINLOG_GROUP_COMMIT) </span><br><span class="line">       SEQ_NUM.</span><br><span class="line">5.7 的从库并发配置方法。</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=4</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br></pre></td></tr></table></figure>

<h1 id="7-多SQL线程复制MTS和-MGR-Writesets"><a href="#7-多SQL线程复制MTS和-MGR-Writesets" class="headerlink" title="7. 多SQL线程复制MTS和 MGR Writesets"></a>7. 多SQL线程复制MTS和 MGR Writesets</h1><h2 id="7-1-5-7-版本MTS"><a href="#7-1-5-7-版本MTS" class="headerlink" title="7.1 5.7+ 版本MTS"></a>7.1 5.7+ 版本MTS</h2><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661960993317-4d120d62-0024-4dcf-920c-3b692931957b.png"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">a. 为什么会有 MTS和 WS ？ </span><br><span class="line">主库执行1000个事务，1000有GC机制，一次性投递到从库。</span><br><span class="line">从库SQL线程默认就1个。只能串行回放relay-log。</span><br><span class="line"></span><br><span class="line">5.6 版本&quot;</span><br><span class="line">加入多SQL线程回放机制。由一个管理线程，自动分配workers.</span><br><span class="line">按照database为基准，进行分配workers.</span><br><span class="line">MySQL 5.7 : </span><br><span class="line">利用Group Commit(LOGICAL<span class="emphasis">_CLOCK),检测事务之间是否冲突。</span></span><br><span class="line"><span class="emphasis">引入了新的并行回放类型， 由参数 slave_</span>parallel<span class="emphasis">_type决定，默认值DATABASE将会采用5.6版本中的SCHEMA级别的并行回放，设置为LOGICAL_</span>CLOCK 则会采用基于Group Commit的并行回放，同一个Group内的事务将会在Slave上并行回放。last<span class="emphasis">_commit=0 1 2 3 4 6</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">为了标记事务所属的组，MySQL 5.7 版本在产生 Binlog日志时会有两个特殊的值记录在Binlog Event中， last_</span>committed 和 sequence<span class="emphasis">_number , 其中 last_</span>committed 指的是该事务提交时，上一个事务提交的编号，sequence<span class="emphasis">_number 是事务提交的序列号，在一个Binlog文件内单调递增。如果两个事务的 last_</span>committed 值一致，这两个事务就是在一个组内提交的。</span><br><span class="line"></span><br><span class="line">mysqlbinlog mysql-bin.0000006 | grep last<span class="emphasis">_committed</span></span><br><span class="line"><span class="emphasis">server_</span>id 51 XXX GTID last<span class="emphasis">_committed=0 sequence_</span>numer=1</span><br><span class="line">server<span class="emphasis">_id 51 XXX GTID last_</span>committed=0 sequence<span class="emphasis">_numer=2</span></span><br><span class="line"><span class="emphasis">server_</span>id 51 XXX GTID last<span class="emphasis">_committed=0 sequence_</span>numer=3</span><br><span class="line">server<span class="emphasis">_id 51 XXX GTID last_</span>committed=0 sequence<span class="emphasis">_numer=4</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">注意： 同一个Session中的事件不能并发回放</span></span><br><span class="line"><span class="emphasis">session1: </span></span><br><span class="line"><span class="emphasis">TX1</span></span><br><span class="line"><span class="emphasis">create table t1;</span></span><br><span class="line"><span class="emphasis">TX2</span></span><br><span class="line"><span class="emphasis">begin;</span></span><br><span class="line"><span class="emphasis">insert into t1 values</span></span><br><span class="line"><span class="emphasis">commit;</span></span><br><span class="line"><span class="emphasis">TX3</span></span><br><span class="line"><span class="emphasis"> create table t2 ;</span></span><br></pre></td></tr></table></figure>

<h2 id="7-2-8-0-版本-MGR-WS"><a href="#7-2-8-0-版本-MGR-WS" class="headerlink" title="7.2 8.0 版本 MGR WS"></a>7.2 8.0 版本 MGR WS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">a. 核心参数</span><br><span class="line">binlog_transaction_dependency_tracking  = WRITESET                 #    COMMIT_ORDER   </span><br><span class="line">transaction_write_set_extraction        = XXHASH64</span><br><span class="line"></span><br><span class="line"> b. 参数介绍</span><br><span class="line">	MySQL 8.0 中引入参数 binlog_transaction_depandency_tracking 用于控制如何决定事务的依赖关系。该值有三个选项：默认的 COMMIT_ORDERE 表示继续使用5.7中的基于组提交的方式决定事务的依赖关系；WRITESET 表示使用写集合来决定事务的依赖关系；还有一个选项 WRITESET_SESSION 表示使用 WriteSet 来决定事务的依赖关系，但是同一个Session内的事务不会有相同的 last_committed 值。</span><br><span class="line">	</span><br><span class="line">C.WS实现原理</span><br><span class="line">	在代码实现上，MySQL采用一个 vector&lt;uint64&gt; 的变量存储已经提交的事务的HASH值，所有已经提交的事务的所修改的主键和非空的 UniqueKey 的值经过HASH后与该vector中的值对比，以判断当前提交的事务是否与已经提交的事务更新了同一行，并以此确定依赖关系。该向量的大小由参数 binlog_transaction_dependency_history_size 控制，取值范围为 1-1000000 ，初始默认值为 25000。 同时有参数 transaction_write_set_extraction 控制检测事务依赖关系时采用的HASH算法，有三个取值 OFF| XXHASH64 | MURMUR32， 如果 binlog_transaction_depandency_tracking 取值为 WRITESET 或 WRITESET_SESSION, 那么该值取值不能为OFF，且不能变更。</span><br><span class="line"></span><br><span class="line">D. WriteSet 依赖检测条件</span><br><span class="line">	WriteSet 是通过检测两个事务是否更新了相同的记录来判断事务能否并行回放的，因此需要在运行时保存已经提交的事务信息以记录历史事务更新了哪些行。记录历史事务的参数为 binlog_transaction_dependency_history_size. 该值越大可以记录更多的已经提交的事务信息，不过需要注意的是，这个值并非指事务大小，而是指追踪的事务更新信息的数量。在开启了 WRITESET 或 WRITESET_SESSION 后，MySQL 按以下的方式标识并记录事务的更新。</span><br><span class="line">insert INTO TEST.T1 VALUES(1,&#x27;zhangsan&#x27;);</span><br><span class="line">insert INTO TEST.T1 VALUES(1,&#x27;ls&#x27;);</span><br><span class="line"></span><br><span class="line">	如果事务当前更新的行有主键（Primary Key），则将 HASH(DB名，TABLE名，KEY名称，KEY_VALUE1, KEY_VALUE2,.....) 加入到当前事务的 vector write_set 中。</span><br><span class="line">	如果事务当前更新的行有非空的唯一键 （Unique Key Not NULL）， 同样将 HASH(DB名, TABLE名，KEY名, KEY_VALUE1, ....)加入到当前事务的 write_set 中。</span><br><span class="line">	如果事务更新的行有外键约束( FOREIGN KEY )且不为空，则将该外键信息与VALUE的HASH加到当前事务的 write_set中.</span><br><span class="line">	如果事务当前更新的表的主键是其他某个表的外键，并设置当前事务 has_related_foreign_key = true</span><br><span class="line">	如果事务更新了某一行且没有任何数据被加入到 write_set 中，则标记当前事务 has_missing_key = true</span><br><span class="line">	在执行冲突检测的时候，先会检查 has_related_foreign_key 和 has_missing_key ， 如果为true， 则退到 COMMIT_ORDER 模式。否则，会依照事务的 write_set 中的HASH值与已提交的事务的 write_set 进行比对，如果没有冲突，则当前事务与最后一个已提交的事务共享相同的 last_commited, 否则将从全局已提交的 write_set 中删除那个冲突的事务之前提交的所有write_set，并退化到 COMMIT_ORDER 计算last_committed 。 每次计算完事务的 last_committed 值以后，检测当前全局已提交事务的 write_set 是否已经超过了 binlog_transaction_dependency_history_size 设置的值，如果超过，则清空已提交事务的全局write_set。</span><br><span class="line">	从检测条件上看，该特性依赖于主键和唯一索引，如果事务涉及的表中没有主键且没有唯一非空索引，那么将无法从此特性中获得性能的提升。除此之外，还需要将 Binlog 格式设置为 Row 格式。</span><br></pre></td></tr></table></figure>

<h1 id="8-延时从库应用"><a href="#8-延时从库应用" class="headerlink" title="8. 延时从库应用"></a>8. 延时从库应用</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">a. 传统复制的痛点 </span><br><span class="line">	只能帮我们解决物理损坏，很难解决逻辑损坏。</span><br><span class="line">	可以用备份解决，但是数据量很大，通过备份方式花费很长时间。</span><br><span class="line">b. 配置方法：</span><br><span class="line">mysql&gt;stop slave;</span><br><span class="line">mysql&gt;CHANGE MASTER TO MASTER_DELAY = 300;</span><br><span class="line">mysql&gt;start slave;</span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">SQL_Delay: 300</span><br><span class="line">SQL_Remaining_Delay: NULL</span><br><span class="line"></span><br><span class="line">#恢复思路 ： </span><br><span class="line">主库发生了逻辑损坏（DROP，truncate）时，可以使用延时从库快速恢复数据。</span><br><span class="line">    2小时延时  </span><br><span class="line">	10：00  做的drop database A;</span><br><span class="line">1. 及时监控故障： 主库 10:05发现故障，从库此时8:05数据状态</span><br><span class="line">2. 立即将从库的SQL线程关闭。 需要对A业务挂维护页。</span><br><span class="line">3. 停止所有线程。</span><br><span class="line">4. 在延时从。恢复A库数据</span><br><span class="line"></span><br><span class="line">方案一：针对无GTID  手工模拟SQL线程工作，直到drop之前位置点。</span><br><span class="line">   SQL线程上次执行到的位置------》drop之前</span><br><span class="line">   relay.info   ----&gt; 分析drop位置点   ---》 截取relaylog日志----》 source</span><br><span class="line">   </span><br><span class="line"># 故障模拟及恢复</span><br><span class="line">故障模拟：  </span><br><span class="line">create database delaydb charset utf8mb4;</span><br><span class="line">use delaydb;</span><br><span class="line">create table t1(id int);</span><br><span class="line">insert into t1 values(1),(2),(3);</span><br><span class="line">commit;</span><br><span class="line">drop database delaydb;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">截取日志： </span><br><span class="line">起点: SQL上次执行到的位置点，</span><br><span class="line">               Relay_Log_File: db02-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 371</span><br><span class="line">终点： drop 之前 </span><br><span class="line">| db02-relay-bin.000002 | 1064 | Gtid           |        51 |        1006 | SET @@SESSION.GTID_NEXT= &#x27;188be1ed-c84c-11ea-98e7-000c29ea9d83:1469&#x27; |</span><br><span class="line">| db02-relay-bin.000002 | 1141 | Query          |        51 |        1119 | drop database delaydb /* xid=5339 */  </span><br><span class="line"></span><br><span class="line">[root@db01 tmp]# mysqlbinlog --start-position=371 --stop-position=1064 /data/3306/data/db02-relay-bin.000002 &gt;/tmp/bin.sql</span><br><span class="line">mysql&gt; reset slave all;</span><br><span class="line">mysql&gt; set sql_log_bin=0;</span><br><span class="line">mysql&gt; source /tmp/bin.sql;</span><br><span class="line">mysql&gt; set sql_log_bin=1;</span><br><span class="line"></span><br><span class="line">方案二： GTID</span><br><span class="line">db02 [(none)]&gt;stop slave;</span><br><span class="line"></span><br><span class="line">db02 [(none)]&gt;show relaylog events in &#x27;db02-relay-bin.000002&#x27;;</span><br><span class="line">SET @@SESSION.GTID_NEXT= &#x27;188be1ed-c84c-11ea-98e7-000c29ea9d83:4&#x27; </span><br><span class="line">CHANGE MASTER TO MASTER_DELAY = 0;</span><br><span class="line"></span><br><span class="line">db02 [delaydb]&gt;START SLAVE UNTIL SQL_BEFORE_GTIDS = &quot;188be1ed-c84c-11ea-98e7-000c29ea9d83:4&quot;;</span><br></pre></td></tr></table></figure>

<h1 id="9-过滤复制"><a href="#9-过滤复制" class="headerlink" title="9. 过滤复制"></a>9. 过滤复制</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 主库实现</span><br><span class="line">binlog_do_db      白名单</span><br><span class="line">binlog_ignore_db  黑名单</span><br><span class="line"></span><br><span class="line">说明： 是否记录binlog日志来控制过滤。</span><br><span class="line"></span><br><span class="line"># 从库实现 ******</span><br><span class="line">实现方法： </span><br><span class="line">IO线程不做限制。</span><br><span class="line">SQL线程回放时，选择性回放。</span><br><span class="line"></span><br><span class="line">参数： </span><br><span class="line">replicate_do_db=world</span><br><span class="line">replicate_do_db=oldboy</span><br><span class="line">replicate_ignore_db= </span><br><span class="line"></span><br><span class="line">replicate_do_table=world.city </span><br><span class="line">replicate_ignore_table= </span><br><span class="line"></span><br><span class="line">replicate_wild_do_table=world.t*</span><br><span class="line">replicate_wild_ignore_table=</span><br><span class="line"></span><br><span class="line">配置方法： </span><br><span class="line">方法一：  </span><br><span class="line">修改配置文件并重启</span><br><span class="line">vim /etc/my.cnf </span><br><span class="line">replicate_do_db=oldguo</span><br><span class="line">replicate_do_db=oldboy</span><br><span class="line"></span><br><span class="line">方法二： </span><br><span class="line">STOP SLAVE SQL_THREAD;</span><br><span class="line">CHANGE REPLICATION FILTER REPLICATE_DO_DB = (oldguo, oldboy);</span><br><span class="line">START  SLAVE SQL_THREAD;</span><br></pre></td></tr></table></figure>

<h1 id="10-多源复制-MSR"><a href="#10-多源复制-MSR" class="headerlink" title="10. 多源复制(MSR)"></a>10. 多源复制(MSR)</h1><h2 id="10-1-架构"><a href="#10-1-架构" class="headerlink" title="10.1 架构"></a>10.1 架构</h2><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961256653-6bbfc44a-dca0-4dfc-a27c-c6c927b8abd2.png"></p>
<h2 id="10-2-主机角色"><a href="#10-2-主机角色" class="headerlink" title="10.2 主机角色"></a>10.2 主机角色</h2><table>
<thead>
<tr>
<th>主机角色</th>
<th>地址</th>
<th>端口</th>
</tr>
</thead>
<tbody><tr>
<td>Master1</td>
<td>10.0.0.51</td>
<td>3306</td>
</tr>
<tr>
<td>Master2</td>
<td>10.0.0.52</td>
<td>3306</td>
</tr>
<tr>
<td>Slave</td>
<td>10.0.0.53</td>
<td>3306</td>
</tr>
</tbody></table>
<h2 id="10-3-配置过程"><a href="#10-3-配置过程" class="headerlink" title="10.3 配置过程"></a>10.3 配置过程</h2><h3 id="a-GTID环境准备"><a href="#a-GTID环境准备" class="headerlink" title="a. GTID环境准备"></a>a. GTID环境准备</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">(1) 清理环境</span><br><span class="line">pkill mysqld </span><br><span class="line">rm -rf /data/3306/*</span><br><span class="line">\mv /etc/my.cnf /tmp </span><br><span class="line"></span><br><span class="line">(2) 创建需要的目录 </span><br><span class="line">mkdir -p /data/3306/data /data/3306/binlog</span><br><span class="line">chown -R mysql.mysql /data</span><br><span class="line"></span><br><span class="line">(3) 准备配置文件 </span><br><span class="line"># db01 </span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql8</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">server_id=6</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency</span><br><span class="line">log-slave-updates=1</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">slow_query_log=ON</span><br><span class="line">slow_query_log_file=/data/3306/data/db01-slow.log</span><br><span class="line">long_query_time=0.1</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># db02 </span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql8</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">server_id=7</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency</span><br><span class="line">log-slave-updates=1</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">slow_query_log=ON</span><br><span class="line">slow_query_log_file=/data/3306/data/db01-slow.log</span><br><span class="line">long_query_time=0.1</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db02 [\\d]&gt;</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># db03 </span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br><span class="line">basedir=/data/app/mysql8</span><br><span class="line">datadir=/data/3306/data</span><br><span class="line">server_id=8</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">log_bin=/data/3306/binlog/mysql-bin</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency</span><br><span class="line">log-slave-updates=1</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">slow_query_log=ON</span><br><span class="line">slow_query_log_file=/data/3306/data/db01-slow.log</span><br><span class="line">long_query_time=0.1</span><br><span class="line">log_queries_not_using_indexes</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">[client]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db03 [\\d]&gt;</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">(4) 初始化数据 </span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/data/app/mysql8  --datadir=/data/3306/data </span><br><span class="line"></span><br><span class="line">(5) 启动数据库</span><br><span class="line">/etc/init.d/mysqld start </span><br><span class="line"></span><br><span class="line">(6) 构建主从  </span><br><span class="line"># 1. 创建复制用户(主节点)</span><br><span class="line">set sql_log_bin=0;</span><br><span class="line">create user repl@&#x27;10.0.0.%&#x27; identified with mysql_native_password by &#x27;123&#x27;;</span><br><span class="line">grant replication slave on *.*  to repl@&#x27;10.0.0.%&#x27; ;</span><br><span class="line">set sql_log_bin=1;</span><br></pre></td></tr></table></figure>

<h3 id="b-配置多源复制"><a href="#b-配置多源复制" class="headerlink" title="b. 配置多源复制"></a>b. 配置多源复制</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;10.0.0.51&#x27;,MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27;, MASTER_AUTO_POSITION=1 FOR CHANNEL &#x27;Master_1&#x27;;                </span><br><span class="line"></span><br><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;10.0.0.52&#x27;,MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27;, MASTER_AUTO_POSITION=1 FOR CHANNEL &#x27;Master_2&#x27;;           </span><br><span class="line"></span><br><span class="line">start slave for CHANNEL  &#x27;Master_1&#x27;;</span><br><span class="line">start slave for CHANNEL  &#x27;Master_2&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="c-多源复制监控"><a href="#c-多源复制监控" class="headerlink" title="c. 多源复制监控"></a>c. 多源复制监控</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db03 [(none)]&gt;SHOW SLAVE STATUS FOR CHANNEL &#x27;Master_1&#x27;\G</span><br><span class="line">db03 [(none)]&gt;SHOW SLAVE STATUS FOR CHANNEL &#x27;Master_2&#x27;\G</span><br><span class="line">db03 [performance_schema]&gt;select * from replication_connection_configuration\G</span><br><span class="line">SELECT * FROM replication_connection_status WHERE CHANNEL_NAME=&#x27;master_1&#x27;\G</span><br><span class="line">db03 [performance_schema]&gt;select * from performance_schema.replication_applier_status_by_worker;</span><br></pre></td></tr></table></figure>

<h3 id="d-多源复制配置过滤"><a href="#d-多源复制配置过滤" class="headerlink" title="d.多源复制配置过滤"></a>d.多源复制配置过滤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CHANGE REPLICATION FILTER REPLICATE_WILD_DO_TABLE = (&#x27;db1.%&#x27;) FOR CHANNEL &quot;master_1&quot;;</span><br><span class="line">mysql&gt; CHANGE REPLICATION FILTER REPLICATE_WILD_DO_TABLE = (&#x27;db2.%&#x27;) FOR CHANNEL &quot;master_2&quot;;</span><br></pre></td></tr></table></figure>

<h1 id="11-MGR组复制引入"><a href="#11-MGR组复制引入" class="headerlink" title="11.  MGR组复制引入"></a>11.  MGR组复制引入</h1><h2 id="11-0-历史"><a href="#11-0-历史" class="headerlink" title="11.0 历史"></a>11.0 历史</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">5.7.17+以后，出现的组复制技术。MySQL Group Replication。</span><br><span class="line">为了复制环境中，数据一致性考虑、多写的场景研发的技术。</span><br></pre></td></tr></table></figure>

<h2 id="11-1-架构原理"><a href="#11-1-架构原理" class="headerlink" title="11.1 架构原理"></a>11.1 架构原理</h2><p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961313863-c981821e-b5d8-4f4a-9ff2-988c81ff785d.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">在2N+1个节点组成的单主模式组复制集群中，主库上一个事务提交时，会将事务修改记录相关的信息和事务产生的BINLOG事件打包生成一个写集(WRITE SET)，将写集发送给所有节点，并通过至少N个节点投票通过才能事务提交成功。</span><br><span class="line"></span><br><span class="line">在事务执行期间，会将：</span><br><span class="line">1、事务操作生成的map event/query event/dml event等写入BINLOG CACHE中(内存)</span><br><span class="line">2、将Write Set写入到Rpl_transaction_write_set_ctx中(内存)</span><br><span class="line"></span><br><span class="line">在事务提交时，具体在MYSQL_BIN_LOG::prepare之后，但是在MYSQL_BIN_LOG::ordered_commit之前，即事务相关的BINLOG Event还在BINLOG CACHE没有写入到BINLOG FILE前，将BINLOG CACHE中和Rpl_transaction_write_set_ctx中的数据进行处理并写入到transaction_msg中，由gcs_module负责发送transaction_msg到各个节点，等待各节点进行事务认证。</span><br><span class="line"></span><br><span class="line">由于transaction_msg中包含BINLOG信息，并在事务认证期间发送给MGR各节点，因此无需等待主节点的BINLOG落盘后再发送给备用节点。</span><br><span class="line"></span><br><span class="line">每个MGR群集中的节点上，都存在IO线程和SQL线程，IO线程会解析transaction_msg获取到BINLOG EVENT并保存到RELAY LOG中，再由SQL线程执行重放到辅助节点上。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">总结： </span><br><span class="line">	single-primary:</span><br><span class="line">	begin;</span><br><span class="line">	update t1 set name=‘zs’ where id=10;</span><br><span class="line">	commit;</span><br><span class="line">	</span><br><span class="line">	1. 主库发生新的事务，事务执行期间，会将事务binlog 刷到binlog cache。</span><br><span class="line">	2. 生成write_set ,包含binlog日志+表、库hash值。写入Rpl_transaction_write_set_ctx。</span><br><span class="line">	3. MYSQL_BIN_LOG::prepare之后，在MYSQL_BIN_LOG::ordered_commit之前</span><br><span class="line">	通过gcs_module将所有的Rpl_transaction_write_set_ctx，以transaction_msg传输给各个节点。</span><br><span class="line">	4. 通过certify验证（Paxos）,通过投票机制，判断此次事务是否满足半数以上节点通过（不冲突）。	</span><br><span class="line">	5. 主库binlog flush &amp;&amp; sync disk</span><br><span class="line">	6. 此时，各个从库开始回放relaylog。</span><br></pre></td></tr></table></figure>

<h2 id="11-2-MGR构建过程"><a href="#11-2-MGR构建过程" class="headerlink" title="11.2 MGR构建过程"></a>11.2 MGR构建过程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line">a. 清理环境 </span><br><span class="line">pkill mysqld </span><br><span class="line">rm -rf /data/83306/*</span><br><span class="line">\mv /etc/my.cnf /etc/my.cnf.sin</span><br><span class="line"></span><br><span class="line">b. 创建目录</span><br><span class="line">mkdir -p /data/83306/data</span><br><span class="line">mkdir -p /data/83306/binlog</span><br><span class="line">chown -R mysql.mysql /data/*</span><br><span class="line"></span><br><span class="line">c. 配置文件</span><br><span class="line">[root@db01 data]# cat /proc/sys/kernel/random/uuid</span><br><span class="line">ca842376-1c50-42ac-bb57-a5adc7da7a12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># db01：</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/data/app/mysql8/</span><br><span class="line">datadir=/data/83306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=51</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/83306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">port=3306</span><br><span class="line">skip_name_resolve</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">report_host=10.0.0.51</span><br><span class="line">report_port=3306</span><br><span class="line">socket=/tmp/mysql83306.sock</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span><br><span class="line">loose-group_replication_start_on_boot=OFF</span><br><span class="line">loose-group_replication_local_address= &quot;10.0.0.51:33061&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;10.0.0.51:33061,10.0.0.52:33062,10.0.0.53:33063&quot;</span><br><span class="line">loose-group_replication_bootstrap_group=OFF</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#db02：</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/data/app/mysql8/</span><br><span class="line">datadir=/data/83306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=52</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/83306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">port=3306</span><br><span class="line">skip_name_resolve</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">report_host=10.0.0.52</span><br><span class="line">report_port=3306</span><br><span class="line">socket=/tmp/mysql83306.sock</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span><br><span class="line">loose-group_replication_start_on_boot=OFF</span><br><span class="line">loose-group_replication_local_address= &quot;10.0.0.52:33062&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;10.0.0.51:33061,10.0.0.52:33062,10.0.0.53:33063&quot;</span><br><span class="line">loose-group_replication_bootstrap_group=OFF</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db02 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># db03 ：</span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/data/app/mysql8/</span><br><span class="line">datadir=/data/83306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=53</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/83306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">port=3306</span><br><span class="line">skip_name_resolve</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">report_host=10.0.0.53</span><br><span class="line">report_port=3306</span><br><span class="line">socket=/tmp/mysql83306.sock</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">binlog_transaction_dependency_tracking = WRITESET</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span><br><span class="line">loose-group_replication_start_on_boot=OFF</span><br><span class="line">loose-group_replication_local_address= &quot;10.0.0.53:33063&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;10.0.0.51:33061,10.0.0.52:33062,10.0.0.53:33063&quot;</span><br><span class="line">loose-group_replication_bootstrap_group=OFF</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db03 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">d. 初始化数据</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/data/app/mysql8  --datadir=/data/83306/data </span><br><span class="line">e. 启动数据库</span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">f. 组复制部分，配置文件介绍：</span><br><span class="line">// group_replication变量使用的loose-前缀是指示Server启用时尚未加载复制插件也将继续启动</span><br><span class="line">##指示Server必须为每个事务收集写集合，并使用XXHASH64哈希算法将其编码为散列</span><br><span class="line">transaction_write_set_extraction = XXHASH64</span><br><span class="line"></span><br><span class="line">##表示将加入或者创建的复制组命名为01e5fb97-be64-41f7-bafd-3afc7a6ab555</span><br><span class="line">##可自定义(通过cat /proc/sys/kernel/random/uuid)</span><br><span class="line">loose-group_replication_group_name=&quot;01e5fb97-be64-41f7-bafd-3afc7a6ab555&quot;</span><br><span class="line"></span><br><span class="line">##设置为Server启动时不自动启动组复制</span><br><span class="line">loose-group_replication_start_on_boot=off </span><br><span class="line"></span><br><span class="line">##绑定本地的192.168.29.128及33061端口接受其他组成员的连接，IP地址必须为其他组成员可正常访问</span><br><span class="line">loose-group_replication_local_address=&quot;192.168.29.128:33061&quot; </span><br><span class="line"></span><br><span class="line">##本行为告诉服务器当服务器加入组时，应当连接到</span><br><span class="line">##这些种子服务器进行配置。本设置可以不是全部的组成员服务地址。</span><br><span class="line">loose-group_replication_group_seeds=&quot;192.168.29.128:33061,192.168.29.128:33062,192.168.29.128:33063&quot;</span><br><span class="line"></span><br><span class="line">##配置是否自动引导组</span><br><span class="line">loose-group_replication_bootstrap_group = off </span><br><span class="line"></span><br><span class="line">##配置白名单，默认情况下只允许192.168.29.128连接到复制组，如果是其他IP则需要配置。</span><br><span class="line">loose-group_replication_ip_whitelist=”10.30.0.0/16,10.31.0..0/16,10.27.0.0/16″</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">g. 设置本地root用户密码和密码插件（所有节点）</span><br><span class="line">mysql -S /tmp/mysql83306.sock -e &quot;ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;123&#x27;;&quot;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">h. 安装MGR插件（所有节点）</span><br><span class="line">mysql -uroot -p123 -S /tmp/mysql83306.sock -e &quot;INSTALL PLUGIN group_replication SONAME &#x27;group_replication.so&#x27;;&quot;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">i. 设置复制账号(所有节点)</span><br><span class="line">[root@db03 83306]# mysql -uroot -p123 -S /tmp/mysql83306.sock </span><br><span class="line">SET SQL_LOG_BIN=0;</span><br><span class="line">CREATE USER repl@&#x27;%&#x27; IDENTIFIED BY &#x27;123&#x27;;</span><br><span class="line">CREATE USER repl@&#x27;localhost&#x27; IDENTIFIED BY &#x27;123&#x27;;</span><br><span class="line">CREATE USER repl@&#x27;127.0.0.1&#x27; IDENTIFIED BY &#x27;123&#x27;;</span><br><span class="line">GRANT REPLICATION SLAVE,replication client ON *.* TO repl@&#x27;%&#x27;;</span><br><span class="line"> grant replication slave,replication client on *.* to repl@&#x27;localhost&#x27; ;</span><br><span class="line"> grant replication slave,replication client on *.* to repl@&#x27;127.0.0.1&#x27; ;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">  </span><br><span class="line">j. 启动MGR单主模式</span><br><span class="line">  </span><br><span class="line"># 启动MGR，在主库(10.0.0.51)上执行</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27;  FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">START GROUP_REPLICATION;</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| group_replication_applier | 5e46b750-c834-11ea-ab1a-000c29ea9d83 | 10.0.0.51   |       65535 | ONLINE       | PRIMARY     | 8.0.20         |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line"></span><br><span class="line"># 其他节点加入MGR，在从库上执行</span><br><span class="line">reset master;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27;  FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br><span class="line"> START GROUP_REPLICATION;</span><br><span class="line">  </span><br><span class="line"># 查看MGR组信息</span><br><span class="line">db03 [(none)]&gt;SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| group_replication_applier | 60aec22c-c83d-11ea-9560-000c29a5e781 | 10.0.0.53   |       65535 | ONLINE       | SECONDARY   | 8.0.20         |</span><br><span class="line">| group_replication_applier | 627fde7d-c83d-11ea-9a66-000c29f2d9fe | 10.0.0.52   |        3306 | ONLINE       | SECONDARY   | 8.0.20         |</span><br><span class="line">| group_replication_applier | 7c612d78-c83d-11ea-b17b-000c29ea9d83 | 10.0.0.51   |        3306 | ONLINE       | PRIMARY     | 8.0.20         |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">// 可以看到，3个节点状态为online，并且主节点为192.168.56.101，只有主节点可以写入，其他节点只读，MGR单主模式搭建成功。</span><br><span class="line">  </span><br><span class="line">如果需要重置，那么需要执行如下命令：</span><br><span class="line">STOP GROUP_REPLICATION;</span><br><span class="line">reset master;</span><br><span class="line">SET SQL_LOG_BIN=1;</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27; FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br><span class="line">start GROUP_REPLICATION;</span><br><span class="line">  </span><br><span class="line">k. 切换到多主模式</span><br><span class="line">MGR切换模式需要重新启动组复制，因些需要在所有节点上先关闭组复制，设置 group_replication_single_primary_mode=OFF 等参数，再启动组复制。</span><br><span class="line">1、该模式启用需设置两个参数</span><br><span class="line">group_replication_single_primary_mode=0 #这个参数很好理解，就是关闭单master模式</span><br><span class="line">group_replication_enforce_update_everywhere_checks=1 #这个参数设置多主模式下各个节点严格一致性检查</span><br><span class="line">================</span><br><span class="line">db02 [(none)]&gt;stop  GROUP_REPLICATION;</span><br><span class="line">db02 [(none)]&gt;set global group_replication_single_primary_mode=OFF;</span><br><span class="line">db02 [(none)]&gt;set global group_replication_enforce_update_everywhere_checks=1;</span><br><span class="line">db03 [(none)]&gt;stop  GROUP_REPLICATION;</span><br><span class="line">db03 [(none)]&gt;set global group_replication_single_primary_mode=OFF;</span><br><span class="line">db03 [(none)]&gt;set global group_replication_enforce_update_everywhere_checks=1;</span><br><span class="line">select @@group_replication_single_primary_mode,@@group_replication_enforce_update_everywhere_checks;</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">2、 默认启动的都是单master模式，其他节点都设置了read_only、super_read_only这两个参数，需要修改这两个配置</span><br><span class="line">===========</span><br><span class="line">db03 [(none)]&gt;set global read_only=0;</span><br><span class="line">db03 [(none)]&gt;set global super_read_only=0;</span><br><span class="line">===========</span><br><span class="line">3、 完成上面的配置后就可以执行多点写入了，多点写入会存在冲突检查，这耗损性能挺大的，官方建议采用网络分区功能，在程序端把相同的业务定位到同一节点，尽量减少冲突发生几率。</span><br><span class="line">  </span><br><span class="line"># 停止组复制(所有节点执行)：</span><br><span class="line">stop group_replication;</span><br><span class="line">set global group_replication_single_primary_mode=OFF;</span><br><span class="line">set global group_replication_enforce_update_everywhere_checks=ON;</span><br><span class="line">  </span><br><span class="line"># 随便选择某个节点执行</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">  </span><br><span class="line"># 其他节点执行</span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">  </span><br><span class="line"># 查看组信息，所有节点的 MEMBER_ROLE 都为 PRIMARY，</span><br><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">切回单主模式</span><br><span class="line"># 所有节点执行</span><br><span class="line">stop group_replication;</span><br><span class="line">set global group_replication_enforce_update_everywhere_checks=OFF;</span><br><span class="line">set global group_replication_single_primary_mode=ON;</span><br><span class="line">  </span><br><span class="line"># 主节点执行</span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=ON; </span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line"></span><br><span class="line"># 从节点执行</span><br><span class="line">START GROUP_REPLICATION; </span><br><span class="line">  </span><br><span class="line"># 查看MGR组信息，SELECT * FROM performance_schema.replication_group_members;</span><br></pre></td></tr></table></figure>

<h2 id="11-3-MGR的运维"><a href="#11-3-MGR的运维" class="headerlink" title="11.3 MGR的运维"></a>11.3 MGR的运维</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">a. MGR的监控</span><br><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">b. MGR故障处理</span><br><span class="line">## 宕掉主节点测试。</span><br><span class="line">db02 [(none)]&gt;SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| group_replication_applier | 60aec22c-c83d-11ea-9560-000c29a5e781 | 10.0.0.53   |       65535 | ONLINE       | PRIMARY     | 8.0.20         |</span><br><span class="line">| group_replication_applier | 627fde7d-c83d-11ea-9a66-000c29f2d9fe | 10.0.0.52   |        3306 | ONLINE       | SECONDARY   | 8.0.20         |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">## 启动主节点</span><br><span class="line">db02 [(none)]&gt;SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE | MEMBER_ROLE | MEMBER_VERSION |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+----------------+</span><br><span class="line">| group_replication_applier | 60aec22c-c83d-11ea-9560-000c29a5e781 | 10.0.0.53   |       65535 | ONLINE       | PRIMARY     | 8.0.20         |</span><br><span class="line">| group_replication_applier | 627fde7d-c83d-11ea-9a66-000c29f2d9fe | 10.0.0.52   |        3306 | ONLINE       | SECONDARY   | 8.0.20         |</span><br><span class="line">| group_replication_applier | 7c612d78-c83d-11ea-b17b-000c29ea9d83 | 10.0.0.51   |        3306 | ONLINE       | SECONDARY   | 8.0.20         |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+-------------+-----</span><br><span class="line"></span><br><span class="line">c. MGR添加删除节点</span><br><span class="line"># 通过clone plugin 添加新的节点</span><br><span class="line">1. 初始化新节点</span><br><span class="line">pkill mysqld </span><br><span class="line">rm -rf /data/83306/*</span><br><span class="line">\mv /etc/my.cnf /etc/my.cnf.sin</span><br><span class="line">mkdir -p /data/83306/data</span><br><span class="line">mkdir -p /data/83306/binlog</span><br><span class="line">chown -R mysql.mysql /data/*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/my.cnf &lt;&lt;EOF</span><br><span class="line">[mysqld]</span><br><span class="line">basedir=/data/app/mysql8/</span><br><span class="line">datadir=/data/83306/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">server_id=51</span><br><span class="line">port=3306</span><br><span class="line">secure-file-priv=/tmp</span><br><span class="line">log_bin=/data/83306/binlog/mysql-bin</span><br><span class="line">binlog_format=row</span><br><span class="line">gtid-mode=on</span><br><span class="line">enforce-gtid-consistency=true</span><br><span class="line">log-slave-updates=1</span><br><span class="line">port=3306</span><br><span class="line">skip_name_resolve</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">report_host=10.0.0.51</span><br><span class="line">report_port=3306</span><br><span class="line">socket=/tmp/mysql83306.sock</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line"></span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;ca842376-1c50-42ac-bb57-a5adc7da7a12&quot;</span><br><span class="line">loose-group_replication_start_on_boot=OFF</span><br><span class="line">loose-group_replication_local_address= &quot;10.0.0.54:33061&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;10.0.0.51:33061,10.0.0.52:33062,10.0.0.53:33063&quot;</span><br><span class="line">loose-group_replication_bootstrap_group=OFF</span><br><span class="line">[mysql]</span><br><span class="line">prompt=db01 [\\d]&gt;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">2. 初始化数据</span><br><span class="line">mysqld --initialize-insecure --user=mysql --basedir=/data/app/mysql8  --datadir=/data/83306/data </span><br><span class="line">3. 启动数据库</span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line"></span><br><span class="line">4. 设置本地root用户密码和密码插件（所有节点）</span><br><span class="line">mysql -S /tmp/mysql83306.sock -e &quot;ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;123&#x27;;&quot;</span><br><span class="line"></span><br><span class="line">5. 安装MGR插件（所有节点）</span><br><span class="line">mysql -uroot -p123 -S /tmp/mysql83306.sock -e &quot;INSTALL PLUGIN group_replication SONAME &#x27;group_replication.so&#x27;;&quot;</span><br><span class="line"></span><br><span class="line">6. clone plugin 克隆主库数据</span><br><span class="line"># 主库： </span><br><span class="line">[root@db01 ~]# mysql -uroot -p123 -S /tmp/mysql83306.sock -e &quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test@&#x27;%&#x27; identified by &#x27;123&#x27;;grant backup_admin on *.* to test@&#x27;%&#x27;;&quot;</span><br><span class="line"></span><br><span class="line"># 从库： </span><br><span class="line"> mysql -uroot -p123 -S /tmp/mysql83306.sock -e &quot;INSTALL PLUGIN clone SONAME &#x27;mysql_clone.so&#x27;;create user test1@&#x27;%&#x27; identified by &#x27;123&#x27;;grant clone_admin on *.* to test1@&#x27;%&#x27;;SET GLOBAL clone_valid_donor_list=&#x27;10.0.0.52:3306&#x27;;&quot;</span><br><span class="line"> mysql -utest1 -p123 -h10.0.0.51  -P3306 -e &quot;CLONE INSTANCE FROM test@&#x27;10.0.0.52&#x27;:3306 IDENTIFIED BY &#x27;123&#x27;;&quot;</span><br><span class="line"> </span><br><span class="line"># 加入集群</span><br><span class="line">CHANGE MASTER TO MASTER_USER=&#x27;repl&#x27;, MASTER_PASSWORD=&#x27;123&#x27;  FOR CHANNEL &#x27;group_replication_recovery&#x27;;</span><br><span class="line"> START GROUP_REPLICATION;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 查看MGR组信息</span><br><span class="line">SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line"></span><br><span class="line">d. MGR的限制</span><br><span class="line">1. 仅支持innodb存储引擎</span><br><span class="line">MGR集群中，只支持innodb存储引擎，能够创建非innodb引擎的表，但是无法写入数据，向非innodb表写数据直接报错。</span><br><span class="line">2. 表必须有主键，或者非Null的唯一键</span><br><span class="line">MGR集群中，只支持innodb引擎的表，并且该表必须有显式的主键，或者非Null的唯一键，否则即使能够创建表，也无法向表中写入数据。</span><br><span class="line">3. 网络限制</span><br><span class="line">MGR 组通信引擎目前仅支持IPv4网络，并且对节点间的网络性能要求较高，低延迟、高带宽的网络是部署MGR集群的基础。</span><br><span class="line">4. MGR忽略表锁和命名锁，在MGR中lock tables、unlock tables、get_lock、release_lock等这些表锁和命名锁将被忽略。</span><br><span class="line">5. MGR多主模式中，默认不支持 SERIALIZABLE 隔离级别。建议使用RC。</span><br><span class="line">6. 多主模式下，对同一个对象进行并发的有冲突的ddl和dml操作导致这种冲突在部分成员节点中无法检测到，最终可能导致数据不一致。</span><br><span class="line">7. 多主模式下，不支持级联约束的外键，可能造成有冲突的操作无法检测。</span><br><span class="line">8. 不支持超大事务。</span><br><span class="line">9. 多主模式下可能导致死锁，比如select ...for update在不同节点执行，由于多节点锁无法共享，很容易导致死锁。</span><br><span class="line">10.不支持复制过滤，如果有节点设置了复制过滤，将影响节点间决议的达成。</span><br><span class="line">11. MGR最多支持9个节点，大于9个节点，将拒绝新节点的加入。</span><br></pre></td></tr></table></figure>

<h2 id="11-4-MGR在8-0版本读写一致性保证"><a href="#11-4-MGR在8-0版本读写一致性保证" class="headerlink" title="11.4 MGR在8.0版本读写一致性保证"></a>11.4 MGR在8.0版本读写一致性保证</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MGR相对于半同步复制，在relay log前增加了冲突检查协调，但是binlog回放仍然可能延时，也就是跟我们熟悉的半同步复制存在SQL线程的回放延迟情况类似。当然关于SQL线程回放慢的原因，跟半同步也类似，比如大事务！！</span><br><span class="line"></span><br><span class="line">所以MGR并不是全同步方案，关于如何处理一致性读写的问题，MySQL 在8.0.14版本中加入了“读写一致性”特性，并引入了参数：group_replication_consistency，下面将对读写一致性的相关参数及不同应用场景进行详细说明。</span><br></pre></td></tr></table></figure>

<h3 id="参数group-replication-consistency的说明"><a href="#参数group-replication-consistency的说明" class="headerlink" title="参数group_replication_consistency的说明"></a>参数group_replication_consistency的说明</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVENTUAL 默认值(最终一致性)，开启事务（T2），事务执行前不会等待先序事务（T1）的回放完成，也不会影响后序事务等待该事务回放完成。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961388742-07ddb480-84fb-48bd-92a8-677e790afb9b.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BEFORE （本地强一致性）开启事务（T2），在开始前首先要等待先序事务（T1）的回放完成，确保此事务将在最新的数据上执行。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961400032-5d8e18d6-ee39-41be-9288-76fa1b709aac.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AFTER（全局强一致性），开启事务（T1），只有等该事务回放完成。其他后序事务（T2）才开始执行，这样所有后序事务都会读取包含其更改的数据库状态，而不管它们在哪个成员上执行。</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961413541-486a9116-f41b-4961-8783-a1cda9d1693f.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BEFORE_AND_AFTER 开启事务（T2），需要等待前序事务的回放完成（T1）；同时后序事务（T3）等待该事务的回放完成；</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.fbbizyy.com/yuque/0/2022/png/1581532/1661961617336-44c73a57-8ccf-403c-b2e2-e244d580aef6.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BEFORE_ON_PRIMARY_FAILOVER,在发生切换时，连到新主的事务会被阻塞，等待先序提交的事务回放完成；这样确保在故障切换时客户端都能读取到主服务器上的最新数据，保证了一致性</span><br><span class="line">group_replication_consistency 参数可以用法SESSION，GLOBAL去进行更改。</span><br><span class="line"></span><br><span class="line">官方说明请参考：</span><br><span class="line">https://dev.mysql.com/doc/refman/8.0/en/group-replication-options.html</span><br></pre></td></tr></table></figure>

<h3 id="MGR读写一致性的优缺点"><a href="#MGR读写一致性的优缺点" class="headerlink" title="MGR读写一致性的优缺点"></a>MGR读写一致性的优缺点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">官方引入的MGR读写一致性既有它自身的天然优势，也不可避免的存在相应的不足，其优缺点如下：</span><br><span class="line">优点：MGR配合中间件，比如读写分离功能的中间件，在MGR单主模式下，可以根据业务场景进行读写分离，不用担心会产生延迟，充分利用了MGR主节点以外的节点。</span><br><span class="line">缺点：使用读写一致性会对性能有极大影响，尤其是网络环境不稳定的场景下。</span><br><span class="line">在实际应用中需要大家因地制宜，根据实际情况选择最适配的方案</span><br></pre></td></tr></table></figure>

<h3 id="MGR读写一致性的方案"><a href="#MGR读写一致性的方案" class="headerlink" title="MGR读写一致性的方案"></a>MGR读写一致性的方案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">针对不同应用场景应当如何选择MGR读写一致性的相关方式，官方提供了几个参数以及与其相对应的应用场景：</span><br><span class="line"></span><br><span class="line">AFTER</span><br><span class="line">适用场景1：写少读多的场景进行读写分离，担心读取到过期事务，可选择AFTER。</span><br><span class="line">适用场景2：只读为主的集群，有RW的事务需要保证提交的事务能被其他后序事务读到最新读数据，可选择AFTER。</span><br><span class="line"></span><br><span class="line">BEFORE</span><br><span class="line">适用场景1：应用大量写入数据，偶尔进行读取一致性数据，应当选择BEFORE。</span><br><span class="line">适用场景2：有特定事务需要读写一致性，以便对敏感数据操作时，始终读取最新的数据；应当选择BEFORE。</span><br><span class="line"></span><br><span class="line">BEFORE_AND_AFTER</span><br><span class="line">适用场景：有一个读为主的集群，有RW的事务既要保证读到最新的数据，又要保证这个事务提交后，被其他后序事务读到；在这种情况下可选择BEFORE_AND_AFTER。</span><br><span class="line"></span><br><span class="line">http://www.itdks.com/Course/detail?id=117532</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"><i class="fa fa-tag"></i> mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/07/15/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84%E4%B8%8A/" rel="prev" title="分布式架构上">
      <i class="fa fa-chevron-left"></i> 分布式架构上
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/15/%E6%85%A2%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" rel="next" title="慢查询优化">
      慢查询优化 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%A4%8D%E5%88%B6%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">1 复制简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%89%8D%E6%8F%90"><span class="nav-number">2.</span> <span class="nav-text">2 主从复制前提</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E8%8A%B1%E5%BC%8F%E6%9E%84%E5%BB%BA%E6%96%B9%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">3 主从复制花式构建方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-0-%E5%87%86%E5%A4%87%E5%88%9D%E5%A7%8B%E7%8E%AF%E5%A2%83"><span class="nav-number">3.1.</span> <span class="nav-text">3.0 准备初始环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E9%80%9A%E8%BF%87mysqldump%EF%BC%88XBK%EF%BC%89%E5%A4%87%E4%BB%BD%E6%9E%84%E5%BB%BA%E4%BC%A0%E7%BB%9F%E4%B8%BB%E4%BB%8E"><span class="nav-number">3.2.</span> <span class="nav-text">3.1 通过mysqldump（XBK）备份构建传统主从</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E5%90%84%E8%8A%82%E7%82%B9%E6%A3%80%E6%9F%A5server-id%E3%80%81server-uuid%E3%80%81binlog"><span class="nav-number">3.2.1.</span> <span class="nav-text">a.各节点检查server_id、server_uuid、binlog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E4%B8%BB%E5%BA%93%EF%BC%8851%EF%BC%89%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%88%B6%E7%94%A8%E6%88%B7%E5%92%8C%E8%BF%9C%E7%A8%8B%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7"><span class="nav-number">3.2.2.</span> <span class="nav-text">b.主库（51）创建复制用户和远程管理用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E4%BB%8E%E5%BA%93%E5%A4%87%E4%BB%BD%E4%B8%BB%E5%BA%93%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E6%81%A2%E5%A4%8D%E3%80%82"><span class="nav-number">3.2.3.</span> <span class="nav-text">c.从库备份主库数据，并恢复。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-%E5%90%AF%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">3.2.4.</span> <span class="nav-text">d. 启动主从复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%96%B0%E5%A7%BF%E5%8A%BF-%E9%80%9A%E8%BF%87Clone-plugin%E6%90%AD%E5%BB%BA%E4%BC%A0%E7%BB%9F%E5%92%8CGTID%E4%B8%BB%E4%BB%8E"><span class="nav-number">3.3.</span> <span class="nav-text">3.2 新姿势-通过Clone-plugin搭建传统和GTID主从</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E4%B8%BB%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">3.3.1.</span> <span class="nav-text">a. 主库操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E4%BB%8E%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="nav-number">3.3.2.</span> <span class="nav-text">b. 从库操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E5%90%AF%E5%8A%A8%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">3.3.3.</span> <span class="nav-text">c. 启动主从复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-%E4%BC%A0%E7%BB%9F%E5%A4%8D%E5%88%B6%E5%92%8CGTID%E8%BD%AC%E6%8D%A2"><span class="nav-number">3.3.4.</span> <span class="nav-text">3.3 传统复制和GTID转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#a-%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81"><span class="nav-number">3.3.5.</span> <span class="nav-text">a. 查看当前状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E4%BF%AE%E6%94%B9enforce-gtid-consistency"><span class="nav-number">3.3.6.</span> <span class="nav-text">b. 修改enforce_gtid_consistency</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E4%BF%AE%E6%94%B9enforce-gtid-consistency-x3D-on"><span class="nav-number">3.3.7.</span> <span class="nav-text">c. 修改enforce_gtid_consistency &#x3D; on</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-%E4%BF%AE%E6%94%B9gtid-mode-x3D-off-permissive"><span class="nav-number">3.3.8.</span> <span class="nav-text">d. 修改gtid_mode &#x3D; off_permissive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#e-%E4%BF%AE%E6%94%B9gtid-mode-x3D-on-permissive"><span class="nav-number">3.3.9.</span> <span class="nav-text">e.修改gtid_mode&#x3D;on_permissive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#f-%E5%90%84%E4%BB%8E%E8%8A%82%E7%82%B9%E6%A3%80%E6%9F%A5%E5%89%A9%E4%BD%99%E4%BA%8B%E5%8A%A1%E6%95%B0"><span class="nav-number">3.3.10.</span> <span class="nav-text">f. 各从节点检查剩余事务数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#g-%E5%90%AF%E7%94%A8gtid-mode"><span class="nav-number">3.3.11.</span> <span class="nav-text">g. 启用gtid_mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#h-%E4%BB%8E%E5%BA%93%E5%88%87%E6%8D%A2%E5%A4%8D%E5%88%B6%E6%A8%A1%E5%BC%8F"><span class="nav-number">3.3.12.</span> <span class="nav-text">h. 从库切换复制模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%B0%B8%E4%B9%85%E7%94%9F%E6%95%88"><span class="nav-number">3.3.13.</span> <span class="nav-text">i. 修改配置文件永久生效</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%BC%82%E6%AD%A5%EF%BC%88%E4%BC%A0%E7%BB%9F%E3%80%81GTID%EF%BC%89%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">4 异步（传统、GTID）复制工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E4%BC%A0%E7%BB%9F"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 传统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-GTID%E5%9C%A8%E5%A4%8D%E5%88%B6%E4%B8%AD%E6%94%B9%E5%8F%98"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 GTID在复制中改变</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E5%8D%8A%E5%90%8C%E6%AD%A5%E3%80%81%E5%A2%9E%E5%BC%BA%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">5 半同步、增强半同步复制工作原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-0-%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86%E2%80%932PC-%E5%8F%8A-group-commit"><span class="nav-number">5.1.</span> <span class="nav-text">5.0 预备知识–2PC 及 group commit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E5%8D%8A%E5%90%8C%E6%AD%A5%E5%A4%8D%E5%88%B6-after-commit"><span class="nav-number">5.2.</span> <span class="nav-text">5.1 半同步复制(after_commit)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E5%A2%9E%E5%BC%BA%E5%8D%8A%E5%90%8C%E6%AD%A5-after-sync"><span class="nav-number">5.3.</span> <span class="nav-text">5.2 增强半同步(after_sync)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%95%85%E9%9A%9C%E7%9B%91%E6%8E%A7%E3%80%81%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90%E3%80%81%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88"><span class="nav-number">6.</span> <span class="nav-text">5 主从复制故障监控、原因分析、处理方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9B%91%E6%8E%A7%E6%96%B9%E5%BC%8F"><span class="nav-number">6.1.</span> <span class="nav-text">5.1 主从复制监控方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-%E4%B8%BB%E5%BA%93%E7%9B%91%E6%8E%A7"><span class="nav-number">6.1.1.</span> <span class="nav-text">5.1.1 主库监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-%E4%BB%8E%E5%BA%93%E7%9B%91%E6%8E%A7"><span class="nav-number">6.1.2.</span> <span class="nav-text">5.1.2 从库监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E4%B8%BB%E5%BA%93%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF%E3%80%81binlog%E4%BD%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.2.1.</span> <span class="nav-text">a. 主库连接信息、binlog位置信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E4%BB%8E%E5%BA%93%E4%B8%ADrelay-log%E7%9A%84%E5%9B%9E%E6%94%BE%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.2.2.</span> <span class="nav-text">b. 从库中relay-log的回放信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#c-%E7%BA%BF%E7%A8%8B%E7%9B%91%E6%8E%A7%E4%BF%A1%E6%81%AF%EF%BC%9A%E4%B8%BB%E8%A6%81%E7%94%A8%E6%9D%A5%E6%8E%92%E6%9F%A5%E4%B8%BB%E4%BB%8E%E6%95%85%E9%9A%9C"><span class="nav-number">6.1.2.3.</span> <span class="nav-text">c. 线程监控信息：主要用来排查主从故障</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#d-%E8%BF%87%E6%BB%A4%E5%A4%8D%E5%88%B6%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.2.4.</span> <span class="nav-text">d. 过滤复制相关信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#e-%E8%90%BD%E5%90%8E%E4%BA%8E%E4%B8%BB%E5%BA%93%E7%9A%84%E7%A7%92%E6%95%B0"><span class="nav-number">6.1.2.5.</span> <span class="nav-text">e. 落后于主库的秒数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#f-%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.2.6.</span> <span class="nav-text">f. 延时从库状态信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#g-GTID%E5%A4%8D%E5%88%B6%E4%BF%A1%E6%81%AF"><span class="nav-number">6.1.2.7.</span> <span class="nav-text">g. GTID复制信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#h-%E4%B8%80%E5%A0%86pos-%E5%8A%9F%E8%83%BD"><span class="nav-number">6.1.2.8.</span> <span class="nav-text">h. 一堆pos 功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-%E4%B8%BB%E4%BB%8E%E6%95%85%E9%9A%9C%E5%88%86%E6%9E%90%E5%8F%8A%E5%A4%84%E7%90%86"><span class="nav-number">6.2.</span> <span class="nav-text">5.2 主从故障分析及处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7"><span class="nav-number">6.2.1.</span> <span class="nav-text">5.2.1 如何监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-IO%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="nav-number">6.2.2.</span> <span class="nav-text">5.2.2 IO线程故障</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-SQL%E7%BA%BF%E7%A8%8B%E6%95%85%E9%9A%9C"><span class="nav-number">6.2.3.</span> <span class="nav-text">5.2.3 SQL线程故障</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-%E4%B8%BB%E4%BB%8E%E5%BB%B6%E6%97%B6%E5%88%86%E6%9E%90%E5%8F%8A%E5%A4%84%E7%90%86"><span class="nav-number">6.3.</span> <span class="nav-text">5.3 主从延时分析及处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-1-%E7%9B%91%E6%8E%A7%E6%96%B9%E6%B3%95"><span class="nav-number">6.3.1.</span> <span class="nav-text">5.3.1 监控方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-2-%E5%AF%BC%E8%87%B4%E5%BB%B6%E6%97%B6%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8E%9F%E5%9B%A0"><span class="nav-number">6.3.2.</span> <span class="nav-text">5.3.2 导致延时的主要原因</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#a-%E4%B8%BB%E5%BA%93%E6%96%B9%E9%9D%A2"><span class="nav-number">6.3.2.1.</span> <span class="nav-text">a. 主库方面</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#b-%E4%BB%8E%E5%BA%93%E6%96%B9%E9%9D%A2"><span class="nav-number">6.3.2.2.</span> <span class="nav-text">b. 从库方面</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E5%A4%9ASQL%E7%BA%BF%E7%A8%8B%E5%A4%8D%E5%88%B6MTS%E5%92%8C-MGR-Writesets"><span class="nav-number">7.</span> <span class="nav-text">7. 多SQL线程复制MTS和 MGR Writesets</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-5-7-%E7%89%88%E6%9C%ACMTS"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 5.7+ 版本MTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-8-0-%E7%89%88%E6%9C%AC-MGR-WS"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 8.0 版本 MGR WS</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E5%BB%B6%E6%97%B6%E4%BB%8E%E5%BA%93%E5%BA%94%E7%94%A8"><span class="nav-number">8.</span> <span class="nav-text">8. 延时从库应用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E8%BF%87%E6%BB%A4%E5%A4%8D%E5%88%B6"><span class="nav-number">9.</span> <span class="nav-text">9. 过滤复制</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-%E5%A4%9A%E6%BA%90%E5%A4%8D%E5%88%B6-MSR"><span class="nav-number">10.</span> <span class="nav-text">10. 多源复制(MSR)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-%E6%9E%B6%E6%9E%84"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-%E4%B8%BB%E6%9C%BA%E8%A7%92%E8%89%B2"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 主机角色</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B"><span class="nav-number">10.3.</span> <span class="nav-text">10.3 配置过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#a-GTID%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-number">10.3.1.</span> <span class="nav-text">a. GTID环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#b-%E9%85%8D%E7%BD%AE%E5%A4%9A%E6%BA%90%E5%A4%8D%E5%88%B6"><span class="nav-number">10.3.2.</span> <span class="nav-text">b. 配置多源复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c-%E5%A4%9A%E6%BA%90%E5%A4%8D%E5%88%B6%E7%9B%91%E6%8E%A7"><span class="nav-number">10.3.3.</span> <span class="nav-text">c. 多源复制监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#d-%E5%A4%9A%E6%BA%90%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE%E8%BF%87%E6%BB%A4"><span class="nav-number">10.3.4.</span> <span class="nav-text">d.多源复制配置过滤</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#11-MGR%E7%BB%84%E5%A4%8D%E5%88%B6%E5%BC%95%E5%85%A5"><span class="nav-number">11.</span> <span class="nav-text">11.  MGR组复制引入</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#11-0-%E5%8E%86%E5%8F%B2"><span class="nav-number">11.1.</span> <span class="nav-text">11.0 历史</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-1-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86"><span class="nav-number">11.2.</span> <span class="nav-text">11.1 架构原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-2-MGR%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">11.3.</span> <span class="nav-text">11.2 MGR构建过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-3-MGR%E7%9A%84%E8%BF%90%E7%BB%B4"><span class="nav-number">11.4.</span> <span class="nav-text">11.3 MGR的运维</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-4-MGR%E5%9C%A88-0%E7%89%88%E6%9C%AC%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E4%BF%9D%E8%AF%81"><span class="nav-number">11.5.</span> <span class="nav-text">11.4 MGR在8.0版本读写一致性保证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0group-replication-consistency%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="nav-number">11.5.1.</span> <span class="nav-text">参数group_replication_consistency的说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MGR%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">11.5.2.</span> <span class="nav-text">MGR读写一致性的优缺点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MGR%E8%AF%BB%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7%E7%9A%84%E6%96%B9%E6%A1%88"><span class="nav-number">11.5.3.</span> <span class="nav-text">MGR读写一致性的方案</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="139"
      src="/images/custom/avatar.jpg">
  <p class="site-author-name" itemprop="name">139</p>
  <div class="site-description" itemprop="description">一个普通的JAVA开发的博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">浙ICP备2023004484号-1 </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">139</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8335634399768246"
     crossorigin="anonymous"></script>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
